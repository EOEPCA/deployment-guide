{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Deployment Guide \u2693\ufe0e Updates See the ChangeLog for any updates/fixes that have been made to the tip since the v1.4 release. This may include relevant fixes that you may wish to take account of in your deployment. The Deployment Guide captures each release of the EOEPCA Reference Implementation, by providing for each version\u2026 Description of how each building-block is configured and deployed - see Deploy EOEPCA Components Scripted deployment in which each building-block can be selectively deployed to form a system - see Getting Started A full system deployment is described, in which components are deployed with complementary configurations that facilitate their integration as a coherent system. Nevertheless, each component can be cherry-picked from this system deployment for individual re-use. The deployment is organised into the following sections: Getting Started A quickstart guide with associated scripts to facilitate example deployments, which preempt the descriptions that follow later in the document. Scripts are provided in a variety of \u2018profiles\u2019 that deploy different combinations of building-blocks for different notional use cases. Prepare Cluster Establish the Kubernetes cluster and other prerequisites for the deployment of the EOEPCA system. Deploy EOEPCA Components Deployment of the EOEPCA components.","title":"Introduction"},{"location":"#deployment-guide","text":"Updates See the ChangeLog for any updates/fixes that have been made to the tip since the v1.4 release. This may include relevant fixes that you may wish to take account of in your deployment. The Deployment Guide captures each release of the EOEPCA Reference Implementation, by providing for each version\u2026 Description of how each building-block is configured and deployed - see Deploy EOEPCA Components Scripted deployment in which each building-block can be selectively deployed to form a system - see Getting Started A full system deployment is described, in which components are deployed with complementary configurations that facilitate their integration as a coherent system. Nevertheless, each component can be cherry-picked from this system deployment for individual re-use. The deployment is organised into the following sections: Getting Started A quickstart guide with associated scripts to facilitate example deployments, which preempt the descriptions that follow later in the document. Scripts are provided in a variety of \u2018profiles\u2019 that deploy different combinations of building-blocks for different notional use cases. Prepare Cluster Establish the Kubernetes cluster and other prerequisites for the deployment of the EOEPCA system. Deploy EOEPCA Components Deployment of the EOEPCA components.","title":"Deployment Guide"},{"location":"cluster/cluster-prerequisites/","text":"Cluster Prerequisites \u2693\ufe0e Overview \u2693\ufe0e The following prerequisite components are assumed to be deployed in the cluster. Note The Scripted Deployment automatically deploys most of the components list here - in particular\u2026 Nginx Ingress Controller Cert Manager Letsencrypt ClusterIssuers Minio Object Storage The Sealed Secrets controller is not deployed - but can be added following the instructions below . Nginx Ingress Controller \u2693\ufe0e # Install the Nginx Ingress Controller helm chart helm upgrade -i --version = '<4.5.0' \\ --repo https://kubernetes.github.io/ingress-nginx \\ ingress-nginx ingress-nginx \\ --wait Note For Kubernetes version 1.22 and earlier the version of the Nginx Ingress Controller must be before v4.5.0. To target the Nginx Ingress Controller the kubernetes.io/ingress.class: nginx annotation must be applied to the Ingress resource\u2026 apiVersion : networking.k8s.io/v1 kind : Ingress metadata : annotations : kubernetes.io/ingress.class : nginx ... Cert Manager \u2693\ufe0e # Install the Cert Manager helm chart helm upgrade -i --namespace cert-manager --create-namespace \\ --repo https://charts.jetstack.io \\ --set installCRDs = true \\ cert-manager cert-manager Letsencrypt Certificates \u2693\ufe0e Once the Certificate Manager is deployed, then we can establish ClusterIssuer operators in the cluster to support use of TLS with service Ingress endpoints. For Letsencrypt we can define two ClusterIssuer - for production and for staging . NOTE that these require the cluster to be publicly accessible, in order for the http01 acme flow to verify the domain ownership. Local development deployments will typically not have public IP/DNS - in which case the system deployment can proceed, but without TLS support for the service endpoints. Production \u2693\ufe0e apiVersion : cert-manager.io/v1 kind : ClusterIssuer metadata : name : letsencrypt-production spec : acme : # You must replace this email address with your own. # Let's Encrypt will use this to contact you about expiring # certificates, and issues related to your account. email : eoepca.systemteam@telespazio.com server : https://acme-v02.api.letsencrypt.org/directory privateKeySecretRef : # Secret resource that will be used to store the account's private key. name : letsencrypt-production-account-key # Add a single challenge solver, HTTP01 using nginx solvers : - http01 : ingress : class : nginx Staging \u2693\ufe0e apiVersion : cert-manager.io/v1 kind : ClusterIssuer metadata : name : letsencrypt-staging spec : acme : # You must replace this email address with your own. # Let's Encrypt will use this to contact you about expiring # certificates, and issues related to your account. email : eoepca.systemteam@telespazio.com server : https://acme-staging-v02.api.letsencrypt.org/directory privateKeySecretRef : # Secret resource that will be used to store the account's private key. name : letsencrypt-staging-account-key # Add a single challenge solver, HTTP01 using nginx solvers : - http01 : ingress : class : nginx To exploit the specified ClusterIssuer the cert-manager.io/cluster-issuer annotation must be applied to the Ingress resource. For example\u2026 apiVersion : networking.k8s.io/v1 kind : Ingress metadata : annotations : kubernetes.io/ingress.class : nginx cert-manager.io/cluster-issuer : letsencrypt-production ... Sealed Secrets \u2693\ufe0e The EOEPCA development team maintain their deployment configurations in GitHub - for declarative, reproducible cluster deployments. Various Secret are relied upon by the system services. Secrets should not be exposed by commit to GitHub. Instead SealedSecret are committed to GitHub, which are encrypted, and can only be decrypted by the sealed-secret-controller that runs within the cluster. The sealed-secret-controller decrypts the SealedSecret to a regular Secret (of the same name) that can then be consumed by the cluster components. The sealed-secret-controller is deployed to the cluster using the helm chart\u2026 helm install --version 2 .1.8 --create-namespace --namespace infra \\ --repo https://bitnami-labs.github.io/sealed-secrets \\ eoepca-sealed-secrets sealed-secrets Once the controller is deployed within the cluster, then the kubeseal command can be used to create a SealedSecret from a regular Secret , as follows\u2026 Create example Secret\u2026 kubectl -n test create secret generic mysecret \\ --from-literal = password = changeme \\ --dry-run = client -o yaml \\ > mysecret.yaml Create SealedSecret from Secret using kubeseal\u2026 kubeseal -o yaml \\ --controller-name eoepca-sealed-secrets \\ --controller-namespace infra \\ < mysecret.yaml \\ > mysecret-sealed.yaml References \u2693\ufe0e Sealed Secrets on GitHub kubeseal Release MinIO Object Storage \u2693\ufe0e Various building blocks require access to an S3-compatible object storage service. In particular the ADES processing service expects to stage-out its processing results to S3 object storage. Ideally the cloud provider for your deployment will make available a suitable object storage service. As a workaround, in the absence of an existing object storage, it is possible to use MinIO to establish an object storage service within the Kubernetes cluster. We use the minio helm chart provided by the MinIO Project . # Install the minio helm chart helm upgrade -i -f minio-values.yaml --namespace rm --create-namespace \\ --repo https://charts.min.io/ \\ minio minio \\ --wait Note The Kubernetes namespace rm is used above as an example, and can be changed according to your deployment preference. The minio deployment is customised via the values file minio-values.yaml , for example\u2026 existingSecret : minio-auth replicas : 2 ingress : enabled : true ingressClassName : nginx annotations : cert-manager.io/cluster-issuer : \"letsencrypt\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/proxy-body-size : \"0\" nginx.ingress.kubernetes.io/proxy-read-timeout : '600' path : / hosts : - minio.192-168-49-2.nip.io tls : - secretName : minio-tls hosts : - minio.192-168-49-2.nip.io consoleIngress : enabled : true ingressClassName : nginx annotations : cert-manager.io/cluster-issuer : \"letsencrypt\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/proxy-body-size : \"0\" nginx.ingress.kubernetes.io/proxy-read-timeout : '600' path : / hosts : - console.minio.192-168-49-2.nip.io tls : - secretName : minio-console-tls hosts : - console.minio.192-168-49-2.nip.io resources : requests : memory : 1Gi persistence : storageClass : standard buckets : - name : eoepca - name : cache-bucket Note The example values assuming a TLS configuration using letsencrypt certificate provider The admin credentials are provided by the Kubernetes secret named minio-auth - see below The annotation nginx.ingress.kubernetes.io/proxy-body-size was found to be required to allow transfer of large files (such as data products) through the nginx proxy Minio Credentials Secret \u2693\ufe0e The Minio admin credentials are provided via a Kubernetes secret that is referenced from the Minio helm chart deployment values. For example\u2026 kubectl -n rm create secret generic minio-auth \\ --from-literal=rootUser=\"eoepca\" \\ --from-literal=rootPassword=\"changeme\" Note The secret must be created in the same Kubernetes namespace as the Minio service deployment - e.g. rm namespce in the example above. s3cmd Configuration \u2693\ufe0e The s3cmd can be configured for access to the MinIO deployment. The --configure option can be used to prepare a suitable configuration file for s3cmd \u2026 s3cmd -c mys3cfg --configure In response to the prompts, the following configuration selections are applicable to the above settings\u2026 Access Key: eoepca Secret Key: changeme Default Region: us-east-1 S3 Endpoint: minio.192-168-49-2.nip.io DNS-style bucket+hostname:port template for accessing a bucket: minio.192-168-49-2.nip.io Encryption password: Path to GPG program: /usr/bin/gpg Use HTTPS protocol: True HTTP Proxy server name: HTTP Proxy server port: 0 Save the configuration file, and check access to the S3 object store with\u2026 # Create a bucket s3cmd -c mys3cfg mb s3://eoepca # List buckets s3cmd -c mys3cfg ls For example, using our sample deployment, the following can be used to interface with the MinIO service deployed in minikube\u2026 s3cmd -c deploy/cluster/s3cfg ls References \u2693\ufe0e MinIO Website MinIO Helm Chart MinIO on GitHub","title":"Cluster Prerequisites"},{"location":"cluster/cluster-prerequisites/#cluster-prerequisites","text":"","title":"Cluster Prerequisites"},{"location":"cluster/cluster-prerequisites/#overview","text":"The following prerequisite components are assumed to be deployed in the cluster. Note The Scripted Deployment automatically deploys most of the components list here - in particular\u2026 Nginx Ingress Controller Cert Manager Letsencrypt ClusterIssuers Minio Object Storage The Sealed Secrets controller is not deployed - but can be added following the instructions below .","title":"Overview"},{"location":"cluster/cluster-prerequisites/#nginx-ingress-controller","text":"# Install the Nginx Ingress Controller helm chart helm upgrade -i --version = '<4.5.0' \\ --repo https://kubernetes.github.io/ingress-nginx \\ ingress-nginx ingress-nginx \\ --wait Note For Kubernetes version 1.22 and earlier the version of the Nginx Ingress Controller must be before v4.5.0. To target the Nginx Ingress Controller the kubernetes.io/ingress.class: nginx annotation must be applied to the Ingress resource\u2026 apiVersion : networking.k8s.io/v1 kind : Ingress metadata : annotations : kubernetes.io/ingress.class : nginx ...","title":"Nginx Ingress Controller"},{"location":"cluster/cluster-prerequisites/#cert-manager","text":"# Install the Cert Manager helm chart helm upgrade -i --namespace cert-manager --create-namespace \\ --repo https://charts.jetstack.io \\ --set installCRDs = true \\ cert-manager cert-manager","title":"Cert Manager"},{"location":"cluster/cluster-prerequisites/#letsencrypt-certificates","text":"Once the Certificate Manager is deployed, then we can establish ClusterIssuer operators in the cluster to support use of TLS with service Ingress endpoints. For Letsencrypt we can define two ClusterIssuer - for production and for staging . NOTE that these require the cluster to be publicly accessible, in order for the http01 acme flow to verify the domain ownership. Local development deployments will typically not have public IP/DNS - in which case the system deployment can proceed, but without TLS support for the service endpoints.","title":"Letsencrypt Certificates"},{"location":"cluster/cluster-prerequisites/#production","text":"apiVersion : cert-manager.io/v1 kind : ClusterIssuer metadata : name : letsencrypt-production spec : acme : # You must replace this email address with your own. # Let's Encrypt will use this to contact you about expiring # certificates, and issues related to your account. email : eoepca.systemteam@telespazio.com server : https://acme-v02.api.letsencrypt.org/directory privateKeySecretRef : # Secret resource that will be used to store the account's private key. name : letsencrypt-production-account-key # Add a single challenge solver, HTTP01 using nginx solvers : - http01 : ingress : class : nginx","title":"Production"},{"location":"cluster/cluster-prerequisites/#staging","text":"apiVersion : cert-manager.io/v1 kind : ClusterIssuer metadata : name : letsencrypt-staging spec : acme : # You must replace this email address with your own. # Let's Encrypt will use this to contact you about expiring # certificates, and issues related to your account. email : eoepca.systemteam@telespazio.com server : https://acme-staging-v02.api.letsencrypt.org/directory privateKeySecretRef : # Secret resource that will be used to store the account's private key. name : letsencrypt-staging-account-key # Add a single challenge solver, HTTP01 using nginx solvers : - http01 : ingress : class : nginx To exploit the specified ClusterIssuer the cert-manager.io/cluster-issuer annotation must be applied to the Ingress resource. For example\u2026 apiVersion : networking.k8s.io/v1 kind : Ingress metadata : annotations : kubernetes.io/ingress.class : nginx cert-manager.io/cluster-issuer : letsencrypt-production ...","title":"Staging"},{"location":"cluster/cluster-prerequisites/#sealed-secrets","text":"The EOEPCA development team maintain their deployment configurations in GitHub - for declarative, reproducible cluster deployments. Various Secret are relied upon by the system services. Secrets should not be exposed by commit to GitHub. Instead SealedSecret are committed to GitHub, which are encrypted, and can only be decrypted by the sealed-secret-controller that runs within the cluster. The sealed-secret-controller decrypts the SealedSecret to a regular Secret (of the same name) that can then be consumed by the cluster components. The sealed-secret-controller is deployed to the cluster using the helm chart\u2026 helm install --version 2 .1.8 --create-namespace --namespace infra \\ --repo https://bitnami-labs.github.io/sealed-secrets \\ eoepca-sealed-secrets sealed-secrets Once the controller is deployed within the cluster, then the kubeseal command can be used to create a SealedSecret from a regular Secret , as follows\u2026 Create example Secret\u2026 kubectl -n test create secret generic mysecret \\ --from-literal = password = changeme \\ --dry-run = client -o yaml \\ > mysecret.yaml Create SealedSecret from Secret using kubeseal\u2026 kubeseal -o yaml \\ --controller-name eoepca-sealed-secrets \\ --controller-namespace infra \\ < mysecret.yaml \\ > mysecret-sealed.yaml","title":"Sealed Secrets"},{"location":"cluster/cluster-prerequisites/#references","text":"Sealed Secrets on GitHub kubeseal Release","title":"References"},{"location":"cluster/cluster-prerequisites/#minio-object-storage","text":"Various building blocks require access to an S3-compatible object storage service. In particular the ADES processing service expects to stage-out its processing results to S3 object storage. Ideally the cloud provider for your deployment will make available a suitable object storage service. As a workaround, in the absence of an existing object storage, it is possible to use MinIO to establish an object storage service within the Kubernetes cluster. We use the minio helm chart provided by the MinIO Project . # Install the minio helm chart helm upgrade -i -f minio-values.yaml --namespace rm --create-namespace \\ --repo https://charts.min.io/ \\ minio minio \\ --wait Note The Kubernetes namespace rm is used above as an example, and can be changed according to your deployment preference. The minio deployment is customised via the values file minio-values.yaml , for example\u2026 existingSecret : minio-auth replicas : 2 ingress : enabled : true ingressClassName : nginx annotations : cert-manager.io/cluster-issuer : \"letsencrypt\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/proxy-body-size : \"0\" nginx.ingress.kubernetes.io/proxy-read-timeout : '600' path : / hosts : - minio.192-168-49-2.nip.io tls : - secretName : minio-tls hosts : - minio.192-168-49-2.nip.io consoleIngress : enabled : true ingressClassName : nginx annotations : cert-manager.io/cluster-issuer : \"letsencrypt\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/proxy-body-size : \"0\" nginx.ingress.kubernetes.io/proxy-read-timeout : '600' path : / hosts : - console.minio.192-168-49-2.nip.io tls : - secretName : minio-console-tls hosts : - console.minio.192-168-49-2.nip.io resources : requests : memory : 1Gi persistence : storageClass : standard buckets : - name : eoepca - name : cache-bucket Note The example values assuming a TLS configuration using letsencrypt certificate provider The admin credentials are provided by the Kubernetes secret named minio-auth - see below The annotation nginx.ingress.kubernetes.io/proxy-body-size was found to be required to allow transfer of large files (such as data products) through the nginx proxy","title":"MinIO Object Storage"},{"location":"cluster/cluster-prerequisites/#minio-credentials-secret","text":"The Minio admin credentials are provided via a Kubernetes secret that is referenced from the Minio helm chart deployment values. For example\u2026 kubectl -n rm create secret generic minio-auth \\ --from-literal=rootUser=\"eoepca\" \\ --from-literal=rootPassword=\"changeme\" Note The secret must be created in the same Kubernetes namespace as the Minio service deployment - e.g. rm namespce in the example above.","title":"Minio Credentials Secret"},{"location":"cluster/cluster-prerequisites/#s3cmd-configuration","text":"The s3cmd can be configured for access to the MinIO deployment. The --configure option can be used to prepare a suitable configuration file for s3cmd \u2026 s3cmd -c mys3cfg --configure In response to the prompts, the following configuration selections are applicable to the above settings\u2026 Access Key: eoepca Secret Key: changeme Default Region: us-east-1 S3 Endpoint: minio.192-168-49-2.nip.io DNS-style bucket+hostname:port template for accessing a bucket: minio.192-168-49-2.nip.io Encryption password: Path to GPG program: /usr/bin/gpg Use HTTPS protocol: True HTTP Proxy server name: HTTP Proxy server port: 0 Save the configuration file, and check access to the S3 object store with\u2026 # Create a bucket s3cmd -c mys3cfg mb s3://eoepca # List buckets s3cmd -c mys3cfg ls For example, using our sample deployment, the following can be used to interface with the MinIO service deployed in minikube\u2026 s3cmd -c deploy/cluster/s3cfg ls","title":"s3cmd Configuration"},{"location":"cluster/cluster-prerequisites/#references_1","text":"MinIO Website MinIO Helm Chart MinIO on GitHub","title":"References"},{"location":"cluster/helm-repositories/","text":"Helm Repositories \u2693\ufe0e Note This section identifies some helm chart repositories that can be referenced (for convenience) via helm add . Nevertheless, all helm commands included in the guide specifically reference the source helm repository via the --repo argument to the helm install command - and thus it is not specifically necessary to add these repositories in advance. EOEPCA Helm Charts \u2693\ufe0e The EOEPCA building-blocks are engineered as containers for deployment to a Kubernetes cluster. Each building block defines a Helm Chart to facilitate its deployment. The EOEPCA Helm Chart Repository is configured with helm as follows\u2026 helm repo add eoepca https://eoepca.github.io/helm-charts/ Third-party Helm Charts \u2693\ufe0e In addition to the EOEPCA Helm Chart Repository, a variety of third party helm repositories are relied upon, as identified below. Cert Manager \u2693\ufe0e helm repo add jetstack https://charts.jetstack.io Nginx Ingress Controller \u2693\ufe0e helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx Minio \u2693\ufe0e helm repo add minio https://charts.min.io/ Sealed Secrets (Bitnami) \u2693\ufe0e helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets Harbor \u2693\ufe0e helm repo add harbor https://helm.goharbor.io Repo Update \u2693\ufe0e Refresh the local repo cache, after helm repo add \u2026 helm repo update","title":"Helm Repositories"},{"location":"cluster/helm-repositories/#helm-repositories","text":"Note This section identifies some helm chart repositories that can be referenced (for convenience) via helm add . Nevertheless, all helm commands included in the guide specifically reference the source helm repository via the --repo argument to the helm install command - and thus it is not specifically necessary to add these repositories in advance.","title":"Helm Repositories"},{"location":"cluster/helm-repositories/#eoepca-helm-charts","text":"The EOEPCA building-blocks are engineered as containers for deployment to a Kubernetes cluster. Each building block defines a Helm Chart to facilitate its deployment. The EOEPCA Helm Chart Repository is configured with helm as follows\u2026 helm repo add eoepca https://eoepca.github.io/helm-charts/","title":"EOEPCA Helm Charts"},{"location":"cluster/helm-repositories/#third-party-helm-charts","text":"In addition to the EOEPCA Helm Chart Repository, a variety of third party helm repositories are relied upon, as identified below.","title":"Third-party Helm Charts"},{"location":"cluster/helm-repositories/#cert-manager","text":"helm repo add jetstack https://charts.jetstack.io","title":"Cert Manager"},{"location":"cluster/helm-repositories/#nginx-ingress-controller","text":"helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx","title":"Nginx Ingress Controller"},{"location":"cluster/helm-repositories/#minio","text":"helm repo add minio https://charts.min.io/","title":"Minio"},{"location":"cluster/helm-repositories/#sealed-secrets-bitnami","text":"helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets","title":"Sealed Secrets (Bitnami)"},{"location":"cluster/helm-repositories/#harbor","text":"helm repo add harbor https://helm.goharbor.io","title":"Harbor"},{"location":"cluster/helm-repositories/#repo-update","text":"Refresh the local repo cache, after helm repo add \u2026 helm repo update","title":"Repo Update"},{"location":"cluster/kubernetes/","text":"Kubernetes Cluster \u2693\ufe0e The EOEPCA Reference Implementation has been developed with Kubernetes as its deployment target. The system components have been developed, deployed and tested using a cluster at version v1.22.5 . Note The Scripted Deployment assumes that minikube is installed, and creates a minikube cluster under the profile eoepca . Rancher Kubernetes Engine (RKE) \u2693\ufe0e The development, integration and test clusters have been established using Rancher Kubernetes Engine (RKE) at version v1.22.5 . An example of the creation of the EOEPCA Kubernetes clusters can be found on the GitHub Kubernetes Setup page . CREODIAS has been used for the development hosting infrastructure - which provides OpenStack infrastructure that is backed by Cloudferro . An example of the Terraform configurations used to automate the creation of the cloud infrastructure that underpins the RKE deployment can be found on the GitHub CREODIAS Setup page . Local Kubernetes \u2693\ufe0e To make a full deployment of the EOEPCA Reference Implementation requires a multi-node node cluster with suitable resources. For example, the development cluster comprises: 1 Master node (2 vCPU, 8 GB RAM) 5 Worker nodes (4 vCPU, 16 GB RAM) 1 NFS server (2 vCPU, 8 GB RAM) Limited local deployment can be made using a suitable local single-node kuberbetes deployment using - for example using minikube \u2026 minikube -p eoepca start --cpus max --memory max --kubernetes-version v1.22.5 minikube profile eoepca With such a deployment it is possible to deploy individual building-blocks for local development, or building-blocks in combination - within the constraints of the local host resources.","title":"Kubernetes Cluster"},{"location":"cluster/kubernetes/#kubernetes-cluster","text":"The EOEPCA Reference Implementation has been developed with Kubernetes as its deployment target. The system components have been developed, deployed and tested using a cluster at version v1.22.5 . Note The Scripted Deployment assumes that minikube is installed, and creates a minikube cluster under the profile eoepca .","title":"Kubernetes Cluster"},{"location":"cluster/kubernetes/#rancher-kubernetes-engine-rke","text":"The development, integration and test clusters have been established using Rancher Kubernetes Engine (RKE) at version v1.22.5 . An example of the creation of the EOEPCA Kubernetes clusters can be found on the GitHub Kubernetes Setup page . CREODIAS has been used for the development hosting infrastructure - which provides OpenStack infrastructure that is backed by Cloudferro . An example of the Terraform configurations used to automate the creation of the cloud infrastructure that underpins the RKE deployment can be found on the GitHub CREODIAS Setup page .","title":"Rancher Kubernetes Engine (RKE)"},{"location":"cluster/kubernetes/#local-kubernetes","text":"To make a full deployment of the EOEPCA Reference Implementation requires a multi-node node cluster with suitable resources. For example, the development cluster comprises: 1 Master node (2 vCPU, 8 GB RAM) 5 Worker nodes (4 vCPU, 16 GB RAM) 1 NFS server (2 vCPU, 8 GB RAM) Limited local deployment can be made using a suitable local single-node kuberbetes deployment using - for example using minikube \u2026 minikube -p eoepca start --cpus max --memory max --kubernetes-version v1.22.5 minikube profile eoepca With such a deployment it is possible to deploy individual building-blocks for local development, or building-blocks in combination - within the constraints of the local host resources.","title":"Local Kubernetes"},{"location":"cluster/prerequisite-tooling/","text":"Prerequisite Tooling \u2693\ufe0e There are some standard tools referenced in this guide. These are detailed in the following subsections. docker \u2693\ufe0e Docker faciliates the creation, management and execution of containers. Whilst not strictly necessary to support deployment to an existing/managed Kubernetes cluster, it can nevertheless be useful to have local access to the docker tooling. For example, if minikube is used to follow this guide using a local k8s cluster, then this is best achieved using minikube\u2019s docker driver. Docker is most easily installed with\u2026 curl -fsSL https://get.docker.com | sh For convenience, add your user to the docker group\u2026 sudo usermod -aG docker ${ USER } Logout/in to refresh your session\u2019s group permissions. kubectl \u2693\ufe0e Kubectl is the main tool for interaction with a Kubernetes cluster. The latest version can be installed with\u2026 mkdir -p $HOME /.local/bin \\ && curl -fsSLo $HOME /.local/bin/kubectl \"https://dl.k8s.io/release/ $( curl -L -s https://dl.k8s.io/release/stable.txt ) /bin/linux/amd64/kubectl\" \\ && chmod +x $HOME /.local/bin/kubectl See the official kubectl installation documentation for more installation options. helm \u2693\ufe0e Helm is the Kubernetes package manager, in which components are deployed to a Kubernetes cluster via helm charts. The helm charts are instantiated for deployment via \u2018values\u2019 that configure the chart templates. The latest helm version can be installed with\u2026 export HELM_INSTALL_DIR = \" $HOME /.local/bin\" \\ && curl -sfL https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash See the official helm installation documentation for more installation options. minikube \u2693\ufe0e Minikube is a tool that allows to create a local (single-node) Kubernetes cluster for development/testing. It is not designed for production use. In the absence of access to a \u2018full\u2019 Kubernetes cluster, this guide can be followed using minikube. The latest version of minikube can be installed with\u2026 mkdir -p $HOME /.local/bin \\ && curl -fsSLo $HOME /.local/bin/minikube \"https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64\" \\ && chmod +x $HOME /.local/bin/minikube See the official minikube installation documentation for more installation options.","title":"Prerequisite Tooling"},{"location":"cluster/prerequisite-tooling/#prerequisite-tooling","text":"There are some standard tools referenced in this guide. These are detailed in the following subsections.","title":"Prerequisite Tooling"},{"location":"cluster/prerequisite-tooling/#docker","text":"Docker faciliates the creation, management and execution of containers. Whilst not strictly necessary to support deployment to an existing/managed Kubernetes cluster, it can nevertheless be useful to have local access to the docker tooling. For example, if minikube is used to follow this guide using a local k8s cluster, then this is best achieved using minikube\u2019s docker driver. Docker is most easily installed with\u2026 curl -fsSL https://get.docker.com | sh For convenience, add your user to the docker group\u2026 sudo usermod -aG docker ${ USER } Logout/in to refresh your session\u2019s group permissions.","title":"docker"},{"location":"cluster/prerequisite-tooling/#kubectl","text":"Kubectl is the main tool for interaction with a Kubernetes cluster. The latest version can be installed with\u2026 mkdir -p $HOME /.local/bin \\ && curl -fsSLo $HOME /.local/bin/kubectl \"https://dl.k8s.io/release/ $( curl -L -s https://dl.k8s.io/release/stable.txt ) /bin/linux/amd64/kubectl\" \\ && chmod +x $HOME /.local/bin/kubectl See the official kubectl installation documentation for more installation options.","title":"kubectl"},{"location":"cluster/prerequisite-tooling/#helm","text":"Helm is the Kubernetes package manager, in which components are deployed to a Kubernetes cluster via helm charts. The helm charts are instantiated for deployment via \u2018values\u2019 that configure the chart templates. The latest helm version can be installed with\u2026 export HELM_INSTALL_DIR = \" $HOME /.local/bin\" \\ && curl -sfL https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash See the official helm installation documentation for more installation options.","title":"helm"},{"location":"cluster/prerequisite-tooling/#minikube","text":"Minikube is a tool that allows to create a local (single-node) Kubernetes cluster for development/testing. It is not designed for production use. In the absence of access to a \u2018full\u2019 Kubernetes cluster, this guide can be followed using minikube. The latest version of minikube can be installed with\u2026 mkdir -p $HOME /.local/bin \\ && curl -fsSLo $HOME /.local/bin/minikube \"https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64\" \\ && chmod +x $HOME /.local/bin/minikube See the official minikube installation documentation for more installation options.","title":"minikube"},{"location":"eoepca/ades-zoo/","text":"ADES (Processing) \u2693\ufe0e ADES - Application Deployment & Execution Service ZOO-Project DRU \u2693\ufe0e Note With EOEPCA release 1.4, the ADES implementation has been significantly reworked and fully aligned with the upstream ZOO-Project ( GitHub ). This zoo-project-dru version deprecates the previous proc-ades implementation. With this transition, there are some functional changes to be aware of\u2026 Service Endpoint With zoo-project-dru the OGC API Processes endpoint is at the path /<username>/ogc-api/processes compared to the previous /<username>/wps3/processes . Deployed Application Endpoint The endpoint for a deployed Application no longer appends the version of the Application Package. For example, previously the application convert-url at version 0.1.2 would result in the endpoint /<username>/wps3/processes/convert-url_0_1_2 . With the new zoo-project-dru this same Application Package deployment will result in the endpoint /<username>/ogc-api/processes/convert-url . Deployed Application Version The version of the deployed application is obtained from the Application Package CWL (ref. s:softwareVersion: 0.1.2 ), and is maintained within the metadata for the deployed process that is returned from the APIs Get Process Details request. In the case that multiple versions of the same Application Package are required to be simultaneously deployed, then this would have to be handled with different CWL documents in which the version is embedded in the workflow id (or some other technique that establishes uniqueness of id between variants). DRU - Deploy, Replace, Undeploy - OFC API Processes Part 2 The ADES provides a platform-hosted execution engine through which users can initiate parameterised processing jobs using applications made available within the platform - supporting the efficient execution of the processing \u2018close to the data\u2019. Users can deploy specific \u2018applications\u2019 to the ADES, which may be their own applications, or those published by other platform users. The ADES provides an implementation of the OGC API Processes - Part 1: Core and Part 2: Deploy, Replace, Undeploy (draft) . Helm Chart \u2693\ufe0e The EOEPCA deployment is aligned with the upstream implementation and so relies upon the upstream helm chart that is hosted at the ZOO-Project Helm Chart Repository - in particular the zoo-project-dru chart variant. The chart is configured via values that are fully documented in the README for the zoo-project-dru chart . helm install --version 0 .2.6 --values ades-values.yaml \\ --repo https://zoo-project.github.io/charts/ \\ zoo-project-dru zoo-project-dru Values \u2693\ufe0e The deployment must be configured for you environment. Some significant configuration values are elaborated here\u2026 Cookie-cutter Template \u2693\ufe0e The implementation zoo-project-dru provides the core capabilities for OGC API Processes Parts 1 & 2. The deployemnt of this core must be completed by inetgartion with the \u2018runner\u2019 that executes the processes as Application Packages, and integrates as necessary with other platform services - such as Catalogue, Workspace, etc. Thus, zoo-project-dru is extensible by design via a \u2018cookie-cutter\u2019 that provides the template \u2018runner\u2019 for each Application Package process as it is deployed to the service. For the purposes of our EOEPCA \u2018release\u2019 as covered by this guide, we provide eoepca-proc-service-template as a cookie-cutter implemetation that provides: Integration with Kubernetes to run process Application packages, via the Calrissian CWL runner Stage-in of inputs as STAC items, integrated as required with S3 object storage Stage-out of outputs as a STAC Collection, integrated with S3 object storage and (optionally) user Workspace inetgration The cookie-cutter template is identified in the helm values\u2026 cookiecutter : templateUrl : https://github.com/EOEPCA/eoepca-proc-service-template.git templateBranch : master The function of the cookie-cutter template is supported some other aspects, that are elaborated below, which must be configured in collaboration with the expectations of the template. In particular\u2026 Template parameterisation that is passed through the core zoo-project-dru configuration [ ref ] CWL \u2018wrapper\u2019 files that prepend and append the process Application Package CWL to perform stage-in and stage-out functions [ ref ] ZOO-Project DRU custom configuration \u2693\ufe0e In order support our eoepca-proc-service-template cookie-cutter template, there is a custom zoo-project-dru container image that includes the python dependencies that are required by this template. Thus, the deployment must identify the custom container image via helm values\u2026 zoofpm : image : tag : eoepca-092ea7a2c6823dba9c6d52c383a73f5ff92d0762 zookernel : image : tag : eoepca-092ea7a2c6823dba9c6d52c383a73f5ff92d0762 In addition, we can add values to the ZOO-Project DRU main.cfg configuration file via helm values. In this case we add some eoepca-specific values that match those that we know to be expected by our eoepca-proc-service-template cookie-cutter template. In this way we can effectively use helm values to pass parameters through to the template. customConfig : main : eoepca : |- domain=192-168-49-2.nip.io workspace_prefix=ws This is manifest in zoo\u2019s main.cfg in INI file configuration syntax\u2026 [eoepca] domain = 192-168-49-2.nip.io workspace_prefix = ws The presence or otherwise of the workspace_prefix parameter dicates whether or not the stage-out step will integrate with the user\u2019s Workspace for persistence of the processing results, and registration within the Workspace services. In the case that workspace_prefix is not set, then the object storage specification in the helm values is relied upon\u2026 workflow : inputs : STAGEOUT_AWS_SERVICEURL : https://minio.192-168-49-2.nip.io STAGEOUT_AWS_ACCESS_KEY_ID : eoepca STAGEOUT_AWS_SECRET_ACCESS_KEY : changeme STAGEOUT_AWS_REGION : RegionOne STAGEOUT_OUTPUT : eoepca Stage-in / Stage-out \u2693\ufe0e The ADES hosts applications that are deployed and invoked in accordance with the OGC Best Practise for Application Package . Thus, the ADES provides a conformant environment within which the application is integrated for execution. A key part of the ADES\u2019s role in this is to faciltate the provision of input data to the application (stage-in), and the handling of the results output at the conclusion of application execution (stage-out). The zoo-project-dru helm chart provides a default implementation via the included files - main.yaml , rules.yaml , stagein.yaml and stageout.yaml . The helm values provides a means through which each of these files can be overriden for reasons of integration with your platform environment\u2026 files : # Directory 'files/cwlwrapper-assets' - assets for ConfigMap 'XXX-cwlwrapper-config' cwlwrapperAssets : main.yaml : |- <override file content here> rules.yaml : |- <override file content here> stagein.yaml : |- <override file content here> stageout.yaml : |- <override file content here> In the most part the default CWL wrapper files provided with the helm chart are suffient. In particular the stagein.yaml implements the stage-in of STAC items that are specified as inputs of type Directory in the Application Package CWL. E.g. inputs : stac : label : the image to convert as a STAC item doc : the image to convert as a STAC item type : Directory Nevertheless, in this guide we provide an override of the stageout.yaml in order to organise the processing outputs into a STAC Collection that is then pushed to the designated S3 object storage, including support for the user\u2019s workspace storage and resource management services. The custom stage-out embeds, within the CWL document, the python code required to implement the desired stage-out functionality. This should be regarded as an example that could be adapted for alternative behaviour. cwlVersion : v1.0 class : CommandLineTool id : stage-out doc : \"Stage-out the results to S3\" inputs : process : type : string collection_id : type : string STAGEOUT_OUTPUT : type : string STAGEOUT_AWS_ACCESS_KEY_ID : type : string STAGEOUT_AWS_SECRET_ACCESS_KEY : type : string STAGEOUT_AWS_REGION : type : string STAGEOUT_AWS_SERVICEURL : type : string outputs : StacCatalogUri : outputBinding : outputEval : ${ return \"s3://\" + inputs.STAGEOUT_OUTPUT + \"/\" + inputs.process + \"/catalog.json\"; } type : string baseCommand : - python - stageout.py arguments : - $( inputs.wf_outputs.path ) - $( inputs.STAGEOUT_OUTPUT ) - $( inputs.process ) - $( inputs.collection_id ) requirements : DockerRequirement : dockerPull : ghcr.io/terradue/ogc-eo-application-package-hands-on/stage:1.3.2 InlineJavascriptRequirement : {} EnvVarRequirement : envDef : AWS_ACCESS_KEY_ID : $( inputs.STAGEOUT_AWS_ACCESS_KEY_ID ) AWS_SECRET_ACCESS_KEY : $( inputs.STAGEOUT_AWS_SECRET_ACCESS_KEY ) AWS_REGION : $( inputs.STAGEOUT_AWS_REGION ) AWS_S3_ENDPOINT : $( inputs.STAGEOUT_AWS_SERVICEURL ) InitialWorkDirRequirement : listing : - entryname : stageout.py entry : |- import sys import shutil import os import pystac cat_url = sys.argv[1] shutil.copytree(cat_url, \"/tmp/catalog\") cat = pystac.read_file(os.path.join(\"/tmp/catalog\", \"catalog.json\")) ... The helm chart values provide the opportunity to pass through additional inputs - to satisfy the input specifications that are specified in the cwlwrapperAssets files\u2026 workflow : inputs : STAGEIN_AWS_SERVICEURL : http://data.cloudferro.com STAGEIN_AWS_ACCESS_KEY_ID : test STAGEIN_AWS_SECRET_ACCESS_KEY : test STAGEIN_AWS_REGION : RegionOne STAGEOUT_AWS_SERVICEURL : https://minio.192-168-49-2.nip.io STAGEOUT_AWS_ACCESS_KEY_ID : eoepca STAGEOUT_AWS_SECRET_ACCESS_KEY : changeme STAGEOUT_AWS_REGION : RegionOne STAGEOUT_OUTPUT : eoepca Node Selection \u2693\ufe0e The zoo-project-dru services uses a Node Selector to determine the node(s) upon which the processing execution is run. This is configured as a matching rule in the helm values, and must be tailored to your cluster. For example, for minikube\u2026 workflow : nodeSelector : minikube.k8s.io/primary : \"true\" Ingress \u2693\ufe0e Ingress can be enabled and configured to establish (reverse-proxy) external access to the zoo-project-dru services. Hosturl In the case that protection is enabled - e.g. via Resource Guard - then it is likely that ingress should be disabled here, since the ingress will instead be handled by the protection. In this case, the hosturl parameter should be set to reflect the public url through the service will be accessed. In the case that ingress is enabled then it is not necessary to specify the hosturl , since it will be taken from the ingress.hosts[0].host value. Ingress disabled\u2026 ingress : enabled : false hosturl : zoo.192-168-49-2.nip.io Ingress enabled\u2026 ingress : enabled : true annotations : kubernetes.io/ingress.class : nginx ingress.kubernetes.io/ssl-redirect : true nginx.ingress.kubernetes.io/ssl-redirect : true cert-manager.io/cluster-issuer : letsencrypt-production hosts : - host : zoo-open.192-168-49-2.nip.io paths : - path : / pathType : ImplementationSpecific tls : - hosts : - zoo-open.192-168-49-2.nip.io secretName : zoo-open-tls The above example assumes that TLS should be enabled via Letsencrypt as certificate provider - see section Letsencrypt Certificates . Persistence \u2693\ufe0e Various of the services deployed as part of zoo-project-dru rely upon dynamic provisioning of persistent storage volumes. A number of helm values are impacted by this setting, which must be configured with the Storage Class appropriate to your cluster. For example, using the minikube standard storage class\u2026 workflow : storageClass : standard persistence : procServicesStorageClass : standard storageClass : standard tmpStorageClass : standard postgresql : primary : persistence : storageClass : standard readReplicas : persistence : storageClass : standard rabbitmq : persistence : storageClass : standard Built-in IAM \u2693\ufe0e ZOO-Project DRU has a built-in capability for Identity & Access Management (IAM), in which the zoo-project-dru service is configured as an OIDC client of an OIDC Identity Provider service. This capability is disabled by the default deployment offered by this guide ( ingress.enabled: false ) - which instead (optionally) applies resource protection using the EOEPCA IAM solution. Nevertheless, the built-in IAM can be enabled and configured through helm values. For example\u2026 iam : enabled : true openIdConnectUrl : https://keycloak.192-168-49-2.nip.io/realms/master/.well-known/openid-configuration type : openIdConnect name : OpenIDAuth realm : Secured section Protection \u2693\ufe0e As described in section Resource Protection (Keycloak) , the identity-gatekeeper component can be inserted into the request path of the zoo-project-dru service to provide access authorization decisions Gatekeeper \u2693\ufe0e Gatekeeper is deployed using its helm chart\u2026 helm install zoo-project-dru-protection identity-gatekeeper -f zoo-protection-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ --namespace \"zoo\" --create-namespace \\ --version 1 .0.11 The identity-gatekeeper must be configured with the values applicable to the zoo-project-dru - in particular the specific ingress requirements for the zoo-project-dru-service \u2026 Example zoo-protection-values.yaml \u2026 fullnameOverride : zoo-project-dru-protection config : client-id : ades discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io targetService : host : zoo.192-168-49-2.nip.io name : zoo-project-dru-service port : number : 80 secrets : # Values for secret 'zoo-project-dru-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production serverSnippets : custom : |- # Open access to some endpoints, including Swagger UI location ~ /(ogc-api/api|swagger-ui) { proxy_pass {{ include \"identity-gatekeeper.targetUrl\" . }}$request_uri; } Keycloak Client \u2693\ufe0e The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. client-id: ades above. This can be created with the create-client helper script, as descirbed in section Client Registration . For example, with path protection for test users\u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = ades \\ --name = \"ADES Gatekeeper\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by ADES Gatekeeper\" \\ --resource = \"eric\" --uris = '/eric/*' --scopes = view --users = \"eric\" \\ --resource = \"bob\" --uris = '/bob/*' --scopes = view --users = \"bob\" \\ --resource = \"alice\" --uris = '/alice/*' --scopes = view --users = \"alice\" Service URLs \u2693\ufe0e The zoo-project-dru service provides a mutil-user aware set of service interfaces at\u2026 OGC API Processes: https://zoo.192-168-49-2.nip.io/<username>/ogc-api/ Swagger UI: https://zoo.192-168-49-2.nip.io/swagger-ui/oapip/ Usage Samples \u2693\ufe0e See the Example Requests in the Processing Deployment for sample requests that cans be used to test your deployment, and to learn usage of the OGC API Processes. Debugging Tips \u2693\ufe0e This section includes some tips that may be useful in debugging errors with deployed application packages. For debugging, establish a shell session with the zoofpm pod\u2026 $ kubectl -n zoo exec -it deploy/zoo-project-dru-zoofpm -c zoofpm -- bash Execution Logs \u2693\ufe0e The logs are in the directory /tmp/zTmp \u2026 $ cd /tmp/zTmp/ In the log directory, each execution is characterised by a set of files/directories\u2026 <appname>_<jobid>_error.log <<START HERE The main log output of the job <appname>_<jobid>.json The output (results) of the job <jobid>_status.json The overall status of the job <jobid>_logs.cfg Index of logs for job workflow steps convert-url-c6637d4a-d561-11ee-bf3b-0242ac11000e (directory) Subdirectory with a dedicated log file for each step of the CWL workflow, including the stage-in and stage-out steps Deployed Process \u2018Executables\u2019 \u2693\ufe0e When the process is deployed from its Application Package, then a representation is created using the configured cookiecutter.templateUrl . It may be useful to debug the consequent process files, which are located under the path /opt/zooservices_user/<username> , with a dedicated subdirectory for each deployed process - i.e. /opt/zooservices_user/<username>/<appname>/ . For example\u2026 $ cd /opt/zooservices_user/eric/convert-url $ ls -l total 28 -rw-rw-r-- 1 www-data www-data 0 Feb 27 11 :17 __init__.py drwxrwxr-x 2 www-data www-data 4096 Feb 27 11 :17 __pycache__ -rw-rw-r-- 1 www-data www-data 1408 Feb 27 11 :17 app-package.cwl -rw-rw-r-- 1 www-data www-data 17840 Feb 27 11 :17 service.py Note In the case that the cookie-cutter template is updated, then the process can be re-deployed to force a refresh against the updated template. Swagger UI (OpenAPI) \u2693\ufe0e The zoo-project-dru service includes a Swagger UI interactive representation of its OpenAPI REST interface - available at the URL https://zoo.192-168-49-2.nip.io/swagger-ui/oapip/ . Application Package Example \u2693\ufe0e For a (trivial) example application package see Example Application Package , which provides a description and illustration of the basics of creating an application that integrates with the expectations of the ADES stage-in and stage-out. For further reference see\u2026 Application Packages OGC Best Practise for Application Package Example Application Package Common Workflow Language (CWL) Guide for CWL in Earth Observation CWL Specification CWL User Guide Additional Information \u2693\ufe0e Additional information regarding the ADES can be found at: ZOO-Project DRU\u2026 Helm Chart Documentation Git Repositories\u2026 ZOO-Project Core OGC API Processes capability eoepca-proc-service-template Cookie-cutter template for Application Package execution in Kubernetes zoo-calrissian-runner Python library used by the eoepca-proc-service-template to aid orchestration of CWL application packages running in Kubernetes via Calrissian pycalrissian Python library used by zoo-calrissian-runner to aid interfacing with Calrissian and Kubernetes","title":"ADES (Processing)"},{"location":"eoepca/ades-zoo/#ades-processing","text":"ADES - Application Deployment & Execution Service","title":"ADES (Processing)"},{"location":"eoepca/ades-zoo/#zoo-project-dru","text":"Note With EOEPCA release 1.4, the ADES implementation has been significantly reworked and fully aligned with the upstream ZOO-Project ( GitHub ). This zoo-project-dru version deprecates the previous proc-ades implementation. With this transition, there are some functional changes to be aware of\u2026 Service Endpoint With zoo-project-dru the OGC API Processes endpoint is at the path /<username>/ogc-api/processes compared to the previous /<username>/wps3/processes . Deployed Application Endpoint The endpoint for a deployed Application no longer appends the version of the Application Package. For example, previously the application convert-url at version 0.1.2 would result in the endpoint /<username>/wps3/processes/convert-url_0_1_2 . With the new zoo-project-dru this same Application Package deployment will result in the endpoint /<username>/ogc-api/processes/convert-url . Deployed Application Version The version of the deployed application is obtained from the Application Package CWL (ref. s:softwareVersion: 0.1.2 ), and is maintained within the metadata for the deployed process that is returned from the APIs Get Process Details request. In the case that multiple versions of the same Application Package are required to be simultaneously deployed, then this would have to be handled with different CWL documents in which the version is embedded in the workflow id (or some other technique that establishes uniqueness of id between variants). DRU - Deploy, Replace, Undeploy - OFC API Processes Part 2 The ADES provides a platform-hosted execution engine through which users can initiate parameterised processing jobs using applications made available within the platform - supporting the efficient execution of the processing \u2018close to the data\u2019. Users can deploy specific \u2018applications\u2019 to the ADES, which may be their own applications, or those published by other platform users. The ADES provides an implementation of the OGC API Processes - Part 1: Core and Part 2: Deploy, Replace, Undeploy (draft) .","title":"ZOO-Project DRU"},{"location":"eoepca/ades-zoo/#helm-chart","text":"The EOEPCA deployment is aligned with the upstream implementation and so relies upon the upstream helm chart that is hosted at the ZOO-Project Helm Chart Repository - in particular the zoo-project-dru chart variant. The chart is configured via values that are fully documented in the README for the zoo-project-dru chart . helm install --version 0 .2.6 --values ades-values.yaml \\ --repo https://zoo-project.github.io/charts/ \\ zoo-project-dru zoo-project-dru","title":"Helm Chart"},{"location":"eoepca/ades-zoo/#values","text":"The deployment must be configured for you environment. Some significant configuration values are elaborated here\u2026","title":"Values"},{"location":"eoepca/ades-zoo/#cookie-cutter-template","text":"The implementation zoo-project-dru provides the core capabilities for OGC API Processes Parts 1 & 2. The deployemnt of this core must be completed by inetgartion with the \u2018runner\u2019 that executes the processes as Application Packages, and integrates as necessary with other platform services - such as Catalogue, Workspace, etc. Thus, zoo-project-dru is extensible by design via a \u2018cookie-cutter\u2019 that provides the template \u2018runner\u2019 for each Application Package process as it is deployed to the service. For the purposes of our EOEPCA \u2018release\u2019 as covered by this guide, we provide eoepca-proc-service-template as a cookie-cutter implemetation that provides: Integration with Kubernetes to run process Application packages, via the Calrissian CWL runner Stage-in of inputs as STAC items, integrated as required with S3 object storage Stage-out of outputs as a STAC Collection, integrated with S3 object storage and (optionally) user Workspace inetgration The cookie-cutter template is identified in the helm values\u2026 cookiecutter : templateUrl : https://github.com/EOEPCA/eoepca-proc-service-template.git templateBranch : master The function of the cookie-cutter template is supported some other aspects, that are elaborated below, which must be configured in collaboration with the expectations of the template. In particular\u2026 Template parameterisation that is passed through the core zoo-project-dru configuration [ ref ] CWL \u2018wrapper\u2019 files that prepend and append the process Application Package CWL to perform stage-in and stage-out functions [ ref ]","title":"Cookie-cutter Template"},{"location":"eoepca/ades-zoo/#zoo-project-dru-custom-configuration","text":"In order support our eoepca-proc-service-template cookie-cutter template, there is a custom zoo-project-dru container image that includes the python dependencies that are required by this template. Thus, the deployment must identify the custom container image via helm values\u2026 zoofpm : image : tag : eoepca-092ea7a2c6823dba9c6d52c383a73f5ff92d0762 zookernel : image : tag : eoepca-092ea7a2c6823dba9c6d52c383a73f5ff92d0762 In addition, we can add values to the ZOO-Project DRU main.cfg configuration file via helm values. In this case we add some eoepca-specific values that match those that we know to be expected by our eoepca-proc-service-template cookie-cutter template. In this way we can effectively use helm values to pass parameters through to the template. customConfig : main : eoepca : |- domain=192-168-49-2.nip.io workspace_prefix=ws This is manifest in zoo\u2019s main.cfg in INI file configuration syntax\u2026 [eoepca] domain = 192-168-49-2.nip.io workspace_prefix = ws The presence or otherwise of the workspace_prefix parameter dicates whether or not the stage-out step will integrate with the user\u2019s Workspace for persistence of the processing results, and registration within the Workspace services. In the case that workspace_prefix is not set, then the object storage specification in the helm values is relied upon\u2026 workflow : inputs : STAGEOUT_AWS_SERVICEURL : https://minio.192-168-49-2.nip.io STAGEOUT_AWS_ACCESS_KEY_ID : eoepca STAGEOUT_AWS_SECRET_ACCESS_KEY : changeme STAGEOUT_AWS_REGION : RegionOne STAGEOUT_OUTPUT : eoepca","title":"ZOO-Project DRU custom configuration"},{"location":"eoepca/ades-zoo/#stage-in-stage-out","text":"The ADES hosts applications that are deployed and invoked in accordance with the OGC Best Practise for Application Package . Thus, the ADES provides a conformant environment within which the application is integrated for execution. A key part of the ADES\u2019s role in this is to faciltate the provision of input data to the application (stage-in), and the handling of the results output at the conclusion of application execution (stage-out). The zoo-project-dru helm chart provides a default implementation via the included files - main.yaml , rules.yaml , stagein.yaml and stageout.yaml . The helm values provides a means through which each of these files can be overriden for reasons of integration with your platform environment\u2026 files : # Directory 'files/cwlwrapper-assets' - assets for ConfigMap 'XXX-cwlwrapper-config' cwlwrapperAssets : main.yaml : |- <override file content here> rules.yaml : |- <override file content here> stagein.yaml : |- <override file content here> stageout.yaml : |- <override file content here> In the most part the default CWL wrapper files provided with the helm chart are suffient. In particular the stagein.yaml implements the stage-in of STAC items that are specified as inputs of type Directory in the Application Package CWL. E.g. inputs : stac : label : the image to convert as a STAC item doc : the image to convert as a STAC item type : Directory Nevertheless, in this guide we provide an override of the stageout.yaml in order to organise the processing outputs into a STAC Collection that is then pushed to the designated S3 object storage, including support for the user\u2019s workspace storage and resource management services. The custom stage-out embeds, within the CWL document, the python code required to implement the desired stage-out functionality. This should be regarded as an example that could be adapted for alternative behaviour. cwlVersion : v1.0 class : CommandLineTool id : stage-out doc : \"Stage-out the results to S3\" inputs : process : type : string collection_id : type : string STAGEOUT_OUTPUT : type : string STAGEOUT_AWS_ACCESS_KEY_ID : type : string STAGEOUT_AWS_SECRET_ACCESS_KEY : type : string STAGEOUT_AWS_REGION : type : string STAGEOUT_AWS_SERVICEURL : type : string outputs : StacCatalogUri : outputBinding : outputEval : ${ return \"s3://\" + inputs.STAGEOUT_OUTPUT + \"/\" + inputs.process + \"/catalog.json\"; } type : string baseCommand : - python - stageout.py arguments : - $( inputs.wf_outputs.path ) - $( inputs.STAGEOUT_OUTPUT ) - $( inputs.process ) - $( inputs.collection_id ) requirements : DockerRequirement : dockerPull : ghcr.io/terradue/ogc-eo-application-package-hands-on/stage:1.3.2 InlineJavascriptRequirement : {} EnvVarRequirement : envDef : AWS_ACCESS_KEY_ID : $( inputs.STAGEOUT_AWS_ACCESS_KEY_ID ) AWS_SECRET_ACCESS_KEY : $( inputs.STAGEOUT_AWS_SECRET_ACCESS_KEY ) AWS_REGION : $( inputs.STAGEOUT_AWS_REGION ) AWS_S3_ENDPOINT : $( inputs.STAGEOUT_AWS_SERVICEURL ) InitialWorkDirRequirement : listing : - entryname : stageout.py entry : |- import sys import shutil import os import pystac cat_url = sys.argv[1] shutil.copytree(cat_url, \"/tmp/catalog\") cat = pystac.read_file(os.path.join(\"/tmp/catalog\", \"catalog.json\")) ... The helm chart values provide the opportunity to pass through additional inputs - to satisfy the input specifications that are specified in the cwlwrapperAssets files\u2026 workflow : inputs : STAGEIN_AWS_SERVICEURL : http://data.cloudferro.com STAGEIN_AWS_ACCESS_KEY_ID : test STAGEIN_AWS_SECRET_ACCESS_KEY : test STAGEIN_AWS_REGION : RegionOne STAGEOUT_AWS_SERVICEURL : https://minio.192-168-49-2.nip.io STAGEOUT_AWS_ACCESS_KEY_ID : eoepca STAGEOUT_AWS_SECRET_ACCESS_KEY : changeme STAGEOUT_AWS_REGION : RegionOne STAGEOUT_OUTPUT : eoepca","title":"Stage-in / Stage-out"},{"location":"eoepca/ades-zoo/#node-selection","text":"The zoo-project-dru services uses a Node Selector to determine the node(s) upon which the processing execution is run. This is configured as a matching rule in the helm values, and must be tailored to your cluster. For example, for minikube\u2026 workflow : nodeSelector : minikube.k8s.io/primary : \"true\"","title":"Node Selection"},{"location":"eoepca/ades-zoo/#ingress","text":"Ingress can be enabled and configured to establish (reverse-proxy) external access to the zoo-project-dru services. Hosturl In the case that protection is enabled - e.g. via Resource Guard - then it is likely that ingress should be disabled here, since the ingress will instead be handled by the protection. In this case, the hosturl parameter should be set to reflect the public url through the service will be accessed. In the case that ingress is enabled then it is not necessary to specify the hosturl , since it will be taken from the ingress.hosts[0].host value. Ingress disabled\u2026 ingress : enabled : false hosturl : zoo.192-168-49-2.nip.io Ingress enabled\u2026 ingress : enabled : true annotations : kubernetes.io/ingress.class : nginx ingress.kubernetes.io/ssl-redirect : true nginx.ingress.kubernetes.io/ssl-redirect : true cert-manager.io/cluster-issuer : letsencrypt-production hosts : - host : zoo-open.192-168-49-2.nip.io paths : - path : / pathType : ImplementationSpecific tls : - hosts : - zoo-open.192-168-49-2.nip.io secretName : zoo-open-tls The above example assumes that TLS should be enabled via Letsencrypt as certificate provider - see section Letsencrypt Certificates .","title":"Ingress"},{"location":"eoepca/ades-zoo/#persistence","text":"Various of the services deployed as part of zoo-project-dru rely upon dynamic provisioning of persistent storage volumes. A number of helm values are impacted by this setting, which must be configured with the Storage Class appropriate to your cluster. For example, using the minikube standard storage class\u2026 workflow : storageClass : standard persistence : procServicesStorageClass : standard storageClass : standard tmpStorageClass : standard postgresql : primary : persistence : storageClass : standard readReplicas : persistence : storageClass : standard rabbitmq : persistence : storageClass : standard","title":"Persistence"},{"location":"eoepca/ades-zoo/#built-in-iam","text":"ZOO-Project DRU has a built-in capability for Identity & Access Management (IAM), in which the zoo-project-dru service is configured as an OIDC client of an OIDC Identity Provider service. This capability is disabled by the default deployment offered by this guide ( ingress.enabled: false ) - which instead (optionally) applies resource protection using the EOEPCA IAM solution. Nevertheless, the built-in IAM can be enabled and configured through helm values. For example\u2026 iam : enabled : true openIdConnectUrl : https://keycloak.192-168-49-2.nip.io/realms/master/.well-known/openid-configuration type : openIdConnect name : OpenIDAuth realm : Secured section","title":"Built-in IAM"},{"location":"eoepca/ades-zoo/#protection","text":"As described in section Resource Protection (Keycloak) , the identity-gatekeeper component can be inserted into the request path of the zoo-project-dru service to provide access authorization decisions","title":"Protection"},{"location":"eoepca/ades-zoo/#gatekeeper","text":"Gatekeeper is deployed using its helm chart\u2026 helm install zoo-project-dru-protection identity-gatekeeper -f zoo-protection-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ --namespace \"zoo\" --create-namespace \\ --version 1 .0.11 The identity-gatekeeper must be configured with the values applicable to the zoo-project-dru - in particular the specific ingress requirements for the zoo-project-dru-service \u2026 Example zoo-protection-values.yaml \u2026 fullnameOverride : zoo-project-dru-protection config : client-id : ades discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io targetService : host : zoo.192-168-49-2.nip.io name : zoo-project-dru-service port : number : 80 secrets : # Values for secret 'zoo-project-dru-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production serverSnippets : custom : |- # Open access to some endpoints, including Swagger UI location ~ /(ogc-api/api|swagger-ui) { proxy_pass {{ include \"identity-gatekeeper.targetUrl\" . }}$request_uri; }","title":"Gatekeeper"},{"location":"eoepca/ades-zoo/#keycloak-client","text":"The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. client-id: ades above. This can be created with the create-client helper script, as descirbed in section Client Registration . For example, with path protection for test users\u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = ades \\ --name = \"ADES Gatekeeper\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by ADES Gatekeeper\" \\ --resource = \"eric\" --uris = '/eric/*' --scopes = view --users = \"eric\" \\ --resource = \"bob\" --uris = '/bob/*' --scopes = view --users = \"bob\" \\ --resource = \"alice\" --uris = '/alice/*' --scopes = view --users = \"alice\"","title":"Keycloak Client"},{"location":"eoepca/ades-zoo/#service-urls","text":"The zoo-project-dru service provides a mutil-user aware set of service interfaces at\u2026 OGC API Processes: https://zoo.192-168-49-2.nip.io/<username>/ogc-api/ Swagger UI: https://zoo.192-168-49-2.nip.io/swagger-ui/oapip/","title":"Service URLs"},{"location":"eoepca/ades-zoo/#usage-samples","text":"See the Example Requests in the Processing Deployment for sample requests that cans be used to test your deployment, and to learn usage of the OGC API Processes.","title":"Usage Samples"},{"location":"eoepca/ades-zoo/#debugging-tips","text":"This section includes some tips that may be useful in debugging errors with deployed application packages. For debugging, establish a shell session with the zoofpm pod\u2026 $ kubectl -n zoo exec -it deploy/zoo-project-dru-zoofpm -c zoofpm -- bash","title":"Debugging Tips"},{"location":"eoepca/ades-zoo/#execution-logs","text":"The logs are in the directory /tmp/zTmp \u2026 $ cd /tmp/zTmp/ In the log directory, each execution is characterised by a set of files/directories\u2026 <appname>_<jobid>_error.log <<START HERE The main log output of the job <appname>_<jobid>.json The output (results) of the job <jobid>_status.json The overall status of the job <jobid>_logs.cfg Index of logs for job workflow steps convert-url-c6637d4a-d561-11ee-bf3b-0242ac11000e (directory) Subdirectory with a dedicated log file for each step of the CWL workflow, including the stage-in and stage-out steps","title":"Execution Logs"},{"location":"eoepca/ades-zoo/#deployed-process-executables","text":"When the process is deployed from its Application Package, then a representation is created using the configured cookiecutter.templateUrl . It may be useful to debug the consequent process files, which are located under the path /opt/zooservices_user/<username> , with a dedicated subdirectory for each deployed process - i.e. /opt/zooservices_user/<username>/<appname>/ . For example\u2026 $ cd /opt/zooservices_user/eric/convert-url $ ls -l total 28 -rw-rw-r-- 1 www-data www-data 0 Feb 27 11 :17 __init__.py drwxrwxr-x 2 www-data www-data 4096 Feb 27 11 :17 __pycache__ -rw-rw-r-- 1 www-data www-data 1408 Feb 27 11 :17 app-package.cwl -rw-rw-r-- 1 www-data www-data 17840 Feb 27 11 :17 service.py Note In the case that the cookie-cutter template is updated, then the process can be re-deployed to force a refresh against the updated template.","title":"Deployed Process 'Executables'"},{"location":"eoepca/ades-zoo/#swagger-ui-openapi","text":"The zoo-project-dru service includes a Swagger UI interactive representation of its OpenAPI REST interface - available at the URL https://zoo.192-168-49-2.nip.io/swagger-ui/oapip/ .","title":"Swagger UI (OpenAPI)"},{"location":"eoepca/ades-zoo/#application-package-example","text":"For a (trivial) example application package see Example Application Package , which provides a description and illustration of the basics of creating an application that integrates with the expectations of the ADES stage-in and stage-out. For further reference see\u2026 Application Packages OGC Best Practise for Application Package Example Application Package Common Workflow Language (CWL) Guide for CWL in Earth Observation CWL Specification CWL User Guide","title":"Application Package Example"},{"location":"eoepca/ades-zoo/#additional-information","text":"Additional information regarding the ADES can be found at: ZOO-Project DRU\u2026 Helm Chart Documentation Git Repositories\u2026 ZOO-Project Core OGC API Processes capability eoepca-proc-service-template Cookie-cutter template for Application Package execution in Kubernetes zoo-calrissian-runner Python library used by the eoepca-proc-service-template to aid orchestration of CWL application packages running in Kubernetes via Calrissian pycalrissian Python library used by zoo-calrissian-runner to aid interfacing with Calrissian and Kubernetes","title":"Additional Information"},{"location":"eoepca/application-hub/","text":"Application Hub \u2693\ufe0e The Application Hub provides a set of web-based tooling, including JupyterLab for interactive analysis, Code Server for application development, and the capability to add user-defined interactive dashboards. Helm Chart \u2693\ufe0e The Application Hub is deployed via the application-hub helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values, which are detailed in the default values file for the chart . helm install --version 2 .0.55 --values application-hub-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ application-hub application-hub Values \u2693\ufe0e The Application Hub supports many values to configure the service - ref. the default values file for the chart . Typically, values for the following attributes may be specified: The fully-qualified public URL for the service Specification of Ingress for reverse-proxy access to the service Storage class for persistence Node selector rule - required by JupyterHub to spawn container workloads Values for integration with the user workspace Integration of JupyterHub with the Login Service (identity provider) via OpenID Connect configuration OIDC client credentials from a secret Example application-hub-values.yaml \u2026 ingress : enabled : true annotations : {} hosts : - host : applicationhub.192-168-49-2.nip.io paths : - path : / pathType : ImplementationSpecific tls : - secretName : applicationhub-tls hosts : - applicationhub.192-168-49-2.nip.io clusterIssuer : letsencrypt-production jupyterhub : fullnameOverride : \"application-hub\" hub : existingSecret : application-hub-secrets extraEnv : JUPYTERHUB_ENV : \"dev\" JUPYTERHUB_SINGLE_USER_IMAGE : \"eoepca/pde-container:1.0.3\" OAUTH_CALLBACK_URL : https://applicationhub.192-168-49-2.nip.io/hub/oauth_callback OAUTH2_USERDATA_URL : https://keycloak.192-168-49-2.nip.io/oxauth/restv1/userinfo OAUTH2_TOKEN_URL : https://keycloak.192-168-49-2.nip.io/oxauth/restv1/token OAUTH2_AUTHORIZE_URL : https://keycloak.192-168-49-2.nip.io/oxauth/restv1/authorize OAUTH_LOGOUT_REDIRECT_URL : \"https://applicationhub.192-168-49-2.nip.io\" OAUTH2_USERNAME_KEY : \"preferred_username\" STORAGE_CLASS : \"standard\" RESOURCE_MANAGER_WORKSPACE_PREFIX : \"ws\" JUPYTERHUB_CRYPT_KEY : valueFrom : secretKeyRef : name : application-hub-secrets key : JUPYTERHUB_CRYPT_KEY OAUTH_CLIENT_ID : valueFrom : secretKeyRef : name : application-hub-secrets key : OAUTH_CLIENT_ID OAUTH_CLIENT_SECRET : valueFrom : secretKeyRef : name : application-hub-secrets key : OAUTH_CLIENT_SECRET image : # name: eoepca/application-hub # tag: \"1.2.0\" pullPolicy : Always # pullSecrets: [] db : pvc : storageClassName : standard singleuser : image : name : jupyter/minimal-notebook tag : \"2343e33dec46\" profileList : - display_name : \"Minimal environment\" description : \"To avoid too much bells and whistles: Python.\" default : \"True\" - display_name : \"EOEPCA profile\" description : \"Sample profile\" kubespawner_override : cpu_limit\" : 4 mem_limit\" : \"8G\" nodeSelector : key : minikube.k8s.io/primary value : \\\"true\\\" Client and Credentials \u2693\ufe0e The Application Hub requires an OIDC client to be registered with the Identity Service (Keycloak) in order to enable user identity integration - ref. OAUTH_CLIENT_ID and OAUTH_CLIENT_SECRET . This can be created with the create-client helper script, as descirbed in section Client Registration . For example\u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = application-hub \\ --name = \"Application Hub OIDC Client\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by Application Hub for OIDC integration\" Corresponding to this client, a secret application-hub-secrets must be created (ref. value jupyterhub.hub.existingSecret: application-hub-secrets )\u2026 kubectl -n proc create secret generic application-hub-secrets \\ --from-literal = JUPYTERHUB_CRYPT_KEY = \" $( openssl rand -hex 32 ) \" \\ --from-literal = OAUTH_CLIENT_ID = \"application-hub\" \\ --from-literal = OAUTH_CLIENT_SECRET = \"changeme\" Post-deployment Manual Steps \u2693\ufe0e The deployment of the Application Hub has been designed, as far as possible, to automate the configuration. However, there remain some steps that must be performed manually after the scripted deployment has completed\u2026 Configure Groups and Users Groups and Users \u2693\ufe0e The default helm chart has some built-in application launchers whose assignments to example users (eric and bob) assume the existence of some JupyterHub groups - which must be replicated to exploit this configuration. In a browser, navigate to the Application Hub - https://applicationhub.192-168-49-2.nip.io/ Login as the user eric (or bob) for admin access Select the Admin menu (top of page) Add groups group-1 , group-2 , group-3 to ApplicationHub, and add users eric , bob to these groups This setup corresponds to the \u2018sample\u2019 configuration that is built=in to the help chart - see file config.yaml . Additional Information \u2693\ufe0e Additional information regarding the Application Hub can be found at: Helm Chart","title":"Application Hub"},{"location":"eoepca/application-hub/#application-hub","text":"The Application Hub provides a set of web-based tooling, including JupyterLab for interactive analysis, Code Server for application development, and the capability to add user-defined interactive dashboards.","title":"Application Hub"},{"location":"eoepca/application-hub/#helm-chart","text":"The Application Hub is deployed via the application-hub helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values, which are detailed in the default values file for the chart . helm install --version 2 .0.55 --values application-hub-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ application-hub application-hub","title":"Helm Chart"},{"location":"eoepca/application-hub/#values","text":"The Application Hub supports many values to configure the service - ref. the default values file for the chart . Typically, values for the following attributes may be specified: The fully-qualified public URL for the service Specification of Ingress for reverse-proxy access to the service Storage class for persistence Node selector rule - required by JupyterHub to spawn container workloads Values for integration with the user workspace Integration of JupyterHub with the Login Service (identity provider) via OpenID Connect configuration OIDC client credentials from a secret Example application-hub-values.yaml \u2026 ingress : enabled : true annotations : {} hosts : - host : applicationhub.192-168-49-2.nip.io paths : - path : / pathType : ImplementationSpecific tls : - secretName : applicationhub-tls hosts : - applicationhub.192-168-49-2.nip.io clusterIssuer : letsencrypt-production jupyterhub : fullnameOverride : \"application-hub\" hub : existingSecret : application-hub-secrets extraEnv : JUPYTERHUB_ENV : \"dev\" JUPYTERHUB_SINGLE_USER_IMAGE : \"eoepca/pde-container:1.0.3\" OAUTH_CALLBACK_URL : https://applicationhub.192-168-49-2.nip.io/hub/oauth_callback OAUTH2_USERDATA_URL : https://keycloak.192-168-49-2.nip.io/oxauth/restv1/userinfo OAUTH2_TOKEN_URL : https://keycloak.192-168-49-2.nip.io/oxauth/restv1/token OAUTH2_AUTHORIZE_URL : https://keycloak.192-168-49-2.nip.io/oxauth/restv1/authorize OAUTH_LOGOUT_REDIRECT_URL : \"https://applicationhub.192-168-49-2.nip.io\" OAUTH2_USERNAME_KEY : \"preferred_username\" STORAGE_CLASS : \"standard\" RESOURCE_MANAGER_WORKSPACE_PREFIX : \"ws\" JUPYTERHUB_CRYPT_KEY : valueFrom : secretKeyRef : name : application-hub-secrets key : JUPYTERHUB_CRYPT_KEY OAUTH_CLIENT_ID : valueFrom : secretKeyRef : name : application-hub-secrets key : OAUTH_CLIENT_ID OAUTH_CLIENT_SECRET : valueFrom : secretKeyRef : name : application-hub-secrets key : OAUTH_CLIENT_SECRET image : # name: eoepca/application-hub # tag: \"1.2.0\" pullPolicy : Always # pullSecrets: [] db : pvc : storageClassName : standard singleuser : image : name : jupyter/minimal-notebook tag : \"2343e33dec46\" profileList : - display_name : \"Minimal environment\" description : \"To avoid too much bells and whistles: Python.\" default : \"True\" - display_name : \"EOEPCA profile\" description : \"Sample profile\" kubespawner_override : cpu_limit\" : 4 mem_limit\" : \"8G\" nodeSelector : key : minikube.k8s.io/primary value : \\\"true\\\"","title":"Values"},{"location":"eoepca/application-hub/#client-and-credentials","text":"The Application Hub requires an OIDC client to be registered with the Identity Service (Keycloak) in order to enable user identity integration - ref. OAUTH_CLIENT_ID and OAUTH_CLIENT_SECRET . This can be created with the create-client helper script, as descirbed in section Client Registration . For example\u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = application-hub \\ --name = \"Application Hub OIDC Client\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by Application Hub for OIDC integration\" Corresponding to this client, a secret application-hub-secrets must be created (ref. value jupyterhub.hub.existingSecret: application-hub-secrets )\u2026 kubectl -n proc create secret generic application-hub-secrets \\ --from-literal = JUPYTERHUB_CRYPT_KEY = \" $( openssl rand -hex 32 ) \" \\ --from-literal = OAUTH_CLIENT_ID = \"application-hub\" \\ --from-literal = OAUTH_CLIENT_SECRET = \"changeme\"","title":"Client and Credentials"},{"location":"eoepca/application-hub/#post-deployment-manual-steps","text":"The deployment of the Application Hub has been designed, as far as possible, to automate the configuration. However, there remain some steps that must be performed manually after the scripted deployment has completed\u2026 Configure Groups and Users","title":"Post-deployment Manual Steps"},{"location":"eoepca/application-hub/#groups-and-users","text":"The default helm chart has some built-in application launchers whose assignments to example users (eric and bob) assume the existence of some JupyterHub groups - which must be replicated to exploit this configuration. In a browser, navigate to the Application Hub - https://applicationhub.192-168-49-2.nip.io/ Login as the user eric (or bob) for admin access Select the Admin menu (top of page) Add groups group-1 , group-2 , group-3 to ApplicationHub, and add users eric , bob to these groups This setup corresponds to the \u2018sample\u2019 configuration that is built=in to the help chart - see file config.yaml .","title":"Groups and Users"},{"location":"eoepca/application-hub/#additional-information","text":"Additional information regarding the Application Hub can be found at: Helm Chart","title":"Additional Information"},{"location":"eoepca/container-registry/","text":"Container Registry \u2693\ufe0e To support the development (ref. Application Hub ) and deployment/execution (ref. ADES ) of user-defined applications, we deploy a container registry to host container images. This is provied by a deployment of the Harbor artefact repository . Helm Chart \u2693\ufe0e Harbor is deployed via the harbor helm chart from the Harbor Helm Chart Repository . helm install --version 1 .7.3 --values harbor-values.yaml \\ --repo https://helm.goharbor.io \\ harbor harbor Values \u2693\ufe0e The chart is configured via values that are fully documented on the Harbor website . Example\u2026 expose : ingress : annotations : kubernetes.io/ingress.class : nginx cert-manager.io/cluster-issuer : letsencrypt-production nginx.ingress.kubernetes.io/proxy-read-timeout : '600' # from chart: ingress.kubernetes.io/ssl-redirect : letsencrypt-production ingress.kubernetes.io/proxy-body-size : \"0\" nginx.ingress.kubernetes.io/ssl-redirect : letsencrypt-production nginx.ingress.kubernetes.io/proxy-body-size : \"0\" hosts : core : harbor.192-168-49-2.nip.io tls : enabled : \"true\" certSource : secret secret : secretName : \"harbor-tls\" persistence : persistentVolumeClaim : registry : storageClass : standard chartmuseum : storageClass : standard jobservice : storageClass : standard database : storageClass : standard redis : storageClass : standard trivy : storageClass : standard externalURL : https://harbor.192-168-49-2.nip.io # initial password for logging in with user \"admin\" harborAdminPassword : \"changeme\" chartmuseum : enabled : false trivy : enabled : false notary : enabled : false Note We specify use of \u2018valid\u2019 certificates from Letsencrypt \u2018production\u2019. The Workspace API, which calls the Harbor API, expects valid certificates and will thus fail if presented with TLS certificates that fail validation. The letsencrypt-production Cluster Issuer relies upon the deployment being accessible from the public internet via the expose.ingress.hosts.core DNS name. If this is not the case, e.g. for a local minikube deployment in which this is unlikely to be so. In this case the TLS will fall-back to the self-signed certificate built-in to the nginx ingress controller. The Workspace API will not like this. Container Registry Usage \u2693\ufe0e After deployemnt Harbor is accessible via its web interface at https://harbor.192-168-49-2.nip.io/ e.g. https://harbor.192-168-49-2.nip.io/ . Login as the admin user with the password specified in the helm values. Additional Information \u2693\ufe0e Additional information regarding the Container Registry can be found at: Web Site Helm Chart Repository Helm Chart Description Harbor Documentation","title":"Container Registry"},{"location":"eoepca/container-registry/#container-registry","text":"To support the development (ref. Application Hub ) and deployment/execution (ref. ADES ) of user-defined applications, we deploy a container registry to host container images. This is provied by a deployment of the Harbor artefact repository .","title":"Container Registry"},{"location":"eoepca/container-registry/#helm-chart","text":"Harbor is deployed via the harbor helm chart from the Harbor Helm Chart Repository . helm install --version 1 .7.3 --values harbor-values.yaml \\ --repo https://helm.goharbor.io \\ harbor harbor","title":"Helm Chart"},{"location":"eoepca/container-registry/#values","text":"The chart is configured via values that are fully documented on the Harbor website . Example\u2026 expose : ingress : annotations : kubernetes.io/ingress.class : nginx cert-manager.io/cluster-issuer : letsencrypt-production nginx.ingress.kubernetes.io/proxy-read-timeout : '600' # from chart: ingress.kubernetes.io/ssl-redirect : letsencrypt-production ingress.kubernetes.io/proxy-body-size : \"0\" nginx.ingress.kubernetes.io/ssl-redirect : letsencrypt-production nginx.ingress.kubernetes.io/proxy-body-size : \"0\" hosts : core : harbor.192-168-49-2.nip.io tls : enabled : \"true\" certSource : secret secret : secretName : \"harbor-tls\" persistence : persistentVolumeClaim : registry : storageClass : standard chartmuseum : storageClass : standard jobservice : storageClass : standard database : storageClass : standard redis : storageClass : standard trivy : storageClass : standard externalURL : https://harbor.192-168-49-2.nip.io # initial password for logging in with user \"admin\" harborAdminPassword : \"changeme\" chartmuseum : enabled : false trivy : enabled : false notary : enabled : false Note We specify use of \u2018valid\u2019 certificates from Letsencrypt \u2018production\u2019. The Workspace API, which calls the Harbor API, expects valid certificates and will thus fail if presented with TLS certificates that fail validation. The letsencrypt-production Cluster Issuer relies upon the deployment being accessible from the public internet via the expose.ingress.hosts.core DNS name. If this is not the case, e.g. for a local minikube deployment in which this is unlikely to be so. In this case the TLS will fall-back to the self-signed certificate built-in to the nginx ingress controller. The Workspace API will not like this.","title":"Values"},{"location":"eoepca/container-registry/#container-registry-usage","text":"After deployemnt Harbor is accessible via its web interface at https://harbor.192-168-49-2.nip.io/ e.g. https://harbor.192-168-49-2.nip.io/ . Login as the admin user with the password specified in the helm values.","title":"Container Registry Usage"},{"location":"eoepca/container-registry/#additional-information","text":"Additional information regarding the Container Registry can be found at: Web Site Helm Chart Repository Helm Chart Description Harbor Documentation","title":"Additional Information"},{"location":"eoepca/data-access/","text":"Data Access \u2693\ufe0e The Data Access provides standards-based services for access to platform hosted data - including OGC WMS/WMTS for visualisation, and OGC WCS for data retrieval. This component also includes Harvester and Registrar services to discover/watch the existing data holding of the infrastructure data layer and populate/maintain the data access and resource catalogue services accordingly. Helm Chart \u2693\ufe0e The Data Access is deployed via the data-access helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are supplied with the instantiation of the helm release. The EOEPCA data-access chart provides a thin wrapper around the EOX View Server ( vs ) helm chart. The documentation for the View Server can be found here: User Guide: https://vs.pages.eox.at/documentation/user/main/ Operator Guide: https://vs.pages.eox.at/documentation/operator/main/ helm install --version 1 .4.0 --values data-access-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ data-access data-access Values \u2693\ufe0e The Data Access supports many values to configure the service. These are documented in full in the View Server - Operator Guide Configuration page . Core Configuration \u2693\ufe0e Typically, values for the following attributes may be specified to override the chart defaults: The fully-qualified public URL for the service, ref. ( global.ingress.hosts.host[0] ) Metadata describing the service instance Dynamic provisioning StorageClass for persistence Persistent Volume Claims for database and redis components Object storage details for data and cache Container images for renderer and registrar (optional) Specification of Ingress for reverse-proxy access to the service Note that this is only required in the case that the Data Access will not be protected by the identity-gatekeeper component - ref. Resource Protection . Otherwise the ingress will be handled by the identity-gatekeeper - use ingress.enabled: false . global : env : REGISTRAR_REPLACE : \"true\" CPL_VSIL_CURL_ALLOWED_EXTENSIONS : .TIF,.tif,.xml,.jp2,.jpg,.jpeg AWS_ENDPOINT_URL_S3 : https://minio.192-168-49-2.nip.io AWS_HTTPS : \"FALSE\" startup_scripts : - /registrar_pycsw/registrar_pycsw/initialize-collections.sh ingress : enabled : true annotations : kubernetes.io/ingress.class : nginx kubernetes.io/tls-acme : \"true\" nginx.ingress.kubernetes.io/proxy-read-timeout : \"600\" nginx.ingress.kubernetes.io/enable-cors : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production hosts : - host : data-access.192-168-49-2.nip.io tls : - hosts : - data-access.192-168-49-2.nip.io secretName : data-access-tls storage : data : data : type : S3 endpoint_url : http://data.cloudferro.com access_key_id : access secret_access_key : access region_name : RegionOne validate_bucket_name : false cache : type : S3 endpoint_url : \"https://minio.192-168-49-2.nip.io\" host : \"minio.192-168-49-2.nip.io\" access_key_id : xxx secret_access_key : xxx region : us-east-1 bucket : cache-bucket metadata : title : EOEPCA Data Access Service developed by EOX abstract : EOEPCA Data Access Service developed by EOX header : \"EOEPCA Data Access View Server (VS) Client powered by <a href=\\\"//eox.at\\\"><img src=\\\"//eox.at/wp-content/uploads/2017/09/EOX_Logo.svg\\\" alt=\\\"EOX\\\" style=\\\"height:25px;margin-left:10px\\\"/></a>\" url : https://data-access.192-168-49-2.nip.io/ows layers : # see section 'Data-layer Configuration' collections : # see section 'Data-layer Configuration' productTypes : # see section 'Data-layer Configuration' vs : renderer : replicaCount : 4 ingress : enabled : false resources : requests : cpu : 100m memory : 300Mi limits : cpu : 1.5 memory : 3Gi registrar : replicaCount : 1 config : # see section 'Registrar Routes Configuration' resources : requests : cpu : 100m memory : 100Mi harvester : # see section 'Harvester Configuration' replicaCount : 1 resources : requests : cpu : 100m memory : 100Mi client : replicaCount : 1 ingress : enabled : false redis : master : persistence : enabled : true storageClass : standard ingestor : replicaCount : 0 ingress : enabled : false preprocessor : replicaCount : 0 cache : ingress : enabled : false scheduler : resources : requests : cpu : 100m memory : 100Mi Note The resources: above have been limited for the benefit of a minikube deployment. For a production deployment the values should be tuned (upwards) according to operational needs. Registrar Routes Configuration \u2693\ufe0e The Data Access registrar component supports a number of different resource types. For each a dedicated \u2018backend\u2019 is configured to handle the specific registration of the resource type\u2026 vs: registrar: config: #-------------- # Default route #-------------- disableDefaultRoute: false # Additional backends for the default route defaultBackends: - path: registrar_pycsw.backend.ItemBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw ows_url: https://data-access.192-168-49-2.nip.io/ows defaultSuccessQueue: seed_queue #---------------- # Specific routes #---------------- routes: collections: path: registrar.route.stac.CollectionRoute queue: register_collection_queue replace: true backends: - path: registrar_pycsw.backend.CollectionBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw ades: path: registrar.route.json.JSONRoute queue: register_ades_queue replace: true backends: - path: registrar_pycsw.backend.ADESBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw application: path: registrar.route.json.JSONRoute queue: register_application_queue replace: true backends: - path: registrar_pycsw.backend.CWLBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw catalogue: path: registrar.route.json.JSONRoute queue: register_catalogue_queue replace: true backends: - path: registrar_pycsw.backend.CatalogueBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw json: path: registrar.route.json.JSONRoute queue: register_json_queue replace: true backends: - path: registrar_pycsw.backend.JSONBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw xml: path: registrar.route.json.JSONRoute queue: register_xml_queue replace: true backends: - path: registrar_pycsw.backend.XMLBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw Data-layer Configuration \u2693\ufe0e Configuration of the service data-layer - as described in the View Server Operator Guide . The data-access service data handling is configured by definition of productTypes , collections and layers \u2026 productTypes - Product Types Identify the underlying file assets as WCS coverages and their visual representation collections - Data Collections Provides groupings into which products are organised layers - Layers Specifies the hoe the product visual representations are exposed through the WMS service For more information, see the worked example in section Data Specification for the example CREODIAS deployment . Harvester \u2693\ufe0e The Data Access service includes a Harvester component. The following subsections describe its configuration and usage. Harvester Helm Configuration \u2693\ufe0e The Harvester can be configured through the helm chart values\u2026 vs : harvester : replicaCount : 1 config : redis : host : data-access-redis-master port : 6379 harvesters : - name : Creodias-Opensearch resource : url : https://datahub.creodias.eu/resto/api/collections/Sentinel2/describe.xml type : OpenSearch format_config : type : 'application/json' property_mapping : start_datetime : 'startDate' end_datetime : 'completionDate' productIdentifier : 'productIdentifier' query : time : property : sensed begin : 2019-09-10T00:00:00Z end : 2019-09-11T00:00:00Z collection : null bbox : 14.9,47.7,16.4,48.7 filter : {} postprocess : - type : harvester_eoepca.postprocess.CREODIASOpenSearchSentinel2Postprocessor queue : register - name : Creodias-Opensearch-Sentinel1 resource : url : https://datahub.creodias.eu/resto/api/collections/Sentinel1/describe.xml type : OpenSearch format_config : type : 'application/json' property_mapping : start_datetime : 'startDate' end_datetime : 'completionDate' productIdentifier : 'productIdentifier' query : time : property : sensed begin : 2019-09-10T00:00:00Z end : 2019-09-11T00:00:00Z collection : null bbox : 14.9,47.7,16.4,48.7 extra_params : productType : GRD-COG filter : {} postprocess : - type : harvester_eoepca.postprocess.CREODIASOpenSearchSentinel1Postprocessor queue : register The harvester.config.harvesters list defines a set of pre-defined harvesters which can be invoked in a later stage. The name property must be unique for each harvester and must be unique among all harvesters in the list. Each harvester is associated with a resource , an optional filter or postprocess function, and a queue . The resource defines where each item is harvested from. This can be a file system, a search service, catalog file or something similar. The example above defines a connection to an OpenSearch service on CREODIAS, with associated default query parameters and a format configuration. The filter allows to filter elements within the harvester, when the resource does not provide a specific filter. This filter can be supplied using CQL2-JSON. The postprocess can adjust the harvested results. In this example the harvested items are not complete, and additional metadata must be retrieved from an object storage. The queue defines where harvested items will be pushed into. Usually this is a registration queue, where the registrar will pick up and start registration according to its configuration. Starting the Harvester \u2693\ufe0e The harvester can either do one-off harvests via the CLI or listen on a redis queue to run consecutive harvests whenever a harvesting request is received on that queue. One-off harvests via the CLI \u2693\ufe0e In order to start a harvest from the CLI, the operator first needs to connect to the kubernetes pod of the harvester. Within that pod, the harvest can be executed like this\u2026 python3 -m harvester harvest --config-file /config-run.yaml --host data-access-redis-master --port 6379 Creodias-Opensearch This will invoke the Creodias-Opensearch harvester with default arguments. When some values are to be overridden, the \u2013values switch can be used to pass override values. These values must be a JSON string. The following example adjusts the begin and end times of the query parameters\u2026 python3 -m harvester harvest --config-file /config-run.yaml --host data-access-redis-master --port 6379 Creodias-Opensearch --values '{\"resource\": {\"query\": {\"time\": {\"begin\": \"2020-09-10T00:00:00Z\", \"end\": \"2020-09-11T00:00:00Z\"}}}}' Harvests via the harvest daemon \u2693\ufe0e The harvester pod runs a service listening on a redis queue. When a message is read from the queue, it will be read as a JSON string, expecting an object with at least a name property. Optionally, it can also have a values property, working in the same way as with CLI --values . To send a harvesting request via the redis queue, it is necessary to connect to the redis pod and execute the redis-cli there. Then the following command can be used to achieve the same result as above with CLI harvesting\u2026 redis-cli LPUSH '{\"name\": \"Creodias-Opensearch\", \"values\": {\"resource\": {\"query\": {\"time\": {\"begin\": \"2020-09-10T00:00:00Z\", \"end\": \"2020-09-11T00:00:00Z\"}}}}}' Results of the harvesting \u2693\ufe0e The harvester produces a continous stream of STAC Items which are sent down via the configured queue. It is possible that the harvested metadata is not sufficient to create a fully functional STAC Item. In this case the postprocess must transform this intermediate item to a valid STAC Item. In our example, the postprocessor looks up the Sentinel-2 product file referenced by the product identifier which is then accessed on the object storage. From the stored metadata files, the STAC Items to be sent is created. Storage \u2693\ufe0e Specification of PVCs and access to object storage. Persistent Volume Claims \u2693\ufe0e The PVCs specified in the helm chart values must be created. PVC for Database \u2693\ufe0e kind : PersistentVolumeClaim apiVersion : v1 metadata : name : data-access-db namespace : rm labels : k8s-app : data-access name : data-access spec : storageClassName : standard accessModes : - ReadWriteMany resources : requests : storage : 100Gi PVC for Redis \u2693\ufe0e kind : PersistentVolumeClaim apiVersion : v1 metadata : name : data-access-redis namespace : rm labels : k8s-app : data-access name : data-access spec : storageClassName : standard accessModes : - ReadWriteMany resources : requests : storage : 1Gi Object Storage \u2693\ufe0e The helm chart values expect specification of object storage details for: data : to access the EO data of the underlying infrastructure cache : a dedicated object storage bucket is used to support the cache function of the data access services Platform EO Data \u2693\ufe0e Specifies the details for the infrastructure object storage that provides direct access to the EO product files. For example, the CREODIAS metadata catalogue provides references to product files in their eodata object storage - the access details for which are configured in the data access services: global : storage : data : data : type : S3 endpoint_url : http://data.cloudferro.com access_key_id : access secret_access_key : access region_name : RegionOne validate_bucket_name : false Data Access Cache \u2693\ufe0e The Data Access services maintain a cache, which relies on the usage of a dedicate object storage bucket for data persistence. This bucket must be created (manual step) and its access details configured in the data access services. Example based upon CREODIAS: global : storage : cache : type : S3 endpoint_url : \"https://cf2.cloudferro.com:8080/cache-bucket\" host : \"cf2.cloudferro.com:8080\" access_key_id : xxx secret_access_key : xxx region : RegionOne bucket : cache-bucket \u2026where xxx must be replaced with the bucket credentials. Protection \u2693\ufe0e As described in section Resource Protection (Keycloak) , the identity-gatekeeper component can be inserted into the request path of the data-access service to provide access authorization decisions Gatekeeper \u2693\ufe0e Gatekeeper is deployed using its helm chart\u2026 helm install data-access-protection identity-gatekeeper -f data-access-protection-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ --namespace \"rm\" --create-namespace \\ --version 1 .0.11 The identity-gatekeeper must be configured with the values applicable to the data-access - in particular the specific ingress requirements for the data-access backend services\u2026 Example data-access-protection-values.yaml \u2026 fullnameOverride : data-access-protection config : client-id : data-access discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io targetService : host : data-access.192-168-49-2.nip.io name : data-access-renderer port : number : 80 secrets : # Values for secret 'data-access-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production nginx.ingress.kubernetes.io/proxy-read-timeout : \"600\" nginx.ingress.kubernetes.io/enable-cors : \"true\" nginx.ingress.kubernetes.io/rewrite-target : /$1 serverSnippets : custom : |- # Open access to renderer... location ~ ^/(ows.*|opensearch.*|coverages/metadata.*|admin.*) { proxy_pass http://data-access-renderer.rm.svc.cluster.local:80/$1; } # Open access to cache... location ~ ^/cache/(.*) { proxy_pass http://data-access-cache.rm.svc.cluster.local:80/$1; } # Open access to client... # Note that we use a negative lookahead to avoid matching '/.well-known/*' which # otherwise appears to interfere with the work of cert-manager/letsencrypt. location ~ ^/(?!\\.well-known)(.*) { proxy_pass http://data-access-client.rm.svc.cluster.local:80/$1; } Keycloak Client \u2693\ufe0e The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. client-id: data-access above. This can be created with the create-client helper script, as descirbed in section Client Registration . For example\u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = data-access \\ --name = \"Data Access Gatekeeper\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by Data Access Gatekeeper\" Data Access Usage \u2693\ufe0e Default Harvesting \u2693\ufe0e At deployment time the harvester helm values include configuration that populates a default harvester configuration, that is prepared in the file /config.yaml in the harvester pod. The Data Access and Resource Catalogue services are configured to properly interpret harvested data via these values specified in the instantiation of the helm release. See section Data-layer Configuration . The harvesting of data can be triggered (post deployment), in accordance with this default configuration, by connecting to the rm/harvester service and executing the command\u2026 python3 -m harvester harvest --config-file /config-run.yaml --host data-access-redis-master --port 6379 Creodias-Opensearch Ad-hoc Harvesting \u2693\ufe0e Ad-hoc harvesting can be invoked by provision of a suitable config.yaml into the harvester pod, which can then be invoked as shown above for the default harvester configuration established at deploy time. The helper script ./deploy/bin/harvest faciltates this\u2026 ./deploy/bin/harvest <path-to-config-file> See directory ./deploy/samples/harvester/ that contains some sample harvesting configuration files. For example\u2026 ./deploy/bin/harvest ./deploy/samples/harvester/config-Sentinel2-2019.09.10.yaml Registration of Collections \u2693\ufe0e The helper script ./deploy/bin/register-collection is provided to faciltate the registration of collections that are specfied in STAC Collection format. ./deploy/bin/register-collection <path-to-stac-collection-file> See directory ./deploy/samples/collections/ that contains some same STAC Collection files. For example\u2026 ./deploy/bin/register-collection ./deploy/samples/collections/S2MSI2A.json Additional Information \u2693\ufe0e Additional information regarding the Data Access can be found at: Helm Chart Documentation: User Guide Operator Guide Git Repository","title":"Data Access"},{"location":"eoepca/data-access/#data-access","text":"The Data Access provides standards-based services for access to platform hosted data - including OGC WMS/WMTS for visualisation, and OGC WCS for data retrieval. This component also includes Harvester and Registrar services to discover/watch the existing data holding of the infrastructure data layer and populate/maintain the data access and resource catalogue services accordingly.","title":"Data Access"},{"location":"eoepca/data-access/#helm-chart","text":"The Data Access is deployed via the data-access helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are supplied with the instantiation of the helm release. The EOEPCA data-access chart provides a thin wrapper around the EOX View Server ( vs ) helm chart. The documentation for the View Server can be found here: User Guide: https://vs.pages.eox.at/documentation/user/main/ Operator Guide: https://vs.pages.eox.at/documentation/operator/main/ helm install --version 1 .4.0 --values data-access-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ data-access data-access","title":"Helm Chart"},{"location":"eoepca/data-access/#values","text":"The Data Access supports many values to configure the service. These are documented in full in the View Server - Operator Guide Configuration page .","title":"Values"},{"location":"eoepca/data-access/#core-configuration","text":"Typically, values for the following attributes may be specified to override the chart defaults: The fully-qualified public URL for the service, ref. ( global.ingress.hosts.host[0] ) Metadata describing the service instance Dynamic provisioning StorageClass for persistence Persistent Volume Claims for database and redis components Object storage details for data and cache Container images for renderer and registrar (optional) Specification of Ingress for reverse-proxy access to the service Note that this is only required in the case that the Data Access will not be protected by the identity-gatekeeper component - ref. Resource Protection . Otherwise the ingress will be handled by the identity-gatekeeper - use ingress.enabled: false . global : env : REGISTRAR_REPLACE : \"true\" CPL_VSIL_CURL_ALLOWED_EXTENSIONS : .TIF,.tif,.xml,.jp2,.jpg,.jpeg AWS_ENDPOINT_URL_S3 : https://minio.192-168-49-2.nip.io AWS_HTTPS : \"FALSE\" startup_scripts : - /registrar_pycsw/registrar_pycsw/initialize-collections.sh ingress : enabled : true annotations : kubernetes.io/ingress.class : nginx kubernetes.io/tls-acme : \"true\" nginx.ingress.kubernetes.io/proxy-read-timeout : \"600\" nginx.ingress.kubernetes.io/enable-cors : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production hosts : - host : data-access.192-168-49-2.nip.io tls : - hosts : - data-access.192-168-49-2.nip.io secretName : data-access-tls storage : data : data : type : S3 endpoint_url : http://data.cloudferro.com access_key_id : access secret_access_key : access region_name : RegionOne validate_bucket_name : false cache : type : S3 endpoint_url : \"https://minio.192-168-49-2.nip.io\" host : \"minio.192-168-49-2.nip.io\" access_key_id : xxx secret_access_key : xxx region : us-east-1 bucket : cache-bucket metadata : title : EOEPCA Data Access Service developed by EOX abstract : EOEPCA Data Access Service developed by EOX header : \"EOEPCA Data Access View Server (VS) Client powered by <a href=\\\"//eox.at\\\"><img src=\\\"//eox.at/wp-content/uploads/2017/09/EOX_Logo.svg\\\" alt=\\\"EOX\\\" style=\\\"height:25px;margin-left:10px\\\"/></a>\" url : https://data-access.192-168-49-2.nip.io/ows layers : # see section 'Data-layer Configuration' collections : # see section 'Data-layer Configuration' productTypes : # see section 'Data-layer Configuration' vs : renderer : replicaCount : 4 ingress : enabled : false resources : requests : cpu : 100m memory : 300Mi limits : cpu : 1.5 memory : 3Gi registrar : replicaCount : 1 config : # see section 'Registrar Routes Configuration' resources : requests : cpu : 100m memory : 100Mi harvester : # see section 'Harvester Configuration' replicaCount : 1 resources : requests : cpu : 100m memory : 100Mi client : replicaCount : 1 ingress : enabled : false redis : master : persistence : enabled : true storageClass : standard ingestor : replicaCount : 0 ingress : enabled : false preprocessor : replicaCount : 0 cache : ingress : enabled : false scheduler : resources : requests : cpu : 100m memory : 100Mi Note The resources: above have been limited for the benefit of a minikube deployment. For a production deployment the values should be tuned (upwards) according to operational needs.","title":"Core Configuration"},{"location":"eoepca/data-access/#registrar-routes-configuration","text":"The Data Access registrar component supports a number of different resource types. For each a dedicated \u2018backend\u2019 is configured to handle the specific registration of the resource type\u2026 vs: registrar: config: #-------------- # Default route #-------------- disableDefaultRoute: false # Additional backends for the default route defaultBackends: - path: registrar_pycsw.backend.ItemBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw ows_url: https://data-access.192-168-49-2.nip.io/ows defaultSuccessQueue: seed_queue #---------------- # Specific routes #---------------- routes: collections: path: registrar.route.stac.CollectionRoute queue: register_collection_queue replace: true backends: - path: registrar_pycsw.backend.CollectionBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw ades: path: registrar.route.json.JSONRoute queue: register_ades_queue replace: true backends: - path: registrar_pycsw.backend.ADESBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw application: path: registrar.route.json.JSONRoute queue: register_application_queue replace: true backends: - path: registrar_pycsw.backend.CWLBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw catalogue: path: registrar.route.json.JSONRoute queue: register_catalogue_queue replace: true backends: - path: registrar_pycsw.backend.CatalogueBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw json: path: registrar.route.json.JSONRoute queue: register_json_queue replace: true backends: - path: registrar_pycsw.backend.JSONBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw xml: path: registrar.route.json.JSONRoute queue: register_xml_queue replace: true backends: - path: registrar_pycsw.backend.XMLBackend kwargs: repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw","title":"Registrar Routes Configuration"},{"location":"eoepca/data-access/#data-layer-configuration","text":"Configuration of the service data-layer - as described in the View Server Operator Guide . The data-access service data handling is configured by definition of productTypes , collections and layers \u2026 productTypes - Product Types Identify the underlying file assets as WCS coverages and their visual representation collections - Data Collections Provides groupings into which products are organised layers - Layers Specifies the hoe the product visual representations are exposed through the WMS service For more information, see the worked example in section Data Specification for the example CREODIAS deployment .","title":"Data-layer Configuration"},{"location":"eoepca/data-access/#harvester","text":"The Data Access service includes a Harvester component. The following subsections describe its configuration and usage.","title":"Harvester"},{"location":"eoepca/data-access/#harvester-helm-configuration","text":"The Harvester can be configured through the helm chart values\u2026 vs : harvester : replicaCount : 1 config : redis : host : data-access-redis-master port : 6379 harvesters : - name : Creodias-Opensearch resource : url : https://datahub.creodias.eu/resto/api/collections/Sentinel2/describe.xml type : OpenSearch format_config : type : 'application/json' property_mapping : start_datetime : 'startDate' end_datetime : 'completionDate' productIdentifier : 'productIdentifier' query : time : property : sensed begin : 2019-09-10T00:00:00Z end : 2019-09-11T00:00:00Z collection : null bbox : 14.9,47.7,16.4,48.7 filter : {} postprocess : - type : harvester_eoepca.postprocess.CREODIASOpenSearchSentinel2Postprocessor queue : register - name : Creodias-Opensearch-Sentinel1 resource : url : https://datahub.creodias.eu/resto/api/collections/Sentinel1/describe.xml type : OpenSearch format_config : type : 'application/json' property_mapping : start_datetime : 'startDate' end_datetime : 'completionDate' productIdentifier : 'productIdentifier' query : time : property : sensed begin : 2019-09-10T00:00:00Z end : 2019-09-11T00:00:00Z collection : null bbox : 14.9,47.7,16.4,48.7 extra_params : productType : GRD-COG filter : {} postprocess : - type : harvester_eoepca.postprocess.CREODIASOpenSearchSentinel1Postprocessor queue : register The harvester.config.harvesters list defines a set of pre-defined harvesters which can be invoked in a later stage. The name property must be unique for each harvester and must be unique among all harvesters in the list. Each harvester is associated with a resource , an optional filter or postprocess function, and a queue . The resource defines where each item is harvested from. This can be a file system, a search service, catalog file or something similar. The example above defines a connection to an OpenSearch service on CREODIAS, with associated default query parameters and a format configuration. The filter allows to filter elements within the harvester, when the resource does not provide a specific filter. This filter can be supplied using CQL2-JSON. The postprocess can adjust the harvested results. In this example the harvested items are not complete, and additional metadata must be retrieved from an object storage. The queue defines where harvested items will be pushed into. Usually this is a registration queue, where the registrar will pick up and start registration according to its configuration.","title":"Harvester Helm Configuration"},{"location":"eoepca/data-access/#starting-the-harvester","text":"The harvester can either do one-off harvests via the CLI or listen on a redis queue to run consecutive harvests whenever a harvesting request is received on that queue.","title":"Starting the Harvester"},{"location":"eoepca/data-access/#results-of-the-harvesting","text":"The harvester produces a continous stream of STAC Items which are sent down via the configured queue. It is possible that the harvested metadata is not sufficient to create a fully functional STAC Item. In this case the postprocess must transform this intermediate item to a valid STAC Item. In our example, the postprocessor looks up the Sentinel-2 product file referenced by the product identifier which is then accessed on the object storage. From the stored metadata files, the STAC Items to be sent is created.","title":"Results of the harvesting"},{"location":"eoepca/data-access/#storage","text":"Specification of PVCs and access to object storage.","title":"Storage"},{"location":"eoepca/data-access/#persistent-volume-claims","text":"The PVCs specified in the helm chart values must be created.","title":"Persistent Volume Claims"},{"location":"eoepca/data-access/#pvc-for-database","text":"kind : PersistentVolumeClaim apiVersion : v1 metadata : name : data-access-db namespace : rm labels : k8s-app : data-access name : data-access spec : storageClassName : standard accessModes : - ReadWriteMany resources : requests : storage : 100Gi","title":"PVC for Database"},{"location":"eoepca/data-access/#pvc-for-redis","text":"kind : PersistentVolumeClaim apiVersion : v1 metadata : name : data-access-redis namespace : rm labels : k8s-app : data-access name : data-access spec : storageClassName : standard accessModes : - ReadWriteMany resources : requests : storage : 1Gi","title":"PVC for Redis"},{"location":"eoepca/data-access/#object-storage","text":"The helm chart values expect specification of object storage details for: data : to access the EO data of the underlying infrastructure cache : a dedicated object storage bucket is used to support the cache function of the data access services","title":"Object Storage"},{"location":"eoepca/data-access/#platform-eo-data","text":"Specifies the details for the infrastructure object storage that provides direct access to the EO product files. For example, the CREODIAS metadata catalogue provides references to product files in their eodata object storage - the access details for which are configured in the data access services: global : storage : data : data : type : S3 endpoint_url : http://data.cloudferro.com access_key_id : access secret_access_key : access region_name : RegionOne validate_bucket_name : false","title":"Platform EO Data"},{"location":"eoepca/data-access/#data-access-cache","text":"The Data Access services maintain a cache, which relies on the usage of a dedicate object storage bucket for data persistence. This bucket must be created (manual step) and its access details configured in the data access services. Example based upon CREODIAS: global : storage : cache : type : S3 endpoint_url : \"https://cf2.cloudferro.com:8080/cache-bucket\" host : \"cf2.cloudferro.com:8080\" access_key_id : xxx secret_access_key : xxx region : RegionOne bucket : cache-bucket \u2026where xxx must be replaced with the bucket credentials.","title":"Data Access Cache"},{"location":"eoepca/data-access/#protection","text":"As described in section Resource Protection (Keycloak) , the identity-gatekeeper component can be inserted into the request path of the data-access service to provide access authorization decisions","title":"Protection"},{"location":"eoepca/data-access/#gatekeeper","text":"Gatekeeper is deployed using its helm chart\u2026 helm install data-access-protection identity-gatekeeper -f data-access-protection-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ --namespace \"rm\" --create-namespace \\ --version 1 .0.11 The identity-gatekeeper must be configured with the values applicable to the data-access - in particular the specific ingress requirements for the data-access backend services\u2026 Example data-access-protection-values.yaml \u2026 fullnameOverride : data-access-protection config : client-id : data-access discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io targetService : host : data-access.192-168-49-2.nip.io name : data-access-renderer port : number : 80 secrets : # Values for secret 'data-access-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production nginx.ingress.kubernetes.io/proxy-read-timeout : \"600\" nginx.ingress.kubernetes.io/enable-cors : \"true\" nginx.ingress.kubernetes.io/rewrite-target : /$1 serverSnippets : custom : |- # Open access to renderer... location ~ ^/(ows.*|opensearch.*|coverages/metadata.*|admin.*) { proxy_pass http://data-access-renderer.rm.svc.cluster.local:80/$1; } # Open access to cache... location ~ ^/cache/(.*) { proxy_pass http://data-access-cache.rm.svc.cluster.local:80/$1; } # Open access to client... # Note that we use a negative lookahead to avoid matching '/.well-known/*' which # otherwise appears to interfere with the work of cert-manager/letsencrypt. location ~ ^/(?!\\.well-known)(.*) { proxy_pass http://data-access-client.rm.svc.cluster.local:80/$1; }","title":"Gatekeeper"},{"location":"eoepca/data-access/#keycloak-client","text":"The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. client-id: data-access above. This can be created with the create-client helper script, as descirbed in section Client Registration . For example\u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = data-access \\ --name = \"Data Access Gatekeeper\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by Data Access Gatekeeper\"","title":"Keycloak Client"},{"location":"eoepca/data-access/#data-access-usage","text":"","title":"Data Access Usage"},{"location":"eoepca/data-access/#default-harvesting","text":"At deployment time the harvester helm values include configuration that populates a default harvester configuration, that is prepared in the file /config.yaml in the harvester pod. The Data Access and Resource Catalogue services are configured to properly interpret harvested data via these values specified in the instantiation of the helm release. See section Data-layer Configuration . The harvesting of data can be triggered (post deployment), in accordance with this default configuration, by connecting to the rm/harvester service and executing the command\u2026 python3 -m harvester harvest --config-file /config-run.yaml --host data-access-redis-master --port 6379 Creodias-Opensearch","title":"Default Harvesting"},{"location":"eoepca/data-access/#ad-hoc-harvesting","text":"Ad-hoc harvesting can be invoked by provision of a suitable config.yaml into the harvester pod, which can then be invoked as shown above for the default harvester configuration established at deploy time. The helper script ./deploy/bin/harvest faciltates this\u2026 ./deploy/bin/harvest <path-to-config-file> See directory ./deploy/samples/harvester/ that contains some sample harvesting configuration files. For example\u2026 ./deploy/bin/harvest ./deploy/samples/harvester/config-Sentinel2-2019.09.10.yaml","title":"Ad-hoc Harvesting"},{"location":"eoepca/data-access/#registration-of-collections","text":"The helper script ./deploy/bin/register-collection is provided to faciltate the registration of collections that are specfied in STAC Collection format. ./deploy/bin/register-collection <path-to-stac-collection-file> See directory ./deploy/samples/collections/ that contains some same STAC Collection files. For example\u2026 ./deploy/bin/register-collection ./deploy/samples/collections/S2MSI2A.json","title":"Registration of Collections"},{"location":"eoepca/data-access/#additional-information","text":"Additional information regarding the Data Access can be found at: Helm Chart Documentation: User Guide Operator Guide Git Repository","title":"Additional Information"},{"location":"eoepca/iam-overview/","text":"IAM Overview \u2693\ufe0e This guide includes two approaches for Identity & Access Management: Keycloak Solution (NEW) Gluu Solution (deprecated) Until now, our IAM solution has been based solely upon Gluu. In the course of the project Keycloak has emerged as a preferred solution across EO platforms. Thus, we have introduced an IAM approach based upon Keycloak, whilst retaining the Gluu-based approach for reference, which will be deprecated.","title":"IAM Overview"},{"location":"eoepca/iam-overview/#iam-overview","text":"This guide includes two approaches for Identity & Access Management: Keycloak Solution (NEW) Gluu Solution (deprecated) Until now, our IAM solution has been based solely upon Gluu. In the course of the project Keycloak has emerged as a preferred solution across EO platforms. Thus, we have introduced an IAM approach based upon Keycloak, whilst retaining the Gluu-based approach for reference, which will be deprecated.","title":"IAM Overview"},{"location":"eoepca/identity-service/","text":"Identity Service \u2693\ufe0e The Identity Service provides the platform Authorization Server for authenticated user identity and request authorization. Identity Service is composed of: Keycloak IAM Authorization Service - supporting OpenID Connect (OIDC), etc. Postgres DB Relational database used by Keycloak for persistence Identity API Service that provided a convenience API to simplify IAM management interactions with Keycloak. Provides endpoints to create clients and protect resources. Uses a keycloak python client which sends requests to Keycloak API Identity API Gatekeeper Instance of Gatekeeper to \u2018protect\u2019 access requests to the Identity API service. Gatekeeper is a reusable component that provides the Policy Enforcement for requests to individual resource servers. A Gatekeeper instance should be configured and deployed for each application that requires protection by access policies. Helm Chart \u2693\ufe0e The Identity Service is deployed via the identity-service helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values - the full set of available values can be tailored according the helm chart defaults, that can be found here\u2026 identity-service https://github.com/ EOEPCA /helm-charts/blob/main/charts/identity-service/values.yaml identity-keycloak https://github.com/ EOEPCA /helm-charts/blob/main/charts/identity-service/charts/identity-keycloak/values.yaml identity-postgres https://github.com/ EOEPCA /helm-charts/blob/main/charts/identity-service/charts/identity-postgres/values.yaml identity-api https://github.com/ EOEPCA /helm-charts/blob/main/charts/identity-service/charts/identity-api/values.yaml helm install --version 1 .0.97 --values identity-service-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ identity-service identity-service Values \u2693\ufe0e The deployment must be configured for you environment. Some significant configuration values are elaborated here\u2026 identity-keycloak \u2693\ufe0e Secrets \u2693\ufe0e Keycloak relies upon a secret identity-keycloak that provides\u2026 KEYCLOAK_ADMIN_PASSWORD - admin password for Keycloak KC_DB_PASSWORD - password for connecting with Postgres DB This should match the POSTGRES_PASSWORD setting for identity-postgres (see below) The secret can either be created directly within the cluster, or can be created by the helm chart via values\u2026 identity-keycloak : secrets : # Values for secret 'identity-keycloak' # Note - if ommitted, these can instead be set by creating the secret independently. kcDbPassword : \"changeme\" keycloakAdminPassword : \"changeme\" Ingress \u2693\ufe0e The details for ingress (reverse-proxy) to the Keycloak service - in particular the hostname and possible TLS - must be specified\u2026 identity-keycloak : ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production hosts : - host : keycloak.192-168-49-2.nip.io paths : - path : / pathType : Prefix tls : - secretName : identity-keycloak-tls hosts : - keycloak.192-168-49-2.nip.io identity-postgres \u2693\ufe0e Secrets \u2693\ufe0e Postgres relies upon a secret identity-postgres that provides\u2026 POSTGRES_PASSWORD - superuser password for PostgreSQL PGPASSWORD - password used for client connections to the DB The secret can either be created directly within the cluster, or can be created by the helm chart via values\u2026 identity-postgres : secrets : # Values for secret 'identity-postgres' # Note - if ommitted, these can instead be set by creating the secret independently. postgresPassword : \"changeme\" pgPassword : \"changeme\" Persistence \u2693\ufe0e In order to persist data, Postgres requires a Persistent Volume Claim. This can be specified as an existing volume claim - for example as described in the Persistence section. identity-postgres : volumeClaim : name : eoepca-userman-pvc identity-api \u2693\ufe0e Secrets \u2693\ufe0e The Identity API relies upon a secret identity-api that provides\u2026 ADMIN_PASSWORD Admin password for Keycloak This should match the KEYCLOAK_ADMIN_PASSWORD setting for identity-keycloak (see above) The secret can either be created directly within the cluster, or can be created by the helm chart via values\u2026 identity-api : secrets : # Values for secret 'identity-api' # Note - if ommitted, these can instead be set by creating the secret independently # e.g. as a SealedSecret via GitOps. adminPassword : \"changeme\" Note It is also possible to set the value of ADMIN_PASSWORD directly as an environment variable . In this case it is necessary to set the secret as optional\u2026 identity-api: secrets: optional: true Environment Variables \u2693\ufe0e The Identity API service can be configured via environment variables as follows\u2026 AUTH_SERVER_URL URL of the Keycloak Authorization Server. Can also be set via value configMap.authServerUrl ADMIN_USERNAME Admin user for Keycloak REALM The Keycloak realm identity-api : deployment : # Config values that can be passed via env vars extraEnv : - name : AUTH_SERVER_URL # see configMap.authServerUrl instead value : https://keycloak.192-168-49-2.nip.io - name : ADMIN_USERNAME value : admin - name : ADMIN_PASSWORD # see secrets.adminPassword instead value : changeme - name : REALM value : master identity-api-gatekeeper \u2693\ufe0e Secrets \u2693\ufe0e gatekeeper relies upon a secret identity-api-protection that provides\u2026 PROXY_CLIENT_SECRET Password for the Keycloak client configured for use by this Gatekeeper instance - corresponding to config.client-id . PROXY_ENCRYPTION_KEY Encryption Key used by Gatekeeper. The secret can either be created directly within the cluster, or can be created by the helm chart via values\u2026 identity-api-gatekeeper : secrets : # Values for secret 'identity-api-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" Configuration \u2693\ufe0e Configuration of Gatekeeper via the file config.yaml that is mounted into the deployment\u2026 client-id ID of the Keycloak client to be used by this Gatekeeper instance. discovery-url Discovery URL of the Keycloak Authorization Server cookie-domain Domain in which this Gatekeeper instance creates cookies identity-api-gatekeeper : config : client-id : identity-api discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io Ingress \u2693\ufe0e The details for ingress (reverse-proxy) to the Gatekeeper service that protects the Identity API\u2026 identity-api-gatekeeper: targetService: host: identity-api.192-168-49-2.nip.io ingress: annotations: ingress.kubernetes.io/ssl-redirect: \"true\" nginx.ingress.kubernetes.io/ssl-redirect: \"true\" cert-manager.io/cluster-issuer: letsencrypt Identity API Client \u2693\ufe0e The Identity API is protected via an instance of Gatekeeper - which relies upon a Keycloak client having been created for authorization decision/enforcement flows between Gatekeeper and Keycloak. As described in the \u2018create-client\u2019 section below , this can be achieved using the create-client helper script. Note At time of client creation, the Identity API is not yet protected with an ingress. Therefore, we use a port-forward to interface directly with the Identity API service. $ kubectl -n um port-forward svc/identity-api \"9876\" :http >/dev/null & $ portForwardPid = $! $ ./deploy/bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i http://localhost:9876 \\ -r master \\ -u admin \\ -p changeme \\ -c admin-cli \\ --id = identity-api \\ --name = \"Identity API Gatekeeper\" \\ --secret = changeme \\ --description = \"Client to be used by Identity API Gatekeeper\" \\ --resource = \"admin\" --uris = '/*' --scopes = view --users = \"admin\" $ kill -TERM $portForwardPid create-user Helper Script \u2693\ufe0e The Keycloak Admin UI can be used to create users interactively. Alternatvely there is a helper script create-user that can be used. The script is available in the deployment-guide repository , and can be obtained as follows\u2026 git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide cd deployment-guide The create-user helper script requires some command-line arguments\u2026 $ ./deploy/bin/create-user -h Create a new user. create-user -h | -a { auth_server } -r { realm } -c { client } -u { admin-username } -p { admin-password } -U { new-username } -P { new-password } where: -h show help message -a authorization server url ( default: http://keycloak.192-168-49-2.nip.io ) -r realm within Keycloak ( default: master ) -u username used for authentication ( default: admin ) -p password used for authentication ( default: changeme ) -c client id of the bootstrap client used in the create request ( default: admin-cli ) -U name of the ( new ) user to create -P password for the ( new ) user to create Protection of Resources \u2693\ufe0e The Identity Service is capable of protecting resources using OpenID-connect/SAML clients, resources (URIs/scopes), policies (user based, role based, etc) and permissions (associations between policies and resources). Creating and protecting resources can be done in multiple ways, as described in the following sections. Keycloak Admin UI \u2693\ufe0e To create and protect resources using the keycloak User Interface (UI), do the following steps: (Optional) Create clients. Clients can be created using the keycloak user interface at http://keycloak.192-168-49-2.nip.io. You need to login as admin. To create a client: Login as admin in the keycloak UI > Clients > Create Client > Set a name > Next > Turn Client Authentication and Authorization On > Add the valid redirect URI\u2019s > Save. (Optional) Create Users. Users > Add User. Then set a password for the user. Credentials > Set Password. Select a client. Create a Resource: Select Authorization tab > Resources > Create Resource. Create a Policy: In client details, select Authorization > Policies > Create Policy > Select Policy Type (e.g.: User) > Select users > Save. Create Authorization Scope: In client details, select Authorization > Scopes > Create authorization scope > Save. Create a Permission: In client details, select Authorization > Permissions > Create Permission > Create Resource Based Permission > Select Resources to protect > Select Policies > Save. create-client Helper Script \u2693\ufe0e Alternatively, a script was developed to allow simultaneaously create a client, create resources and protect them. The script is available in the deployment-guide repository , and can be obtained as follows\u2026 git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide cd deployment-guide The create-client helper script requires some command-line arguments\u2026 $ ./deploy/bin/create-client -h Add a client with protected resources. create-client [-h] [-a] [-i] [-u] [-p] [-c] [-s] [-t | --token t] [-r] --id id [--name name] (--secret secret | --public) [--default] [--authenticated] [--resource name] [--uris u1,u2] [--scopes s1,s2] [--users u1,u2] [--roles r1,r2] where: -h show help message -a authorization server url - e.g. https://keycloak.192-168-49-2.nip.io -i identity-api server url - e.g. https://identity-api.192-168-49-2.nip.io -u username used for authentication -p password used for authentication -c client id (of the bootstrap client used in the create request) -s client secret (of the bootstrap client used in the create request) -t or --token access token used for authentication -r realm --id client id (of the created client) --name client name (of the created client) --secret client secret (of the created client) --public public client (no client secret) --default add default resource - /* authenticated --authenticated allow access to the resource only when authenticated --resource resource name --uris resource uris - separated by comma (,) --scopes resource scopes - separated by comma (,) --users user names with access to the resource - separated by comma (,) --roles role names with access to the resource - separated by comma (,) The script interacts with Identity API and therefore requires admin authorization. It accepts basic authentication with username and password with -u and -p parameters, respectively - or a bearer access token with -t parameter. To generate the access token needed to use the script, you can get it through the login in the eoepca portal, by accessing the cookies in the browser. See section EOEPCA Portal for details regarding deployment/configuration of the eoepca-portal . Or you can generate an access token using postman oauth2.0, as described in the Postman document Requesting an OAuth 2.0 token . Script execution examples: With username/password ./deploy/bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r master \\ -u admin \\ -p changeme \\ -c admin-cli \\ --id = myservice-gatekeeper \\ --name = \"MyService Gatekeeper\" \\ --secret = changeme \\ --description = \"Client to be used by MyService Gatekeeper\" \\ --resource = \"Eric space\" --uris = /eric/* --users = eric \\ --resource = \"Alice space\" --uris = /alice/* --users = alice \\ --resource = \"Admin space\" --uris = /admin/* --roles = admin With access token ./deploy/bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r master \\ -t eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJXZWFIY2pscThPc1RUYjdlV0s5SjJTTDFBUDIyazZpajdlMGFlVHRNU2xRIn0.eyJleHAiOjE3MDAyNDM4MzgsImlhdCI6MTcwMDI0Mzc3OCwiYXV0aF90aW1lIjoxNzAwMjQxODYyLCJqdGkiOiI2MWI0ZGRhYy1mOWZjLTRmZjktOWQ4Zi01NWU1N2NlNmE5ODgiLCJpc3MiOiJodHRwczovL2lkZW50aXR5LmtleWNsb2FrLmRldmVsb3AuZW9lcGNhLm9yZy9yZWFsbXMvbWFzdGVyIiwiYXVkIjpbImFkZXMtcmVhbG0iLCJkZW1vLXJlYWxtIiwiZHVtbXktc2VydmljZS1yZWFsbSIsIm1hc3Rlci1yZWFsbSIsImFjY291bnQiLCJlb2VwY2EtcmVhbG0iXSwic3ViIjoiZTNkZTMyNGUtMGY0NS00MWUwLTk2YTctNTM1YzkxMTA1NTUyIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiZW9lcGNhLXBvcnRhbCIsIm5vbmNlIjoiMTIwMGJlNzAtZWI1Ni00Nzc2LThjODgtOWRiOWQxMDdiMGY2Iiwic2Vzc2lvbl9zdGF0ZSI6ImVmNGUwOTlmLTFmMDgtNDY3MC04ZmE2LTJiOGI3OGUwNWMzMSIsImFjciI6IjAiLCJhbGxvd2VkLW9yaWdpbnMiOlsiKiJdLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiY3JlYXRlLXJlYWxtIiwiZGVmYXVsdC1yb2xlcy1tYXN0ZXIiLCJvZmZsaW5lX2FjY2VzcyIsImFkbWluIiwidW1hX2F1dGhvcml6YXRpb24iLCJ1c2VyIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWRlcy1yZWFsbSI6eyJyb2xlcyI6WyJ2aWV3LWlkZW50aXR5LXByb3ZpZGVycyIsInZpZXctcmVhbG0iLCJtYW5hZ2UtaWRlbnRpdHktcHJvdmlkZXJzIiwiaW1wZXJzb25hdGlvbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfSwiZGVtby1yZWFsbSI6eyJyb2xlcyI6WyJ2aWV3LXJlYWxtIiwidmlldy1pZGVudGl0eS1wcm92aWRlcnMiLCJtYW5hZ2UtaWRlbnRpdHktcHJvdmlkZXJzIiwiaW1wZXJzb25hdGlvbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfSwiZHVtbXktc2VydmljZS1yZWFsbSI6eyJyb2xlcyI6WyJ2aWV3LXJlYWxtIiwidmlldy1pZGVudGl0eS1wcm92aWRlcnMiLCJtYW5hZ2UtaWRlbnRpdHktcHJvdmlkZXJzIiwiaW1wZXJzb25hdGlvbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfSwibWFzdGVyLXJlYWxtIjp7InJvbGVzIjpbInZpZXctaWRlbnRpdHktcHJvdmlkZXJzIiwidmlldy1yZWFsbSIsIm1hbmFnZS1pZGVudGl0eS1wcm92aWRlcnMiLCJpbXBlcnNvbmF0aW9uIiwiY3JlYXRlLWNsaWVudCIsIm1hbmFnZS11c2VycyIsInF1ZXJ5LXJlYWxtcyIsInZpZXctYXV0aG9yaXphdGlvbiIsInF1ZXJ5LWNsaWVudHMiLCJxdWVyeS11c2VycyIsIm1hbmFnZS1ldmVudHMiLCJtYW5hZ2UtcmVhbG0iLCJ2aWV3LWV2ZW50cyIsInZpZXctdXNlcnMiLCJ2aWV3LWNsaWVudHMiLCJtYW5hZ2UtYXV0aG9yaXphdGlvbiIsIm1hbmFnZS1jbGllbnRzIiwicXVlcnktZ3JvdXBzIl19LCJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX0sImVvZXBjYS1yZWFsbSI6eyJyb2xlcyI6WyJ2aWV3LWlkZW50aXR5LXByb3ZpZGVycyIsInZpZXctcmVhbG0iLCJtYW5hZ2UtaWRlbnRpdHktcHJvdmlkZXJzIiwiaW1wZXJzb25hdGlvbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfX0sInNjb3BlIjoib3BlbmlkIGVtYWlsIHByb2ZpbGUiLCJzaWQiOiJlZjRlMDk5Zi0xZjA4LTQ2NzAtOGZhNi0yYjhiNzhlMDVjMzEiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6ImFkbWluIn0.FK6DhVzpCRFmef2acD2Hmc149e1GTOCGz13dZA828crFbG8j4uhpkoNpiZqdyOPmDtMQ-OebNfjTAUaOt2sS1FmEIBgb9IddcpHKNJOquRjdzQNsX09bX8pFUq1haGwKh6_QmABNOBcT-kQNDSZO-aq7-8FoO9PYa0GWvBRcbcx0W_ngyb7xHglaZTElzcDPBcUTW6llVTTTFygn55smwdxTZ7-tEsMVGM5gNuHwJyLB51HI5KDWrwgUm1hqhhRzvcoutDEAB_HSEXGNNeF7fjP9Qx6q04b7fKOTtnIlXsu3oYW4va9y754llMSJ7w8U-y7yI6Tm2UdNMdYqju7hAA \\ -c admin-cli \\ --id = myservice-gatekeeper \\ --name = \"MyService Gatekeeper\" \\ --secret = changeme \\ --description = \"Client to be used by MyService Gatekeeper\" \\ --resource = \"Eric space\" --uris = /eric/* --users = eric \\ --resource = \"Alice space\" --uris = /alice/* --users = alice \\ --resource = \"Admin space\" --uris = /admin/* --roles = admin Using Identity API \u2693\ufe0e Also, an API was developed to interact more easily with the Keycloak API, that allows client, resource, policies and permissions management. The API documentation can be found in its Swagger UI at the service endpoint - https://identity-api.192-168-49-2.nip.io/docs . The Identity API is best used in combination with the eoepca-portal test aide, which can be used to establish a login sesssion in the browser to the benefit of the Identity API swagger UI. See section EOEPCA Portal for details regarding deployment/configuration of the eoepca-portal . Token Lifespans \u2693\ufe0e By default the Access Token Lifespan is 1 minute. With the current ADES (zoo-dru) implementation this presents a problem - since the access_token that is provided to the process execute request will (most likely) have expired by the time the ADES attempts to use the access_token in its call to the Workspace API to register the processing outputs. The lifespan of the token must outlive the duration of the processing execution - which we must assume can take a long time. To avoid this potential problem, the Keycloak Admin web console can be used to increase this token lifespan. Thus, the following settings are recommended to be updated following deployment\u2026 SSO Session Settings /admin/master/console/#/master/realm-settings/sessions SSO Session Idle: 1 day SSO Session Max: 1 day Tokens /admin/master/console/#/master/realm-settings/tokens Access Token Lifespan: 1 day Additional Information \u2693\ufe0e Additional information regarding the Identity Service can be found at: Helm Chart GitHub Repository","title":"Identity Service"},{"location":"eoepca/identity-service/#identity-service","text":"The Identity Service provides the platform Authorization Server for authenticated user identity and request authorization. Identity Service is composed of: Keycloak IAM Authorization Service - supporting OpenID Connect (OIDC), etc. Postgres DB Relational database used by Keycloak for persistence Identity API Service that provided a convenience API to simplify IAM management interactions with Keycloak. Provides endpoints to create clients and protect resources. Uses a keycloak python client which sends requests to Keycloak API Identity API Gatekeeper Instance of Gatekeeper to \u2018protect\u2019 access requests to the Identity API service. Gatekeeper is a reusable component that provides the Policy Enforcement for requests to individual resource servers. A Gatekeeper instance should be configured and deployed for each application that requires protection by access policies.","title":"Identity Service"},{"location":"eoepca/identity-service/#helm-chart","text":"The Identity Service is deployed via the identity-service helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values - the full set of available values can be tailored according the helm chart defaults, that can be found here\u2026 identity-service https://github.com/ EOEPCA /helm-charts/blob/main/charts/identity-service/values.yaml identity-keycloak https://github.com/ EOEPCA /helm-charts/blob/main/charts/identity-service/charts/identity-keycloak/values.yaml identity-postgres https://github.com/ EOEPCA /helm-charts/blob/main/charts/identity-service/charts/identity-postgres/values.yaml identity-api https://github.com/ EOEPCA /helm-charts/blob/main/charts/identity-service/charts/identity-api/values.yaml helm install --version 1 .0.97 --values identity-service-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ identity-service identity-service","title":"Helm Chart"},{"location":"eoepca/identity-service/#values","text":"The deployment must be configured for you environment. Some significant configuration values are elaborated here\u2026","title":"Values"},{"location":"eoepca/identity-service/#identity-keycloak","text":"","title":"identity-keycloak"},{"location":"eoepca/identity-service/#secrets","text":"Keycloak relies upon a secret identity-keycloak that provides\u2026 KEYCLOAK_ADMIN_PASSWORD - admin password for Keycloak KC_DB_PASSWORD - password for connecting with Postgres DB This should match the POSTGRES_PASSWORD setting for identity-postgres (see below) The secret can either be created directly within the cluster, or can be created by the helm chart via values\u2026 identity-keycloak : secrets : # Values for secret 'identity-keycloak' # Note - if ommitted, these can instead be set by creating the secret independently. kcDbPassword : \"changeme\" keycloakAdminPassword : \"changeme\"","title":"Secrets"},{"location":"eoepca/identity-service/#ingress","text":"The details for ingress (reverse-proxy) to the Keycloak service - in particular the hostname and possible TLS - must be specified\u2026 identity-keycloak : ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production hosts : - host : keycloak.192-168-49-2.nip.io paths : - path : / pathType : Prefix tls : - secretName : identity-keycloak-tls hosts : - keycloak.192-168-49-2.nip.io","title":"Ingress"},{"location":"eoepca/identity-service/#identity-postgres","text":"","title":"identity-postgres"},{"location":"eoepca/identity-service/#secrets_1","text":"Postgres relies upon a secret identity-postgres that provides\u2026 POSTGRES_PASSWORD - superuser password for PostgreSQL PGPASSWORD - password used for client connections to the DB The secret can either be created directly within the cluster, or can be created by the helm chart via values\u2026 identity-postgres : secrets : # Values for secret 'identity-postgres' # Note - if ommitted, these can instead be set by creating the secret independently. postgresPassword : \"changeme\" pgPassword : \"changeme\"","title":"Secrets"},{"location":"eoepca/identity-service/#persistence","text":"In order to persist data, Postgres requires a Persistent Volume Claim. This can be specified as an existing volume claim - for example as described in the Persistence section. identity-postgres : volumeClaim : name : eoepca-userman-pvc","title":"Persistence"},{"location":"eoepca/identity-service/#identity-api","text":"","title":"identity-api"},{"location":"eoepca/identity-service/#secrets_2","text":"The Identity API relies upon a secret identity-api that provides\u2026 ADMIN_PASSWORD Admin password for Keycloak This should match the KEYCLOAK_ADMIN_PASSWORD setting for identity-keycloak (see above) The secret can either be created directly within the cluster, or can be created by the helm chart via values\u2026 identity-api : secrets : # Values for secret 'identity-api' # Note - if ommitted, these can instead be set by creating the secret independently # e.g. as a SealedSecret via GitOps. adminPassword : \"changeme\" Note It is also possible to set the value of ADMIN_PASSWORD directly as an environment variable . In this case it is necessary to set the secret as optional\u2026 identity-api: secrets: optional: true","title":"Secrets"},{"location":"eoepca/identity-service/#environment-variables","text":"The Identity API service can be configured via environment variables as follows\u2026 AUTH_SERVER_URL URL of the Keycloak Authorization Server. Can also be set via value configMap.authServerUrl ADMIN_USERNAME Admin user for Keycloak REALM The Keycloak realm identity-api : deployment : # Config values that can be passed via env vars extraEnv : - name : AUTH_SERVER_URL # see configMap.authServerUrl instead value : https://keycloak.192-168-49-2.nip.io - name : ADMIN_USERNAME value : admin - name : ADMIN_PASSWORD # see secrets.adminPassword instead value : changeme - name : REALM value : master","title":"Environment Variables"},{"location":"eoepca/identity-service/#identity-api-gatekeeper","text":"","title":"identity-api-gatekeeper"},{"location":"eoepca/identity-service/#secrets_3","text":"gatekeeper relies upon a secret identity-api-protection that provides\u2026 PROXY_CLIENT_SECRET Password for the Keycloak client configured for use by this Gatekeeper instance - corresponding to config.client-id . PROXY_ENCRYPTION_KEY Encryption Key used by Gatekeeper. The secret can either be created directly within the cluster, or can be created by the helm chart via values\u2026 identity-api-gatekeeper : secrets : # Values for secret 'identity-api-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\"","title":"Secrets"},{"location":"eoepca/identity-service/#configuration","text":"Configuration of Gatekeeper via the file config.yaml that is mounted into the deployment\u2026 client-id ID of the Keycloak client to be used by this Gatekeeper instance. discovery-url Discovery URL of the Keycloak Authorization Server cookie-domain Domain in which this Gatekeeper instance creates cookies identity-api-gatekeeper : config : client-id : identity-api discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io","title":"Configuration"},{"location":"eoepca/identity-service/#ingress_1","text":"The details for ingress (reverse-proxy) to the Gatekeeper service that protects the Identity API\u2026 identity-api-gatekeeper: targetService: host: identity-api.192-168-49-2.nip.io ingress: annotations: ingress.kubernetes.io/ssl-redirect: \"true\" nginx.ingress.kubernetes.io/ssl-redirect: \"true\" cert-manager.io/cluster-issuer: letsencrypt","title":"Ingress"},{"location":"eoepca/identity-service/#identity-api-client","text":"The Identity API is protected via an instance of Gatekeeper - which relies upon a Keycloak client having been created for authorization decision/enforcement flows between Gatekeeper and Keycloak. As described in the \u2018create-client\u2019 section below , this can be achieved using the create-client helper script. Note At time of client creation, the Identity API is not yet protected with an ingress. Therefore, we use a port-forward to interface directly with the Identity API service. $ kubectl -n um port-forward svc/identity-api \"9876\" :http >/dev/null & $ portForwardPid = $! $ ./deploy/bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i http://localhost:9876 \\ -r master \\ -u admin \\ -p changeme \\ -c admin-cli \\ --id = identity-api \\ --name = \"Identity API Gatekeeper\" \\ --secret = changeme \\ --description = \"Client to be used by Identity API Gatekeeper\" \\ --resource = \"admin\" --uris = '/*' --scopes = view --users = \"admin\" $ kill -TERM $portForwardPid","title":"Identity API Client"},{"location":"eoepca/identity-service/#create-user-helper-script","text":"The Keycloak Admin UI can be used to create users interactively. Alternatvely there is a helper script create-user that can be used. The script is available in the deployment-guide repository , and can be obtained as follows\u2026 git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide cd deployment-guide The create-user helper script requires some command-line arguments\u2026 $ ./deploy/bin/create-user -h Create a new user. create-user -h | -a { auth_server } -r { realm } -c { client } -u { admin-username } -p { admin-password } -U { new-username } -P { new-password } where: -h show help message -a authorization server url ( default: http://keycloak.192-168-49-2.nip.io ) -r realm within Keycloak ( default: master ) -u username used for authentication ( default: admin ) -p password used for authentication ( default: changeme ) -c client id of the bootstrap client used in the create request ( default: admin-cli ) -U name of the ( new ) user to create -P password for the ( new ) user to create","title":"create-user Helper Script"},{"location":"eoepca/identity-service/#protection-of-resources","text":"The Identity Service is capable of protecting resources using OpenID-connect/SAML clients, resources (URIs/scopes), policies (user based, role based, etc) and permissions (associations between policies and resources). Creating and protecting resources can be done in multiple ways, as described in the following sections.","title":"Protection of Resources"},{"location":"eoepca/identity-service/#keycloak-admin-ui","text":"To create and protect resources using the keycloak User Interface (UI), do the following steps: (Optional) Create clients. Clients can be created using the keycloak user interface at http://keycloak.192-168-49-2.nip.io. You need to login as admin. To create a client: Login as admin in the keycloak UI > Clients > Create Client > Set a name > Next > Turn Client Authentication and Authorization On > Add the valid redirect URI\u2019s > Save. (Optional) Create Users. Users > Add User. Then set a password for the user. Credentials > Set Password. Select a client. Create a Resource: Select Authorization tab > Resources > Create Resource. Create a Policy: In client details, select Authorization > Policies > Create Policy > Select Policy Type (e.g.: User) > Select users > Save. Create Authorization Scope: In client details, select Authorization > Scopes > Create authorization scope > Save. Create a Permission: In client details, select Authorization > Permissions > Create Permission > Create Resource Based Permission > Select Resources to protect > Select Policies > Save.","title":"Keycloak Admin UI"},{"location":"eoepca/identity-service/#create-client-helper-script","text":"Alternatively, a script was developed to allow simultaneaously create a client, create resources and protect them. The script is available in the deployment-guide repository , and can be obtained as follows\u2026 git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide cd deployment-guide The create-client helper script requires some command-line arguments\u2026 $ ./deploy/bin/create-client -h Add a client with protected resources. create-client [-h] [-a] [-i] [-u] [-p] [-c] [-s] [-t | --token t] [-r] --id id [--name name] (--secret secret | --public) [--default] [--authenticated] [--resource name] [--uris u1,u2] [--scopes s1,s2] [--users u1,u2] [--roles r1,r2] where: -h show help message -a authorization server url - e.g. https://keycloak.192-168-49-2.nip.io -i identity-api server url - e.g. https://identity-api.192-168-49-2.nip.io -u username used for authentication -p password used for authentication -c client id (of the bootstrap client used in the create request) -s client secret (of the bootstrap client used in the create request) -t or --token access token used for authentication -r realm --id client id (of the created client) --name client name (of the created client) --secret client secret (of the created client) --public public client (no client secret) --default add default resource - /* authenticated --authenticated allow access to the resource only when authenticated --resource resource name --uris resource uris - separated by comma (,) --scopes resource scopes - separated by comma (,) --users user names with access to the resource - separated by comma (,) --roles role names with access to the resource - separated by comma (,) The script interacts with Identity API and therefore requires admin authorization. It accepts basic authentication with username and password with -u and -p parameters, respectively - or a bearer access token with -t parameter. To generate the access token needed to use the script, you can get it through the login in the eoepca portal, by accessing the cookies in the browser. See section EOEPCA Portal for details regarding deployment/configuration of the eoepca-portal . Or you can generate an access token using postman oauth2.0, as described in the Postman document Requesting an OAuth 2.0 token . Script execution examples: With username/password ./deploy/bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r master \\ -u admin \\ -p changeme \\ -c admin-cli \\ --id = myservice-gatekeeper \\ --name = \"MyService Gatekeeper\" \\ --secret = changeme \\ --description = \"Client to be used by MyService Gatekeeper\" \\ --resource = \"Eric space\" --uris = /eric/* --users = eric \\ --resource = \"Alice space\" --uris = /alice/* --users = alice \\ --resource = \"Admin space\" --uris = /admin/* --roles = admin With access token ./deploy/bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r master \\ -t eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJXZWFIY2pscThPc1RUYjdlV0s5SjJTTDFBUDIyazZpajdlMGFlVHRNU2xRIn0.eyJleHAiOjE3MDAyNDM4MzgsImlhdCI6MTcwMDI0Mzc3OCwiYXV0aF90aW1lIjoxNzAwMjQxODYyLCJqdGkiOiI2MWI0ZGRhYy1mOWZjLTRmZjktOWQ4Zi01NWU1N2NlNmE5ODgiLCJpc3MiOiJodHRwczovL2lkZW50aXR5LmtleWNsb2FrLmRldmVsb3AuZW9lcGNhLm9yZy9yZWFsbXMvbWFzdGVyIiwiYXVkIjpbImFkZXMtcmVhbG0iLCJkZW1vLXJlYWxtIiwiZHVtbXktc2VydmljZS1yZWFsbSIsIm1hc3Rlci1yZWFsbSIsImFjY291bnQiLCJlb2VwY2EtcmVhbG0iXSwic3ViIjoiZTNkZTMyNGUtMGY0NS00MWUwLTk2YTctNTM1YzkxMTA1NTUyIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiZW9lcGNhLXBvcnRhbCIsIm5vbmNlIjoiMTIwMGJlNzAtZWI1Ni00Nzc2LThjODgtOWRiOWQxMDdiMGY2Iiwic2Vzc2lvbl9zdGF0ZSI6ImVmNGUwOTlmLTFmMDgtNDY3MC04ZmE2LTJiOGI3OGUwNWMzMSIsImFjciI6IjAiLCJhbGxvd2VkLW9yaWdpbnMiOlsiKiJdLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiY3JlYXRlLXJlYWxtIiwiZGVmYXVsdC1yb2xlcy1tYXN0ZXIiLCJvZmZsaW5lX2FjY2VzcyIsImFkbWluIiwidW1hX2F1dGhvcml6YXRpb24iLCJ1c2VyIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWRlcy1yZWFsbSI6eyJyb2xlcyI6WyJ2aWV3LWlkZW50aXR5LXByb3ZpZGVycyIsInZpZXctcmVhbG0iLCJtYW5hZ2UtaWRlbnRpdHktcHJvdmlkZXJzIiwiaW1wZXJzb25hdGlvbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfSwiZGVtby1yZWFsbSI6eyJyb2xlcyI6WyJ2aWV3LXJlYWxtIiwidmlldy1pZGVudGl0eS1wcm92aWRlcnMiLCJtYW5hZ2UtaWRlbnRpdHktcHJvdmlkZXJzIiwiaW1wZXJzb25hdGlvbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfSwiZHVtbXktc2VydmljZS1yZWFsbSI6eyJyb2xlcyI6WyJ2aWV3LXJlYWxtIiwidmlldy1pZGVudGl0eS1wcm92aWRlcnMiLCJtYW5hZ2UtaWRlbnRpdHktcHJvdmlkZXJzIiwiaW1wZXJzb25hdGlvbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfSwibWFzdGVyLXJlYWxtIjp7InJvbGVzIjpbInZpZXctaWRlbnRpdHktcHJvdmlkZXJzIiwidmlldy1yZWFsbSIsIm1hbmFnZS1pZGVudGl0eS1wcm92aWRlcnMiLCJpbXBlcnNvbmF0aW9uIiwiY3JlYXRlLWNsaWVudCIsIm1hbmFnZS11c2VycyIsInF1ZXJ5LXJlYWxtcyIsInZpZXctYXV0aG9yaXphdGlvbiIsInF1ZXJ5LWNsaWVudHMiLCJxdWVyeS11c2VycyIsIm1hbmFnZS1ldmVudHMiLCJtYW5hZ2UtcmVhbG0iLCJ2aWV3LWV2ZW50cyIsInZpZXctdXNlcnMiLCJ2aWV3LWNsaWVudHMiLCJtYW5hZ2UtYXV0aG9yaXphdGlvbiIsIm1hbmFnZS1jbGllbnRzIiwicXVlcnktZ3JvdXBzIl19LCJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX0sImVvZXBjYS1yZWFsbSI6eyJyb2xlcyI6WyJ2aWV3LWlkZW50aXR5LXByb3ZpZGVycyIsInZpZXctcmVhbG0iLCJtYW5hZ2UtaWRlbnRpdHktcHJvdmlkZXJzIiwiaW1wZXJzb25hdGlvbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfX0sInNjb3BlIjoib3BlbmlkIGVtYWlsIHByb2ZpbGUiLCJzaWQiOiJlZjRlMDk5Zi0xZjA4LTQ2NzAtOGZhNi0yYjhiNzhlMDVjMzEiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6ImFkbWluIn0.FK6DhVzpCRFmef2acD2Hmc149e1GTOCGz13dZA828crFbG8j4uhpkoNpiZqdyOPmDtMQ-OebNfjTAUaOt2sS1FmEIBgb9IddcpHKNJOquRjdzQNsX09bX8pFUq1haGwKh6_QmABNOBcT-kQNDSZO-aq7-8FoO9PYa0GWvBRcbcx0W_ngyb7xHglaZTElzcDPBcUTW6llVTTTFygn55smwdxTZ7-tEsMVGM5gNuHwJyLB51HI5KDWrwgUm1hqhhRzvcoutDEAB_HSEXGNNeF7fjP9Qx6q04b7fKOTtnIlXsu3oYW4va9y754llMSJ7w8U-y7yI6Tm2UdNMdYqju7hAA \\ -c admin-cli \\ --id = myservice-gatekeeper \\ --name = \"MyService Gatekeeper\" \\ --secret = changeme \\ --description = \"Client to be used by MyService Gatekeeper\" \\ --resource = \"Eric space\" --uris = /eric/* --users = eric \\ --resource = \"Alice space\" --uris = /alice/* --users = alice \\ --resource = \"Admin space\" --uris = /admin/* --roles = admin","title":"create-client Helper Script"},{"location":"eoepca/identity-service/#using-identity-api","text":"Also, an API was developed to interact more easily with the Keycloak API, that allows client, resource, policies and permissions management. The API documentation can be found in its Swagger UI at the service endpoint - https://identity-api.192-168-49-2.nip.io/docs . The Identity API is best used in combination with the eoepca-portal test aide, which can be used to establish a login sesssion in the browser to the benefit of the Identity API swagger UI. See section EOEPCA Portal for details regarding deployment/configuration of the eoepca-portal .","title":"Using Identity API"},{"location":"eoepca/identity-service/#token-lifespans","text":"By default the Access Token Lifespan is 1 minute. With the current ADES (zoo-dru) implementation this presents a problem - since the access_token that is provided to the process execute request will (most likely) have expired by the time the ADES attempts to use the access_token in its call to the Workspace API to register the processing outputs. The lifespan of the token must outlive the duration of the processing execution - which we must assume can take a long time. To avoid this potential problem, the Keycloak Admin web console can be used to increase this token lifespan. Thus, the following settings are recommended to be updated following deployment\u2026 SSO Session Settings /admin/master/console/#/master/realm-settings/sessions SSO Session Idle: 1 day SSO Session Max: 1 day Tokens /admin/master/console/#/master/realm-settings/tokens Access Token Lifespan: 1 day","title":"Token Lifespans"},{"location":"eoepca/identity-service/#additional-information","text":"Additional information regarding the Identity Service can be found at: Helm Chart GitHub Repository","title":"Additional Information"},{"location":"eoepca/login-service/","text":"Login Service \u2693\ufe0e The Login Service provides the platform Authorization Server for authenticated user identity and request authorization. Helm Chart \u2693\ufe0e The Login Service is deployed via the login-service helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the login-service chart . helm install --version 1 .2.8 --values login-service-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ login-service login-service Values \u2693\ufe0e At minimum, values for the following attributes should be specified: Public hostname of the Authorization Server, e.g. auth.192-168-49-2.nip.io IP Address of the public facing reverse proxy (Nginx Ingress Controller), e.g. 192.168.49.2 Kubernetes namespace for the login-service components Initial password for the admin user Note that the password must meet the complexity: at least 6 characters and include one uppercase letter, one lowercase letter, one digit, and one special character Name of Persistent Volume Claim for login-service persistence, e.g. eoepca-userman-pvc The boolen value volumeClaim.create can be used for the PVC to be created by the helm release. This creates a volume of type host-path and, hence, is only useful for single-node development usage. TLS Certificate Provider, e.g. letsencrypt-production Example login-service-values.yaml \u2026 global : domain : auth.192-168-49-2.nip.io nginxIp : 192.168.49.2 namespace : um volumeClaim : name : eoepca-userman-pvc create : false config : domain : auth.192-168-49-2.nip.io adminPass : Chang3me! ldapPass : Chang3me! volumeClaim : name : eoepca-userman-pvc opendj : volumeClaim : name : eoepca-userman-pvc resources : requests : cpu : 100m memory : 300Mi oxauth : volumeClaim : name : eoepca-userman-pvc resources : requests : cpu : 100m memory : 1000Mi oxtrust : volumeClaim : name : eoepca-userman-pvc resources : requests : cpu : 100m memory : 1500Mi oxpassport : resources : requests : cpu : 100m memory : 100Mi nginx : ingress : annotations : cert-manager.io/cluster-issuer : letsencrypt-production hosts : - auth.192-168-49-2.nip.io tls : - hosts : - auth.192-168-49-2.nip.io secretName : login-service-tls Note The resources: above have been limited for the benefit of a minikube deployment. For a production deployment the values should be tuned (upwards) according to operational needs. Post-deployment Manual Steps \u2693\ufe0e The deployment of the Login Service has been designed, as far as possible, to automate the configuration. However, there remain some steps that must be performed manually after the scripted deployment has completed\u2026 Configure UMA Resource Lifetime Configure Operator user UMA Resource Lifetime \u2693\ufe0e The Login Service maintains a background service that \u2018cleans\u2019 UMA resources that are older than aa certain age - by default 30 days ( 2592000 secs). This lifetime does not fit the approach we are adopting, and so we must update this lifetime value to avoid the unexpected removal of UMA resources that would cause unexpected failures in policy enforcement. In a browser, navigate to the Login Service (Gluu) - https://auth.192-168-49-2.nip.io/ - and login as the admin user Open Configuration -> JSON Configuration -> OxAuth Configuration Search for the setting umaResourceLifetime Update the values of umaResourceLifetime to 2147483647 Select to Save Configuration Restart the oxauth deployment\u2026 kubectl -n um rollout restart deploy/login-service-oxauth Configure Operator user \u2693\ufe0e The default resource protection establishes policy in which \u2018operator\u2019 privilege is required for some services, such as the Workspace API. Thus, we need to configure a user with this privilege. For convenience we add this attribute to the built-in admin user - but alternatively you may choose to create a new user for this role. In a browser, navigate to the Login Service (Gluu) - https://auth.192-168-49-2.nip.io/ - and login as the admin user Select Users -> Manage People and search for user admin For user admin select Available User Claims -> gluuCustomPerson Select Is Operator and ensure the value is set True Select Update to confirm Login Service Usage \u2693\ufe0e Once the deployment has been completed successfully, the Login Service is accessed at the endpoint https://auth.192-168-49-2.nip.io/ , configured by your domain - e.g. https://auth.192-168-49-2.nip.io/ . Login as the admin user with the credentials configured in the helm values - ref. adminPass / ldapPass . Typical first actions to undertake through the Gluu web interface include creation of users and clients. Additional Information \u2693\ufe0e Additional information regarding the Login Service can be found at: Helm Chart Wiki GitHub Repository","title":"Login Service"},{"location":"eoepca/login-service/#login-service","text":"The Login Service provides the platform Authorization Server for authenticated user identity and request authorization.","title":"Login Service"},{"location":"eoepca/login-service/#helm-chart","text":"The Login Service is deployed via the login-service helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the login-service chart . helm install --version 1 .2.8 --values login-service-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ login-service login-service","title":"Helm Chart"},{"location":"eoepca/login-service/#values","text":"At minimum, values for the following attributes should be specified: Public hostname of the Authorization Server, e.g. auth.192-168-49-2.nip.io IP Address of the public facing reverse proxy (Nginx Ingress Controller), e.g. 192.168.49.2 Kubernetes namespace for the login-service components Initial password for the admin user Note that the password must meet the complexity: at least 6 characters and include one uppercase letter, one lowercase letter, one digit, and one special character Name of Persistent Volume Claim for login-service persistence, e.g. eoepca-userman-pvc The boolen value volumeClaim.create can be used for the PVC to be created by the helm release. This creates a volume of type host-path and, hence, is only useful for single-node development usage. TLS Certificate Provider, e.g. letsencrypt-production Example login-service-values.yaml \u2026 global : domain : auth.192-168-49-2.nip.io nginxIp : 192.168.49.2 namespace : um volumeClaim : name : eoepca-userman-pvc create : false config : domain : auth.192-168-49-2.nip.io adminPass : Chang3me! ldapPass : Chang3me! volumeClaim : name : eoepca-userman-pvc opendj : volumeClaim : name : eoepca-userman-pvc resources : requests : cpu : 100m memory : 300Mi oxauth : volumeClaim : name : eoepca-userman-pvc resources : requests : cpu : 100m memory : 1000Mi oxtrust : volumeClaim : name : eoepca-userman-pvc resources : requests : cpu : 100m memory : 1500Mi oxpassport : resources : requests : cpu : 100m memory : 100Mi nginx : ingress : annotations : cert-manager.io/cluster-issuer : letsencrypt-production hosts : - auth.192-168-49-2.nip.io tls : - hosts : - auth.192-168-49-2.nip.io secretName : login-service-tls Note The resources: above have been limited for the benefit of a minikube deployment. For a production deployment the values should be tuned (upwards) according to operational needs.","title":"Values"},{"location":"eoepca/login-service/#post-deployment-manual-steps","text":"The deployment of the Login Service has been designed, as far as possible, to automate the configuration. However, there remain some steps that must be performed manually after the scripted deployment has completed\u2026 Configure UMA Resource Lifetime Configure Operator user","title":"Post-deployment Manual Steps"},{"location":"eoepca/login-service/#uma-resource-lifetime","text":"The Login Service maintains a background service that \u2018cleans\u2019 UMA resources that are older than aa certain age - by default 30 days ( 2592000 secs). This lifetime does not fit the approach we are adopting, and so we must update this lifetime value to avoid the unexpected removal of UMA resources that would cause unexpected failures in policy enforcement. In a browser, navigate to the Login Service (Gluu) - https://auth.192-168-49-2.nip.io/ - and login as the admin user Open Configuration -> JSON Configuration -> OxAuth Configuration Search for the setting umaResourceLifetime Update the values of umaResourceLifetime to 2147483647 Select to Save Configuration Restart the oxauth deployment\u2026 kubectl -n um rollout restart deploy/login-service-oxauth","title":"UMA Resource Lifetime"},{"location":"eoepca/login-service/#configure-operator-user","text":"The default resource protection establishes policy in which \u2018operator\u2019 privilege is required for some services, such as the Workspace API. Thus, we need to configure a user with this privilege. For convenience we add this attribute to the built-in admin user - but alternatively you may choose to create a new user for this role. In a browser, navigate to the Login Service (Gluu) - https://auth.192-168-49-2.nip.io/ - and login as the admin user Select Users -> Manage People and search for user admin For user admin select Available User Claims -> gluuCustomPerson Select Is Operator and ensure the value is set True Select Update to confirm","title":"Configure Operator user"},{"location":"eoepca/login-service/#login-service-usage","text":"Once the deployment has been completed successfully, the Login Service is accessed at the endpoint https://auth.192-168-49-2.nip.io/ , configured by your domain - e.g. https://auth.192-168-49-2.nip.io/ . Login as the admin user with the credentials configured in the helm values - ref. adminPass / ldapPass . Typical first actions to undertake through the Gluu web interface include creation of users and clients.","title":"Login Service Usage"},{"location":"eoepca/login-service/#additional-information","text":"Additional information regarding the Login Service can be found at: Helm Chart Wiki GitHub Repository","title":"Additional Information"},{"location":"eoepca/pdp/","text":"Policy Decision Point \u2693\ufe0e The Policy Decision Point (PDP) provides the platform policy database and associated service for access policy decision requests. Helm Chart \u2693\ufe0e The PDP is deployed via the pdp-engine helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the pdp-engine chart . helm install --version 1 .1.12 --values pdp-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ pdp pdp-engine Values \u2693\ufe0e At minimum, values for the following attributes should be specified: Public hostname of the Authorization Server, e.g. auth.192-168-49-2.nip.io IP Address of the public facing reverse proxy (Nginx Ingress Controller), e.g. 192.168.49.2 Name of Persistent Volume Claim for pdp-engine persistence, e.g. eoepca-userman-pvc The boolen value volumeClaim.create can be used for the PVC to be created by the helm release. This creates a volume of type host-path and, hence, is only useful for single-node development usage. Example pdp-values.yaml \u2026 global : nginxIp : 192.168.49.2 domain : auth.192-168-49-2.nip.io volumeClaim : name : eoepca-userman-pvc create : false Additional Information \u2693\ufe0e Additional information regarding the PDP can be found at: Helm Chart Wiki GitHub Repository","title":"Policy Decision Point"},{"location":"eoepca/pdp/#policy-decision-point","text":"The Policy Decision Point (PDP) provides the platform policy database and associated service for access policy decision requests.","title":"Policy Decision Point"},{"location":"eoepca/pdp/#helm-chart","text":"The PDP is deployed via the pdp-engine helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the pdp-engine chart . helm install --version 1 .1.12 --values pdp-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ pdp pdp-engine","title":"Helm Chart"},{"location":"eoepca/pdp/#values","text":"At minimum, values for the following attributes should be specified: Public hostname of the Authorization Server, e.g. auth.192-168-49-2.nip.io IP Address of the public facing reverse proxy (Nginx Ingress Controller), e.g. 192.168.49.2 Name of Persistent Volume Claim for pdp-engine persistence, e.g. eoepca-userman-pvc The boolen value volumeClaim.create can be used for the PVC to be created by the helm release. This creates a volume of type host-path and, hence, is only useful for single-node development usage. Example pdp-values.yaml \u2026 global : nginxIp : 192.168.49.2 domain : auth.192-168-49-2.nip.io volumeClaim : name : eoepca-userman-pvc create : false","title":"Values"},{"location":"eoepca/pdp/#additional-information","text":"Additional information regarding the PDP can be found at: Helm Chart Wiki GitHub Repository","title":"Additional Information"},{"location":"eoepca/persistence/","text":"Persistence \u2693\ufe0e Overview \u2693\ufe0e The EOEPCA building-blocks rely upon Kubernetes Persistent Volumes for their component persistence. Components integrate with the storage provided in the cluster by means of configurable Persistent Volume Claims and/or dynamic Storage Class that are specfied as values at time of deployment. Some components require storage of type ReadWriteMany - which, for a multi-node cluster, implies a network-based storage solution. Note Local CLuster Storage For the purposes of the Scripted Deployment , the default Storage Class included with the local Kubernetes distribution can be used for all storage concerns - e.g. standard for minikube which provides the ReadWriteMany persistence that is required by the ADES. ReadWriteMany Storage \u2693\ufe0e For the EOEPCA development deployment, an NFS server has been established to provide the persistence layer for ReadWriteMany storage. Pre-defined Persistent Volume Claims \u2693\ufe0e The EOEPCA development deployment establishes the following pre-defined Persistent Volume Claims, to provide a simple storage architecture that is organised around the \u2018domain areas\u2019 into which the Reference Implementation is split. Resource Managment ( resman ) - persistentvolumeclaim/eoepca-resman-pvc Processing & Chaining ( proc ) - persistentvolumeclaim/eoepca-proc-pvc User Management ( userman ) - persistentvolumeclaim/eoepca-userman-pvc NOTE that this is offered only as an example thay suits the approach of the development team. Each building-block has configuration through which its persistence (PV/PVC) can be configured according the needs of the deployment. The following Kubernetes yaml provides an example of provisioning such domain-specific PersistentVolumeClaims within the cluster - in this case using the minikube built-in storage-class standard for dynamic provisioning\u2026 --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: eoepca-proc-pvc namespace: proc spec: accessModes: - ReadWriteMany storageClassName: standard resources: requests: storage: 5Gi --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: eoepca-resman-pvc namespace: rm spec: accessModes: - ReadWriteMany storageClassName: standard resources: requests: storage: 5Gi --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: eoepca-userman-pvc namespace: um spec: accessModes: - ReadWriteMany storageClassName: standard resources: requests: storage: 5Gi Once established, these PersistentVolumeClaims are then referenced within the deployment configurations of the building-blocks. Dynamic ReadWriteMany Storage Provisioning \u2693\ufe0e In addition to the pre-defined PV/PVCs, the EOEPCA Reference Implementation also defines NFS-based storage classes for dynamic storage provisioning: managed-nfs-storage With a Reclaim Policy of Delete . managed-nfs-storage-retain With a Reclaim Policy of Retain . The building-blocks simply reference the required Storage Class in their volume specifications, to receive a Persistent Volume Claim that is dynamically provisioned at deployment time. This is acheived through the nfs-provisioner helm chart , with the following typical configurations\u2026 Reclaim Policy Delete \u2026 provisionerName : nfs-storage storageClass : name : managed-nfs-storage create : true reclaimPolicy : Delete archiveOnDelete : false allowVolumeExpansion : true nfs : server : \"<your-nfs-ip-address-here>\" path : /data/dynamic # your NFS server path here Reclaim Policy Retain \u2026 provisionerName : nfs-storage-retain storageClass : name : managed-nfs-storage-retain create : true reclaimPolicy : Retain allowVolumeExpansion : true nfs : server : \"<your-nfs-ip-address-here>\" path : /data/dynamic # your NFS server path here Clustered Storage Solutions \u2693\ufe0e Clustered storage approaches offer an alternative to NFS. Clustered Storage provides a network-attached storage through a set of commodity hosts whose storage is aggregated to form a distributed file-system. Capacity is scaled by adding additional nodes or adding additional storage to the existing nodes. In the context of a multi-node Kubernetes cluster, then it is typical that the same commodity nodes provide both the cluster members and storage resources, i.e. the clustered storage is spread across the Kubernetes worker nodes. Candidate clustered storage solutions include: GlusterFS GlusterFS is deployed as an operating system service across each node participating in the storage solution. Thus, with GlusterFS, the distributed storage nodes do not need to be one-and-the-same with the compute (cluster) nodes \u2013 although this may preferably be the case. Longhorn Longhorn offers a solution that is similar to that of GlusterFS, except that Longhorn is \u2018cloud-native\u2019 in that its service layer deploys within the Kubernetes cluster itself. Thus, the storage nodes are also the cluster compute nodes by design. All things being equal, Longhorn is recommended as the best approach for Kubernetes clusters.","title":"Persistence"},{"location":"eoepca/persistence/#persistence","text":"","title":"Persistence"},{"location":"eoepca/persistence/#overview","text":"The EOEPCA building-blocks rely upon Kubernetes Persistent Volumes for their component persistence. Components integrate with the storage provided in the cluster by means of configurable Persistent Volume Claims and/or dynamic Storage Class that are specfied as values at time of deployment. Some components require storage of type ReadWriteMany - which, for a multi-node cluster, implies a network-based storage solution. Note Local CLuster Storage For the purposes of the Scripted Deployment , the default Storage Class included with the local Kubernetes distribution can be used for all storage concerns - e.g. standard for minikube which provides the ReadWriteMany persistence that is required by the ADES.","title":"Overview"},{"location":"eoepca/persistence/#readwritemany-storage","text":"For the EOEPCA development deployment, an NFS server has been established to provide the persistence layer for ReadWriteMany storage.","title":"ReadWriteMany Storage"},{"location":"eoepca/persistence/#pre-defined-persistent-volume-claims","text":"The EOEPCA development deployment establishes the following pre-defined Persistent Volume Claims, to provide a simple storage architecture that is organised around the \u2018domain areas\u2019 into which the Reference Implementation is split. Resource Managment ( resman ) - persistentvolumeclaim/eoepca-resman-pvc Processing & Chaining ( proc ) - persistentvolumeclaim/eoepca-proc-pvc User Management ( userman ) - persistentvolumeclaim/eoepca-userman-pvc NOTE that this is offered only as an example thay suits the approach of the development team. Each building-block has configuration through which its persistence (PV/PVC) can be configured according the needs of the deployment. The following Kubernetes yaml provides an example of provisioning such domain-specific PersistentVolumeClaims within the cluster - in this case using the minikube built-in storage-class standard for dynamic provisioning\u2026 --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: eoepca-proc-pvc namespace: proc spec: accessModes: - ReadWriteMany storageClassName: standard resources: requests: storage: 5Gi --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: eoepca-resman-pvc namespace: rm spec: accessModes: - ReadWriteMany storageClassName: standard resources: requests: storage: 5Gi --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: eoepca-userman-pvc namespace: um spec: accessModes: - ReadWriteMany storageClassName: standard resources: requests: storage: 5Gi Once established, these PersistentVolumeClaims are then referenced within the deployment configurations of the building-blocks.","title":"Pre-defined Persistent Volume Claims"},{"location":"eoepca/persistence/#dynamic-readwritemany-storage-provisioning","text":"In addition to the pre-defined PV/PVCs, the EOEPCA Reference Implementation also defines NFS-based storage classes for dynamic storage provisioning: managed-nfs-storage With a Reclaim Policy of Delete . managed-nfs-storage-retain With a Reclaim Policy of Retain . The building-blocks simply reference the required Storage Class in their volume specifications, to receive a Persistent Volume Claim that is dynamically provisioned at deployment time. This is acheived through the nfs-provisioner helm chart , with the following typical configurations\u2026 Reclaim Policy Delete \u2026 provisionerName : nfs-storage storageClass : name : managed-nfs-storage create : true reclaimPolicy : Delete archiveOnDelete : false allowVolumeExpansion : true nfs : server : \"<your-nfs-ip-address-here>\" path : /data/dynamic # your NFS server path here Reclaim Policy Retain \u2026 provisionerName : nfs-storage-retain storageClass : name : managed-nfs-storage-retain create : true reclaimPolicy : Retain allowVolumeExpansion : true nfs : server : \"<your-nfs-ip-address-here>\" path : /data/dynamic # your NFS server path here","title":"Dynamic ReadWriteMany Storage Provisioning"},{"location":"eoepca/persistence/#clustered-storage-solutions","text":"Clustered storage approaches offer an alternative to NFS. Clustered Storage provides a network-attached storage through a set of commodity hosts whose storage is aggregated to form a distributed file-system. Capacity is scaled by adding additional nodes or adding additional storage to the existing nodes. In the context of a multi-node Kubernetes cluster, then it is typical that the same commodity nodes provide both the cluster members and storage resources, i.e. the clustered storage is spread across the Kubernetes worker nodes. Candidate clustered storage solutions include: GlusterFS GlusterFS is deployed as an operating system service across each node participating in the storage solution. Thus, with GlusterFS, the distributed storage nodes do not need to be one-and-the-same with the compute (cluster) nodes \u2013 although this may preferably be the case. Longhorn Longhorn offers a solution that is similar to that of GlusterFS, except that Longhorn is \u2018cloud-native\u2019 in that its service layer deploys within the Kubernetes cluster itself. Thus, the storage nodes are also the cluster compute nodes by design. All things being equal, Longhorn is recommended as the best approach for Kubernetes clusters.","title":"Clustered Storage Solutions"},{"location":"eoepca/registration-api/","text":"Registration API \u2693\ufe0e The Registration API provides a REST API through which resources can be registered with both the Resource Catalogue and (as applicable) with the Data Access services. Helm Chart \u2693\ufe0e The Registration API is deployed via the rm-registration-api helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the rm-registration-api chart . helm install --version 1 .4.0 --values registration-api-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ registration-api rm-registration-api Values \u2693\ufe0e The Registration API supports many values to configure the service - as described in the Values section of the chart README . Typically, values for the following attributes may be specified: The fully-qualified public URL for the service (optional) Specification of Ingress for reverse-proxy access to the service Note that this is only required in the case that the Registration API will not be protected by the identity-gatekeeper component - ref. Resource Protection . Otherwise the ingress will be handled by the identity-gatekeeper - use ingress.enabled: false . Values for integration with the workspace-api and data-access services Example registration-api-values.yaml \u2026 fullnameOverride : registration-api ingress : enabled : false hosts : - host : registration-api-open.192-168-49-2.nip.io paths : [ \"/\" ] tls : - hosts : - registration-api-open.192-168-49-2.nip.io secretName : registration-api-tls # some values for the workspace API workspaceK8sNamespace : rm redisServiceName : \"data-access-redis-master\" Protection \u2693\ufe0e As described in section Resource Protection (Keycloak) , the identity-gatekeeper component can be inserted into the request path of the registration-api service to provide access authorization decisions Gatekeeper \u2693\ufe0e Gatekeeper is deployed using its helm chart\u2026 helm install registration-api-protection identity-gatekeeper -f registration-api-protection-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ --namespace \"rm\" --create-namespace \\ --version 1 .0.11 The identity-gatekeeper must be configured with the values applicable to the registration-api - in particular the specific ingress requirements for the registration-api backend service\u2026 Example registration-api-protection-values.yaml \u2026 fullnameOverride : registration-api-protection config : client-id : registration-api discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io targetService : host : registration-api.192-168-49-2.nip.io name : registration-api port : number : 8080 secrets : # Values for secret 'registration-api-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production nginx.ingress.kubernetes.io/proxy-read-timeout : \"600\" nginx.ingress.kubernetes.io/enable-cors : \"true\" serverSnippets : custom : |- # Open access... location ~ ^/ { proxy_pass {{ include \"identity-gatekeeper.targetUrl\" . }}$request_uri; } Keycloak Client \u2693\ufe0e The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. client-id: registration-api above. This can be created with the create-client helper script, as descirbed in section Client Registration . For example\u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = registration-api \\ --name = \"Registration API Gatekeeper\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by Registration API Gatekeeper\" Additional Information \u2693\ufe0e Additional information regarding the Registration API can be found at: Helm Chart GitHub Repository","title":"Registration API"},{"location":"eoepca/registration-api/#registration-api","text":"The Registration API provides a REST API through which resources can be registered with both the Resource Catalogue and (as applicable) with the Data Access services.","title":"Registration API"},{"location":"eoepca/registration-api/#helm-chart","text":"The Registration API is deployed via the rm-registration-api helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the rm-registration-api chart . helm install --version 1 .4.0 --values registration-api-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ registration-api rm-registration-api","title":"Helm Chart"},{"location":"eoepca/registration-api/#values","text":"The Registration API supports many values to configure the service - as described in the Values section of the chart README . Typically, values for the following attributes may be specified: The fully-qualified public URL for the service (optional) Specification of Ingress for reverse-proxy access to the service Note that this is only required in the case that the Registration API will not be protected by the identity-gatekeeper component - ref. Resource Protection . Otherwise the ingress will be handled by the identity-gatekeeper - use ingress.enabled: false . Values for integration with the workspace-api and data-access services Example registration-api-values.yaml \u2026 fullnameOverride : registration-api ingress : enabled : false hosts : - host : registration-api-open.192-168-49-2.nip.io paths : [ \"/\" ] tls : - hosts : - registration-api-open.192-168-49-2.nip.io secretName : registration-api-tls # some values for the workspace API workspaceK8sNamespace : rm redisServiceName : \"data-access-redis-master\"","title":"Values"},{"location":"eoepca/registration-api/#protection","text":"As described in section Resource Protection (Keycloak) , the identity-gatekeeper component can be inserted into the request path of the registration-api service to provide access authorization decisions","title":"Protection"},{"location":"eoepca/registration-api/#gatekeeper","text":"Gatekeeper is deployed using its helm chart\u2026 helm install registration-api-protection identity-gatekeeper -f registration-api-protection-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ --namespace \"rm\" --create-namespace \\ --version 1 .0.11 The identity-gatekeeper must be configured with the values applicable to the registration-api - in particular the specific ingress requirements for the registration-api backend service\u2026 Example registration-api-protection-values.yaml \u2026 fullnameOverride : registration-api-protection config : client-id : registration-api discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io targetService : host : registration-api.192-168-49-2.nip.io name : registration-api port : number : 8080 secrets : # Values for secret 'registration-api-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production nginx.ingress.kubernetes.io/proxy-read-timeout : \"600\" nginx.ingress.kubernetes.io/enable-cors : \"true\" serverSnippets : custom : |- # Open access... location ~ ^/ { proxy_pass {{ include \"identity-gatekeeper.targetUrl\" . }}$request_uri; }","title":"Gatekeeper"},{"location":"eoepca/registration-api/#keycloak-client","text":"The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. client-id: registration-api above. This can be created with the create-client helper script, as descirbed in section Client Registration . For example\u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = registration-api \\ --name = \"Registration API Gatekeeper\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by Registration API Gatekeeper\"","title":"Keycloak Client"},{"location":"eoepca/registration-api/#additional-information","text":"Additional information regarding the Registration API can be found at: Helm Chart GitHub Repository","title":"Additional Information"},{"location":"eoepca/resource-catalogue/","text":"Resource Catalogue \u2693\ufe0e The Resource Catalogue provides a standards-based EO metadata catalogue that includes support for OGC CSW / API Records, STAC and OpenSearch. Helm Chart \u2693\ufe0e The Resource Catalogue is deployed via the rm-resource-catalogue helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the rm-resource-catalogue chart . helm install --version 1 .4.0 --values resource-catalogue-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ resource-catalogue rm-resource-catalogue Values \u2693\ufe0e The Resource Catalogue supports many values to configure the service - as described in the Values section of the chart README . Typically, values for the following attributes may be specified: The fully-qualified public URL for the service Dynamic provisioning StorageClass for database persistence (optional) Specification of Ingress for reverse-proxy access to the service Note that this is only required in the case that the Resource Catalogue will not be protected by the identity-gatekeeper component - ref. Resource Protection . Otherwise the ingress will be handled by the identity-gatekeeper - use ingress.enabled: false . Metadata describing the Catalogue instance Tuning configuration for PostgreSQL - see values db.config.XXX . Example resource-catalogue-values.yaml \u2026 global : namespace : rm # For protected access disable this ingress, and rely upon the identity-gatekeeper # for ingress with protection. ingress : # Enabled for unprotected 'open' access to the resource-catalogue. enabled : true name : resource-catalogue host : resource-catalogue.192-168-49-2.nip.io tls_host : resource-catalogue.192-168-49-2.nip.io tls_secret_name : resource-catalogue-tls annotations : cert-manager.io/cluster-issuer : letsencrypt-production db : volume_storage_type : standard # config: # enabled: true # shared_buffers: 2GB # effective_cache_size: 6GB # maintenance_work_mem: 512MB # checkpoint_completion_target: 0.9 # wal_buffers: 16MB # default_statistics_target: 100 # random_page_cost: 4 # work_mem: 4MB # cpu_tuple_cost: 0.4 pycsw : config : server : url : https://resource-catalogue.192-168-49-2.nip.io/ manager : transactions : \"true\" allowed_ips : \"*\" Note The above example values enable transactions (write-access) to the catalogue from any IP address. This is convenient for testing/demonstration of the capability, but should be disbaled or restricted for operational deployments. Protection \u2693\ufe0e As described in section Resource Protection (Keycloak) , the identity-gatekeeper component can be inserted into the request path of the resource-catalogue service to provide access authorization decisions Gatekeeper \u2693\ufe0e Gatekeeper is deployed using its helm chart\u2026 helm install resource-catalogue-protection identity-gatekeeper -f resource-catalogue-protection-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ --namespace \"rm\" --create-namespace \\ --version 1 .0.11 The identity-gatekeeper must be configured with the values applicable to the resource-catalogue - in particular the specific ingress requirements for the resource-catalogue-service \u2026 Example resource-catalogue-protection-values.yaml \u2026 fullnameOverride : resource-catalogue-protection config : client-id : resource-catalogue discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io targetService : host : resource-catalogue.192-168-49-2.nip.io name : resource-catalogue-service port : number : 80 secrets : # Values for secret 'resource-catalogue-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production nginx.ingress.kubernetes.io/proxy-read-timeout : \"600\" nginx.ingress.kubernetes.io/enable-cors : \"true\" serverSnippets : custom : |- # Open access... location ~ ^/ { proxy_pass {{ include \"identity-gatekeeper.targetUrl\" . }}$request_uri; } Keycloak Client \u2693\ufe0e The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. client-id: resource-catalogue above. This can be created with the create-client helper script, as descirbed in section Client Registration . For example\u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = resource-catalogue \\ --name = \"Resource Catalogue Gatekeeper\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by Resource Catalogue Gatekeeper\" Resource Catalogue Usage \u2693\ufe0e The Resource Catalogue is initially populated during the initialisation of the Data Access service. See section Data-layer Configuration . The Resource Catalogue is accessed at the endpoint https://resource-catalogue.192-168-49-2.nip.io/ , configured by your domain - e.g. https://resource-catalogue.192-168-49-2.nip.io/ . Loading Records \u2693\ufe0e As described in the pycsw documentation , ISO XML records can be loaded into the resource-catalogue using the pycsw-admin.py admin utility\u2026 pycsw-admin.py load_records -c /path/to/cfg -p /path/to/records The /path/to/records can either be a single metadata file, or a directory containing multiple metadata files. This is most easily achieved via connection to the pycsw pod, which includes the pycsw-admin.py utility and the pycsw configuration file at /etc/pycsw/pycsw.cfg \u2026 kubectl -n rm cp \"<metadata-file-or-directory>\" \"<pycsw-pod-name>\" :/tmp/metadata kubectl -n rm exec -i \"<pycsw-pod-name>\" -- pycsw-admin.py load-records -c /etc/pycsw/pycsw.cfg -p /tmp/metadata The name of the pycsw pod can be obtained using kubectl \u2026 kubectl -n rm get pod --selector = 'io.kompose.service=pycsw' --output = jsonpath ={ .items [ 0 ] .metadata.name } To facilitate the loading of records via the pycsw pod, a helper script load-records has been provided in the git repository that hosts this document \u2026 git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide cd deployment-guide ./deploy/bin/load-records \"<metadata-file-or-directory>\" The helper script identifies the pycsw pod, copies the metadata files to the pod, and runs pycsw-admin.py load-records within the pod to load the records. Additional Information \u2693\ufe0e Additional information regarding the Resource Catalogue can be found at: Helm Chart pycsw Documentation GitHub Repository","title":"Resource Catalogue"},{"location":"eoepca/resource-catalogue/#resource-catalogue","text":"The Resource Catalogue provides a standards-based EO metadata catalogue that includes support for OGC CSW / API Records, STAC and OpenSearch.","title":"Resource Catalogue"},{"location":"eoepca/resource-catalogue/#helm-chart","text":"The Resource Catalogue is deployed via the rm-resource-catalogue helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the rm-resource-catalogue chart . helm install --version 1 .4.0 --values resource-catalogue-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ resource-catalogue rm-resource-catalogue","title":"Helm Chart"},{"location":"eoepca/resource-catalogue/#values","text":"The Resource Catalogue supports many values to configure the service - as described in the Values section of the chart README . Typically, values for the following attributes may be specified: The fully-qualified public URL for the service Dynamic provisioning StorageClass for database persistence (optional) Specification of Ingress for reverse-proxy access to the service Note that this is only required in the case that the Resource Catalogue will not be protected by the identity-gatekeeper component - ref. Resource Protection . Otherwise the ingress will be handled by the identity-gatekeeper - use ingress.enabled: false . Metadata describing the Catalogue instance Tuning configuration for PostgreSQL - see values db.config.XXX . Example resource-catalogue-values.yaml \u2026 global : namespace : rm # For protected access disable this ingress, and rely upon the identity-gatekeeper # for ingress with protection. ingress : # Enabled for unprotected 'open' access to the resource-catalogue. enabled : true name : resource-catalogue host : resource-catalogue.192-168-49-2.nip.io tls_host : resource-catalogue.192-168-49-2.nip.io tls_secret_name : resource-catalogue-tls annotations : cert-manager.io/cluster-issuer : letsencrypt-production db : volume_storage_type : standard # config: # enabled: true # shared_buffers: 2GB # effective_cache_size: 6GB # maintenance_work_mem: 512MB # checkpoint_completion_target: 0.9 # wal_buffers: 16MB # default_statistics_target: 100 # random_page_cost: 4 # work_mem: 4MB # cpu_tuple_cost: 0.4 pycsw : config : server : url : https://resource-catalogue.192-168-49-2.nip.io/ manager : transactions : \"true\" allowed_ips : \"*\" Note The above example values enable transactions (write-access) to the catalogue from any IP address. This is convenient for testing/demonstration of the capability, but should be disbaled or restricted for operational deployments.","title":"Values"},{"location":"eoepca/resource-catalogue/#protection","text":"As described in section Resource Protection (Keycloak) , the identity-gatekeeper component can be inserted into the request path of the resource-catalogue service to provide access authorization decisions","title":"Protection"},{"location":"eoepca/resource-catalogue/#gatekeeper","text":"Gatekeeper is deployed using its helm chart\u2026 helm install resource-catalogue-protection identity-gatekeeper -f resource-catalogue-protection-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ --namespace \"rm\" --create-namespace \\ --version 1 .0.11 The identity-gatekeeper must be configured with the values applicable to the resource-catalogue - in particular the specific ingress requirements for the resource-catalogue-service \u2026 Example resource-catalogue-protection-values.yaml \u2026 fullnameOverride : resource-catalogue-protection config : client-id : resource-catalogue discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io targetService : host : resource-catalogue.192-168-49-2.nip.io name : resource-catalogue-service port : number : 80 secrets : # Values for secret 'resource-catalogue-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production nginx.ingress.kubernetes.io/proxy-read-timeout : \"600\" nginx.ingress.kubernetes.io/enable-cors : \"true\" serverSnippets : custom : |- # Open access... location ~ ^/ { proxy_pass {{ include \"identity-gatekeeper.targetUrl\" . }}$request_uri; }","title":"Gatekeeper"},{"location":"eoepca/resource-catalogue/#keycloak-client","text":"The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. client-id: resource-catalogue above. This can be created with the create-client helper script, as descirbed in section Client Registration . For example\u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = resource-catalogue \\ --name = \"Resource Catalogue Gatekeeper\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by Resource Catalogue Gatekeeper\"","title":"Keycloak Client"},{"location":"eoepca/resource-catalogue/#resource-catalogue-usage","text":"The Resource Catalogue is initially populated during the initialisation of the Data Access service. See section Data-layer Configuration . The Resource Catalogue is accessed at the endpoint https://resource-catalogue.192-168-49-2.nip.io/ , configured by your domain - e.g. https://resource-catalogue.192-168-49-2.nip.io/ .","title":"Resource Catalogue Usage"},{"location":"eoepca/resource-catalogue/#loading-records","text":"As described in the pycsw documentation , ISO XML records can be loaded into the resource-catalogue using the pycsw-admin.py admin utility\u2026 pycsw-admin.py load_records -c /path/to/cfg -p /path/to/records The /path/to/records can either be a single metadata file, or a directory containing multiple metadata files. This is most easily achieved via connection to the pycsw pod, which includes the pycsw-admin.py utility and the pycsw configuration file at /etc/pycsw/pycsw.cfg \u2026 kubectl -n rm cp \"<metadata-file-or-directory>\" \"<pycsw-pod-name>\" :/tmp/metadata kubectl -n rm exec -i \"<pycsw-pod-name>\" -- pycsw-admin.py load-records -c /etc/pycsw/pycsw.cfg -p /tmp/metadata The name of the pycsw pod can be obtained using kubectl \u2026 kubectl -n rm get pod --selector = 'io.kompose.service=pycsw' --output = jsonpath ={ .items [ 0 ] .metadata.name } To facilitate the loading of records via the pycsw pod, a helper script load-records has been provided in the git repository that hosts this document \u2026 git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide cd deployment-guide ./deploy/bin/load-records \"<metadata-file-or-directory>\" The helper script identifies the pycsw pod, copies the metadata files to the pod, and runs pycsw-admin.py load-records within the pod to load the records.","title":"Loading Records"},{"location":"eoepca/resource-catalogue/#additional-information","text":"Additional information regarding the Resource Catalogue can be found at: Helm Chart pycsw Documentation GitHub Repository","title":"Additional Information"},{"location":"eoepca/resource-protection-gluu/","text":"Resource Protection (Gluu) \u2693\ufe0e EOEPCA defines Building Blocks within a micro-service architecture. The services are subject to protection within an Identity and Access Management (IAM) approach that includes: Login Service (Authorization Server) Policy Decision Point (PDP) Policy Enforcement Point (PEP) Building Blocks that act as a Resource Server are individually protected by a Policy Enforcement Point (PEP). The PEP enforces the authorization decision in collaboration with the Login Service and Policy Decision Point (PDP). The PEP expects to interface to a client (user agent, e.g. browser) using User Managed Access (UMA) flows. It is not typical for a client to support UMA flows , and so the PEP can be deployed with a companion UMA User Agent component that interfaces between the client and the PEP, and performs the UMA Flow on behalf of the client. The Resource Guard is a \u2018convenience\u2019 component that deploys the PEP & UMA User Agent as a cooperating pair. The Resource Guard \u2018inserts itself\u2019 into the request path of the target Resource Server using the auth_request facility offered by Nginx. Thus, the Resource Guard deploys with an Ingress specification that: Configures the auth_request module to defer access authorization to the uma-user-agent service Configures the ingress rules (host/path) for the target Resource Server Helm Chart \u2693\ufe0e The Resource Guard is deployed via the resource-guard helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the resource-guard chart . It is expected to deploy multiple instances of the Resource Guard chart, one for each Resource Server to be protected. helm install --version 1 .3.1 --values myservice-guard-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ myservice-guard resource-guard Values \u2693\ufe0e The helm chart is deployed with values that are passed through to the subcharts for the pep-engine and uma-user-agent . Typical values to be specified include: Host/domain details for the Login Service and PDP, e.g. auth.192-168-49-2.nip.io IP Address of the public facing reverse proxy (Nginx Ingress Controller), e.g. 192.168.49.2 Name of Persistent Volume Claim for pep-engine persistence, e.g. myservice-pep-pvc TLS Certificate Provider, e.g. letsencrypt-production Optional specification of default resources with which to initialise the policy database for the component Ingress rules definition for reverse-proxy to the target Resource Server Name of Secret that contains the client credentials used by the uma-user-agent to interface with the Login Service. See section Client Secret below Example myservice-guard-values.yaml \u2026 #--------------------------------------------------------------------------- # Global values #--------------------------------------------------------------------------- global : context : myservice domain : 192-168-49-2.nip.io nginxIp : 192.168.49.2 certManager : clusterIssuer : letsencrypt-production #--------------------------------------------------------------------------- # PEP values #--------------------------------------------------------------------------- pep-engine : configMap : asHostname : auth pdpHostname : auth customDefaultResources : - name : \"Eric's space\" description : \"Protected Access for eric to his space in myservice\" resource_uri : \"/ericspace\" scopes : [] default_owner : \"d3688daa-385d-45b0-8e04-2062e3e2cd86\" volumeClaim : name : myservice-pep-pvc create : false #--------------------------------------------------------------------------- # UMA User Agent values #--------------------------------------------------------------------------- uma-user-agent : nginxIntegration : enabled : true hosts : - host : myservice paths : - path : /(.*) service : name : myservice port : 80 - path : /(doc.*) service : name : myservice-docs port : 80 annotations : nginx.ingress.kubernetes.io/proxy-read-timeout : \"600\" nginx.ingress.kubernetes.io/enable-cors : \"true\" nginx.ingress.kubernetes.io/rewrite-target : /$1 client : credentialsSecretName : \"myservice-agent\" logging : level : \"debug\" unauthorizedResponse : 'Bearer realm=\"https://portal.192-168-49-2.nip.io/oidc/authenticate/\"' #--------------------------------------------------------------------------- # END values #--------------------------------------------------------------------------- Client Credentials \u2693\ufe0e The uma-user-agent requires Client Credentials for its interactions with the login-service . The uma-user-agent expects to read these credentials from the file client.yaml , in the form\u2026 client-id: <my-client-id> client-secret: <my-secret> Client Registration \u2693\ufe0e To obtain the Client Credentials required by the uma-user-agent it is necessary to register a client with the login-service , or use the credentials for an existing client. A helper script is provided to register a basic client and obtain the required credentials. The script is available in the deployment-guide repository , and can be obtained as follows\u2026 git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide cd deployment-guide The register-client helper script requires some command-line arguments\u2026 Usage: register_client <authorization-server-hostname> <client-name> [<redirect-uri> [<logout-uri>]] For example\u2026 ./deploy/bin/register-client auth.192-168-49-2.nip.io myclient INFO: Preparing docker image... [ done ] Client successfully registered. Make a note of the credentials: client-id: a98ba66e-e876-46e1-8619-5e130a38d1a4 client-secret: 73914cfc-c7dd-4b54-8807-ce17c3645558 Or to register OIDC redirect URLs\u2026 ./deploy/bin/register-client auth.192-168-49-2.nip.io myclient https://portal.192-168-49-2.nip.io/oidc/callback/ https://portal.192-168-49-2.nip.io/logout The script writes the \u2018client credentials\u2019 to stdout - in the expected YAML configuration file format - which can be redirected to file\u2026 ./deploy/bin/register-client auth.192-168-49-2.nip.io myclient | tee client.yaml \u2026writes the client credentials to the file client.yaml . NOTE that the register-client helper relies upon docker to build and run the script. Client Secret \u2693\ufe0e The client.yaml configuration file is made available via a Kubernetes Secret\u2026 kubectl -n myservice-ns create secret generic myservice-agent \\ --from-file = client.yaml \\ --dry-run = client -o yaml \\ > myservice-agent-secret.yaml apiVersion : v1 kind : Secret metadata : name : myservice-agent namespace : myservice-ns data : client.yaml : Y2xpZW50LWlkOiBhOThiYTY2ZS1lODc2LTQ2ZTEtODYxOS01ZTEzMGEzOGQxYTQKY2xpZW50LXNlY3JldDogNzM5MTRjZmMtYzdkZC00YjU0LTg4MDctY2UxN2MzNjQ1NTU4 The resource-guard deployment is configured with the name of the Secret through the helm chart value client.credentialsSecretName . User ID Token \u2693\ufe0e As described in the README for the Resource Guard , it is necessary for a request to a protected resource to provide the User ID Token in the request header. Obtaining the User ID Token \u2693\ufe0e In the simple case of a user with username/password held within the Login Service, the User ID Token can be obtained as follows: curl --location --request POST 'https://auth.192-168-49-2.nip.io/oxauth/restv1/token' \\ --header 'Cache-Control: no-cache' \\ --header 'Content-Type: application/x-www-form-urlencoded' \\ --data-urlencode 'scope=openid user_name is_operator' \\ --data-urlencode 'grant_type=password' \\ --data-urlencode 'username=<username>' \\ --data-urlencode 'password=<password>' \\ --data-urlencode 'client_id=<client-id>' \\ --data-urlencode 'client_secret=<client-password>' The User ID Token is included in the id_token field of the json response. Alternatively, OAuth/OIDC flows can be followed to authenticate via external identity providers. User ID Token in HTTP requests \u2693\ufe0e The Resource Guard protection supports presentation of the User ID Token via the following HTTP request headers (in order of priority)\u2026 Authorization header as a bearer token - in the form: Authorization: Bearer <token> X-User-Id header Cookie: auth_user_id=<token> Note that the name of the cookie is configurable Additional Information \u2693\ufe0e Additional information regarding the Resource Guard can be found at: Helm Chart README GitHub Repository: pep-engine uma-user-agent","title":"Resource Protection"},{"location":"eoepca/resource-protection-gluu/#resource-protection-gluu","text":"EOEPCA defines Building Blocks within a micro-service architecture. The services are subject to protection within an Identity and Access Management (IAM) approach that includes: Login Service (Authorization Server) Policy Decision Point (PDP) Policy Enforcement Point (PEP) Building Blocks that act as a Resource Server are individually protected by a Policy Enforcement Point (PEP). The PEP enforces the authorization decision in collaboration with the Login Service and Policy Decision Point (PDP). The PEP expects to interface to a client (user agent, e.g. browser) using User Managed Access (UMA) flows. It is not typical for a client to support UMA flows , and so the PEP can be deployed with a companion UMA User Agent component that interfaces between the client and the PEP, and performs the UMA Flow on behalf of the client. The Resource Guard is a \u2018convenience\u2019 component that deploys the PEP & UMA User Agent as a cooperating pair. The Resource Guard \u2018inserts itself\u2019 into the request path of the target Resource Server using the auth_request facility offered by Nginx. Thus, the Resource Guard deploys with an Ingress specification that: Configures the auth_request module to defer access authorization to the uma-user-agent service Configures the ingress rules (host/path) for the target Resource Server","title":"Resource Protection (Gluu)"},{"location":"eoepca/resource-protection-gluu/#helm-chart","text":"The Resource Guard is deployed via the resource-guard helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the resource-guard chart . It is expected to deploy multiple instances of the Resource Guard chart, one for each Resource Server to be protected. helm install --version 1 .3.1 --values myservice-guard-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ myservice-guard resource-guard","title":"Helm Chart"},{"location":"eoepca/resource-protection-gluu/#values","text":"The helm chart is deployed with values that are passed through to the subcharts for the pep-engine and uma-user-agent . Typical values to be specified include: Host/domain details for the Login Service and PDP, e.g. auth.192-168-49-2.nip.io IP Address of the public facing reverse proxy (Nginx Ingress Controller), e.g. 192.168.49.2 Name of Persistent Volume Claim for pep-engine persistence, e.g. myservice-pep-pvc TLS Certificate Provider, e.g. letsencrypt-production Optional specification of default resources with which to initialise the policy database for the component Ingress rules definition for reverse-proxy to the target Resource Server Name of Secret that contains the client credentials used by the uma-user-agent to interface with the Login Service. See section Client Secret below Example myservice-guard-values.yaml \u2026 #--------------------------------------------------------------------------- # Global values #--------------------------------------------------------------------------- global : context : myservice domain : 192-168-49-2.nip.io nginxIp : 192.168.49.2 certManager : clusterIssuer : letsencrypt-production #--------------------------------------------------------------------------- # PEP values #--------------------------------------------------------------------------- pep-engine : configMap : asHostname : auth pdpHostname : auth customDefaultResources : - name : \"Eric's space\" description : \"Protected Access for eric to his space in myservice\" resource_uri : \"/ericspace\" scopes : [] default_owner : \"d3688daa-385d-45b0-8e04-2062e3e2cd86\" volumeClaim : name : myservice-pep-pvc create : false #--------------------------------------------------------------------------- # UMA User Agent values #--------------------------------------------------------------------------- uma-user-agent : nginxIntegration : enabled : true hosts : - host : myservice paths : - path : /(.*) service : name : myservice port : 80 - path : /(doc.*) service : name : myservice-docs port : 80 annotations : nginx.ingress.kubernetes.io/proxy-read-timeout : \"600\" nginx.ingress.kubernetes.io/enable-cors : \"true\" nginx.ingress.kubernetes.io/rewrite-target : /$1 client : credentialsSecretName : \"myservice-agent\" logging : level : \"debug\" unauthorizedResponse : 'Bearer realm=\"https://portal.192-168-49-2.nip.io/oidc/authenticate/\"' #--------------------------------------------------------------------------- # END values #---------------------------------------------------------------------------","title":"Values"},{"location":"eoepca/resource-protection-gluu/#client-credentials","text":"The uma-user-agent requires Client Credentials for its interactions with the login-service . The uma-user-agent expects to read these credentials from the file client.yaml , in the form\u2026 client-id: <my-client-id> client-secret: <my-secret>","title":"Client Credentials"},{"location":"eoepca/resource-protection-gluu/#client-registration","text":"To obtain the Client Credentials required by the uma-user-agent it is necessary to register a client with the login-service , or use the credentials for an existing client. A helper script is provided to register a basic client and obtain the required credentials. The script is available in the deployment-guide repository , and can be obtained as follows\u2026 git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide cd deployment-guide The register-client helper script requires some command-line arguments\u2026 Usage: register_client <authorization-server-hostname> <client-name> [<redirect-uri> [<logout-uri>]] For example\u2026 ./deploy/bin/register-client auth.192-168-49-2.nip.io myclient INFO: Preparing docker image... [ done ] Client successfully registered. Make a note of the credentials: client-id: a98ba66e-e876-46e1-8619-5e130a38d1a4 client-secret: 73914cfc-c7dd-4b54-8807-ce17c3645558 Or to register OIDC redirect URLs\u2026 ./deploy/bin/register-client auth.192-168-49-2.nip.io myclient https://portal.192-168-49-2.nip.io/oidc/callback/ https://portal.192-168-49-2.nip.io/logout The script writes the \u2018client credentials\u2019 to stdout - in the expected YAML configuration file format - which can be redirected to file\u2026 ./deploy/bin/register-client auth.192-168-49-2.nip.io myclient | tee client.yaml \u2026writes the client credentials to the file client.yaml . NOTE that the register-client helper relies upon docker to build and run the script.","title":"Client Registration"},{"location":"eoepca/resource-protection-gluu/#client-secret","text":"The client.yaml configuration file is made available via a Kubernetes Secret\u2026 kubectl -n myservice-ns create secret generic myservice-agent \\ --from-file = client.yaml \\ --dry-run = client -o yaml \\ > myservice-agent-secret.yaml apiVersion : v1 kind : Secret metadata : name : myservice-agent namespace : myservice-ns data : client.yaml : Y2xpZW50LWlkOiBhOThiYTY2ZS1lODc2LTQ2ZTEtODYxOS01ZTEzMGEzOGQxYTQKY2xpZW50LXNlY3JldDogNzM5MTRjZmMtYzdkZC00YjU0LTg4MDctY2UxN2MzNjQ1NTU4 The resource-guard deployment is configured with the name of the Secret through the helm chart value client.credentialsSecretName .","title":"Client Secret"},{"location":"eoepca/resource-protection-gluu/#user-id-token","text":"As described in the README for the Resource Guard , it is necessary for a request to a protected resource to provide the User ID Token in the request header.","title":"User ID Token"},{"location":"eoepca/resource-protection-gluu/#obtaining-the-user-id-token","text":"In the simple case of a user with username/password held within the Login Service, the User ID Token can be obtained as follows: curl --location --request POST 'https://auth.192-168-49-2.nip.io/oxauth/restv1/token' \\ --header 'Cache-Control: no-cache' \\ --header 'Content-Type: application/x-www-form-urlencoded' \\ --data-urlencode 'scope=openid user_name is_operator' \\ --data-urlencode 'grant_type=password' \\ --data-urlencode 'username=<username>' \\ --data-urlencode 'password=<password>' \\ --data-urlencode 'client_id=<client-id>' \\ --data-urlencode 'client_secret=<client-password>' The User ID Token is included in the id_token field of the json response. Alternatively, OAuth/OIDC flows can be followed to authenticate via external identity providers.","title":"Obtaining the User ID Token"},{"location":"eoepca/resource-protection-gluu/#user-id-token-in-http-requests","text":"The Resource Guard protection supports presentation of the User ID Token via the following HTTP request headers (in order of priority)\u2026 Authorization header as a bearer token - in the form: Authorization: Bearer <token> X-User-Id header Cookie: auth_user_id=<token> Note that the name of the cookie is configurable","title":"User ID Token in HTTP requests"},{"location":"eoepca/resource-protection-gluu/#additional-information","text":"Additional information regarding the Resource Guard can be found at: Helm Chart README GitHub Repository: pep-engine uma-user-agent","title":"Additional Information"},{"location":"eoepca/resource-protection-keycloak/","text":"Resource Protection (Keycloak) \u2693\ufe0e EOEPCA defines Building Blocks within a micro-service architecture. The services are subject to protection within an Identity and Access Management (IAM) approach that includes: Keycloak - Identity Service (Authorization Server) Gatekeeper - Policy Enforcement Building Blocks that act as a Resource Server are individually protected by a dedicated Gatekeeper instance that enforces the authorization decision in collaboration with the Identity Service (Keycloak). Gatekeeper \u2018inserts itself\u2019 into the request path of the target Resource Server using the auth_request facility offered by Nginx. Thus, Gatekeeper deploys with an Ingress specification that: Configures the auth_request module to defer access authorization to the gatekeeper service Configures the ingress rules (host/path) for the target Resource Server Helm Chart \u2693\ufe0e Each Gatekeeper is deployed via the identity-gatekeeper helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values - the full set of available values can be seen at https://github.com/ EOEPCA /helm-charts/blob/main/charts/application-hub/values.yaml . It is expected to deploy multiple instances of the Gatekeeper chart, one for each Resource Server to be protected. helm install --version 1 .0.10 --values myservice-gatekeeper-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ myservice-protection identity-gatekeeper Values \u2693\ufe0e The helm chart is deployed with values that customise the service for the specific needs of the resource-server under protection and the deployment target platform. Typical values to be specified include: Host/domain details for the Keycloak Identity Service, e.g. keycloak.192-168-49-2.nip.io Credentials for the Keycloak client to be used by Gatekeeper (ideally via secret) TLS Certificate Provider, e.g. letsencrypt-production Ingress rules definition for reverse-proxy to the target Resource Server Example myservice-protection-values.yaml \u2026 nameOverride : myservice-protection config : client-id : myservice discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io targetService : host : myservice.192-168-49-2.nip.io name : myservice port : number : 80 secrets : # Values for secret 'myservice-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production serverSnippets : custom : |- # Open access to some endpoints, including Swagger UI location ~ ^/(docs|openapi.json|probe) { proxy_pass {{ include \"identity-gatekeeper.targetUrl\" . }}$request_uri; } Client Credentials \u2693\ufe0e Gatekeeper requires Client Credentials for its interactions with the Keycloak identity-service . These credentials must be supplied by the secret named <myservice>-protection . The secret can be created directly by the helm chart - via the values secrets.clientSecret and secrets.encryptionKey - or perhaps more securely the secret can be created independently (e.g. via a SealedSecret ). Client Registration \u2693\ufe0e The Keycloak client can be created directly in the Keycloak admin console - e.g. via https://keycloak.192-168-49-2.nip.io/admin. As an aide there is a helper script create-client . The script is available in the deployment-guide repository , and can be obtained as follows\u2026 git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide cd deployment-guide The create-client helper script requires some command-line arguments\u2026 $ ./deploy/bin/create-client -h Add a client with protected resources. create-client [-h] [-a] [-i] [-u] [-p] [-c] [-s] [-t | --token t] [-r] --id id [--name name] (--secret secret | --public) [--default] [--authenticated] [--resource name] [--uris u1,u2] [--scopes s1,s2] [--users u1,u2] [--roles r1,r2] where: -h show help message -a authorization server url - e.g. https://keycloak.192-168-49-2.nip.io -i identity-api server url - e.g. https://identity-api.192-168-49-2.nip.io -u username used for authentication -p password used for authentication -c client id (of the bootstrap client used in the create request) -s client secret (of the bootstrap client used in the create request) -t or --token access token used for authentication -r realm --id client id (of the created client) --name client name (of the created client) --secret client secret (of the created client) --public public client (no client secret) --default add default resource - /* authenticated --authenticated allow access to the resource only when authenticated --resource resource name --uris resource uris - separated by comma (,) --scopes resource scopes - separated by comma (,) --users user names with access to the resource - separated by comma (,) --roles role names with access to the resource - separated by comma (,) For example\u2026 ./deploy/bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = myservice \\ --name = \"Gatekeeper for myservice\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by Gatekeeper for myservice\" \\ --resource = \"eric\" --uris = '/eric/*' --scopes = view --users = \"eric\" \\ --resource = \"bob\" --uris = '/bob/*' --scopes = view --users = \"bob\" \\ --resource = \"alice\" --uris = '/alice/*' --scopes = view --users = \"alice\" User Tokens \u2693\ufe0e Requests to resource server endpoints that are protected by Gatekeeper must carry an Access Token that has been obtained on behalf of the requesting user. The access_token is carried in the request header\u2026 Authorization: Bearer <access_token> The Access Token for a given user can be obtained with a call to the token endpoint of the Keycloak Identity Service - supplying the credentials for the user and the pre-registered client\u2026 curl -L -X POST 'https://keycloak.192-168-49-2.nip.io/realms/master/protocol/openid-connect/token' \\ -H 'Cache-Control: no-cache' \\ -H 'Content-Type: application/x-www-form-urlencoded' \\ --data-urlencode 'scope=openid profile email' \\ --data-urlencode 'grant_type=password' \\ --data-urlencode 'username=<username>' \\ --data-urlencode 'password=<password>' \\ --data-urlencode 'client_id=admin-cli' A json response is returned, in which the field access_token provides the Access Token for the specified <username> . Additional Information \u2693\ufe0e Additional information regarding the Gatekeeper can be found at: Container Image Helm Chart GitHub Repository","title":"Resource Protection"},{"location":"eoepca/resource-protection-keycloak/#resource-protection-keycloak","text":"EOEPCA defines Building Blocks within a micro-service architecture. The services are subject to protection within an Identity and Access Management (IAM) approach that includes: Keycloak - Identity Service (Authorization Server) Gatekeeper - Policy Enforcement Building Blocks that act as a Resource Server are individually protected by a dedicated Gatekeeper instance that enforces the authorization decision in collaboration with the Identity Service (Keycloak). Gatekeeper \u2018inserts itself\u2019 into the request path of the target Resource Server using the auth_request facility offered by Nginx. Thus, Gatekeeper deploys with an Ingress specification that: Configures the auth_request module to defer access authorization to the gatekeeper service Configures the ingress rules (host/path) for the target Resource Server","title":"Resource Protection (Keycloak)"},{"location":"eoepca/resource-protection-keycloak/#helm-chart","text":"Each Gatekeeper is deployed via the identity-gatekeeper helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values - the full set of available values can be seen at https://github.com/ EOEPCA /helm-charts/blob/main/charts/application-hub/values.yaml . It is expected to deploy multiple instances of the Gatekeeper chart, one for each Resource Server to be protected. helm install --version 1 .0.10 --values myservice-gatekeeper-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ myservice-protection identity-gatekeeper","title":"Helm Chart"},{"location":"eoepca/resource-protection-keycloak/#values","text":"The helm chart is deployed with values that customise the service for the specific needs of the resource-server under protection and the deployment target platform. Typical values to be specified include: Host/domain details for the Keycloak Identity Service, e.g. keycloak.192-168-49-2.nip.io Credentials for the Keycloak client to be used by Gatekeeper (ideally via secret) TLS Certificate Provider, e.g. letsencrypt-production Ingress rules definition for reverse-proxy to the target Resource Server Example myservice-protection-values.yaml \u2026 nameOverride : myservice-protection config : client-id : myservice discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io targetService : host : myservice.192-168-49-2.nip.io name : myservice port : number : 80 secrets : # Values for secret 'myservice-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production serverSnippets : custom : |- # Open access to some endpoints, including Swagger UI location ~ ^/(docs|openapi.json|probe) { proxy_pass {{ include \"identity-gatekeeper.targetUrl\" . }}$request_uri; }","title":"Values"},{"location":"eoepca/resource-protection-keycloak/#client-credentials","text":"Gatekeeper requires Client Credentials for its interactions with the Keycloak identity-service . These credentials must be supplied by the secret named <myservice>-protection . The secret can be created directly by the helm chart - via the values secrets.clientSecret and secrets.encryptionKey - or perhaps more securely the secret can be created independently (e.g. via a SealedSecret ).","title":"Client Credentials"},{"location":"eoepca/resource-protection-keycloak/#client-registration","text":"The Keycloak client can be created directly in the Keycloak admin console - e.g. via https://keycloak.192-168-49-2.nip.io/admin. As an aide there is a helper script create-client . The script is available in the deployment-guide repository , and can be obtained as follows\u2026 git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide cd deployment-guide The create-client helper script requires some command-line arguments\u2026 $ ./deploy/bin/create-client -h Add a client with protected resources. create-client [-h] [-a] [-i] [-u] [-p] [-c] [-s] [-t | --token t] [-r] --id id [--name name] (--secret secret | --public) [--default] [--authenticated] [--resource name] [--uris u1,u2] [--scopes s1,s2] [--users u1,u2] [--roles r1,r2] where: -h show help message -a authorization server url - e.g. https://keycloak.192-168-49-2.nip.io -i identity-api server url - e.g. https://identity-api.192-168-49-2.nip.io -u username used for authentication -p password used for authentication -c client id (of the bootstrap client used in the create request) -s client secret (of the bootstrap client used in the create request) -t or --token access token used for authentication -r realm --id client id (of the created client) --name client name (of the created client) --secret client secret (of the created client) --public public client (no client secret) --default add default resource - /* authenticated --authenticated allow access to the resource only when authenticated --resource resource name --uris resource uris - separated by comma (,) --scopes resource scopes - separated by comma (,) --users user names with access to the resource - separated by comma (,) --roles role names with access to the resource - separated by comma (,) For example\u2026 ./deploy/bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = myservice \\ --name = \"Gatekeeper for myservice\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by Gatekeeper for myservice\" \\ --resource = \"eric\" --uris = '/eric/*' --scopes = view --users = \"eric\" \\ --resource = \"bob\" --uris = '/bob/*' --scopes = view --users = \"bob\" \\ --resource = \"alice\" --uris = '/alice/*' --scopes = view --users = \"alice\"","title":"Client Registration"},{"location":"eoepca/resource-protection-keycloak/#user-tokens","text":"Requests to resource server endpoints that are protected by Gatekeeper must carry an Access Token that has been obtained on behalf of the requesting user. The access_token is carried in the request header\u2026 Authorization: Bearer <access_token> The Access Token for a given user can be obtained with a call to the token endpoint of the Keycloak Identity Service - supplying the credentials for the user and the pre-registered client\u2026 curl -L -X POST 'https://keycloak.192-168-49-2.nip.io/realms/master/protocol/openid-connect/token' \\ -H 'Cache-Control: no-cache' \\ -H 'Content-Type: application/x-www-form-urlencoded' \\ --data-urlencode 'scope=openid profile email' \\ --data-urlencode 'grant_type=password' \\ --data-urlencode 'username=<username>' \\ --data-urlencode 'password=<password>' \\ --data-urlencode 'client_id=admin-cli' A json response is returned, in which the field access_token provides the Access Token for the specified <username> .","title":"User Tokens"},{"location":"eoepca/resource-protection-keycloak/#additional-information","text":"Additional information regarding the Gatekeeper can be found at: Container Image Helm Chart GitHub Repository","title":"Additional Information"},{"location":"eoepca/user-profile/","text":"User Profile \u2693\ufe0e The User Profile represents the user\u2019s \u2018account\u2019 within the platform. Helm Chart \u2693\ufe0e The User Profile is deployed via the user-profile helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the user-profile chart . helm install --version 1 .1.12 --values user-profile-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ user-profile user-profile Values \u2693\ufe0e At minimum, values for the following attributes should be specified: Public hostname of the Authorization Server, e.g. auth.192-168-49-2.nip.io IP Address of the public facing reverse proxy (Nginx Ingress Controller), e.g. 192.168.49.2 Name of Persistent Volume Claim for user-profile persistence, e.g. eoepca-userman-pvc The boolen value volumeClaim.create can be used for the PVC to be created by the helm release. This creates a volume of type host-path and, hence, is only useful for single-node development usage. Example user-profile-values.yaml \u2026 global : domain : auth.192-168-49-2.nip.io nginxIp : 192.168.49.2 volumeClaim : name : eoepca-userman-pvc create : false User Profile Usage \u2693\ufe0e The User Profile is accessed through the /web_ui path of the Login Service, e.g. http://auth.kube.guide.eoepca.org/web_ui. Additional Information \u2693\ufe0e Additional information regarding the User Profile can be found at: Helm Chart Wiki GitHub Repository","title":"User Profile"},{"location":"eoepca/user-profile/#user-profile","text":"The User Profile represents the user\u2019s \u2018account\u2019 within the platform.","title":"User Profile"},{"location":"eoepca/user-profile/#helm-chart","text":"The User Profile is deployed via the user-profile helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the user-profile chart . helm install --version 1 .1.12 --values user-profile-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ user-profile user-profile","title":"Helm Chart"},{"location":"eoepca/user-profile/#values","text":"At minimum, values for the following attributes should be specified: Public hostname of the Authorization Server, e.g. auth.192-168-49-2.nip.io IP Address of the public facing reverse proxy (Nginx Ingress Controller), e.g. 192.168.49.2 Name of Persistent Volume Claim for user-profile persistence, e.g. eoepca-userman-pvc The boolen value volumeClaim.create can be used for the PVC to be created by the helm release. This creates a volume of type host-path and, hence, is only useful for single-node development usage. Example user-profile-values.yaml \u2026 global : domain : auth.192-168-49-2.nip.io nginxIp : 192.168.49.2 volumeClaim : name : eoepca-userman-pvc create : false","title":"Values"},{"location":"eoepca/user-profile/#user-profile-usage","text":"The User Profile is accessed through the /web_ui path of the Login Service, e.g. http://auth.kube.guide.eoepca.org/web_ui.","title":"User Profile Usage"},{"location":"eoepca/user-profile/#additional-information","text":"Additional information regarding the User Profile can be found at: Helm Chart Wiki GitHub Repository","title":"Additional Information"},{"location":"eoepca/workspace/","text":"Workspace \u2693\ufe0e The Workspace provides protected user resource management that includes dedicated storage and services for resource discovery and access. Workspace API \u2693\ufe0e The Workspace API provides a REST service through which user workspaces can be created, interrogated, managed and deleted. Helm Chart \u2693\ufe0e The Workspace API is deployed via the rm-workspace-api helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the um-workspace-api chart . helm install --version 1 .4.2 --values workspace-api-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ workspace-api rm-workspace-api Values \u2693\ufe0e At minimum, values for the following attributes should be specified: The fully-qualified public URL for the service (optional) Specification of Ingress for reverse-proxy access to the service Note that this is only required in the case that the Workspace API will not be protected by the identity-gatekeeper component - ref. Resource Protection . Otherwise the ingress will be handled by the identity-gatekeeper - use ingress.enabled: false . Prefix for user projects in OpenStack Details for underlying S3 object storage service Identification of secret that provides the client credentials for resource protection Whether flux components should be installed - otherwise they must already be present - Flux Dependency Name of the ConfigMap for user workspace templates - See User Workspace Templates Example workspace-api-values.yaml \u2026 fullnameOverride : workspace-api ingress : enabled : true annotations : cert-manager.io/cluster-issuer : letsencrypt-production kubernetes.io/ingress.class : nginx nginx.ingress.kubernetes.io/enable-cors : \"true\" nginx.ingress.kubernetes.io/proxy-read-timeout : \"600\" hosts : - host : workspace-api-open.192-168-49-2.nip.io paths : [ \"/\" ] tls : - hosts : - workspace-api-open.192-168-49-2.nip.io secretName : workspace-api-open-tls fluxHelmOperator : enabled : true prefixForName : \"ws\" workspaceSecretName : \"bucket\" namespaceForBucketResource : \"rm\" s3Endpoint : \"https://minio.192-168-49-2.nip.io\" s3Region : \"RegionOne\" harborUrl : \"https://harbor.192-168-49-2.nip.io\" harborUsername : \"admin\" harborPasswordSecretName : \"harbor\" workspaceChartsConfigMap : \"workspace-charts\" bucketEndpointUrl : \"http://minio-bucket-api:8080/bucket\" keycloakIntegration : enabled : true keycloakUrl : \"https://keycloak.192-168-49-2.nip.io\" realm : \"master\" identityApiUrl : \"https://identity-api.192-168-49-2.nip.io\" workspaceApiIamClientId : \"workspace-api\" defaultIamClientSecret : \"changeme\" Note The Workspace API assumes a deployment of the Harbor Container Regsitry, as configured by the harborXXX values above. See section Container Registry . The password for the harbor admin user must be created as described in the section Harbor admin Password . The keycloakIntegration allows the Workspace API to apply protecion (for the specified workspace owner) to the services within newly created workspaces. The workspace-api initiates the creation of a storage \u2018bucket\u2019 for each workspace - the actual bucket creation being abstracted via a webhook - the URL of which is specified in the value bucketEndpointUrl . See section Bucket Creation Webhook for details. Harbor admin Password \u2693\ufe0e The password for the harbor admin user is provided to the workspace-api via the specified secret - defined as harbor above. This secret must be created - for example as follows\u2026 kubectl -n rm create secret generic harbor \\ --from-literal=HARBOR_ADMIN_PASSWORD=\"changeme\" Flux Dependency \u2693\ufe0e Workspaces are created by instantiating the rm-user-workspace helm chart for each user/group. The Workspace API uses Flux CD as a helper to manage these subordinate helm charts - via flux resources of type HelmRelease . Thus, it is necessary to deploy within the cluster the aspects of flux that support this helm chart management - namely the flux helm-controller , source-controller and the Kubernetes Custom Resource Definitions (CRD) for HelmRelease and HelmRepository . In case you are not already using flux within your clsuter, then the Workspace API helm chart can be configured to deploy the required flux components\u2026 fluxHelmOperator: enabled: true # true = install flux for me, false = I already have flux User Workspace Templates \u2693\ufe0e The Workspace API instantiates for each user a set of services, including a Resource Catalogue and Data Access services. These user services are instantiated via helm using templates. The templates are provided to the Workspace API in a ConfigMap that is, by default, named workspace-charts . Each file in the config-map is expected to be of kind HelmRelease . During creation of a new workspace, the Worksapce API applies each file to the cluster in the namespace of the newly created namespace. The default ConfigMap that is included with this guide contains the following templates for instantiation of user-specific components: Data Access : template-hr-data-access.yaml Resource Catalogue : template-hr-resource-catalogue.yaml Protection : template-hr-resource-protection.yaml Each of these templates is expressed as a flux HelmRelease object that describes the helm chart and values required to deploy the service. In addition, ConfigMap templates are included that provide specific details required to access the user-scoped workspace resources, including access to S3 object storage and container registry: S3 client configuration : template-cm-aws-config.yaml S3 client credentials : template-cm-aws-credentials.yaml Container registry configuration : template-cm-docker-config.yaml These ConfigMaps are designed to be mounted as files into the runtime environments of other components for user workspace integration. In particular the Application Hub makes use of this approach to provide a user experience that integrates with the user\u2019s workspace resources. Templates ConfigMap \u2693\ufe0e The templates are provided to the Workspace API as a ConfigMap in the namespace of the Workspace API deployment\u2026 (for full examples see https://github.com/ EOEPCA /deployment-guide/tree/eoepca-v1.4/deploy/eoepca/workspace-templates ) apiVersion : v1 kind : ConfigMap metadata : name : workspace-charts data : template-hr-resource-catalogue.yaml : | apiVersion: helm.toolkit.fluxcd.io/v2beta1 kind: HelmRelease metadata: name: rm-resource-catalogue spec: interval: 5m chart: spec: chart: rm-resource-catalogue version: 1.3.1 sourceRef: kind: HelmRepository name: eoepca namespace: rm values: ... template-hr-data-access.yaml : | apiVersion: helm.toolkit.fluxcd.io/v2beta1 kind: HelmRelease metadata: name: vs spec: interval: 5m chart: spec: chart: data-access version: 1.3.1 sourceRef: kind: HelmRepository name: eoepca namespace: rm values: ... template-hr-resource-protection.yaml : | apiVersion: helm.toolkit.fluxcd.io/v2beta1 kind: HelmRelease metadata: name: resource-protection spec: interval: 5m chart: spec: chart: identity-gatekeeper version: 1.0.11 sourceRef: kind: HelmRepository name: eoepca namespace: ${NAMESPACE} values: ... template-cm-aws-config.yaml : | apiVersion: v1 kind: ConfigMap metadata: name: aws-config data: aws-config: | [default] region = {{ s3_region }} s3 = endpoint_url = {{ s3_endpoint_url }} s3api = endpoint_url = {{ s3_endpoint_url }} [plugins] endpoint = awscli_plugin_endpoint template-cm-aws-credentials.yaml : | apiVersion: v1 kind: ConfigMap metadata: name: aws-credentials data: aws-credentials: | [default] aws_access_key_id = {{ access_key_id }} aws_secret_access_key = {{ secret_access_key }} template-cm-docker-config.yaml : | apiVersion: v1 kind: ConfigMap metadata: name: docker-config data: docker-config: | { \"auths\": { \"{{ container_registry_host }}\": { \"auth\": \"{{ container_registry_credentials }}\" } } Notice the use of workspace template parameters {{ param_name }} that are used at workspace creation time to contextualise the workspace for the owning user. See section Workspace Template Parameters for more information. HelmRepositories for Templates \u2693\ufe0e As can be seen above, the HelmRelease templates rely upon objects of type HelmRepository that define the hosting helm chart repository. Thus, in support of the workspace templates, appropriate HelmRepository objects must be provisioned within the cluster. For example, in support of the above examples that rely upon the EOEPCA Helm Chart Repository \u2026 apiVersion : source.toolkit.fluxcd.io/v1beta1 kind : HelmRepository metadata : name : eoepca namespace : rm spec : interval : 2m url : https://eoepca.github.io/helm-charts/ Workspace Template Parameters \u2693\ufe0e The Workspace API uses the jinja2 templating engine when applying the resources for a user workspace. The current parameters are currently supported: workspace_name The name of the workspace - {{ workspace_name }} used to ensure unique naming of cluster resources, such as service ingress default_owner The uuid of the owner of the workspace - {{ default_owner }} used to initialise the workspace protection S3 Object Storage details\u2026 {{ s3_endpoint_url }} {{ s3_region }} {{ access_key_id }} {{ secret_access_key }} Container Registry details\u2026 {{ container_registry_host }} {{ container_registry_credentials }} Protection \u2693\ufe0e As described in section Resource Protection (Keycloak) , the identity-gatekeeper component can be inserted into the request path of the workspace-api service to provide access authorization decisions Gatekeeper \u2693\ufe0e Gatekeeper is deployed using its helm chart\u2026 helm install workspace-api-protection identity-gatekeeper -f workspace-api-protection-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ --namespace \"rm\" --create-namespace \\ --version 1 .0.11 The identity-gatekeeper must be configured with the values applicable to the workspace-api - in particular the specific ingress requirements for the workspace-api backend service\u2026 Example workspace-api-protection-values.yaml \u2026 fullnameOverride : workspace-api-protection config : client-id : workspace-api discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io targetService : host : workspace-api.192-168-49-2.nip.io name : workspace-api port : number : 8080 secrets : # Values for secret 'workspace-api-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production serverSnippets : custom : |- # Open access to some endpoints, including Swagger UI location ~ ^/(docs|openapi.json|probe) { proxy_pass {{ include \"identity-gatekeeper.targetUrl\" . }}$request_uri; } Keycloak Client \u2693\ufe0e The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. client-id: workspace-api above. This can be created with the create-client helper script, as descirbed in section Client Registration . For example, with path protection for the admin user\u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = \"workspace-api\" \\ --name = \"Workspace API Gatekeeper\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by Workspace API Gatekeeper\" \\ --resource = \"admin\" --uris = '/*' --scopes = view --users = \"admin\" Workspace API Usage \u2693\ufe0e The Workspace API provides a REST interface that is accessed at the endpoint https://workspace-api.192-168-49-2.nip.io/. See the Swagger Docs - /docs . Note If the Workspace API has been protected ( via Gatekeeper with Keycloak ), then requests must be supported by an access_token carried in the HTTP header Authorozation: Bearer <token> . This diminishes the utility of the swagger UI. Additional Information \u2693\ufe0e Additional information regarding the Workspace API can be found at: Helm Chart Wiki GitHub Repository Bucket Creation Webhook \u2693\ufe0e With helm chart version 1.3.1 of the workspace-api the approach to bucket creation has been re-architected to use a webhook approach. Approach \u2693\ufe0e During workspace creation the workspace-api needs to create an object storage bucket for the user. The method by which the bucket is created is a function of the hosting infrastructure object storage layer - i.e. there is no \u2018common\u2019 approach for the workspace-api to perform the bucket creation. In order to allow this bucket creation step to be customised by the platform integrator, the workspace-api is configured with a webhook endpoint that is invoked to effect the bucket creation on behalf of the workspace-api. The workspace-api is configured by the following value in its helm chart deployment, e.g\u2026 bucketEndpointUrl: \"http://my-bucket-webhook:8080/bucket\" The webhook service must implement the following REST interface\u2026 method: POST content-type: application/json data: { bucketName: str secretName: str secretNamespace: str } There are two possible approaches to implement this request, distinguished by the response code\u2026 200 The bucket is created and the credentials are included in the response body. In this case only the supplied bucketName is relevant to fulfil the request. 201 The bucket will be created (asychronously) and the outcome is provided by the webhook via a Kubernetes secret, as per the secretName and secretNamespace request parameters 200 Response In case 200 response, the response body should communicate the credentials with an application/json content-type in the form\u2026 { \"bucketname\": \"...\", \"access_key\": \"...\", \"access_secret\": \"....\", \"projectid\": \"...\", } In this case the workspace-api will create the appropriate bucket secret using the returned credentials. 201 Response In case 201 response, the secret should be created in the form\u2026 data: bucketname: \"...\" access: \"...\" secret: \"...\" projectid: \"...\" In this case the workspace-api will wait for the (asynchronous) creation of the specified secret before continuing with the workspace creation. Overall Outcome In both cases the ultimate outcome is the creation of the bucket in the back-end object storage, and the creation of a Kubernetes secret that maintains the credentials for access to the bucket. The existence of the bucket secret is prerequisite to the continuation of the user workspace creation. Minio Bucket API (Webhook) \u2693\ufe0e The Minio Bucket API provides an implementation of a Bucket Creation Webhook for a Minio S3 Object Storage backend. This is used as the default in this guide - but should be replaced for a production deployment with an appropriate webhook to integrate with the object storage solution of the deployment environment. Helm Chart \u2693\ufe0e The Minio Bucket API is deployed via the rm-minio-bucket-api helm chart from the EOEPCA Helm Chart Repository - ref. Helm Chart for the Minio Bucket API . helm install --version 0 .0.4 --values minio-bucket-api-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ rm-minio-bucket-api rm-minio-bucket-api Values \u2693\ufe0e At minimum, values for the following attributes should be specified: The URL for the Minio endpoint - minIOServerEndpoint The credentials for admin access to Minio - via the specified secret accessCredentials.secretName (ref. Minio Credentials Secret ) Example minio-bucket-api-values.yaml \u2026 fullnameOverride : minio-bucket-api minIOServerEndpoint : https://minio.192-168-49-2.nip.io accessCredentials : secretName : minio-auth Additional Information \u2693\ufe0e Additional information regarding the Minio Bucket API can be found at: Helm Chart GitHub Repository","title":"Workspace"},{"location":"eoepca/workspace/#workspace","text":"The Workspace provides protected user resource management that includes dedicated storage and services for resource discovery and access.","title":"Workspace"},{"location":"eoepca/workspace/#workspace-api","text":"The Workspace API provides a REST service through which user workspaces can be created, interrogated, managed and deleted.","title":"Workspace API"},{"location":"eoepca/workspace/#helm-chart","text":"The Workspace API is deployed via the rm-workspace-api helm chart from the EOEPCA Helm Chart Repository . The chart is configured via values that are fully documented in the README for the um-workspace-api chart . helm install --version 1 .4.2 --values workspace-api-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ workspace-api rm-workspace-api","title":"Helm Chart"},{"location":"eoepca/workspace/#values","text":"At minimum, values for the following attributes should be specified: The fully-qualified public URL for the service (optional) Specification of Ingress for reverse-proxy access to the service Note that this is only required in the case that the Workspace API will not be protected by the identity-gatekeeper component - ref. Resource Protection . Otherwise the ingress will be handled by the identity-gatekeeper - use ingress.enabled: false . Prefix for user projects in OpenStack Details for underlying S3 object storage service Identification of secret that provides the client credentials for resource protection Whether flux components should be installed - otherwise they must already be present - Flux Dependency Name of the ConfigMap for user workspace templates - See User Workspace Templates Example workspace-api-values.yaml \u2026 fullnameOverride : workspace-api ingress : enabled : true annotations : cert-manager.io/cluster-issuer : letsencrypt-production kubernetes.io/ingress.class : nginx nginx.ingress.kubernetes.io/enable-cors : \"true\" nginx.ingress.kubernetes.io/proxy-read-timeout : \"600\" hosts : - host : workspace-api-open.192-168-49-2.nip.io paths : [ \"/\" ] tls : - hosts : - workspace-api-open.192-168-49-2.nip.io secretName : workspace-api-open-tls fluxHelmOperator : enabled : true prefixForName : \"ws\" workspaceSecretName : \"bucket\" namespaceForBucketResource : \"rm\" s3Endpoint : \"https://minio.192-168-49-2.nip.io\" s3Region : \"RegionOne\" harborUrl : \"https://harbor.192-168-49-2.nip.io\" harborUsername : \"admin\" harborPasswordSecretName : \"harbor\" workspaceChartsConfigMap : \"workspace-charts\" bucketEndpointUrl : \"http://minio-bucket-api:8080/bucket\" keycloakIntegration : enabled : true keycloakUrl : \"https://keycloak.192-168-49-2.nip.io\" realm : \"master\" identityApiUrl : \"https://identity-api.192-168-49-2.nip.io\" workspaceApiIamClientId : \"workspace-api\" defaultIamClientSecret : \"changeme\" Note The Workspace API assumes a deployment of the Harbor Container Regsitry, as configured by the harborXXX values above. See section Container Registry . The password for the harbor admin user must be created as described in the section Harbor admin Password . The keycloakIntegration allows the Workspace API to apply protecion (for the specified workspace owner) to the services within newly created workspaces. The workspace-api initiates the creation of a storage \u2018bucket\u2019 for each workspace - the actual bucket creation being abstracted via a webhook - the URL of which is specified in the value bucketEndpointUrl . See section Bucket Creation Webhook for details.","title":"Values"},{"location":"eoepca/workspace/#harbor-admin-password","text":"The password for the harbor admin user is provided to the workspace-api via the specified secret - defined as harbor above. This secret must be created - for example as follows\u2026 kubectl -n rm create secret generic harbor \\ --from-literal=HARBOR_ADMIN_PASSWORD=\"changeme\"","title":"Harbor admin Password"},{"location":"eoepca/workspace/#flux-dependency","text":"Workspaces are created by instantiating the rm-user-workspace helm chart for each user/group. The Workspace API uses Flux CD as a helper to manage these subordinate helm charts - via flux resources of type HelmRelease . Thus, it is necessary to deploy within the cluster the aspects of flux that support this helm chart management - namely the flux helm-controller , source-controller and the Kubernetes Custom Resource Definitions (CRD) for HelmRelease and HelmRepository . In case you are not already using flux within your clsuter, then the Workspace API helm chart can be configured to deploy the required flux components\u2026 fluxHelmOperator: enabled: true # true = install flux for me, false = I already have flux","title":"Flux Dependency"},{"location":"eoepca/workspace/#user-workspace-templates","text":"The Workspace API instantiates for each user a set of services, including a Resource Catalogue and Data Access services. These user services are instantiated via helm using templates. The templates are provided to the Workspace API in a ConfigMap that is, by default, named workspace-charts . Each file in the config-map is expected to be of kind HelmRelease . During creation of a new workspace, the Worksapce API applies each file to the cluster in the namespace of the newly created namespace. The default ConfigMap that is included with this guide contains the following templates for instantiation of user-specific components: Data Access : template-hr-data-access.yaml Resource Catalogue : template-hr-resource-catalogue.yaml Protection : template-hr-resource-protection.yaml Each of these templates is expressed as a flux HelmRelease object that describes the helm chart and values required to deploy the service. In addition, ConfigMap templates are included that provide specific details required to access the user-scoped workspace resources, including access to S3 object storage and container registry: S3 client configuration : template-cm-aws-config.yaml S3 client credentials : template-cm-aws-credentials.yaml Container registry configuration : template-cm-docker-config.yaml These ConfigMaps are designed to be mounted as files into the runtime environments of other components for user workspace integration. In particular the Application Hub makes use of this approach to provide a user experience that integrates with the user\u2019s workspace resources.","title":"User Workspace Templates"},{"location":"eoepca/workspace/#templates-configmap","text":"The templates are provided to the Workspace API as a ConfigMap in the namespace of the Workspace API deployment\u2026 (for full examples see https://github.com/ EOEPCA /deployment-guide/tree/eoepca-v1.4/deploy/eoepca/workspace-templates ) apiVersion : v1 kind : ConfigMap metadata : name : workspace-charts data : template-hr-resource-catalogue.yaml : | apiVersion: helm.toolkit.fluxcd.io/v2beta1 kind: HelmRelease metadata: name: rm-resource-catalogue spec: interval: 5m chart: spec: chart: rm-resource-catalogue version: 1.3.1 sourceRef: kind: HelmRepository name: eoepca namespace: rm values: ... template-hr-data-access.yaml : | apiVersion: helm.toolkit.fluxcd.io/v2beta1 kind: HelmRelease metadata: name: vs spec: interval: 5m chart: spec: chart: data-access version: 1.3.1 sourceRef: kind: HelmRepository name: eoepca namespace: rm values: ... template-hr-resource-protection.yaml : | apiVersion: helm.toolkit.fluxcd.io/v2beta1 kind: HelmRelease metadata: name: resource-protection spec: interval: 5m chart: spec: chart: identity-gatekeeper version: 1.0.11 sourceRef: kind: HelmRepository name: eoepca namespace: ${NAMESPACE} values: ... template-cm-aws-config.yaml : | apiVersion: v1 kind: ConfigMap metadata: name: aws-config data: aws-config: | [default] region = {{ s3_region }} s3 = endpoint_url = {{ s3_endpoint_url }} s3api = endpoint_url = {{ s3_endpoint_url }} [plugins] endpoint = awscli_plugin_endpoint template-cm-aws-credentials.yaml : | apiVersion: v1 kind: ConfigMap metadata: name: aws-credentials data: aws-credentials: | [default] aws_access_key_id = {{ access_key_id }} aws_secret_access_key = {{ secret_access_key }} template-cm-docker-config.yaml : | apiVersion: v1 kind: ConfigMap metadata: name: docker-config data: docker-config: | { \"auths\": { \"{{ container_registry_host }}\": { \"auth\": \"{{ container_registry_credentials }}\" } } Notice the use of workspace template parameters {{ param_name }} that are used at workspace creation time to contextualise the workspace for the owning user. See section Workspace Template Parameters for more information.","title":"Templates ConfigMap"},{"location":"eoepca/workspace/#helmrepositories-for-templates","text":"As can be seen above, the HelmRelease templates rely upon objects of type HelmRepository that define the hosting helm chart repository. Thus, in support of the workspace templates, appropriate HelmRepository objects must be provisioned within the cluster. For example, in support of the above examples that rely upon the EOEPCA Helm Chart Repository \u2026 apiVersion : source.toolkit.fluxcd.io/v1beta1 kind : HelmRepository metadata : name : eoepca namespace : rm spec : interval : 2m url : https://eoepca.github.io/helm-charts/","title":"HelmRepositories for Templates"},{"location":"eoepca/workspace/#workspace-template-parameters","text":"The Workspace API uses the jinja2 templating engine when applying the resources for a user workspace. The current parameters are currently supported: workspace_name The name of the workspace - {{ workspace_name }} used to ensure unique naming of cluster resources, such as service ingress default_owner The uuid of the owner of the workspace - {{ default_owner }} used to initialise the workspace protection S3 Object Storage details\u2026 {{ s3_endpoint_url }} {{ s3_region }} {{ access_key_id }} {{ secret_access_key }} Container Registry details\u2026 {{ container_registry_host }} {{ container_registry_credentials }}","title":"Workspace Template Parameters"},{"location":"eoepca/workspace/#protection","text":"As described in section Resource Protection (Keycloak) , the identity-gatekeeper component can be inserted into the request path of the workspace-api service to provide access authorization decisions","title":"Protection"},{"location":"eoepca/workspace/#gatekeeper","text":"Gatekeeper is deployed using its helm chart\u2026 helm install workspace-api-protection identity-gatekeeper -f workspace-api-protection-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ --namespace \"rm\" --create-namespace \\ --version 1 .0.11 The identity-gatekeeper must be configured with the values applicable to the workspace-api - in particular the specific ingress requirements for the workspace-api backend service\u2026 Example workspace-api-protection-values.yaml \u2026 fullnameOverride : workspace-api-protection config : client-id : workspace-api discovery-url : https://keycloak.192-168-49-2.nip.io/realms/master cookie-domain : 192-168-49-2.nip.io targetService : host : workspace-api.192-168-49-2.nip.io name : workspace-api port : number : 8080 secrets : # Values for secret 'workspace-api-protection' # Note - if ommitted, these can instead be set by creating the secret independently. clientSecret : \"changeme\" encryptionKey : \"changemechangeme\" ingress : enabled : true className : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production serverSnippets : custom : |- # Open access to some endpoints, including Swagger UI location ~ ^/(docs|openapi.json|probe) { proxy_pass {{ include \"identity-gatekeeper.targetUrl\" . }}$request_uri; }","title":"Gatekeeper"},{"location":"eoepca/workspace/#keycloak-client","text":"The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. client-id: workspace-api above. This can be created with the create-client helper script, as descirbed in section Client Registration . For example, with path protection for the admin user\u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = \"workspace-api\" \\ --name = \"Workspace API Gatekeeper\" \\ --secret = \"changeme\" \\ --description = \"Client to be used by Workspace API Gatekeeper\" \\ --resource = \"admin\" --uris = '/*' --scopes = view --users = \"admin\"","title":"Keycloak Client"},{"location":"eoepca/workspace/#workspace-api-usage","text":"The Workspace API provides a REST interface that is accessed at the endpoint https://workspace-api.192-168-49-2.nip.io/. See the Swagger Docs - /docs . Note If the Workspace API has been protected ( via Gatekeeper with Keycloak ), then requests must be supported by an access_token carried in the HTTP header Authorozation: Bearer <token> . This diminishes the utility of the swagger UI.","title":"Workspace API Usage"},{"location":"eoepca/workspace/#additional-information","text":"Additional information regarding the Workspace API can be found at: Helm Chart Wiki GitHub Repository","title":"Additional Information"},{"location":"eoepca/workspace/#bucket-creation-webhook","text":"With helm chart version 1.3.1 of the workspace-api the approach to bucket creation has been re-architected to use a webhook approach.","title":"Bucket Creation Webhook"},{"location":"eoepca/workspace/#approach","text":"During workspace creation the workspace-api needs to create an object storage bucket for the user. The method by which the bucket is created is a function of the hosting infrastructure object storage layer - i.e. there is no \u2018common\u2019 approach for the workspace-api to perform the bucket creation. In order to allow this bucket creation step to be customised by the platform integrator, the workspace-api is configured with a webhook endpoint that is invoked to effect the bucket creation on behalf of the workspace-api. The workspace-api is configured by the following value in its helm chart deployment, e.g\u2026 bucketEndpointUrl: \"http://my-bucket-webhook:8080/bucket\" The webhook service must implement the following REST interface\u2026 method: POST content-type: application/json data: { bucketName: str secretName: str secretNamespace: str } There are two possible approaches to implement this request, distinguished by the response code\u2026 200 The bucket is created and the credentials are included in the response body. In this case only the supplied bucketName is relevant to fulfil the request. 201 The bucket will be created (asychronously) and the outcome is provided by the webhook via a Kubernetes secret, as per the secretName and secretNamespace request parameters 200 Response In case 200 response, the response body should communicate the credentials with an application/json content-type in the form\u2026 { \"bucketname\": \"...\", \"access_key\": \"...\", \"access_secret\": \"....\", \"projectid\": \"...\", } In this case the workspace-api will create the appropriate bucket secret using the returned credentials. 201 Response In case 201 response, the secret should be created in the form\u2026 data: bucketname: \"...\" access: \"...\" secret: \"...\" projectid: \"...\" In this case the workspace-api will wait for the (asynchronous) creation of the specified secret before continuing with the workspace creation. Overall Outcome In both cases the ultimate outcome is the creation of the bucket in the back-end object storage, and the creation of a Kubernetes secret that maintains the credentials for access to the bucket. The existence of the bucket secret is prerequisite to the continuation of the user workspace creation.","title":"Approach"},{"location":"eoepca/workspace/#minio-bucket-api-webhook","text":"The Minio Bucket API provides an implementation of a Bucket Creation Webhook for a Minio S3 Object Storage backend. This is used as the default in this guide - but should be replaced for a production deployment with an appropriate webhook to integrate with the object storage solution of the deployment environment.","title":"Minio Bucket API (Webhook)"},{"location":"eoepca/workspace/#helm-chart_1","text":"The Minio Bucket API is deployed via the rm-minio-bucket-api helm chart from the EOEPCA Helm Chart Repository - ref. Helm Chart for the Minio Bucket API . helm install --version 0 .0.4 --values minio-bucket-api-values.yaml \\ --repo https://eoepca.github.io/helm-charts \\ rm-minio-bucket-api rm-minio-bucket-api","title":"Helm Chart"},{"location":"eoepca/workspace/#values_1","text":"At minimum, values for the following attributes should be specified: The URL for the Minio endpoint - minIOServerEndpoint The credentials for admin access to Minio - via the specified secret accessCredentials.secretName (ref. Minio Credentials Secret ) Example minio-bucket-api-values.yaml \u2026 fullnameOverride : minio-bucket-api minIOServerEndpoint : https://minio.192-168-49-2.nip.io accessCredentials : secretName : minio-auth","title":"Values"},{"location":"eoepca/workspace/#additional-information_1","text":"Additional information regarding the Minio Bucket API can be found at: Helm Chart GitHub Repository","title":"Additional Information"},{"location":"quickstart/application-hub-deployment/","text":"Application Hub Deployment \u2693\ufe0e Overview \u2693\ufe0e A deployment wrapper script has been prepared for an \u2018Application Hub\u2019 deployment - that provides the Application Hub integrated with the Identity Service (Keycloak) via OIDC for user authentication. The script deploy/apphub/apphub achieves this by appropriate configuration of the environment variables , before launching the eoepca.sh deployment script . The deployment configuration is captured in the file deploy/apphub/apphub-options . The Application Hub deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Services deployed: Identity Service (Keycloak) With test users eric, bob and alice created in Keycloak Application Hub User eric and bob predefined as admin users Other eoepca services not deployed Initiate Deployment \u2693\ufe0e Deployment is initiated by invoking the script\u2026 ./deploy/apphub/apphub The Identity Service (Keycloak) is accessed at the following endpoints\u2026 http://keycloak.192-168-49-2.nip.io/ http://identity-api.192-168-49-2.nip.io/docs (Swagger docs for the API) The Application Hub is accessed at the endpoint - http://applicationhub.192-168-49-2.nip.io/ . Post-deploy Manual Steps \u2693\ufe0e To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page. Application Hub Notes \u2693\ufe0e Login \u2693\ufe0e Authentication is made via the Sign in with EOEPCA button on the service home page - which redirects to Keycloak for authentication. With the out-of-the-box configuration user eric or bob should be used with default password changeme . Users eric and bob are currently predefined within the helm chart as admin users - see https://github.com/ EOEPCA /helm-charts/blob/main/charts/application-hub/files/hub/jupyter_config.py#L171 . Spawning Applications \u2693\ufe0e Once logged in, the service list is presented for spawning of applications. Note that this list of applications is currently defined within the helm chart - see https://github.com/ EOEPCA /helm-charts/blob/main/charts/application-hub/files/hub/config.yml . From the list, a service is selected and the Start button initiates spawning. For a clean deployment, the first spawn of each application may take some time whilst the container image representing the application is downloaded to the node. Subsequent invocations (at least on the same node) should be much faster. Once running, the application continues (in the background) until stopped by the user using the Stop Server button on the user\u2019s home screen. The current JupyterHub configuration assumes a single application service (per user) running at a time - i.e. the current application must be stopped before the next can be started. There is an alternative configuration in which applications can be run in parallel and their lifecycles individually managed. Returning to the Home Screen \u2693\ufe0e The launched applications do not (yet) have a navigation link \u2018out\u2019 of the application back to the home screen. Therefore, it is necessary to manually modify the url in the browser address bar to /hub/home to navigate to the home screen - from where the current running server can be stopped or re-entered. IAT - JupyterLab \u2693\ufe0e Following instantiation, the IAT application (Interactive Analysis Tool) defaults to the \u2018Jupyter Notebook\u2019 view ( /user/<user>/tree ) - rather than the Jupyter Lab view ( /user/<user>/lab ). To switch to the Jupyter Lab view it is necessary to manually edit the url path from /user/<user>/tree to /user/<user>/lab . It is intended to update the default to this Jupyter Lab path.","title":"Application Hub"},{"location":"quickstart/application-hub-deployment/#application-hub-deployment","text":"","title":"Application Hub Deployment"},{"location":"quickstart/application-hub-deployment/#overview","text":"A deployment wrapper script has been prepared for an \u2018Application Hub\u2019 deployment - that provides the Application Hub integrated with the Identity Service (Keycloak) via OIDC for user authentication. The script deploy/apphub/apphub achieves this by appropriate configuration of the environment variables , before launching the eoepca.sh deployment script . The deployment configuration is captured in the file deploy/apphub/apphub-options . The Application Hub deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Services deployed: Identity Service (Keycloak) With test users eric, bob and alice created in Keycloak Application Hub User eric and bob predefined as admin users Other eoepca services not deployed","title":"Overview"},{"location":"quickstart/application-hub-deployment/#initiate-deployment","text":"Deployment is initiated by invoking the script\u2026 ./deploy/apphub/apphub The Identity Service (Keycloak) is accessed at the following endpoints\u2026 http://keycloak.192-168-49-2.nip.io/ http://identity-api.192-168-49-2.nip.io/docs (Swagger docs for the API) The Application Hub is accessed at the endpoint - http://applicationhub.192-168-49-2.nip.io/ .","title":"Initiate Deployment"},{"location":"quickstart/application-hub-deployment/#post-deploy-manual-steps","text":"To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.","title":"Post-deploy Manual Steps"},{"location":"quickstart/application-hub-deployment/#application-hub-notes","text":"","title":"Application Hub Notes"},{"location":"quickstart/application-hub-deployment/#login","text":"Authentication is made via the Sign in with EOEPCA button on the service home page - which redirects to Keycloak for authentication. With the out-of-the-box configuration user eric or bob should be used with default password changeme . Users eric and bob are currently predefined within the helm chart as admin users - see https://github.com/ EOEPCA /helm-charts/blob/main/charts/application-hub/files/hub/jupyter_config.py#L171 .","title":"Login"},{"location":"quickstart/application-hub-deployment/#spawning-applications","text":"Once logged in, the service list is presented for spawning of applications. Note that this list of applications is currently defined within the helm chart - see https://github.com/ EOEPCA /helm-charts/blob/main/charts/application-hub/files/hub/config.yml . From the list, a service is selected and the Start button initiates spawning. For a clean deployment, the first spawn of each application may take some time whilst the container image representing the application is downloaded to the node. Subsequent invocations (at least on the same node) should be much faster. Once running, the application continues (in the background) until stopped by the user using the Stop Server button on the user\u2019s home screen. The current JupyterHub configuration assumes a single application service (per user) running at a time - i.e. the current application must be stopped before the next can be started. There is an alternative configuration in which applications can be run in parallel and their lifecycles individually managed.","title":"Spawning Applications"},{"location":"quickstart/application-hub-deployment/#returning-to-the-home-screen","text":"The launched applications do not (yet) have a navigation link \u2018out\u2019 of the application back to the home screen. Therefore, it is necessary to manually modify the url in the browser address bar to /hub/home to navigate to the home screen - from where the current running server can be stopped or re-entered.","title":"Returning to the Home Screen"},{"location":"quickstart/application-hub-deployment/#iat-jupyterlab","text":"Following instantiation, the IAT application (Interactive Analysis Tool) defaults to the \u2018Jupyter Notebook\u2019 view ( /user/<user>/tree ) - rather than the Jupyter Lab view ( /user/<user>/lab ). To switch to the Jupyter Lab view it is necessary to manually edit the url path from /user/<user>/tree to /user/<user>/lab . It is intended to update the default to this Jupyter Lab path.","title":"IAT - JupyterLab"},{"location":"quickstart/creodias-deployment/","text":"CREODIAS Deployment \u2693\ufe0e Deployment \u2693\ufe0e Based upon our development experiences on CREODIAS, there is a wrapper script creodias with particular customisations suited to the CREODIAS infrastructure and data offering. The customisations are expressed through environment variables that are captured in the file creodias-options . These scripts are examples that can be seen as a starting point, from which they can be adapted to your needs. The CREODIAS deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Protected service endpoints requiring IAM authorization With reference to the file creodias-options , particular attention is drawn to the following environment variables that require tailoring to your CREODIAS (Cloudferro) environment\u2026 Passwords: MINIO_ROOT_PASSWORD , HARBOR_ADMIN_PASSWORD Identity Service credentials - e.g. IDENTITY_SERVICE_DEFAULT_SECRET , IDENTITY_SERVICE_ADMIN_PASSWORD , etc. OpenStack details: see section Openstack Configuration If configuring an external deployment - ref. Public Deployment \u2026 public_ip - The public IP address through which the deployment is exposed via the ingress-controller domain - The DNS domain name through which the deployment is accessed - forming the stem for all service hostnames in the ingress rules Once the file creodias-options has been well populated for your environment, then the deployment is initiated with\u2026 ./deploy/creodias/creodias \u2026noting that this step is a customised version of that described in section Deployment . Harvest CREODIAS Data \u2693\ufe0e The harvester can be deployed with a default configuration file at /config.yaml . As described in the Data Access section , harvesting according to this configuration can be triggered with\u2026 kubectl -n rm exec -it deployment.apps/data-access-harvester -- python3 -m harvester harvest --config-file /config.yaml --host data-access-redis-master --port 6379 Creodias-Opensearch See the Harvester section below for an explanation of this harvester configuration. Data Specification Walkthrough \u2693\ufe0e The example scripts include optional specifcation of data-access/harvesting configuration that is tailored for the CREODIAS data offering. This is controlled via the option CREODIAS_DATA_SPECIFICATION=true - see Environment Variables . This section provides a walkthrough of this configuration for CREODIAS - to act as an aid to understanding by way of a worked example. Harvester \u2693\ufe0e The harvester configuration specifies datasets with spatial/temporal extents, which is configured into the file /config.yaml of the data-access-harvester deployment. The harvester is configured as follows\u2026 harvester: replicaCount: 1 resources: requests: cpu: 100m memory: 100Mi config: redis: host: data-access-redis-master port: 6379 harvesters: - name: Creodias-Opensearch resource: url: https://datahub.creodias.eu/resto/api/collections/Sentinel2/describe.xml type: OpenSearch format_config: type: 'application/json' property_mapping: start_datetime: 'startDate' end_datetime: 'completionDate' productIdentifier: 'productIdentifier' query: time: property: sensed begin: 2019-09-10T00:00:00Z end: 2019-09-11T00:00:00Z collection: null bbox: 14.9,47.7,16.4,48.7 filter: {} postprocess: - type: harvester_eoepca.postprocess.CREODIASOpenSearchSentinel2Postprocessor queue: register - name: Creodias-Opensearch-Sentinel1 resource: url: https://datahub.creodias.eu/resto/api/collections/Sentinel1/describe.xml type: OpenSearch format_config: type: 'application/json' property_mapping: start_datetime: 'startDate' end_datetime: 'completionDate' productIdentifier: 'productIdentifier' query: time: property: sensed begin: 2019-09-10T00:00:00Z end: 2019-09-11T00:00:00Z collection: null bbox: 14.9,47.7,16.4,48.7 extra_params: productType: GRD-COG filter: {} postprocess: - type: harvester_eoepca.postprocess.CREODIASOpenSearchSentinel1Postprocessor queue: register Based upon this harvester configuration we expect that the following query is made to discover data - i.e. an OpenSearch query, with json response representation, for a defined spatial and temporal extent\u2026 https://datahub.creodias.eu/resto/api/collections/Sentinel2/search.json?startDate=2019-09-10T00:00:00Z&completionDate=2019-09-11T00:00:00Z&box=14.9,47.7,16.4,48.7 From the result returned, the path to each product ( feature ) is obtained from the productIdentifier property, e.g. { \"type\": \"FeatureCollection\", \"features\": [ { \"type\": \"Feature\", \"properties\": { \"productIdentifier\": \"/eodata/Sentinel-2/MSI/L1C/2019/09/10/S2B_MSIL1C_20190910T095029_N0208_R079_T33TXN_20190910T120910.SAFE\" ... } ... } ... ] } The harvester is configured with a Sentinel-2/CREODIAS specific post-processor harvester_eoepca.postprocess.CREODIASOpenSearchSentinel2Postprocessor which transforms the product path from /eodata/... to s3://EODATA/... . The harvester post-processor follows this path to the Sentinel-2 scene and uses stactools (with built-in support for Sentinel-2) to establish a STAC item representing the product. This includes enumeration of assets for inspire-metadata and product-metadata - which are used by the registrar pycsw backend to embelesh the product record metadata. Note The above description considers Sentinel-2 data. Similar considerations apply for Sentinel-1 that is also detailed in the above harvester configuration. The harvester outputs the STAC item for each product, which is pushed to the registrar via the register redis queue. Registration \u2693\ufe0e The registrar is configured at deployment to have the access details for the CREODIAS data in S3\u2026 global: storage: data: data: type: S3 endpoint_url: http://data.cloudferro.com access_key_id: access secret_access_key: access region_name: RegionOne validate_bucket_name: false Using this S3 configuration, the registrar pycsw backend uses the product metadata linked in the STAC item (ref. assets inspire-metadata and product-metadata ) to embelesh the metadata. For example, product-metadata in the file\u2026 s3://EODATA/Sentinel-2/MSI/L1C/2019/09/10/S2B_MSIL1C_20190910T095029_N0208_R079_T33TXN_20190910T120910.SAFE/MTD_MSIL1C.xml The registrar uses this information to create the ISO XML metadata that is loaded into the resource-catalogue. Product Type \u2693\ufe0e The registrar recognises the product as Sentinel-2 and so reads its metadata XML files to obtain additional information. From the metadata XML file (e.g. MTD_MSIL1C.xml ) the registrar obtains the Product Type for each product from the field <PRODUCT_TYPE> \u2026 <n1:Level-1C_User_Product> <n1:General_Info> <Product_Info> <PRODUCT_TYPE>S2MSI1C</PRODUCT_TYPE> ... </Product_Info> ... </n1:General_Info> ... <n1:Level-1C_User_Product> Resource Catalogue Collections \u2693\ufe0e The registrar ( eoepca/rm-data-access-core ) container image is pre-loaded with two collections at the path /registrar_pycsw/registrar_pycsw/resources , (in the built container the files are at the path /usr/local/lib/python3.8/dist-packages/registrar_pycsw/resources/ ): S2MSI1C.yml - identifier: S2MSI1C S2MSI2A.yml - identifier: S2MSI2A The registrar applies these collections into the resource-catalogue during start-up - to create pre-defined out-of-the-box collections in pycsw. During registration, the PycswBackend of the registrar uses the Product Type to map the product into the collection of the same name - using metadata field parentidentifier . Data Specification \u2693\ufe0e The data-access service data handling is configured by definition of productTypes , collections and layers \u2026 productTypes identify the underlying file assets as WCS coverages and their visual representation collections provide groupings into which products are organised layers specifies the hoe the product visual representations are exposed through the WMS service productType \u2693\ufe0e During registration, products are mapped into a productType via a filter that is applied against the STAC item metadata. The registrar uses the product_type of each product to determine the collection into which the product should be registered - noting that the name of the product type does not take part in the matching logic (and hence can be any text name)\u2026 productTypes: - name: S2MSI1C filter: s2:product_type: S2MSI1C In the above example, the field s2:product_type is populated by the stactools that prepares the STAC item from the product metadata. productType - coverages \u2693\ufe0e coverages defines the coverages for the WCS service. Each coverage links to the assets that are defined within the product STAC item. productType - browses \u2693\ufe0e browses defines the images that are visualised in the View Server Client. Expressions are used to map the product assets into their visual representation. collections \u2693\ufe0e Collections are defined by reference to the defined productTypes and coverages . layers \u2693\ufe0e layers defines the layers that are presented through the WMS service - each layer being linked to the underlying browse that provides the image source. Layers are defined via their id that relies upon the naming convection <collection>__<browse> to identify the browse and so define the layer. Example Configuration \u2693\ufe0e Example configuration for Sentinel-2 L1C and L2A data. global : layers : - id : S2L1C title : Sentinel-2 Level 1C True Color abstract : Sentinel-2 Level 2A True Color displayColor : '#eb3700' grids : - name : WGS84 zoom : 13 parentLayer : S2L1C - id : S2L1C__TRUE_COLOR title : Sentinel-2 Level 1C True Color abstract : Sentinel-2 Level 2A True Color grids : - name : WGS84 zoom : 13 parentLayer : S2L1C - id : S2L1C__masked_clouds title : Sentinel-2 Level 1C True Color with cloud masks abstract : Sentinel-2 Level 1C True Color with cloud masks grids : - name : WGS84 zoom : 13 parentLayer : S2L1C - id : S2L1C__FALSE_COLOR title : Sentinel-2 Level 1C False Color abstract : Sentinel-2 Level 1C False Color grids : - name : WGS84 zoom : 13 parentLayer : S2L1C - id : S2L1C__NDVI title : Sentinel-2 Level 21CNDVI abstract : Sentinel-2 Level 1C NDVI grids : - name : WGS84 zoom : 13 parentLayer : S2L1C - id : S2L2A title : Sentinel-2 Level 2A True Color abstract : Sentinel-2 Level 2A True Color displayColor : '#eb3700' grids : - name : WGS84 zoom : 13 parentLayer : S2L2A - id : S2L2A__TRUE_COLOR title : Sentinel-2 Level 2A True Color abstract : Sentinel-2 Level 2A True Color grids : - name : WGS84 zoom : 13 parentLayer : S2L2A - id : S2L2A__masked_clouds title : Sentinel-2 Level 2A True Color with cloud masks abstract : Sentinel-2 Level 2A True Color with cloud masks grids : - name : WGS84 zoom : 13 parentLayer : S2L2A - id : S2L2A__FALSE_COLOR title : Sentinel-2 Level 2A False Color abstract : Sentinel-2 Level 2A False Color grids : - name : WGS84 zoom : 13 parentLayer : S2L2A - id : S2L2A__NDVI title : Sentinel-2 Level 2A NDVI abstract : Sentinel-2 Level 2A NDVI grids : - name : WGS84 zoom : 13 parentLayer : S2L2A collections : S2L1C : product_types : - S2MSI1C coverage_types : - S2L1C_B01 - S2L1C_B02 - S2L1C_B03 - S2L1C_B04 - S2L1C_B05 - S2L1C_B06 - S2L1C_B07 - S2L1C_B08 - S2L1C_B8A - S2L1C_B09 - S2L1C_B10 - S2L1C_B11 - S2L1C_B12 S2L2A : product_types : - S2MSI2A product_levels : - Level-2A coverage_types : - S2L2A_B01 - S2L2A_B02 - S2L2A_B03 - S2L2A_B04 - S2L2A_B05 - S2L2A_B06 - S2L2A_B07 - S2L2A_B08 - S2L2A_B8A - S2L2A_B09 - S2L2A_B11 - S2L2A_B12 productTypes : - name : S2MSI1C filter : s2:product_type : S2MSI1C metadata_assets : [] coverages : S2L1C_B01 : assets : - B01 S2L1C_B02 : assets : - B02 S2L1C_B03 : assets : - B03 S2L1C_B04 : assets : - B04 S2L1C_B05 : assets : - B05 S2L1C_B06 : assets : - B06 S2L1C_B07 : assets : - B07 S2L1C_B08 : assets : - B08 S2L1C_B8A : assets : - B8A S2L1C_B09 : assets : - B09 S2L1C_B10 : assets : - B10 S2L1C_B11 : assets : - B11 S2L1C_B12 : assets : - B12 defaultBrowse : TRUE_COLOR browses : TRUE_COLOR : asset : visual red : expression : B04 range : [ 0 , 4000 ] nodata : 0 green : expression : B03 range : [ 0 , 4000 ] nodata : 0 blue : expression : B02 range : [ 0 , 4000 ] nodata : 0 FALSE_COLOR : red : expression : B08 range : [ 0 , 4000 ] nodata : 0 green : expression : B04 range : [ 0 , 4000 ] nodata : 0 blue : expression : B03 range : [ 0 , 4000 ] nodata : 0 NDVI : grey : expression : (B08-B04)/(B08+B04) range : [ -1 , 1 ] masks : clouds : validity : false - name : S2MSI2A filter : s2:product_type : S2MSI2A metadata_assets : [] coverages : S2L2A_B01 : assets : - B01 S2L2A_B02 : assets : - B02 S2L2A_B03 : assets : - B03 S2L2A_B04 : assets : - B04 S2L2A_B05 : assets : - B05 S2L2A_B06 : assets : - B06 S2L2A_B07 : assets : - B07 S2L2A_B08 : assets : - B08 S2L2A_B8A : assets : - B8A S2L2A_B09 : assets : - B09 S2L2A_B11 : assets : - B11 S2L2A_B12 : assets : - B12 default_browse_locator : TCI_10m browses : TRUE_COLOR : asset : visual-10m red : expression : B04 range : [ 0 , 4000 ] nodata : 0 green : expression : B03 range : [ 0 , 4000 ] nodata : 0 blue : expression : B02 range : [ 0 , 4000 ] nodata : 0 FALSE_COLOR : red : expression : B08 range : [ 0 , 4000 ] nodata : 0 green : expression : B04 range : [ 0 , 4000 ] nodata : 0 blue : expression : B03 range : [ 0 , 4000 ] nodata : 0 NDVI : grey : expression : (B08-B04)/(B08+B04) range : [ -1 , 1 ] masks : clouds : validity : false","title":"CREODIAS Data"},{"location":"quickstart/creodias-deployment/#creodias-deployment","text":"","title":"CREODIAS Deployment"},{"location":"quickstart/creodias-deployment/#deployment","text":"Based upon our development experiences on CREODIAS, there is a wrapper script creodias with particular customisations suited to the CREODIAS infrastructure and data offering. The customisations are expressed through environment variables that are captured in the file creodias-options . These scripts are examples that can be seen as a starting point, from which they can be adapted to your needs. The CREODIAS deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Protected service endpoints requiring IAM authorization With reference to the file creodias-options , particular attention is drawn to the following environment variables that require tailoring to your CREODIAS (Cloudferro) environment\u2026 Passwords: MINIO_ROOT_PASSWORD , HARBOR_ADMIN_PASSWORD Identity Service credentials - e.g. IDENTITY_SERVICE_DEFAULT_SECRET , IDENTITY_SERVICE_ADMIN_PASSWORD , etc. OpenStack details: see section Openstack Configuration If configuring an external deployment - ref. Public Deployment \u2026 public_ip - The public IP address through which the deployment is exposed via the ingress-controller domain - The DNS domain name through which the deployment is accessed - forming the stem for all service hostnames in the ingress rules Once the file creodias-options has been well populated for your environment, then the deployment is initiated with\u2026 ./deploy/creodias/creodias \u2026noting that this step is a customised version of that described in section Deployment .","title":"Deployment"},{"location":"quickstart/creodias-deployment/#harvest-creodias-data","text":"The harvester can be deployed with a default configuration file at /config.yaml . As described in the Data Access section , harvesting according to this configuration can be triggered with\u2026 kubectl -n rm exec -it deployment.apps/data-access-harvester -- python3 -m harvester harvest --config-file /config.yaml --host data-access-redis-master --port 6379 Creodias-Opensearch See the Harvester section below for an explanation of this harvester configuration.","title":"Harvest CREODIAS Data"},{"location":"quickstart/creodias-deployment/#data-specification-walkthrough","text":"The example scripts include optional specifcation of data-access/harvesting configuration that is tailored for the CREODIAS data offering. This is controlled via the option CREODIAS_DATA_SPECIFICATION=true - see Environment Variables . This section provides a walkthrough of this configuration for CREODIAS - to act as an aid to understanding by way of a worked example.","title":"Data Specification Walkthrough"},{"location":"quickstart/creodias-deployment/#harvester","text":"The harvester configuration specifies datasets with spatial/temporal extents, which is configured into the file /config.yaml of the data-access-harvester deployment. The harvester is configured as follows\u2026 harvester: replicaCount: 1 resources: requests: cpu: 100m memory: 100Mi config: redis: host: data-access-redis-master port: 6379 harvesters: - name: Creodias-Opensearch resource: url: https://datahub.creodias.eu/resto/api/collections/Sentinel2/describe.xml type: OpenSearch format_config: type: 'application/json' property_mapping: start_datetime: 'startDate' end_datetime: 'completionDate' productIdentifier: 'productIdentifier' query: time: property: sensed begin: 2019-09-10T00:00:00Z end: 2019-09-11T00:00:00Z collection: null bbox: 14.9,47.7,16.4,48.7 filter: {} postprocess: - type: harvester_eoepca.postprocess.CREODIASOpenSearchSentinel2Postprocessor queue: register - name: Creodias-Opensearch-Sentinel1 resource: url: https://datahub.creodias.eu/resto/api/collections/Sentinel1/describe.xml type: OpenSearch format_config: type: 'application/json' property_mapping: start_datetime: 'startDate' end_datetime: 'completionDate' productIdentifier: 'productIdentifier' query: time: property: sensed begin: 2019-09-10T00:00:00Z end: 2019-09-11T00:00:00Z collection: null bbox: 14.9,47.7,16.4,48.7 extra_params: productType: GRD-COG filter: {} postprocess: - type: harvester_eoepca.postprocess.CREODIASOpenSearchSentinel1Postprocessor queue: register Based upon this harvester configuration we expect that the following query is made to discover data - i.e. an OpenSearch query, with json response representation, for a defined spatial and temporal extent\u2026 https://datahub.creodias.eu/resto/api/collections/Sentinel2/search.json?startDate=2019-09-10T00:00:00Z&completionDate=2019-09-11T00:00:00Z&box=14.9,47.7,16.4,48.7 From the result returned, the path to each product ( feature ) is obtained from the productIdentifier property, e.g. { \"type\": \"FeatureCollection\", \"features\": [ { \"type\": \"Feature\", \"properties\": { \"productIdentifier\": \"/eodata/Sentinel-2/MSI/L1C/2019/09/10/S2B_MSIL1C_20190910T095029_N0208_R079_T33TXN_20190910T120910.SAFE\" ... } ... } ... ] } The harvester is configured with a Sentinel-2/CREODIAS specific post-processor harvester_eoepca.postprocess.CREODIASOpenSearchSentinel2Postprocessor which transforms the product path from /eodata/... to s3://EODATA/... . The harvester post-processor follows this path to the Sentinel-2 scene and uses stactools (with built-in support for Sentinel-2) to establish a STAC item representing the product. This includes enumeration of assets for inspire-metadata and product-metadata - which are used by the registrar pycsw backend to embelesh the product record metadata. Note The above description considers Sentinel-2 data. Similar considerations apply for Sentinel-1 that is also detailed in the above harvester configuration. The harvester outputs the STAC item for each product, which is pushed to the registrar via the register redis queue.","title":"Harvester"},{"location":"quickstart/creodias-deployment/#registration","text":"The registrar is configured at deployment to have the access details for the CREODIAS data in S3\u2026 global: storage: data: data: type: S3 endpoint_url: http://data.cloudferro.com access_key_id: access secret_access_key: access region_name: RegionOne validate_bucket_name: false Using this S3 configuration, the registrar pycsw backend uses the product metadata linked in the STAC item (ref. assets inspire-metadata and product-metadata ) to embelesh the metadata. For example, product-metadata in the file\u2026 s3://EODATA/Sentinel-2/MSI/L1C/2019/09/10/S2B_MSIL1C_20190910T095029_N0208_R079_T33TXN_20190910T120910.SAFE/MTD_MSIL1C.xml The registrar uses this information to create the ISO XML metadata that is loaded into the resource-catalogue.","title":"Registration"},{"location":"quickstart/creodias-deployment/#product-type","text":"The registrar recognises the product as Sentinel-2 and so reads its metadata XML files to obtain additional information. From the metadata XML file (e.g. MTD_MSIL1C.xml ) the registrar obtains the Product Type for each product from the field <PRODUCT_TYPE> \u2026 <n1:Level-1C_User_Product> <n1:General_Info> <Product_Info> <PRODUCT_TYPE>S2MSI1C</PRODUCT_TYPE> ... </Product_Info> ... </n1:General_Info> ... <n1:Level-1C_User_Product>","title":"Product Type"},{"location":"quickstart/creodias-deployment/#resource-catalogue-collections","text":"The registrar ( eoepca/rm-data-access-core ) container image is pre-loaded with two collections at the path /registrar_pycsw/registrar_pycsw/resources , (in the built container the files are at the path /usr/local/lib/python3.8/dist-packages/registrar_pycsw/resources/ ): S2MSI1C.yml - identifier: S2MSI1C S2MSI2A.yml - identifier: S2MSI2A The registrar applies these collections into the resource-catalogue during start-up - to create pre-defined out-of-the-box collections in pycsw. During registration, the PycswBackend of the registrar uses the Product Type to map the product into the collection of the same name - using metadata field parentidentifier .","title":"Resource Catalogue Collections"},{"location":"quickstart/creodias-deployment/#data-specification","text":"The data-access service data handling is configured by definition of productTypes , collections and layers \u2026 productTypes identify the underlying file assets as WCS coverages and their visual representation collections provide groupings into which products are organised layers specifies the hoe the product visual representations are exposed through the WMS service","title":"Data Specification"},{"location":"quickstart/creodias-deployment/#producttype","text":"During registration, products are mapped into a productType via a filter that is applied against the STAC item metadata. The registrar uses the product_type of each product to determine the collection into which the product should be registered - noting that the name of the product type does not take part in the matching logic (and hence can be any text name)\u2026 productTypes: - name: S2MSI1C filter: s2:product_type: S2MSI1C In the above example, the field s2:product_type is populated by the stactools that prepares the STAC item from the product metadata.","title":"productType"},{"location":"quickstart/creodias-deployment/#collections","text":"Collections are defined by reference to the defined productTypes and coverages .","title":"collections"},{"location":"quickstart/creodias-deployment/#layers","text":"layers defines the layers that are presented through the WMS service - each layer being linked to the underlying browse that provides the image source. Layers are defined via their id that relies upon the naming convection <collection>__<browse> to identify the browse and so define the layer.","title":"layers"},{"location":"quickstart/creodias-deployment/#example-configuration","text":"Example configuration for Sentinel-2 L1C and L2A data. global : layers : - id : S2L1C title : Sentinel-2 Level 1C True Color abstract : Sentinel-2 Level 2A True Color displayColor : '#eb3700' grids : - name : WGS84 zoom : 13 parentLayer : S2L1C - id : S2L1C__TRUE_COLOR title : Sentinel-2 Level 1C True Color abstract : Sentinel-2 Level 2A True Color grids : - name : WGS84 zoom : 13 parentLayer : S2L1C - id : S2L1C__masked_clouds title : Sentinel-2 Level 1C True Color with cloud masks abstract : Sentinel-2 Level 1C True Color with cloud masks grids : - name : WGS84 zoom : 13 parentLayer : S2L1C - id : S2L1C__FALSE_COLOR title : Sentinel-2 Level 1C False Color abstract : Sentinel-2 Level 1C False Color grids : - name : WGS84 zoom : 13 parentLayer : S2L1C - id : S2L1C__NDVI title : Sentinel-2 Level 21CNDVI abstract : Sentinel-2 Level 1C NDVI grids : - name : WGS84 zoom : 13 parentLayer : S2L1C - id : S2L2A title : Sentinel-2 Level 2A True Color abstract : Sentinel-2 Level 2A True Color displayColor : '#eb3700' grids : - name : WGS84 zoom : 13 parentLayer : S2L2A - id : S2L2A__TRUE_COLOR title : Sentinel-2 Level 2A True Color abstract : Sentinel-2 Level 2A True Color grids : - name : WGS84 zoom : 13 parentLayer : S2L2A - id : S2L2A__masked_clouds title : Sentinel-2 Level 2A True Color with cloud masks abstract : Sentinel-2 Level 2A True Color with cloud masks grids : - name : WGS84 zoom : 13 parentLayer : S2L2A - id : S2L2A__FALSE_COLOR title : Sentinel-2 Level 2A False Color abstract : Sentinel-2 Level 2A False Color grids : - name : WGS84 zoom : 13 parentLayer : S2L2A - id : S2L2A__NDVI title : Sentinel-2 Level 2A NDVI abstract : Sentinel-2 Level 2A NDVI grids : - name : WGS84 zoom : 13 parentLayer : S2L2A collections : S2L1C : product_types : - S2MSI1C coverage_types : - S2L1C_B01 - S2L1C_B02 - S2L1C_B03 - S2L1C_B04 - S2L1C_B05 - S2L1C_B06 - S2L1C_B07 - S2L1C_B08 - S2L1C_B8A - S2L1C_B09 - S2L1C_B10 - S2L1C_B11 - S2L1C_B12 S2L2A : product_types : - S2MSI2A product_levels : - Level-2A coverage_types : - S2L2A_B01 - S2L2A_B02 - S2L2A_B03 - S2L2A_B04 - S2L2A_B05 - S2L2A_B06 - S2L2A_B07 - S2L2A_B08 - S2L2A_B8A - S2L2A_B09 - S2L2A_B11 - S2L2A_B12 productTypes : - name : S2MSI1C filter : s2:product_type : S2MSI1C metadata_assets : [] coverages : S2L1C_B01 : assets : - B01 S2L1C_B02 : assets : - B02 S2L1C_B03 : assets : - B03 S2L1C_B04 : assets : - B04 S2L1C_B05 : assets : - B05 S2L1C_B06 : assets : - B06 S2L1C_B07 : assets : - B07 S2L1C_B08 : assets : - B08 S2L1C_B8A : assets : - B8A S2L1C_B09 : assets : - B09 S2L1C_B10 : assets : - B10 S2L1C_B11 : assets : - B11 S2L1C_B12 : assets : - B12 defaultBrowse : TRUE_COLOR browses : TRUE_COLOR : asset : visual red : expression : B04 range : [ 0 , 4000 ] nodata : 0 green : expression : B03 range : [ 0 , 4000 ] nodata : 0 blue : expression : B02 range : [ 0 , 4000 ] nodata : 0 FALSE_COLOR : red : expression : B08 range : [ 0 , 4000 ] nodata : 0 green : expression : B04 range : [ 0 , 4000 ] nodata : 0 blue : expression : B03 range : [ 0 , 4000 ] nodata : 0 NDVI : grey : expression : (B08-B04)/(B08+B04) range : [ -1 , 1 ] masks : clouds : validity : false - name : S2MSI2A filter : s2:product_type : S2MSI2A metadata_assets : [] coverages : S2L2A_B01 : assets : - B01 S2L2A_B02 : assets : - B02 S2L2A_B03 : assets : - B03 S2L2A_B04 : assets : - B04 S2L2A_B05 : assets : - B05 S2L2A_B06 : assets : - B06 S2L2A_B07 : assets : - B07 S2L2A_B08 : assets : - B08 S2L2A_B8A : assets : - B8A S2L2A_B09 : assets : - B09 S2L2A_B11 : assets : - B11 S2L2A_B12 : assets : - B12 default_browse_locator : TCI_10m browses : TRUE_COLOR : asset : visual-10m red : expression : B04 range : [ 0 , 4000 ] nodata : 0 green : expression : B03 range : [ 0 , 4000 ] nodata : 0 blue : expression : B02 range : [ 0 , 4000 ] nodata : 0 FALSE_COLOR : red : expression : B08 range : [ 0 , 4000 ] nodata : 0 green : expression : B04 range : [ 0 , 4000 ] nodata : 0 blue : expression : B03 range : [ 0 , 4000 ] nodata : 0 NDVI : grey : expression : (B08-B04)/(B08+B04) range : [ -1 , 1 ] masks : clouds : validity : false","title":"Example Configuration"},{"location":"quickstart/data-access-deployment/","text":"Data Access Deployment \u2693\ufe0e Overview \u2693\ufe0e A deployment wrapper script has been prepared for a \u2018data access\u2019 deployment - that is focused on the Resource Catalogue and Data Access services. The script deploy/data-access/data-access achieves this by appropriate configuration of the environment variables , before launching the eoepca.sh deployment script . The deployment configuration is captured in the file deploy/data-access/data-access-options . The data-access deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Services deployed: Resource Catalogue for data discovery Data Access for data visualisation and download Includes data specification for CREODIAS Sentinel-2, which can be exploited if running in a CREODIAS VM connected to the eodata network - see description of variable CREODIAS_DATA_SPECIFICATION Open ingress are enabled for unauthenticated access to resource-catalogue and data-access services Other eoepca services not deployed Initiate Deployment \u2693\ufe0e Deployment is initiated by invoking the script\u2026 ./deploy/data-access/data-access The Resource Catalogue is accessed at the endpoint resource-catalogue-open.192-168-49-2.nip.io - e.g. resource-catalogue-open.192-168-49-2.nip.io . The Data Access View Server is accessed at the endpoint data-access-open.192-168-49-2.nip.io - e.g. data-access-open.192-168-49-2.nip.io . Post-deploy Manual Steps \u2693\ufe0e To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page. Data Harvesting \u2693\ufe0e See section Harvest CREODIAS Data to harvest the default data specification from the CREODIAS data offering.","title":"Data Access"},{"location":"quickstart/data-access-deployment/#data-access-deployment","text":"","title":"Data Access Deployment"},{"location":"quickstart/data-access-deployment/#overview","text":"A deployment wrapper script has been prepared for a \u2018data access\u2019 deployment - that is focused on the Resource Catalogue and Data Access services. The script deploy/data-access/data-access achieves this by appropriate configuration of the environment variables , before launching the eoepca.sh deployment script . The deployment configuration is captured in the file deploy/data-access/data-access-options . The data-access deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Services deployed: Resource Catalogue for data discovery Data Access for data visualisation and download Includes data specification for CREODIAS Sentinel-2, which can be exploited if running in a CREODIAS VM connected to the eodata network - see description of variable CREODIAS_DATA_SPECIFICATION Open ingress are enabled for unauthenticated access to resource-catalogue and data-access services Other eoepca services not deployed","title":"Overview"},{"location":"quickstart/data-access-deployment/#initiate-deployment","text":"Deployment is initiated by invoking the script\u2026 ./deploy/data-access/data-access The Resource Catalogue is accessed at the endpoint resource-catalogue-open.192-168-49-2.nip.io - e.g. resource-catalogue-open.192-168-49-2.nip.io . The Data Access View Server is accessed at the endpoint data-access-open.192-168-49-2.nip.io - e.g. data-access-open.192-168-49-2.nip.io .","title":"Initiate Deployment"},{"location":"quickstart/data-access-deployment/#post-deploy-manual-steps","text":"To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.","title":"Post-deploy Manual Steps"},{"location":"quickstart/data-access-deployment/#data-harvesting","text":"See section Harvest CREODIAS Data to harvest the default data specification from the CREODIAS data offering.","title":"Data Harvesting"},{"location":"quickstart/exploitation-deployment/","text":"Exploitation Deployment \u2693\ufe0e Overview \u2693\ufe0e A deployment wrapper script has been prepared for an \u2018exploitation\u2019 deployment - that provides deployment/execution of processing via the ADES, supported by Resource Catalogue and Data Access services. The script deploy/exploitation/exploitation achieves this by appropriate configuration of the environment variables , before launching the eoepca.sh deployment script . The deployment configuration is captured in the file deploy/exploitation/exploitation-options . The exploitation deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Services deployed: ADES for processing Resource Catalogue for data discovery Data Access for data visualisation and download Minio for S3 object storage ADES stage-out to Minio Includes data specification for CREODIAS Sentinel-2, which can be exploited if running in a CREODIAS VM connected to the eodata network - see description of variable CREODIAS_DATA_SPECIFICATION Open ingress are enabled for unauthenticated access to ADES, resource-catalogue and data-access services Other eoepca services not deployed Initiate Deployment \u2693\ufe0e Deployment is initiated by invoking the script\u2026 ./deploy/exploitation/exploitation The ADES service is accessed at the endpoint ades-open.192-168-49-2.nip.io . The Resource Catalogue is accessed at the endpoint resource-catalogue-open.192-168-49-2.nip.io . The Data Access View Server is accessed at the endpoint data-access-open.192-168-49-2.nip.io . Post-deploy Manual Steps \u2693\ufe0e To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page. Example Requests - s-expression on CREODIAS \u2693\ufe0e NOTE that this example processing request requires harvesting data from CREODIAS, which can only be performed if the deployment is made to a CREODIAS VM with access to the eodata network - see description of variable CREODIAS_DATA_SPECIFICATION . Section Processing provides an example of a simple self-contained processing deployment and execution , and access to the processing results . In addition to the snuggs example, the file deploy/samples/requests/processing/s-expression.http has been prepared to exploit data that has been registered within the Resource Catalogue and Data Access services. First the input data for processing must be harvested into the resource management services. Sentinel-2 data on 2nd Sept 2020\u2026 ./deploy/bin/harvest ./deploy/samples/harvester/config-Sentinel2-2020.09.02.yaml Then the s-expression.http file provides sample requests for OGC API Processes operations: List Processes Deploy Process Get Process Details Execute Process Get Job Status Get Job Results NOTE that the first requests in the file provide optional calls to obtain a user access token ( openidConfiguration / authenticate ) - to be used in the case that protected (not \u2018open\u2019) endpoints are deployed. The files snuggs.http and s-expression.http describe the HTTP requests for the ADES OGC API Processes endpoint, and is designed for use with the Visual Studio Code (vscode) extension REST Client . Install in vscode with ext install humao.rest-client . Various variables, such as to specify the @domain for your deployment, can be configured at the top of the file. At the completion of successful processing execution, the procesing results are obtained as described in section Processing Results . Data Harvesting \u2693\ufe0e See section Harvest CREODIAS Data to harvest the default data specification from the CREODIAS data offering.","title":"Exploitation"},{"location":"quickstart/exploitation-deployment/#exploitation-deployment","text":"","title":"Exploitation Deployment"},{"location":"quickstart/exploitation-deployment/#overview","text":"A deployment wrapper script has been prepared for an \u2018exploitation\u2019 deployment - that provides deployment/execution of processing via the ADES, supported by Resource Catalogue and Data Access services. The script deploy/exploitation/exploitation achieves this by appropriate configuration of the environment variables , before launching the eoepca.sh deployment script . The deployment configuration is captured in the file deploy/exploitation/exploitation-options . The exploitation deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Services deployed: ADES for processing Resource Catalogue for data discovery Data Access for data visualisation and download Minio for S3 object storage ADES stage-out to Minio Includes data specification for CREODIAS Sentinel-2, which can be exploited if running in a CREODIAS VM connected to the eodata network - see description of variable CREODIAS_DATA_SPECIFICATION Open ingress are enabled for unauthenticated access to ADES, resource-catalogue and data-access services Other eoepca services not deployed","title":"Overview"},{"location":"quickstart/exploitation-deployment/#initiate-deployment","text":"Deployment is initiated by invoking the script\u2026 ./deploy/exploitation/exploitation The ADES service is accessed at the endpoint ades-open.192-168-49-2.nip.io . The Resource Catalogue is accessed at the endpoint resource-catalogue-open.192-168-49-2.nip.io . The Data Access View Server is accessed at the endpoint data-access-open.192-168-49-2.nip.io .","title":"Initiate Deployment"},{"location":"quickstart/exploitation-deployment/#post-deploy-manual-steps","text":"To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.","title":"Post-deploy Manual Steps"},{"location":"quickstart/exploitation-deployment/#example-requests-s-expression-on-creodias","text":"NOTE that this example processing request requires harvesting data from CREODIAS, which can only be performed if the deployment is made to a CREODIAS VM with access to the eodata network - see description of variable CREODIAS_DATA_SPECIFICATION . Section Processing provides an example of a simple self-contained processing deployment and execution , and access to the processing results . In addition to the snuggs example, the file deploy/samples/requests/processing/s-expression.http has been prepared to exploit data that has been registered within the Resource Catalogue and Data Access services. First the input data for processing must be harvested into the resource management services. Sentinel-2 data on 2nd Sept 2020\u2026 ./deploy/bin/harvest ./deploy/samples/harvester/config-Sentinel2-2020.09.02.yaml Then the s-expression.http file provides sample requests for OGC API Processes operations: List Processes Deploy Process Get Process Details Execute Process Get Job Status Get Job Results NOTE that the first requests in the file provide optional calls to obtain a user access token ( openidConfiguration / authenticate ) - to be used in the case that protected (not \u2018open\u2019) endpoints are deployed. The files snuggs.http and s-expression.http describe the HTTP requests for the ADES OGC API Processes endpoint, and is designed for use with the Visual Studio Code (vscode) extension REST Client . Install in vscode with ext install humao.rest-client . Various variables, such as to specify the @domain for your deployment, can be configured at the top of the file. At the completion of successful processing execution, the procesing results are obtained as described in section Processing Results .","title":"Example Requests - s-expression on CREODIAS"},{"location":"quickstart/exploitation-deployment/#data-harvesting","text":"See section Harvest CREODIAS Data to harvest the default data specification from the CREODIAS data offering.","title":"Data Harvesting"},{"location":"quickstart/processing-deployment/","text":"Processing Deployment \u2693\ufe0e Overview \u2693\ufe0e A deployment wrapper script has been prepared for a \u2018processing\u2019 deployment - that is focused on the ADES and the deployment/execution of processing jobs. The script deploy/processing/processing achieves this by appropriate configuration of the environment variables , before launching the eoepca.sh deployment script . The deployment configuration is captured in the file deploy/processing/processing-options . The processing deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Services deployed: ADES for processing Minio for S3 object storage ADES stage-out to Minio Open ingress are enabled for unauthenticated access to ADES service Other eoepca services not deployed Initiate Deployment \u2693\ufe0e Deployment is initiated by invoking the script\u2026 ./deploy/processing/processing The ADES service is accessed at the endpoint zoo-open.192-168-49-2.nip.io . Post-deploy Manual Steps \u2693\ufe0e To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page. Example Requests \u2693\ufe0e Some sample requests have been prepared in the subdirectory deploy/samples/requests/processing - for example\u2026 convert Provides a \u2018hello world\u2019 processing example that can be used simply to check that the processing capability has been well deployed snuggs Provides a packaged EO exploitation algorithm that perform \u2018real\u2019 work and, as such, is more resource demanding (10GB RAM, 3 CPU) - and so may not be suitable for execution within a local minikube deployment (depending on resource allocations) These sample http files have been prepared with sample requests for OGC API Processes operations: List Processes Deploy Process Get Process Details Execute Process Get Job Status Get Job Results Note The first requests in the file provide optional calls to obtain a user ID token ( openidConfiguration / authenticate ). These are to be used in the case that protected (not \u2018open\u2019) endpoints are deployed. The file describes the HTTP requests for the ADES OGC API Processes endpoint, and is designed for use with the Visual Studio Code (vscode) extension REST Client . Install in vscode with ext install humao.rest-client . The variables @hostname and @domain can be configured at the top of the file. Alternative curl Commands \u2693\ufe0e Alternatively the following curl commands can be used\u2026 List Processes curl -k \\ --request GET \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes \\ --header 'accept: application/json' Deploy & Execute ( convert ) Deploy Process ( convert ) - By Reference (JSON) curl -k \\ --request POST \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes \\ --header 'accept: application/json' \\ --header 'content-type: application/json' \\ --data '{\"executionUnit\": {\"href\": \"https://raw.githubusercontent.com/EOEPCA/convert/main/convert-url-app.cwl\",\"type\": \"application/cwl\"}}' Deploy Process ( convert ) - Inline (CWL) curl -k \\ --request POST \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes \\ --header 'accept: application/json' \\ --header 'content-type: application/cwl+yaml' \\ --data '< convert-url-app.cwl' Get Process Details ( convert ) curl -k \\ --request GET \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/convert-url \\ --header 'accept: application/json' Execute Process ( convert ) curl -k -v \\ --request POST \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/convert-url/execution \\ --header 'accept: application/json' \\ --header 'content-type: application/json' \\ --header 'prefer: respond-async' \\ --data '{\"inputs\": {\"fn\": \"resize\",\"url\": \"https://eoepca.org/media_portal/images/logo6_med.original.png\", \"size\": \"50%\"},\"response\":\"raw\"}' Undeploy Process ( convert ) curl -k -v \\ --request DELETE \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/convert-url \\ --header 'accept: application/json' Deploy & Execute ( snuggs ) Deploy Process ( snuggs ) curl -k \\ --request POST \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes \\ --header 'accept: application/json' \\ --header 'content-type: application/json' \\ --data '{\"executionUnit\": {\"href\": \"https://raw.githubusercontent.com/EOEPCA/deployment-guide/eoepca-v1.4/deploy/samples/requests/processing/snuggs.cwl\",\"type\": \"application/cwl\"}}' Get Process Details ( snuggs ) curl -k \\ --request GET \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/snuggs \\ --header 'accept: application/json' Execute Process ( snuggs ) curl -k -v \\ --request POST \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/snuggs/execution \\ --header 'accept: application/json' \\ --header 'content-type: application/json' \\ --header 'prefer: respond-async' \\ --data '{\"inputs\": {\"input_reference\": \"https://earth-search.aws.element84.com/v0/collections/sentinel-s2-l2a-cogs/items/S2B_36RTT_20191205_0_L2A\",\"s_expression\": \"ndvi:(/ (- B05 B03) (+ B05 B03))\"},\"response\":\"raw\"}' Undeploy Process ( snuggs ) curl -k -v \\ --request DELETE \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/snuggs \\ --header 'accept: application/json' Get Job Status This request requires the Location header from the response to the execute request. This will be of the form http://zoo-open.192-168-49-2.nip.io/{user}/ogc-api/jobs/{job-id} - e.g. http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/jobs/7b58bc38-64d4-11ed-b962-0242ac11000e . curl -k \\ --request GET \\ --url { location-header } \\ --header 'accept: application/json' Get Job Results This request uses the same URL as Get Job Status , with the additional URL path /results - i.e. /{user}/ogc-api/jobs/{job-id}/results - e.g. /eric/ogc-api/jobs/7b58bc38-64d4-11ed-b962-0242ac11000e/results curl -k \\ --request GET \\ --url { location-header } /results \\ --header 'accept: application/json' The response indicates the location of the results, which should be in the minio object storage. See Processing Results . The response also provides links to log files regarding each step of the Application Package workflow execution - which may be useful for debugging. List Jobs curl -k \\ --request GET \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/jobs \\ --header 'accept: application/json' Processing Results \u2693\ufe0e The outputs are published as a static STAC catalogue to a path that includes the unique job ID. In the default configuration, the processing results are pushed to the Minio S3 object storage. This can be checked via browser access at the endpoint http://console.minio.192-168-49-2.nip.io/ , or using an S3 client such as\u2026 s3cmd -c ./deploy/cluster/s3cfg ls s3://eoepca For the default credentials to connect to Minio see Minio Object Storage Default Credentials . Note If the ADES deployment has been configured to stage-out to the user\u2019s Workspace, then the above s3cmd and credentials would have to be adjusted accordingly - for example the bucket s3://ws-eric .","title":"Processing"},{"location":"quickstart/processing-deployment/#processing-deployment","text":"","title":"Processing Deployment"},{"location":"quickstart/processing-deployment/#overview","text":"A deployment wrapper script has been prepared for a \u2018processing\u2019 deployment - that is focused on the ADES and the deployment/execution of processing jobs. The script deploy/processing/processing achieves this by appropriate configuration of the environment variables , before launching the eoepca.sh deployment script . The deployment configuration is captured in the file deploy/processing/processing-options . The processing deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Services deployed: ADES for processing Minio for S3 object storage ADES stage-out to Minio Open ingress are enabled for unauthenticated access to ADES service Other eoepca services not deployed","title":"Overview"},{"location":"quickstart/processing-deployment/#initiate-deployment","text":"Deployment is initiated by invoking the script\u2026 ./deploy/processing/processing The ADES service is accessed at the endpoint zoo-open.192-168-49-2.nip.io .","title":"Initiate Deployment"},{"location":"quickstart/processing-deployment/#post-deploy-manual-steps","text":"To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.","title":"Post-deploy Manual Steps"},{"location":"quickstart/processing-deployment/#example-requests","text":"Some sample requests have been prepared in the subdirectory deploy/samples/requests/processing - for example\u2026 convert Provides a \u2018hello world\u2019 processing example that can be used simply to check that the processing capability has been well deployed snuggs Provides a packaged EO exploitation algorithm that perform \u2018real\u2019 work and, as such, is more resource demanding (10GB RAM, 3 CPU) - and so may not be suitable for execution within a local minikube deployment (depending on resource allocations) These sample http files have been prepared with sample requests for OGC API Processes operations: List Processes Deploy Process Get Process Details Execute Process Get Job Status Get Job Results Note The first requests in the file provide optional calls to obtain a user ID token ( openidConfiguration / authenticate ). These are to be used in the case that protected (not \u2018open\u2019) endpoints are deployed. The file describes the HTTP requests for the ADES OGC API Processes endpoint, and is designed for use with the Visual Studio Code (vscode) extension REST Client . Install in vscode with ext install humao.rest-client . The variables @hostname and @domain can be configured at the top of the file.","title":"Example Requests"},{"location":"quickstart/processing-deployment/#alternative-curl-commands","text":"Alternatively the following curl commands can be used\u2026 List Processes curl -k \\ --request GET \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes \\ --header 'accept: application/json' Deploy & Execute ( convert ) Deploy Process ( convert ) - By Reference (JSON) curl -k \\ --request POST \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes \\ --header 'accept: application/json' \\ --header 'content-type: application/json' \\ --data '{\"executionUnit\": {\"href\": \"https://raw.githubusercontent.com/EOEPCA/convert/main/convert-url-app.cwl\",\"type\": \"application/cwl\"}}' Deploy Process ( convert ) - Inline (CWL) curl -k \\ --request POST \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes \\ --header 'accept: application/json' \\ --header 'content-type: application/cwl+yaml' \\ --data '< convert-url-app.cwl' Get Process Details ( convert ) curl -k \\ --request GET \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/convert-url \\ --header 'accept: application/json' Execute Process ( convert ) curl -k -v \\ --request POST \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/convert-url/execution \\ --header 'accept: application/json' \\ --header 'content-type: application/json' \\ --header 'prefer: respond-async' \\ --data '{\"inputs\": {\"fn\": \"resize\",\"url\": \"https://eoepca.org/media_portal/images/logo6_med.original.png\", \"size\": \"50%\"},\"response\":\"raw\"}' Undeploy Process ( convert ) curl -k -v \\ --request DELETE \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/convert-url \\ --header 'accept: application/json' Deploy & Execute ( snuggs ) Deploy Process ( snuggs ) curl -k \\ --request POST \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes \\ --header 'accept: application/json' \\ --header 'content-type: application/json' \\ --data '{\"executionUnit\": {\"href\": \"https://raw.githubusercontent.com/EOEPCA/deployment-guide/eoepca-v1.4/deploy/samples/requests/processing/snuggs.cwl\",\"type\": \"application/cwl\"}}' Get Process Details ( snuggs ) curl -k \\ --request GET \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/snuggs \\ --header 'accept: application/json' Execute Process ( snuggs ) curl -k -v \\ --request POST \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/snuggs/execution \\ --header 'accept: application/json' \\ --header 'content-type: application/json' \\ --header 'prefer: respond-async' \\ --data '{\"inputs\": {\"input_reference\": \"https://earth-search.aws.element84.com/v0/collections/sentinel-s2-l2a-cogs/items/S2B_36RTT_20191205_0_L2A\",\"s_expression\": \"ndvi:(/ (- B05 B03) (+ B05 B03))\"},\"response\":\"raw\"}' Undeploy Process ( snuggs ) curl -k -v \\ --request DELETE \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/snuggs \\ --header 'accept: application/json' Get Job Status This request requires the Location header from the response to the execute request. This will be of the form http://zoo-open.192-168-49-2.nip.io/{user}/ogc-api/jobs/{job-id} - e.g. http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/jobs/7b58bc38-64d4-11ed-b962-0242ac11000e . curl -k \\ --request GET \\ --url { location-header } \\ --header 'accept: application/json' Get Job Results This request uses the same URL as Get Job Status , with the additional URL path /results - i.e. /{user}/ogc-api/jobs/{job-id}/results - e.g. /eric/ogc-api/jobs/7b58bc38-64d4-11ed-b962-0242ac11000e/results curl -k \\ --request GET \\ --url { location-header } /results \\ --header 'accept: application/json' The response indicates the location of the results, which should be in the minio object storage. See Processing Results . The response also provides links to log files regarding each step of the Application Package workflow execution - which may be useful for debugging. List Jobs curl -k \\ --request GET \\ --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/jobs \\ --header 'accept: application/json'","title":"Alternative curl Commands"},{"location":"quickstart/processing-deployment/#processing-results","text":"The outputs are published as a static STAC catalogue to a path that includes the unique job ID. In the default configuration, the processing results are pushed to the Minio S3 object storage. This can be checked via browser access at the endpoint http://console.minio.192-168-49-2.nip.io/ , or using an S3 client such as\u2026 s3cmd -c ./deploy/cluster/s3cfg ls s3://eoepca For the default credentials to connect to Minio see Minio Object Storage Default Credentials . Note If the ADES deployment has been configured to stage-out to the user\u2019s Workspace, then the above s3cmd and credentials would have to be adjusted accordingly - for example the bucket s3://ws-eric .","title":"Processing Results"},{"location":"quickstart/quickstart/","text":"Quick Start \u2693\ufe0e Note The deployment of the EOEPCA components and the supporting Kubernetes cluster is described in the sections Prepare Cluster and Deploy EOEPCA Components . These sections should be consulted for more detailed information. Scripted Deployment \u2693\ufe0e As a companion to these descriptions, we have developed a set of scripts to provide a demonstration of example deployments - see section Scripted Deployment for a detailed description of the scripts and how they are configured and used. Note The scripted deployment assumes that installation of the Prerequisite Tooling has been performed Customised Deployments \u2693\ufe0e The Scripted Deployment can be quickly exploited through the following customisations (profiles) for particular use cases: Simple Basic local deployment Processing Deployment focused on processing Data Access Deployment focused on the Resource Catalogue and Data Access services Exploitation Deployment providing deployment/execution of processing via the ADES, supported by Resource Catalogue and Data Access services User Management Deployment focused on the Identity & Access Management services Application Hub Deployment providing the Application Hub that is pre-integrated via OIDC with the Identity Service CREODIAS Deployment with access to CREODIAS EO data Each customisation is introduced in their respective sections. Quick Example \u2693\ufe0e Follow these steps to create a simple local deployment in minikube\u2026 Prerequisite Tooling Follow the steps in section Prerequisite Tooling to install the required tooling. Clone the repository git clone -b eoepca-v1.4 https://github.com/EOEPCA/deployment-guide Initiate the deployment cd deployment-guide ./deploy/simple/simple Wait for deployment ready List pod status watch kubectl get pod -A Wait until all pods report either Running or Completed This may take 10-20 mins depending on the capabilities of your platform. Test the deployment Make the sample requests to the ADES processing service.","title":"Quick Start"},{"location":"quickstart/quickstart/#quick-start","text":"Note The deployment of the EOEPCA components and the supporting Kubernetes cluster is described in the sections Prepare Cluster and Deploy EOEPCA Components . These sections should be consulted for more detailed information.","title":"Quick Start"},{"location":"quickstart/quickstart/#scripted-deployment","text":"As a companion to these descriptions, we have developed a set of scripts to provide a demonstration of example deployments - see section Scripted Deployment for a detailed description of the scripts and how they are configured and used. Note The scripted deployment assumes that installation of the Prerequisite Tooling has been performed","title":"Scripted Deployment"},{"location":"quickstart/quickstart/#customised-deployments","text":"The Scripted Deployment can be quickly exploited through the following customisations (profiles) for particular use cases: Simple Basic local deployment Processing Deployment focused on processing Data Access Deployment focused on the Resource Catalogue and Data Access services Exploitation Deployment providing deployment/execution of processing via the ADES, supported by Resource Catalogue and Data Access services User Management Deployment focused on the Identity & Access Management services Application Hub Deployment providing the Application Hub that is pre-integrated via OIDC with the Identity Service CREODIAS Deployment with access to CREODIAS EO data Each customisation is introduced in their respective sections.","title":"Customised Deployments"},{"location":"quickstart/quickstart/#quick-example","text":"Follow these steps to create a simple local deployment in minikube\u2026 Prerequisite Tooling Follow the steps in section Prerequisite Tooling to install the required tooling. Clone the repository git clone -b eoepca-v1.4 https://github.com/EOEPCA/deployment-guide Initiate the deployment cd deployment-guide ./deploy/simple/simple Wait for deployment ready List pod status watch kubectl get pod -A Wait until all pods report either Running or Completed This may take 10-20 mins depending on the capabilities of your platform. Test the deployment Make the sample requests to the ADES processing service.","title":"Quick Example"},{"location":"quickstart/scripted-deployment/","text":"Scripted Deployment \u2693\ufe0e Overview \u2693\ufe0e The Scripted Deployment provides a demonstration of an example deployment, and can found in the subdirectory deployment-guide/deploy of the source repository for this guide\u2026 git clone -b eoepca-v1.4 https://github.com/EOEPCA/deployment-guide \\ && cd deployment-guide \\ && ls deploy The script deploy/eoepca/eoepca.sh acts as an entry-point to the full system deployment. In order to tailor the deployment for your target environment, the script is configured through environment variables and command-line arguments. By default the script assumes deployment to a local minikube. Note The scripted deployment assumes that installation of the Prerequisite Tooling has been performed. The following subsections lead through the steps for a full local deployment. Whilst minikube is assumed, minimal adaptions are required to make the deployment to your existing Kubernetes cluster. The deployment follows these broad steps: Configuration Tailoring of deployment options. Deployment Creation of cluster and deployment of eoepca services. Manual Steps Manual steps to be performed post-deployment. Configuration \u2693\ufe0e The script deploy/eoepca/eoepca.sh is configured by some environment variables and command-line arguments. Environment Variables \u2693\ufe0e Environment Variables Variable Description Default REQUIRE_<cluster-component> A set of variables that can be used to control which CLUSTER components are deployed by the script, as follows (with defaults): REQUIRE_MINIKUBE=true REQUIRE_INGRESS_NGINX=true REQUIRE_CERT_MANAGER=true REQUIRE_LETSENCRYPT=true REQUIRE_SEALED_SECRETS=false REQUIRE_MINIO=false see description REQUIRE_<eoepca-component> A set of variables that can be used to control which EOEPCA components are deployed by the script, as follows (with defaults): REQUIRE_STORAGE=true REQUIRE_DUMMY_SERVICE=false REQUIRE_IDENTITY_SERVICE=true REQUIRE_ADES=true REQUIRE_RESOURCE_CATALOGUE=true REQUIRE_DATA_ACCESS=true REQUIRE_REGISTRATION_API=true REQUIRE_WORKSPACE_API=true REQUIRE_HARBOR=true REQUIRE_PORTAL=true REQUIRE_APPLICATION_HUB=true see description REQUIRE_<protection-component> A set of variables that can be used to control which PROTECTION components are deployed by the script, as follows (with defaults): REQUIRE_DUMMY_SERVICE_PROTECTION=false REQUIRE_ADES_PROTECTION=true REQUIRE_RESOURCE_CATALOGUE_PROTECTION=true REQUIRE_DATA_ACCESS_PROTECTION=true REGISTRATION_API_PROTECTION=true REQUIRE_WORKSPACE_API_PROTECTION=true see description MINIKUBE_VERSION The Minikube version to be (optionally) installed Note that the EOEPCA development has been conducted using the default stated here. v1.32.0 MINIKUBE_KUBERNETES_VERSION The Kubernetes version to be used by minikube Note that the EOEPCA development has been conducted primarily using version 1.22.5. v1.22.5 MINIKUBE_MEMORY_AMOUNT Amount of memory to allocate to the docker containers used by minikube to implement the cluster. 12g MINIKUBE_DISK_AMOUNT Amount of disk space to allocate to the docker containers used by minikube to implement the cluster. 20g MINIKUBE_EXTRA_OPTIONS Additional options to pass to minikube start command-line --ports=80:80,443:443 USE_METALLB Enable use of minikube\u2019s built-in load-balancer. The load-balancer can be used to facilitate exposing services publicly. However, the same can be achieved using minikube\u2019s built-in ingress-controller. Therefore, this option is suppressed by default. false USE_INGRESS_NGINX_HELM Install the ingress-nginx controller using the published helm chart, rather than relying upon the version that is built-in to minikube. By default we prefer the version that is built in to minikube. false USE_INGRESS_NGINX_LOADBALANCER Patch the built-in minikube nginx-ingress-controller to offer a service of type LoadBalancer , rather than the default NodePort . It was initially thought that this would be necessary to achieve public access to the ingress services - but was subsequently found that the default NodePort configuration of the ingress-controller was sufficient. This option is left in case it proves useful. Only applicable for USE_INGRESS_NGINX_HELM=false (i.e. when using the minikube built-in ) false OPEN_INGRESS Create \u2018open\u2019 ingress endpoints that are not subject to authorization protection. For a secure system the open endpoints should be disabled ( false ) and access to resource should be protected via ingress that apply protection false USE_TLS Indicates whether TLS will be configured for service Ingress rules. If not (i.e. USE_TLS=false ), then the ingress-controller is configured to disable ssl-redirect , and TLS_CLUSTER_ISSUER=notls is set. true TLS_CLUSTER_ISSUER The name of the ClusterIssuer to satisfy ingress tls certificates. Out-of-the-box ClusterIssuer instances are configured in the file deploy/cluster/letsencrypt.sh . letsencrypt-staging IDENTITY_SERVICE_DEFAULT_SECRET Default secret that is used by exception for other Identity Service credentials changeme IDENTITY_SERVICE_ADMIN_USER The admin user for Keycloak admin IDENTITY_SERVICE_ADMIN_PASSWORD The admin user password for Keycloak ${IDENTITY_SERVICE_DEFAULT_SECRET} IDENTITY_SERVICE_ADMIN_CLIENT The Keycloak client to use for admin API tasks during scripted deployment admin-cli IDENTITY_POSTGRES_PASSWORD The password for the Keycloak Postgres service ${IDENTITY_SERVICE_DEFAULT_SECRET} IDENTITY_GATEKEEPER_CLIENT_SECRET The secret used for each Keycloak client (one per resource service) created during scripted deployment ${IDENTITY_SERVICE_DEFAULT_SECRET} IDENTITY_GATEKEEPER_ENCRYPTION_KEY The encryption key for each Keycloak client (one per resource service) created during scripted deployment changemechangeme IDENTITY_REALM Keycloak realm for Identity Service. This is not explicitly created by the scripted deployment, and so is assumed to exist within the Keycloak instance. Thus, will probably break the deployment if modified. master MINIO_ROOT_USER Name of the \u2018root\u2019 user for the Minio object storage service. eoepca MINIO_ROOT_PASSWORD Password for the \u2018root\u2019 user for the Minio object storage service. changeme HARBOR_ADMIN_PASSWORD Password for the \u2018admin\u2019 user for the Harbor artefact registry service. changeme DEFAULT_STORAGE Storage Class to be used by default for all components requiring dynamic storage provisioning. See variables <component>_STORAGE for per-component overrides. standard <component>_STORAGE A set of variables to control the dynamic provisioning Storage Class for individual components, as follows: MINIO_STORAGE ADES_STORAGE APPLICATION_HUB_STORAGE DATA_ACCESS_STORAGE HARBOR_STORAGE RESOURCE_CATALOGUE_STORAGE <DEFAULT_STORAGE> PROCESSING_MAX_RAM Max RAM allocated to an individual processing job 8Gi PROCESSING_MAX_CORES Max number of CPU cores allocated to an individual processing job 4 PROCESSING_ZOO_IMAGE Container image for zoo-dru deployment eoepca-092ea7a2c6823dba9c6d52c383a73f5ff92d0762 STAGEOUT_TARGET Configures the ADES with the destination to which it should push processing results: workspace - via the Workspace API minio - to minio S3 object storage workspace INSTALL_FLUX The Workspace API relies upon Flux CI/CD , and has the capability to install the required flux components to the cluster. If your deployment already has flux installed then set this value false to suppress the Workspace API flux install true CREODIAS_DATA_SPECIFICATION Apply the data specification to harvest from the CREODIAS data offering into the resource-catalogue and data-access services. Can only be used when running in the CREODIAS (Cloudferro) cloud, with access to the eodata network. false TEMP_FORWARDING_PORT Local port used during the scripted deployment for kubectl port-forward operations 9876 Command-line Arguments \u2693\ufe0e The eoepca.sh script is further configured via command-line arguments\u2026 eoepca.sh <action> <cluster-name> <domain> <public-ip> eoepca.sh Command-line Arguments Argument Description Default action Action to perform: apply | delete | template . apply makes the deployment delete removes the deployment template outputs generated kubernetes yaml to stdout apply cluster-name The name of the minikube \u2018profile\u2019 for the created minikube cluster eoepca domain The DNS domain name through which the deployment is accessed. Forms the stem for all service hostnames in the ingress rules - i.e. <service-name>.<domain> . By default, the value is deduced from the assigned cluster minikube IP address, using nip.io to establish a DNS lookup - i.e. <minikube ip>.nip.io . <minikube ip>.nip.io public-ip The public IP address through which the deployment is exposed via the ingress-controller. By default, the value is deduced from the assigned cluster minikube IP address - ref. command minikube ip . <minikube-ip> Public Deployment \u2693\ufe0e For simplicity, the out-of-the-box scripts assume a \u2018private\u2019 deployment - with no public IP / DNS and hence no use of TLS for service ingress endpoints. In the case that an external-facing public deployment is desired, then the following configuration selections should be made: domain - set to the domain (as per DNS records) for your deployment Note that the EOEPCA components typically configure their ingress with hostname prefixes applied to this domain . Thus, it is necessary that the DNS record for the domain is established as a wildcard record - i.e. *.<domain> public_ip - set to the public IP address through which the deployment is exposed via the ingress-controller i.e. the IP address that is assigned to the ingress controller service of type LoadBalancer USE_TLS=true - to enable configuration of TLS endpoints in each component service ingress TLS_CLUSTER_ISSUER=<issuer> - should be configured ~ e.g. using the letsencrypt-production or letsencrypt-staging (testing only) Cluster Issuer that are configured by the scripted deployment Deployment \u2693\ufe0e The deployment is initiated by setting the appropriate environment variables and invoking the eoepca.sh script with suitable command-line arguments . You may find it convenient to do so using a wrapper script that customises the environment varaibles according to your cluster, and then invokes the eoepca.sh script. Customised examples are provided for Simple, CREODIAS and Processing deployments. NOTE that if a prior deployment has been attempted then, before redeploying, a clean-up should be performed as described in the Clean-up section below. This is particularly important in the case that the minikube none driver is used, as the persistence is maintained on the host and so is not naturally removed when the minikube cluster is destroyed. Initiate the deployment\u2026 ./deploy/eoepca/eoepca.sh apply \"<cluster-name>\" \"<public-ip>\" \"<domain>\" The deployment takes 10+ minutes - depending on the resources of your host/cluster. The progress can be monitored\u2026 kubectl get pods -A The deployment is ready once all pods are either Running or Completed . Post-deployment Manual Steps \u2693\ufe0e The scripted deployment has been designed, as far as possible, to automate the configuration of the deployed components. However, there remain some steps that must be performed manually after the scripted deployment has completed. See the building block specific pages\u2026 Identity Service: Token Lifespans Application Hub: Post-deployment Manual Steps Default Credentials \u2693\ufe0e Identity Service \u2693\ufe0e By default, the Identity Service is accessed at the URL https://keycloak.192-168-49-2.nip.io/ with the credentials\u2026 username: `admin` password: `changeme` \u2026unless the password is overridden via the variable IDENTITY_SERVICE_ADMIN_PASSWORD . Minio Object Storage \u2693\ufe0e By default, Minio is accessed at the URL https://console.minio.192-168-49-2.nip.io/ with the credentials\u2026 username: `eoepca` password: `changeme` \u2026unless the username/password are overridden via the variables MINIO_ROOT_USER and MINIO_ROOT_PASSWORD . Harbor Container Registry \u2693\ufe0e By default, Harbor is accessed at the URL https://harbor.192-168-49-2.nip.io/ with the credentials\u2026 username: `admin` password: `changeme` \u2026unless the password is overridden via the variable HARBOR_ADMIN_PASSWORD . Protection \u2693\ufe0e The protection of resource server endpoints is applied during the deployment of each service requiring protection. This comprises creating a dedicated Keycloak client for each resource server, and the creation of associated resources and policies that protect the service-specific URLs. This protection can be disabled via the environment variables REQUIRE_XXX_PROTECTION - e.g. REQUIRE_ADES_PROTECTION=false . Note By default, if OPEN_INGRESS is set true then PROTECTION will be disabled ( false ) unless overridden via the REQUIRE_XXX_PROTECTION variables. Test Users \u2693\ufe0e The deployment creates (in the Keycloak Identity Service) the test users: eric , bob , alice . Note This does NOT create the workspace for each of these users - which must be performed via the Workspace API. User Workspace Creation \u2693\ufe0e The deployment created the test users eric , bob and alice . For completeness we use the Workspace API to create their user workspaces, which hold their personal resources (data, processing results, etc.) within the platform - see Workspace . Using Workspace Swagger UI \u2693\ufe0e The Workspace API provides a Swagger UI that facilitates interaction with the API - at the URL https://workspace-api.192-168-49-2.nip.io/docs# . Note If the Workspace API has been protected ( via Gatekeeper with Keycloak ), then requests must be supported by an access_token carried in the HTTP header Authorozation: Bearer <token> . This diminishes the utility of the swagger UI. Access the Workspace Swagger UI at https://workspace-api.192-168-49-2.nip.io/docs . Workspaces are created using POST /workspaces (Create Workspace) . Expand the node and select Try it out . Complete the request body, such as\u2026 { \"preferred_name\" : \"eric\" , \"default_owner\" : \"eric\" } \u2026where the default_owner is the ID for the user in Keycloak - thus protecting the created workspace for the identified user. Using curl \u2693\ufe0e The same can be achieved with a straight http request, for example using curl \u2026 curl -X 'POST' \\ 'http://workspace-api.192-168-49-2.nip.io/workspaces' \\ -H 'Content-Type: application/json' \\ -H 'Accept: application/json' \\ -H 'Authorization: Bearer <admin-access-token>' \\ -d '{ \"preferred_name\": \"<workspace-name>\", \"default_owner\": \"<user-id>\" }' Values must be provided for: admin-access-token - Access Token for the admin user workspace-name - name of the workspace, typically the username user-id - the ID of the user for which the created workspace will be protected, typically the username The Access Token for the admin user can be obtained with a call to the token endpoint of the Identity Service - supplying the credentials for the admin user and the pre-registered client\u2026 curl -L -X POST 'https://keycloak.192-168-49-2.nip.io/realms/master/protocol/openid-connect/token' \\ -H 'Cache-Control: no-cache' \\ -H 'Content-Type: application/x-www-form-urlencoded' \\ --data-urlencode 'scope=openid profile email' \\ --data-urlencode 'grant_type=password' \\ --data-urlencode 'username=admin' \\ --data-urlencode 'password=<admin-password>' \\ --data-urlencode 'client_id=admin-cli' A json response is returned, in which the field access_token provides the Access Token for the admin user. Using create-workspace helper script \u2693\ufe0e As an aide there is a helper script create-workspace . The script is available in the deployment-guide repository , and can be obtained as follows\u2026 git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide cd deployment-guide The create-workspace helper script requires some command-line arguments\u2026 $ ./deploy/bin/create-workspace -h Create a new User Workspace. create-workspace -h | -w {workspace_api} -a {auth_server} -r {realm} -c {client} -u {admin-username} -p {admin-password} -O {owner} -W {workspace-name} where: -h show help message -w workspace-api service url (default: http://workspace-api.192-168-49-2.nip.io) -a authorization server url (default: http://keycloak.192-168-49-2.nip.io) -r realm within Keycloak (default: master) -u username used for authentication (default: admin) -p password used for authentication (default: changeme) -c client id of the bootstrap client used in the create request (default: admin-cli) -O user ID of the 'owner' of the new workspace (default: workspace(-W)) -W name of the workspace to create (default: owner(-O)) Most of the arguments have default values that are aligned to the defaults of the scripted deployment. At minimum either -O owner or -W workspace must be specified. For example (assuming defaults)\u2026 ./deploy/bin/create-workspace -O eric For example (all arguments)\u2026 ./deploy/bin/create-workspace -w http://workspace-api.192-168-49-2.nip.io \\ -a http://keycloak.192-168-49-2.nip.io \\ -r master \\ -u admin \\ -p changeme \\ -c admin-cli \\ -O bob \\ -W bob EOEPCA Portal \u2693\ufe0e The eoepca-portal is a simple web application that is used as a test aid. It\u2019s main purpose is to provide the ability to login, and so establish a session with appropriate browser cookies - which then allow authenticated access to other EOEPCA services such as the Workspace API, Identity API, etc. The portal is deployed via a helm chart\u2026 helm install eoepca-portal eoepca-portal -f portal-values.yaml - \\ --repo https://eoepca.github.io/helm-charts \\ --namespace \"demo\" --create-namespace \\ --version 1 .0.11 The helm values must be tailored for your deployment. For example\u2026 configMap : identity_url : \"http://keycloak.192-168-49-2.nip.io\" realm : \"master\" client_id : \"eoepca-portal\" identity_api_url : \"http://identity-api.192-168-49-2.nip.io\" ades_url : \"http://zoo.192-168-49-2.nip.io/ogc-api/processes\" resource_catalogue_url : \"http://resource-catalogue.192-168-49-2.nip.io\" data_access_url : \"http://data-access.192-168-49-2.nip.io\" workspace_url : \"http://workspace-api.192-168-49-2.nip.io\" workspace_docs_url : \"http://workspace-api.192-168-49-2.nip.io/docs#\" images_registry_url : \"http://harbor.192-168-49-2.nip.io\" dummy_service_url : \"http://dummy-service.192-168-49-2.nip.io\" access_token_name : \"auth_user_id\" access_token_domain : \".192-168-49-2.nip.io\" refresh_token_name : \"auth_refresh_token\" refresh_token_domain : \".192-168-49-2.nip.io\" ingress : enabled : true annotations : kubernetes.io/ingress.class : nginx ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production hosts : - host : eoepca-portal.192-168-49-2.nip.io paths : - path : / pathType : Prefix tls : - secretName : eoepca-portal-tls hosts : - eoepca-portal.192-168-49-2.nip.io The setting client_id: eoepca-portal identifies a client that must be created in Keycloak - as described in section create-client Helper Script - noting that the eoepca-portal requires a client that is configured as a Public Client \u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = eoepca-portal \\ --name = \"EOEPCA Portal\" \\ --public \\ --description = \"Client to be used by the EOEPCA Portal\" Clean-up \u2693\ufe0e Before initiating a fresh deployment, if a prior deployment has been attempted, then it is necessary to remove any persistent artefacts of the prior deployment. This includes\u2026 Minikube cluster Delete the minikube cluster\u2026 minikube delete If necessary specify the cluster (profile)\u2026 minikube -p <profile> delete Persistent Data In the case that the minikube none driver is used, the persistence is maintained on the host and so is not naturally removed when the minikube cluster is destroyed. In this case, the minikube standard StorageClass is fulfilled by the hostpath provisioner, whose persistence is removed as follows\u2026 sudo rm -rf /tmp/hostpath-provisioner There is a helper script clean that can be used for step 2 above, (the script does not delete the cluster). ./deploy/cluster/clean","title":"Scripted Deployment"},{"location":"quickstart/scripted-deployment/#scripted-deployment","text":"","title":"Scripted Deployment"},{"location":"quickstart/scripted-deployment/#overview","text":"The Scripted Deployment provides a demonstration of an example deployment, and can found in the subdirectory deployment-guide/deploy of the source repository for this guide\u2026 git clone -b eoepca-v1.4 https://github.com/EOEPCA/deployment-guide \\ && cd deployment-guide \\ && ls deploy The script deploy/eoepca/eoepca.sh acts as an entry-point to the full system deployment. In order to tailor the deployment for your target environment, the script is configured through environment variables and command-line arguments. By default the script assumes deployment to a local minikube. Note The scripted deployment assumes that installation of the Prerequisite Tooling has been performed. The following subsections lead through the steps for a full local deployment. Whilst minikube is assumed, minimal adaptions are required to make the deployment to your existing Kubernetes cluster. The deployment follows these broad steps: Configuration Tailoring of deployment options. Deployment Creation of cluster and deployment of eoepca services. Manual Steps Manual steps to be performed post-deployment.","title":"Overview"},{"location":"quickstart/scripted-deployment/#configuration","text":"The script deploy/eoepca/eoepca.sh is configured by some environment variables and command-line arguments.","title":"Configuration"},{"location":"quickstart/scripted-deployment/#environment-variables","text":"Environment Variables Variable Description Default REQUIRE_<cluster-component> A set of variables that can be used to control which CLUSTER components are deployed by the script, as follows (with defaults): REQUIRE_MINIKUBE=true REQUIRE_INGRESS_NGINX=true REQUIRE_CERT_MANAGER=true REQUIRE_LETSENCRYPT=true REQUIRE_SEALED_SECRETS=false REQUIRE_MINIO=false see description REQUIRE_<eoepca-component> A set of variables that can be used to control which EOEPCA components are deployed by the script, as follows (with defaults): REQUIRE_STORAGE=true REQUIRE_DUMMY_SERVICE=false REQUIRE_IDENTITY_SERVICE=true REQUIRE_ADES=true REQUIRE_RESOURCE_CATALOGUE=true REQUIRE_DATA_ACCESS=true REQUIRE_REGISTRATION_API=true REQUIRE_WORKSPACE_API=true REQUIRE_HARBOR=true REQUIRE_PORTAL=true REQUIRE_APPLICATION_HUB=true see description REQUIRE_<protection-component> A set of variables that can be used to control which PROTECTION components are deployed by the script, as follows (with defaults): REQUIRE_DUMMY_SERVICE_PROTECTION=false REQUIRE_ADES_PROTECTION=true REQUIRE_RESOURCE_CATALOGUE_PROTECTION=true REQUIRE_DATA_ACCESS_PROTECTION=true REGISTRATION_API_PROTECTION=true REQUIRE_WORKSPACE_API_PROTECTION=true see description MINIKUBE_VERSION The Minikube version to be (optionally) installed Note that the EOEPCA development has been conducted using the default stated here. v1.32.0 MINIKUBE_KUBERNETES_VERSION The Kubernetes version to be used by minikube Note that the EOEPCA development has been conducted primarily using version 1.22.5. v1.22.5 MINIKUBE_MEMORY_AMOUNT Amount of memory to allocate to the docker containers used by minikube to implement the cluster. 12g MINIKUBE_DISK_AMOUNT Amount of disk space to allocate to the docker containers used by minikube to implement the cluster. 20g MINIKUBE_EXTRA_OPTIONS Additional options to pass to minikube start command-line --ports=80:80,443:443 USE_METALLB Enable use of minikube\u2019s built-in load-balancer. The load-balancer can be used to facilitate exposing services publicly. However, the same can be achieved using minikube\u2019s built-in ingress-controller. Therefore, this option is suppressed by default. false USE_INGRESS_NGINX_HELM Install the ingress-nginx controller using the published helm chart, rather than relying upon the version that is built-in to minikube. By default we prefer the version that is built in to minikube. false USE_INGRESS_NGINX_LOADBALANCER Patch the built-in minikube nginx-ingress-controller to offer a service of type LoadBalancer , rather than the default NodePort . It was initially thought that this would be necessary to achieve public access to the ingress services - but was subsequently found that the default NodePort configuration of the ingress-controller was sufficient. This option is left in case it proves useful. Only applicable for USE_INGRESS_NGINX_HELM=false (i.e. when using the minikube built-in ) false OPEN_INGRESS Create \u2018open\u2019 ingress endpoints that are not subject to authorization protection. For a secure system the open endpoints should be disabled ( false ) and access to resource should be protected via ingress that apply protection false USE_TLS Indicates whether TLS will be configured for service Ingress rules. If not (i.e. USE_TLS=false ), then the ingress-controller is configured to disable ssl-redirect , and TLS_CLUSTER_ISSUER=notls is set. true TLS_CLUSTER_ISSUER The name of the ClusterIssuer to satisfy ingress tls certificates. Out-of-the-box ClusterIssuer instances are configured in the file deploy/cluster/letsencrypt.sh . letsencrypt-staging IDENTITY_SERVICE_DEFAULT_SECRET Default secret that is used by exception for other Identity Service credentials changeme IDENTITY_SERVICE_ADMIN_USER The admin user for Keycloak admin IDENTITY_SERVICE_ADMIN_PASSWORD The admin user password for Keycloak ${IDENTITY_SERVICE_DEFAULT_SECRET} IDENTITY_SERVICE_ADMIN_CLIENT The Keycloak client to use for admin API tasks during scripted deployment admin-cli IDENTITY_POSTGRES_PASSWORD The password for the Keycloak Postgres service ${IDENTITY_SERVICE_DEFAULT_SECRET} IDENTITY_GATEKEEPER_CLIENT_SECRET The secret used for each Keycloak client (one per resource service) created during scripted deployment ${IDENTITY_SERVICE_DEFAULT_SECRET} IDENTITY_GATEKEEPER_ENCRYPTION_KEY The encryption key for each Keycloak client (one per resource service) created during scripted deployment changemechangeme IDENTITY_REALM Keycloak realm for Identity Service. This is not explicitly created by the scripted deployment, and so is assumed to exist within the Keycloak instance. Thus, will probably break the deployment if modified. master MINIO_ROOT_USER Name of the \u2018root\u2019 user for the Minio object storage service. eoepca MINIO_ROOT_PASSWORD Password for the \u2018root\u2019 user for the Minio object storage service. changeme HARBOR_ADMIN_PASSWORD Password for the \u2018admin\u2019 user for the Harbor artefact registry service. changeme DEFAULT_STORAGE Storage Class to be used by default for all components requiring dynamic storage provisioning. See variables <component>_STORAGE for per-component overrides. standard <component>_STORAGE A set of variables to control the dynamic provisioning Storage Class for individual components, as follows: MINIO_STORAGE ADES_STORAGE APPLICATION_HUB_STORAGE DATA_ACCESS_STORAGE HARBOR_STORAGE RESOURCE_CATALOGUE_STORAGE <DEFAULT_STORAGE> PROCESSING_MAX_RAM Max RAM allocated to an individual processing job 8Gi PROCESSING_MAX_CORES Max number of CPU cores allocated to an individual processing job 4 PROCESSING_ZOO_IMAGE Container image for zoo-dru deployment eoepca-092ea7a2c6823dba9c6d52c383a73f5ff92d0762 STAGEOUT_TARGET Configures the ADES with the destination to which it should push processing results: workspace - via the Workspace API minio - to minio S3 object storage workspace INSTALL_FLUX The Workspace API relies upon Flux CI/CD , and has the capability to install the required flux components to the cluster. If your deployment already has flux installed then set this value false to suppress the Workspace API flux install true CREODIAS_DATA_SPECIFICATION Apply the data specification to harvest from the CREODIAS data offering into the resource-catalogue and data-access services. Can only be used when running in the CREODIAS (Cloudferro) cloud, with access to the eodata network. false TEMP_FORWARDING_PORT Local port used during the scripted deployment for kubectl port-forward operations 9876","title":"Environment Variables"},{"location":"quickstart/scripted-deployment/#command-line-arguments","text":"The eoepca.sh script is further configured via command-line arguments\u2026 eoepca.sh <action> <cluster-name> <domain> <public-ip> eoepca.sh Command-line Arguments Argument Description Default action Action to perform: apply | delete | template . apply makes the deployment delete removes the deployment template outputs generated kubernetes yaml to stdout apply cluster-name The name of the minikube \u2018profile\u2019 for the created minikube cluster eoepca domain The DNS domain name through which the deployment is accessed. Forms the stem for all service hostnames in the ingress rules - i.e. <service-name>.<domain> . By default, the value is deduced from the assigned cluster minikube IP address, using nip.io to establish a DNS lookup - i.e. <minikube ip>.nip.io . <minikube ip>.nip.io public-ip The public IP address through which the deployment is exposed via the ingress-controller. By default, the value is deduced from the assigned cluster minikube IP address - ref. command minikube ip . <minikube-ip>","title":"Command-line Arguments"},{"location":"quickstart/scripted-deployment/#public-deployment","text":"For simplicity, the out-of-the-box scripts assume a \u2018private\u2019 deployment - with no public IP / DNS and hence no use of TLS for service ingress endpoints. In the case that an external-facing public deployment is desired, then the following configuration selections should be made: domain - set to the domain (as per DNS records) for your deployment Note that the EOEPCA components typically configure their ingress with hostname prefixes applied to this domain . Thus, it is necessary that the DNS record for the domain is established as a wildcard record - i.e. *.<domain> public_ip - set to the public IP address through which the deployment is exposed via the ingress-controller i.e. the IP address that is assigned to the ingress controller service of type LoadBalancer USE_TLS=true - to enable configuration of TLS endpoints in each component service ingress TLS_CLUSTER_ISSUER=<issuer> - should be configured ~ e.g. using the letsencrypt-production or letsencrypt-staging (testing only) Cluster Issuer that are configured by the scripted deployment","title":"Public Deployment"},{"location":"quickstart/scripted-deployment/#deployment","text":"The deployment is initiated by setting the appropriate environment variables and invoking the eoepca.sh script with suitable command-line arguments . You may find it convenient to do so using a wrapper script that customises the environment varaibles according to your cluster, and then invokes the eoepca.sh script. Customised examples are provided for Simple, CREODIAS and Processing deployments. NOTE that if a prior deployment has been attempted then, before redeploying, a clean-up should be performed as described in the Clean-up section below. This is particularly important in the case that the minikube none driver is used, as the persistence is maintained on the host and so is not naturally removed when the minikube cluster is destroyed. Initiate the deployment\u2026 ./deploy/eoepca/eoepca.sh apply \"<cluster-name>\" \"<public-ip>\" \"<domain>\" The deployment takes 10+ minutes - depending on the resources of your host/cluster. The progress can be monitored\u2026 kubectl get pods -A The deployment is ready once all pods are either Running or Completed .","title":"Deployment"},{"location":"quickstart/scripted-deployment/#post-deployment-manual-steps","text":"The scripted deployment has been designed, as far as possible, to automate the configuration of the deployed components. However, there remain some steps that must be performed manually after the scripted deployment has completed. See the building block specific pages\u2026 Identity Service: Token Lifespans Application Hub: Post-deployment Manual Steps","title":"Post-deployment Manual Steps"},{"location":"quickstart/scripted-deployment/#default-credentials","text":"","title":"Default Credentials"},{"location":"quickstart/scripted-deployment/#identity-service","text":"By default, the Identity Service is accessed at the URL https://keycloak.192-168-49-2.nip.io/ with the credentials\u2026 username: `admin` password: `changeme` \u2026unless the password is overridden via the variable IDENTITY_SERVICE_ADMIN_PASSWORD .","title":"Identity Service"},{"location":"quickstart/scripted-deployment/#minio-object-storage","text":"By default, Minio is accessed at the URL https://console.minio.192-168-49-2.nip.io/ with the credentials\u2026 username: `eoepca` password: `changeme` \u2026unless the username/password are overridden via the variables MINIO_ROOT_USER and MINIO_ROOT_PASSWORD .","title":"Minio Object Storage"},{"location":"quickstart/scripted-deployment/#harbor-container-registry","text":"By default, Harbor is accessed at the URL https://harbor.192-168-49-2.nip.io/ with the credentials\u2026 username: `admin` password: `changeme` \u2026unless the password is overridden via the variable HARBOR_ADMIN_PASSWORD .","title":"Harbor Container Registry"},{"location":"quickstart/scripted-deployment/#protection","text":"The protection of resource server endpoints is applied during the deployment of each service requiring protection. This comprises creating a dedicated Keycloak client for each resource server, and the creation of associated resources and policies that protect the service-specific URLs. This protection can be disabled via the environment variables REQUIRE_XXX_PROTECTION - e.g. REQUIRE_ADES_PROTECTION=false . Note By default, if OPEN_INGRESS is set true then PROTECTION will be disabled ( false ) unless overridden via the REQUIRE_XXX_PROTECTION variables.","title":"Protection"},{"location":"quickstart/scripted-deployment/#test-users","text":"The deployment creates (in the Keycloak Identity Service) the test users: eric , bob , alice . Note This does NOT create the workspace for each of these users - which must be performed via the Workspace API.","title":"Test Users"},{"location":"quickstart/scripted-deployment/#user-workspace-creation","text":"The deployment created the test users eric , bob and alice . For completeness we use the Workspace API to create their user workspaces, which hold their personal resources (data, processing results, etc.) within the platform - see Workspace .","title":"User Workspace Creation"},{"location":"quickstart/scripted-deployment/#using-workspace-swagger-ui","text":"The Workspace API provides a Swagger UI that facilitates interaction with the API - at the URL https://workspace-api.192-168-49-2.nip.io/docs# . Note If the Workspace API has been protected ( via Gatekeeper with Keycloak ), then requests must be supported by an access_token carried in the HTTP header Authorozation: Bearer <token> . This diminishes the utility of the swagger UI. Access the Workspace Swagger UI at https://workspace-api.192-168-49-2.nip.io/docs . Workspaces are created using POST /workspaces (Create Workspace) . Expand the node and select Try it out . Complete the request body, such as\u2026 { \"preferred_name\" : \"eric\" , \"default_owner\" : \"eric\" } \u2026where the default_owner is the ID for the user in Keycloak - thus protecting the created workspace for the identified user.","title":"Using Workspace Swagger UI"},{"location":"quickstart/scripted-deployment/#using-curl","text":"The same can be achieved with a straight http request, for example using curl \u2026 curl -X 'POST' \\ 'http://workspace-api.192-168-49-2.nip.io/workspaces' \\ -H 'Content-Type: application/json' \\ -H 'Accept: application/json' \\ -H 'Authorization: Bearer <admin-access-token>' \\ -d '{ \"preferred_name\": \"<workspace-name>\", \"default_owner\": \"<user-id>\" }' Values must be provided for: admin-access-token - Access Token for the admin user workspace-name - name of the workspace, typically the username user-id - the ID of the user for which the created workspace will be protected, typically the username The Access Token for the admin user can be obtained with a call to the token endpoint of the Identity Service - supplying the credentials for the admin user and the pre-registered client\u2026 curl -L -X POST 'https://keycloak.192-168-49-2.nip.io/realms/master/protocol/openid-connect/token' \\ -H 'Cache-Control: no-cache' \\ -H 'Content-Type: application/x-www-form-urlencoded' \\ --data-urlencode 'scope=openid profile email' \\ --data-urlencode 'grant_type=password' \\ --data-urlencode 'username=admin' \\ --data-urlencode 'password=<admin-password>' \\ --data-urlencode 'client_id=admin-cli' A json response is returned, in which the field access_token provides the Access Token for the admin user.","title":"Using curl"},{"location":"quickstart/scripted-deployment/#using-create-workspace-helper-script","text":"As an aide there is a helper script create-workspace . The script is available in the deployment-guide repository , and can be obtained as follows\u2026 git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide cd deployment-guide The create-workspace helper script requires some command-line arguments\u2026 $ ./deploy/bin/create-workspace -h Create a new User Workspace. create-workspace -h | -w {workspace_api} -a {auth_server} -r {realm} -c {client} -u {admin-username} -p {admin-password} -O {owner} -W {workspace-name} where: -h show help message -w workspace-api service url (default: http://workspace-api.192-168-49-2.nip.io) -a authorization server url (default: http://keycloak.192-168-49-2.nip.io) -r realm within Keycloak (default: master) -u username used for authentication (default: admin) -p password used for authentication (default: changeme) -c client id of the bootstrap client used in the create request (default: admin-cli) -O user ID of the 'owner' of the new workspace (default: workspace(-W)) -W name of the workspace to create (default: owner(-O)) Most of the arguments have default values that are aligned to the defaults of the scripted deployment. At minimum either -O owner or -W workspace must be specified. For example (assuming defaults)\u2026 ./deploy/bin/create-workspace -O eric For example (all arguments)\u2026 ./deploy/bin/create-workspace -w http://workspace-api.192-168-49-2.nip.io \\ -a http://keycloak.192-168-49-2.nip.io \\ -r master \\ -u admin \\ -p changeme \\ -c admin-cli \\ -O bob \\ -W bob","title":"Using create-workspace helper script"},{"location":"quickstart/scripted-deployment/#eoepca-portal","text":"The eoepca-portal is a simple web application that is used as a test aid. It\u2019s main purpose is to provide the ability to login, and so establish a session with appropriate browser cookies - which then allow authenticated access to other EOEPCA services such as the Workspace API, Identity API, etc. The portal is deployed via a helm chart\u2026 helm install eoepca-portal eoepca-portal -f portal-values.yaml - \\ --repo https://eoepca.github.io/helm-charts \\ --namespace \"demo\" --create-namespace \\ --version 1 .0.11 The helm values must be tailored for your deployment. For example\u2026 configMap : identity_url : \"http://keycloak.192-168-49-2.nip.io\" realm : \"master\" client_id : \"eoepca-portal\" identity_api_url : \"http://identity-api.192-168-49-2.nip.io\" ades_url : \"http://zoo.192-168-49-2.nip.io/ogc-api/processes\" resource_catalogue_url : \"http://resource-catalogue.192-168-49-2.nip.io\" data_access_url : \"http://data-access.192-168-49-2.nip.io\" workspace_url : \"http://workspace-api.192-168-49-2.nip.io\" workspace_docs_url : \"http://workspace-api.192-168-49-2.nip.io/docs#\" images_registry_url : \"http://harbor.192-168-49-2.nip.io\" dummy_service_url : \"http://dummy-service.192-168-49-2.nip.io\" access_token_name : \"auth_user_id\" access_token_domain : \".192-168-49-2.nip.io\" refresh_token_name : \"auth_refresh_token\" refresh_token_domain : \".192-168-49-2.nip.io\" ingress : enabled : true annotations : kubernetes.io/ingress.class : nginx ingress.kubernetes.io/ssl-redirect : \"true\" nginx.ingress.kubernetes.io/ssl-redirect : \"true\" cert-manager.io/cluster-issuer : letsencrypt-production hosts : - host : eoepca-portal.192-168-49-2.nip.io paths : - path : / pathType : Prefix tls : - secretName : eoepca-portal-tls hosts : - eoepca-portal.192-168-49-2.nip.io The setting client_id: eoepca-portal identifies a client that must be created in Keycloak - as described in section create-client Helper Script - noting that the eoepca-portal requires a client that is configured as a Public Client \u2026 ../bin/create-client \\ -a https://keycloak.192-168-49-2.nip.io \\ -i https://identity-api.192-168-49-2.nip.io \\ -r \"master\" \\ -u \"admin\" \\ -p \"changeme\" \\ -c \"admin-cli\" \\ --id = eoepca-portal \\ --name = \"EOEPCA Portal\" \\ --public \\ --description = \"Client to be used by the EOEPCA Portal\"","title":"EOEPCA Portal"},{"location":"quickstart/scripted-deployment/#clean-up","text":"Before initiating a fresh deployment, if a prior deployment has been attempted, then it is necessary to remove any persistent artefacts of the prior deployment. This includes\u2026 Minikube cluster Delete the minikube cluster\u2026 minikube delete If necessary specify the cluster (profile)\u2026 minikube -p <profile> delete Persistent Data In the case that the minikube none driver is used, the persistence is maintained on the host and so is not naturally removed when the minikube cluster is destroyed. In this case, the minikube standard StorageClass is fulfilled by the hostpath provisioner, whose persistence is removed as follows\u2026 sudo rm -rf /tmp/hostpath-provisioner There is a helper script clean that can be used for step 2 above, (the script does not delete the cluster). ./deploy/cluster/clean","title":"Clean-up"},{"location":"quickstart/simple-deployment/","text":"Simple Deployment \u2693\ufe0e Overview \u2693\ufe0e A deployment wrapper script has been prepared for a \u2018simple\u2019 deployment - designed to get a core local deployment of the primary servies. The script deploy/simple/simple achieves this by appropriate configuration of the environment variables , before launching the eoepca.sh deployment script . The deployment configuration is captured in the file deploy/simple/simple-options . The simple deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Configuration of \u2018open\u2019 interfaces - i.e. service/API endpoints that are not protected and can accessed without authentication. This facilitates experimentation with the services Configuration of ADES stage-out to a local instance of minio , to avoid the need to create a Workspace for each user Initiate Deployment \u2693\ufe0e Deployment is initiated by invoking the script\u2026 ./deploy/simple/simple See section Deployment for more details regarding the outcome of the scripted deployment. Post-deploy Manual Steps \u2693\ufe0e To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.","title":"Simple"},{"location":"quickstart/simple-deployment/#simple-deployment","text":"","title":"Simple Deployment"},{"location":"quickstart/simple-deployment/#overview","text":"A deployment wrapper script has been prepared for a \u2018simple\u2019 deployment - designed to get a core local deployment of the primary servies. The script deploy/simple/simple achieves this by appropriate configuration of the environment variables , before launching the eoepca.sh deployment script . The deployment configuration is captured in the file deploy/simple/simple-options . The simple deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Configuration of \u2018open\u2019 interfaces - i.e. service/API endpoints that are not protected and can accessed without authentication. This facilitates experimentation with the services Configuration of ADES stage-out to a local instance of minio , to avoid the need to create a Workspace for each user","title":"Overview"},{"location":"quickstart/simple-deployment/#initiate-deployment","text":"Deployment is initiated by invoking the script\u2026 ./deploy/simple/simple See section Deployment for more details regarding the outcome of the scripted deployment.","title":"Initiate Deployment"},{"location":"quickstart/simple-deployment/#post-deploy-manual-steps","text":"To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.","title":"Post-deploy Manual Steps"},{"location":"quickstart/userman-deployment/","text":"User Management Deployment \u2693\ufe0e Overview \u2693\ufe0e A deployment wrapper script has been prepared for a \u2018user management\u2019 deployment - that is focused on the Identity Service (Authorization Server), Identity API and Gatekeeper (Protection Policy Enforcement). The script deploy/userman/userman achieves this by appropriate configuration of the environment variables , before launching the eoepca.sh deployment script . The deployment configuration is captured in the file deploy/userman/userman-options . The user-management deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Services deployed: Identity Service Identity API Gatekeeper instance, protecting the Identity API Other eoepca services not deployed Initiate Deployment \u2693\ufe0e Deployment is initiated by invoking the script\u2026 ./deploy/userman/userman The Identity Service is accessed at the endpoint keycloak.192-168-49-2.nip.io . The Identity API is accessed at the endpoint identity-api.192-168-49-2.nip.io . Post-deploy Manual Steps \u2693\ufe0e To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.","title":"User Management"},{"location":"quickstart/userman-deployment/#user-management-deployment","text":"","title":"User Management Deployment"},{"location":"quickstart/userman-deployment/#overview","text":"A deployment wrapper script has been prepared for a \u2018user management\u2019 deployment - that is focused on the Identity Service (Authorization Server), Identity API and Gatekeeper (Protection Policy Enforcement). The script deploy/userman/userman achieves this by appropriate configuration of the environment variables , before launching the eoepca.sh deployment script . The deployment configuration is captured in the file deploy/userman/userman-options . The user-management deployment applies the following configuration: Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment No TLS for service ingress endpoints Services deployed: Identity Service Identity API Gatekeeper instance, protecting the Identity API Other eoepca services not deployed","title":"Overview"},{"location":"quickstart/userman-deployment/#initiate-deployment","text":"Deployment is initiated by invoking the script\u2026 ./deploy/userman/userman The Identity Service is accessed at the endpoint keycloak.192-168-49-2.nip.io . The Identity API is accessed at the endpoint identity-api.192-168-49-2.nip.io .","title":"Initiate Deployment"},{"location":"quickstart/userman-deployment/#post-deploy-manual-steps","text":"To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.","title":"Post-deploy Manual Steps"}]}