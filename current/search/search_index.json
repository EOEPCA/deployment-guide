{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Deployment Guide","text":"<p>Changelog</p> <p>This <code>current</code> version of the Deployment Guide represents the development tip that goes beyond the latest release version v1.4.</p> <p>The following provides a summary of changes since the last release (v1.4)\u2026</p> <ul> <li>08/04/2023 - Correction to example usage of the data-access <code>harvester</code> CLI - in particular use of <code>-co, --config-override</code> for values override</li> <li>03/04/2024 - Update Identity Gatekeeper to chart version <code>1.0.12</code> with an alternative approach to establishing \u2018open\u2019 access to select request paths (e.g. for docs etc.), to simplify proxying to the backend resource server.</li> <li>03/04/2024 - Update Data Access to chart <code>1.4.1</code> to introduce variables to remedy hard-coded harvester values for access to Creodias eodata. Ref. - <code>CREODIAS_EODATA_S3_ENDPOINT</code>, <code>CREODIAS_EODATA_S3_ACCESS_KEY</code>, <code>CREODIAS_EODATA_S3_ACCESS_SECRET</code> and <code>CREODIAS_EODATA_S3_REGION</code>.</li> <li>20/03/2024 - Correction to chart path for helm deployment of <code>eoepca-portal</code></li> <li>20/03/2024 - Correct hardcoded OAuth client secret for Application Hub</li> <li>20/03/2024 - Clarify Gatekeeper encryption key must be 16 or 32 characters long</li> <li>19/03/2024 - ADES stage-out fix (partial) for cwl workflow outputs of type Directory[] - e.g. <code>snuggs</code> sample app</li> <li>15/03/2024 - Update Application Hub to chart version <code>2.0.59</code> to add support for path-prefix (<code>BASE_URL</code>)</li> <li>08/03/2024 - Update Application Hub to chart version <code>2.0.58</code> to fix hard-coded namespace <code>proc</code> Namespace can now be set via chart environment variable <code>APP_HUB_NAMESPACE</code></li> <li>01/03/2024 - Adjust default Calrissian pod resource limits to 1024 Mi RAM, 2 vCPU</li> <li>01/03/2024 - Correct default value of <code>PROCESSING_MAX_RAM</code> to the integer value in Mi <code>1024</code> (was string <code>8Gi</code>)</li> </ul> <p>The Deployment Guide captures each release of the EOEPCA Reference Implementation, by providing for each version\u2026</p> <ul> <li>Description of how each building-block is configured and deployed - see Deploy EOEPCA Components</li> <li>Scripted deployment in which each building-block can be selectively deployed to form a system - see Getting Started</li> </ul> <p>A full system deployment is described, in which components are deployed with complementary configurations that facilitate their integration as a coherent system. Nevertheless, each component can be cherry-picked from this system deployment for individual re-use.</p> <p>The deployment is organised into the following sections:</p> <ul> <li>Getting Started   A quickstart guide with associated scripts to facilitate example deployments, which preempt the descriptions that follow later in the document.   Scripts are provided in a variety of \u2018profiles\u2019 that deploy different combinations of building-blocks for different notional use cases.</li> <li>Prepare Cluster   Establish the Kubernetes cluster and other prerequisites for the deployment of the EOEPCA system.</li> <li>Deploy EOEPCA Components   Deployment of the EOEPCA components.</li> </ul>"},{"location":"cluster/cluster-prerequisites/","title":"Cluster Prerequisites","text":""},{"location":"cluster/cluster-prerequisites/#overview","title":"Overview","text":"<p>The following prerequisite components are assumed to be deployed in the cluster.</p> <p>Note</p> <p>The Scripted Deployment automatically deploys most of the components list here - in particular\u2026</p> <ul> <li>Nginx Ingress Controller</li> <li>Cert Manager</li> <li>Letsencrypt ClusterIssuers</li> <li>Minio Object Storage</li> </ul> <p>The Sealed Secrets controller is not deployed - but can be added following the instructions below.</p>"},{"location":"cluster/cluster-prerequisites/#nginx-ingress-controller","title":"Nginx Ingress Controller","text":"<pre><code># Install the Nginx Ingress Controller helm chart\nhelm upgrade -i --version='&lt;4.5.0' \\\n  --repo https://kubernetes.github.io/ingress-nginx \\\n  ingress-nginx ingress-nginx \\\n  --wait\n</code></pre> <p>Note</p> <p>For Kubernetes version 1.22 and earlier the version of the Nginx Ingress Controller must be before v4.5.0.</p> <p>To target the Nginx Ingress Controller the <code>kubernetes.io/ingress.class: nginx</code> annotation must be applied to the Ingress resource\u2026 <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    ...\n</code></pre></p>"},{"location":"cluster/cluster-prerequisites/#cert-manager","title":"Cert Manager","text":"<pre><code># Install the Cert Manager helm chart\nhelm upgrade -i --namespace cert-manager --create-namespace \\\n  --repo https://charts.jetstack.io \\\n  --set installCRDs=true \\\n  cert-manager cert-manager\n</code></pre>"},{"location":"cluster/cluster-prerequisites/#letsencrypt-certificates","title":"Letsencrypt Certificates","text":"<p>Once the Certificate Manager is deployed, then we can establish <code>ClusterIssuer</code> operators in the cluster to support use of TLS with service <code>Ingress</code> endpoints.</p> <p>For Letsencrypt we can define two <code>ClusterIssuer</code> - for <code>production</code> and for <code>staging</code>.</p> <p>NOTE that these require the cluster to be publicly accessible, in order for the <code>http01</code> acme flow to verify the domain ownership. Local development deployments will typically not have public IP/DNS - in which case the system deployment can proceed, but without TLS support for the service endpoints.</p>"},{"location":"cluster/cluster-prerequisites/#production","title":"Production","text":"<pre><code>apiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-production\nspec:\n  acme:\n    # You must replace this email address with your own.\n    # Let's Encrypt will use this to contact you about expiring\n    # certificates, and issues related to your account.\n    email: eoepca.systemteam@telespazio.com\n    server: https://acme-v02.api.letsencrypt.org/directory\n    privateKeySecretRef:\n      # Secret resource that will be used to store the account's private key.\n      name: letsencrypt-production-account-key\n    # Add a single challenge solver, HTTP01 using nginx\n    solvers:\n      - http01:\n          ingress:\n            class: nginx\n</code></pre>"},{"location":"cluster/cluster-prerequisites/#staging","title":"Staging","text":"<pre><code>apiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-staging\nspec:\n  acme:\n    # You must replace this email address with your own.\n    # Let's Encrypt will use this to contact you about expiring\n    # certificates, and issues related to your account.\n    email: eoepca.systemteam@telespazio.com\n    server: https://acme-staging-v02.api.letsencrypt.org/directory\n    privateKeySecretRef:\n      # Secret resource that will be used to store the account's private key.\n      name: letsencrypt-staging-account-key\n    # Add a single challenge solver, HTTP01 using nginx\n    solvers:\n      - http01:\n          ingress:\n            class: nginx\n</code></pre> <p>To exploit the specified ClusterIssuer the <code>cert-manager.io/cluster-issuer</code> annotation must be applied to the Ingress resource. For example\u2026 <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    cert-manager.io/cluster-issuer: letsencrypt-production\n    ...\n</code></pre></p>"},{"location":"cluster/cluster-prerequisites/#sealed-secrets","title":"Sealed Secrets","text":"<p>The EOEPCA development team maintain their deployment configurations in GitHub - for declarative, reproducible cluster deployments.</p> <p>Various <code>Secret</code> are relied upon by the system services. Secrets should not be exposed by commit to GitHub.</p> <p>Instead <code>SealedSecret</code> are committed to GitHub, which are encrypted, and can only be decrypted by the <code>sealed-secret-controller</code> that runs within the cluster. The <code>sealed-secret-controller</code> decrypts the <code>SealedSecret</code> to a regular <code>Secret</code> (of the same name) that can then be consumed by the cluster components.</p> <p>The <code>sealed-secret-controller</code> is deployed to the cluster using the helm chart\u2026</p> <pre><code>helm install --version 2.1.8 --create-namespace --namespace infra \\\n  --repo https://bitnami-labs.github.io/sealed-secrets \\\n  eoepca-sealed-secrets sealed-secrets\n</code></pre> <p>Once the controller is deployed within the cluster, then the <code>kubeseal</code> command can be used to create a <code>SealedSecret</code> from a regular <code>Secret</code>, as follows\u2026</p> <p>Create example Secret\u2026 <pre><code>kubectl -n test create secret generic mysecret \\\n  --from-literal=password=changeme \\\n  --dry-run=client -o yaml \\\n  &gt; mysecret.yaml\n</code></pre></p> <p>Create SealedSecret from Secret using kubeseal\u2026 <pre><code>kubeseal -o yaml \\\n  --controller-name eoepca-sealed-secrets \\\n  --controller-namespace infra \\\n  &lt; mysecret.yaml \\\n  &gt; mysecret-sealed.yaml\n</code></pre></p>"},{"location":"cluster/cluster-prerequisites/#references","title":"References","text":"<ul> <li>Sealed Secrets on GitHub</li> <li><code>kubeseal</code> Release</li> </ul>"},{"location":"cluster/cluster-prerequisites/#minio-object-storage","title":"MinIO Object Storage","text":"<p>Various building blocks require access to an S3-compatible object storage service. In particular the ADES processing service expects to stage-out its processing results to S3 object storage. Ideally the cloud provider for your deployment will make available a suitable object storage service.</p> <p>As a workaround, in the absence of an existing object storage, it is possible to use MinIO to establish an object storage service within the Kubernetes cluster. We use the minio helm chart provided by the MinIO Project.</p> <pre><code># Install the minio helm chart\nhelm upgrade -i -f minio-values.yaml --namespace rm --create-namespace \\\n  --repo https://charts.min.io/ \\\n  minio minio \\\n  --wait\n</code></pre> <p>Note</p> <p>The Kubernetes namespace <code>rm</code> is used above as an example, and can be changed according to your deployment preference.</p> <p>The minio deployment is customised via the values file <code>minio-values.yaml</code>, for example\u2026</p> <pre><code>existingSecret: minio-auth\nreplicas: 2\n\ningress:\n  enabled: true\n  ingressClassName: nginx\n  annotations:\n    cert-manager.io/cluster-issuer: \"letsencrypt\"\n    nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/proxy-body-size: \"0\"\n    nginx.ingress.kubernetes.io/proxy-read-timeout: '600'\n  path: /\n  hosts:\n    - minio.192-168-49-2.nip.io\n  tls:\n    - secretName: minio-tls\n      hosts:\n        - minio.192-168-49-2.nip.io\n\nconsoleIngress:\n  enabled: true\n  ingressClassName: nginx\n  annotations:\n    cert-manager.io/cluster-issuer: \"letsencrypt\"\n    nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/proxy-body-size: \"0\"\n    nginx.ingress.kubernetes.io/proxy-read-timeout: '600'\n  path: /\n  hosts:\n    - console.minio.192-168-49-2.nip.io\n  tls:\n  - secretName: minio-console-tls\n    hosts:\n      - console.minio.192-168-49-2.nip.io\n\nresources:\n  requests:\n    memory: 1Gi\n\npersistence:\n  storageClass: standard\n\nbuckets:\n  - name: eoepca\n  - name: cache-bucket\n</code></pre> <p>Note</p> <ul> <li>The example values assuming a TLS configuration using <code>letsencrypt</code> certificate provider</li> <li>The admin credentials are provided by the Kubernetes secret named <code>minio-auth</code> - see below</li> <li>The annotation <code>nginx.ingress.kubernetes.io/proxy-body-size</code> was found to be required to allow transfer of large files (such as data products) through the nginx proxy</li> </ul>"},{"location":"cluster/cluster-prerequisites/#minio-credentials-secret","title":"Minio Credentials Secret","text":"<p>The Minio admin credentials are provided via a Kubernetes secret that is referenced from the Minio helm chart deployment values. For example\u2026</p> <pre><code>kubectl -n rm create secret generic minio-auth \\\n  --from-literal=rootUser=\"eoepca\" \\\n  --from-literal=rootPassword=\"changeme\"\n</code></pre> <p>Note</p> <p>The secret must be created in the same Kubernetes namespace as the Minio service deployment - e.g. <code>rm</code> namespce in the example above.</p>"},{"location":"cluster/cluster-prerequisites/#s3cmd-configuration","title":"s3cmd Configuration","text":"<p>The <code>s3cmd</code> can be configured for access to the MinIO deployment. The <code>--configure</code> option can be used to prepare a suitable configuration file for <code>s3cmd</code>\u2026</p> <pre><code>s3cmd -c mys3cfg --configure\n</code></pre> <p>In response to the prompts, the following configuration selections are applicable to the above settings\u2026</p> <pre><code>Access Key: eoepca\nSecret Key: changeme\nDefault Region: us-east-1\nS3 Endpoint: minio.192-168-49-2.nip.io\nDNS-style bucket+hostname:port template for accessing a bucket: minio.192-168-49-2.nip.io\nEncryption password: \nPath to GPG program: /usr/bin/gpg\nUse HTTPS protocol: True\nHTTP Proxy server name: \nHTTP Proxy server port: 0\n</code></pre> <p>Save the configuration file, and check access to the S3 object store with\u2026</p> <pre><code># Create a bucket\ns3cmd -c mys3cfg mb s3://eoepca\n\n# List buckets\ns3cmd -c mys3cfg ls\n</code></pre> <p>For example, using our sample deployment, the following can be used to interface with the MinIO service deployed in minikube\u2026 <pre><code>s3cmd -c deploy/cluster/s3cfg ls\n</code></pre></p>"},{"location":"cluster/cluster-prerequisites/#references_1","title":"References","text":"<ul> <li>MinIO Website</li> <li>MinIO Helm Chart</li> <li>MinIO on GitHub</li> </ul>"},{"location":"cluster/helm-repositories/","title":"Helm Repositories","text":"<p>Note</p> <p>This section identifies some helm chart repositories that can be referenced (for convenience) via <code>helm add</code>. Nevertheless, all helm commands included in the guide specifically reference the source helm repository via the <code>--repo</code> argument to the <code>helm install</code> command - and thus it is not specifically necessary to <code>add</code> these repositories in advance.</p>"},{"location":"cluster/helm-repositories/#eoepca-helm-charts","title":"EOEPCA Helm Charts","text":"<p>The EOEPCA building-blocks are engineered as containers for deployment to a Kubernetes cluster. Each building block defines a Helm Chart to facilitate its deployment.</p> <p>The EOEPCA Helm Chart Repository is configured with <code>helm</code> as follows\u2026 <pre><code>helm repo add eoepca https://eoepca.github.io/helm-charts/\n</code></pre></p>"},{"location":"cluster/helm-repositories/#third-party-helm-charts","title":"Third-party Helm Charts","text":"<p>In addition to the EOEPCA Helm Chart Repository, a variety of third party helm repositories are relied upon, as identified below.</p>"},{"location":"cluster/helm-repositories/#cert-manager","title":"Cert Manager","text":"<pre><code>helm repo add jetstack https://charts.jetstack.io\n</code></pre>"},{"location":"cluster/helm-repositories/#nginx-ingress-controller","title":"Nginx Ingress Controller","text":"<pre><code>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx\n</code></pre>"},{"location":"cluster/helm-repositories/#minio","title":"Minio","text":"<pre><code>helm repo add minio https://charts.min.io/\n</code></pre>"},{"location":"cluster/helm-repositories/#sealed-secrets-bitnami","title":"Sealed Secrets (Bitnami)","text":"<pre><code>helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets\n</code></pre>"},{"location":"cluster/helm-repositories/#harbor","title":"Harbor","text":"<pre><code>helm repo add harbor https://helm.goharbor.io\n</code></pre>"},{"location":"cluster/helm-repositories/#repo-update","title":"Repo Update","text":"<p>Refresh the local repo cache, after <code>helm repo add</code>\u2026</p> <pre><code>helm repo update\n</code></pre>"},{"location":"cluster/kubernetes/","title":"Kubernetes Cluster","text":"<p>The EOEPCA Reference Implementation has been developed with Kubernetes as its deployment target. The system components have been developed, deployed and tested using a cluster at version <code>v1.22.5</code>.</p> <p>Note</p> <p>The Scripted Deployment assumes that <code>minikube</code> is installed, and creates a minikube cluster under the profile <code>eoepca</code>.</p>"},{"location":"cluster/kubernetes/#rancher-kubernetes-engine-rke","title":"Rancher Kubernetes Engine (RKE)","text":"<p>The development, integration and test clusters have been established using Rancher Kubernetes Engine (RKE) at version <code>v1.22.5</code>.</p> <p>An example of the creation of the EOEPCA Kubernetes clusters can be found on the GitHub Kubernetes Setup page. CREODIAS has been used for the development hosting infrastructure - which provides OpenStack infrastructure that is backed by Cloudferro. An example of the Terraform configurations used to automate the creation of the cloud infrastructure that underpins the RKE deployment can be found on the GitHub CREODIAS Setup page.</p>"},{"location":"cluster/kubernetes/#local-kubernetes","title":"Local Kubernetes","text":"<p>To make a full deployment of the EOEPCA Reference Implementation requires a multi-node node cluster with suitable resources. For example, the development cluster comprises:</p> <ul> <li>1 Master node (2 vCPU, 8 GB RAM)</li> <li>5 Worker nodes (4 vCPU, 16 GB RAM)</li> <li>1 NFS server (2 vCPU, 8 GB RAM)</li> </ul> <p>Limited local deployment can be made using a suitable local single-node kuberbetes deployment using - for example using minikube\u2026</p> <pre><code>minikube -p eoepca start --cpus max --memory max --kubernetes-version v1.22.5\nminikube profile eoepca\n</code></pre> <p>With such a deployment it is possible to deploy individual building-blocks for local development, or building-blocks in combination - within the constraints of the local host resources.</p>"},{"location":"cluster/prerequisite-tooling/","title":"Prerequisite Tooling","text":"<p>There are some standard tools referenced in this guide. These are detailed in the following subsections.</p>"},{"location":"cluster/prerequisite-tooling/#docker","title":"docker","text":"<p>Docker faciliates the creation, management and execution of containers. Whilst not strictly necessary to support deployment to an existing/managed Kubernetes cluster, it can nevertheless be useful to have local access to the docker tooling. For example, if minikube is used to follow this guide using a local k8s cluster, then this is best achieved using minikube\u2019s docker driver.</p> <p>Docker is most easily installed with\u2026 <pre><code>curl -fsSL https://get.docker.com | sh\n</code></pre></p> <p>For convenience, add your user to the <code>docker</code> group\u2026 <pre><code>sudo usermod -aG docker ${USER}\n</code></pre></p> <p>Logout/in to refresh your session\u2019s group permissions.</p>"},{"location":"cluster/prerequisite-tooling/#kubectl","title":"kubectl","text":"<p>Kubectl is the main tool for interaction with a Kubernetes cluster. The latest version can be installed with\u2026 <pre><code>mkdir -p $HOME/.local/bin \\\n&amp;&amp; curl -fsSLo $HOME/.local/bin/kubectl \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl\" \\\n&amp;&amp; chmod +x $HOME/.local/bin/kubectl\n</code></pre></p> <p>See the official kubectl installation documentation for more installation options.</p>"},{"location":"cluster/prerequisite-tooling/#helm","title":"helm","text":"<p>Helm is the Kubernetes package manager, in which components are deployed to a Kubernetes cluster via helm charts. The helm charts are instantiated for deployment via \u2018values\u2019 that configure the chart templates.</p> <p>The latest helm version can be installed with\u2026 <pre><code>export HELM_INSTALL_DIR=\"$HOME/.local/bin\" \\\n&amp;&amp; curl -sfL https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash\n</code></pre></p> <p>See the official helm installation documentation for more installation options.</p>"},{"location":"cluster/prerequisite-tooling/#minikube","title":"minikube","text":"<p>Minikube is a tool that allows to create a local (single-node) Kubernetes cluster for development/testing. It is not designed for production use. In the absence of access to a \u2018full\u2019 Kubernetes cluster, this guide can be followed using minikube.</p> <p>The latest version of minikube can be installed with\u2026 <pre><code>mkdir -p $HOME/.local/bin \\\n&amp;&amp; curl -fsSLo $HOME/.local/bin/minikube \"https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64\" \\\n&amp;&amp; chmod +x $HOME/.local/bin/minikube\n</code></pre></p> <p>See the official minikube installation documentation for more installation options.</p>"},{"location":"eoepca/ades-zoo/","title":"ADES (Processing)","text":"ADES - Application Deployment &amp; Execution Service"},{"location":"eoepca/ades-zoo/#zoo-project-dru","title":"ZOO-Project DRU","text":"<p>Note</p> <p>With EOEPCA release 1.4, the ADES implementation has been significantly reworked and fully aligned with the upstream ZOO-Project (GitHub). This <code>zoo-project-dru</code> version deprecates the previous <code>proc-ades</code> implementation.</p> <p>With this transition, there are some functional changes to be aware of\u2026</p> <ul> <li>Service Endpoint   With <code>zoo-project-dru</code> the OGC API Processes endpoint is at the path <code>/&lt;username&gt;/ogc-api/processes</code> compared to the previous <code>/&lt;username&gt;/wps3/processes</code>.</li> <li>Deployed Application Endpoint   The endpoint for a deployed Application no longer appends the version of the Application Package.   For example, previously the application <code>convert-url</code> at version <code>0.1.2</code> would result in the endpoint <code>/&lt;username&gt;/wps3/processes/convert-url_0_1_2</code>.   With the new <code>zoo-project-dru</code> this same Application Package deployment will result in the endpoint <code>/&lt;username&gt;/ogc-api/processes/convert-url</code>.</li> <li>Deployed Application Version   The version of the deployed application is obtained from the Application Package CWL (ref. <code>s:softwareVersion: 0.1.2</code>), and is maintained within the metadata for the deployed process that is returned from the APIs <code>Get Process Details</code> request.   In the case that multiple versions of the same Application Package are required to be simultaneously deployed, then this would have to be handled with different CWL documents in which the version is embedded in the workflow <code>id</code> (or some other technique that establishes uniqueness of <code>id</code> between variants).</li> </ul>    DRU - Deploy, Replace, Undeploy - OFC API Processes Part 2  <p>The ADES provides a platform-hosted execution engine through which users can initiate parameterised processing jobs using applications made available within the platform - supporting the efficient execution of the processing \u2018close to the data\u2019. Users can deploy specific \u2018applications\u2019 to the ADES, which may be their own applications, or those published by other platform users.</p> <p>The ADES provides an implementation of the OGC API Processes - Part 1: Core and Part 2: Deploy, Replace, Undeploy (draft).</p>"},{"location":"eoepca/ades-zoo/#helm-chart","title":"Helm Chart","text":"<p>The EOEPCA deployment is aligned with the upstream implementation and so relies upon the upstream helm chart that is hosted at the ZOO-Project Helm Chart Repository - in particular the <code>zoo-project-dru</code> chart variant.</p> <p>The chart is configured via values that are fully documented in the README for the <code>zoo-project-dru</code> chart.</p> <pre><code>helm install --version 0.2.6 --values ades-values.yaml \\\n  --repo https://zoo-project.github.io/charts/ \\\n  zoo-project-dru zoo-project-dru\n</code></pre>"},{"location":"eoepca/ades-zoo/#values","title":"Values","text":"<p>The deployment must be configured for you environment. Some significant configuration values are elaborated here\u2026</p>"},{"location":"eoepca/ades-zoo/#cookie-cutter-template","title":"Cookie-cutter Template","text":"<p>The implementation <code>zoo-project-dru</code> provides the core capabilities for OGC API Processes Parts 1 &amp; 2. The deployemnt of this core must be completed by inetgartion with the \u2018runner\u2019 that executes the processes as Application Packages, and integrates as necessary with other platform services - such as Catalogue, Workspace, etc.</p> <p>Thus, <code>zoo-project-dru</code> is extensible by design via a \u2018cookie-cutter\u2019 that provides the template \u2018runner\u2019 for each Application Package process as it is deployed to the service.</p> <p>For the purposes of our EOEPCA \u2018release\u2019 as covered by this guide, we provide <code>eoepca-proc-service-template</code> as a cookie-cutter implemetation that provides:</p> <ul> <li>Integration with Kubernetes to run process Application packages, via the Calrissian CWL runner</li> <li>Stage-in of inputs as STAC items, integrated as required with S3 object storage</li> <li>Stage-out of outputs as a STAC Collection, integrated with S3 object storage and (optionally) user Workspace inetgration</li> </ul> <p>The cookie-cutter template is identified in the helm values\u2026</p> <pre><code>cookiecutter:\n  templateUrl: https://github.com/EOEPCA/eoepca-proc-service-template.git\n  templateBranch: master\n</code></pre> <p>The function of the cookie-cutter template is supported some other aspects, that are elaborated below, which must be configured in collaboration with the expectations of the template. In particular\u2026</p> <ul> <li>Template parameterisation that is passed through the core <code>zoo-project-dru</code> configuration [ref]</li> <li>CWL \u2018wrapper\u2019 files that prepend and append the process Application Package CWL to perform stage-in and stage-out functions [ref]</li> </ul>"},{"location":"eoepca/ades-zoo/#zoo-project-dru-custom-configuration","title":"ZOO-Project DRU custom configuration","text":"<p>In order support our <code>eoepca-proc-service-template</code> cookie-cutter template, there is a custom <code>zoo-project-dru</code> container image that includes the python dependencies that are required by this template. Thus, the deployment must identify the custom container image via helm values\u2026</p> <pre><code>zoofpm:\n  image:\n    tag: eoepca-092ea7a2c6823dba9c6d52c383a73f5ff92d0762\nzookernel:\n  image:\n    tag: eoepca-092ea7a2c6823dba9c6d52c383a73f5ff92d0762\n</code></pre> <p>In addition, we can add values to the ZOO-Project DRU <code>main.cfg</code> configuration file via helm values. In this case we add some eoepca-specific values that match those that we know to be expected by our <code>eoepca-proc-service-template</code> cookie-cutter template. In this way we can effectively use helm values to pass parameters through to the template.</p> <pre><code>customConfig:\n  main:\n    eoepca: |-\n      domain=192-168-49-2.nip.io\n      workspace_prefix=ws\n</code></pre> <p>This is manifest in zoo\u2019s <code>main.cfg</code> in INI file configuration syntax\u2026</p> <pre><code>[eoepca]\ndomain=192-168-49-2.nip.io\nworkspace_prefix=ws\n</code></pre> <p>The presence or otherwise of the <code>workspace_prefix</code> parameter dicates whether or not the stage-out step will integrate with the user\u2019s Workspace for persistence of the processing results, and registration within the Workspace services.</p> <p>In the case that <code>workspace_prefix</code> is not set, then the object storage specification in the helm values is relied upon\u2026</p> <pre><code>workflow:\n  inputs:\n    STAGEOUT_AWS_SERVICEURL: https://minio.192-168-49-2.nip.io\n    STAGEOUT_AWS_ACCESS_KEY_ID: eoepca\n    STAGEOUT_AWS_SECRET_ACCESS_KEY: changeme\n    STAGEOUT_AWS_REGION: RegionOne\n    STAGEOUT_OUTPUT: eoepca\n</code></pre>"},{"location":"eoepca/ades-zoo/#stage-in-stage-out","title":"Stage-in / Stage-out","text":"<p>The ADES hosts applications that are deployed and invoked in accordance with the OGC Best Practise for Application Package. Thus, the ADES provides a conformant environment within which the application is integrated for execution. A key part of the ADES\u2019s role in this is to faciltate the provision of input data to the application (stage-in), and the handling of the results output at the conclusion of application execution (stage-out).</p> <p>The <code>zoo-project-dru</code> helm chart provides a default implementation via the included files - <code>main.yaml</code>, <code>rules.yaml</code>, <code>stagein.yaml</code> and <code>stageout.yaml</code>.</p> <p>The helm values provides a means through which each of these files can be overriden for reasons of integration with your platform environment\u2026</p> <pre><code>files:\n  # Directory 'files/cwlwrapper-assets' - assets for ConfigMap 'XXX-cwlwrapper-config'\n  cwlwrapperAssets:\n    main.yaml: |-\n      &lt;override file content here&gt;\n    rules.yaml: |-\n      &lt;override file content here&gt;\n    stagein.yaml: |-\n      &lt;override file content here&gt;\n    stageout.yaml: |-\n      &lt;override file content here&gt;\n</code></pre> <p>In the most part the default CWL wrapper files provided with the helm chart are suffient. In particular the <code>stagein.yaml</code> implements the stage-in of STAC items that are specified as inputs of type <code>Directory</code> in the Application Package CWL.</p> <p>E.g. <pre><code>    inputs:\n      stac:\n        label: the image to convert as a STAC item\n        doc: the image to convert as a STAC item\n        type: Directory\n</code></pre></p> <p>Nevertheless, in this guide we provide an override of the <code>stageout.yaml</code> in order to organise the processing outputs into a STAC Collection that is then pushed to the designated S3 object storage, including support for the user\u2019s workspace storage and resource management services.</p> <p>The custom stage-out embeds, within the CWL document, the python code required to implement the desired stage-out functionality. This should be regarded as an example that could be adapted for alternative behaviour.</p> <pre><code>cwlVersion: v1.0\nclass: CommandLineTool\nid: stage-out\ndoc: \"Stage-out the results to S3\"\ninputs:\n  process:\n    type: string\n  collection_id:\n    type: string\n  STAGEOUT_OUTPUT:\n    type: string\n  STAGEOUT_AWS_ACCESS_KEY_ID:\n    type: string\n  STAGEOUT_AWS_SECRET_ACCESS_KEY:\n    type: string\n  STAGEOUT_AWS_REGION:\n    type: string\n  STAGEOUT_AWS_SERVICEURL:\n    type: string\noutputs:\n  StacCatalogUri:\n    outputBinding:\n      outputEval: ${  return \"s3://\" + inputs.STAGEOUT_OUTPUT + \"/\" + inputs.process + \"/catalog.json\"; }\n    type: string\nbaseCommand:\n  - python\n  - stageout.py\narguments:\n  - $( inputs.wf_outputs.path )\n  - $( inputs.STAGEOUT_OUTPUT )\n  - $( inputs.process )\n  - $( inputs.collection_id )\nrequirements:\n  DockerRequirement:\n    dockerPull: ghcr.io/terradue/ogc-eo-application-package-hands-on/stage:1.3.2\n  InlineJavascriptRequirement: {}\n  EnvVarRequirement:\n    envDef:\n      AWS_ACCESS_KEY_ID: $( inputs.STAGEOUT_AWS_ACCESS_KEY_ID )\n      AWS_SECRET_ACCESS_KEY: $( inputs.STAGEOUT_AWS_SECRET_ACCESS_KEY )\n      AWS_REGION: $( inputs.STAGEOUT_AWS_REGION )\n      AWS_S3_ENDPOINT: $( inputs.STAGEOUT_AWS_SERVICEURL )\n  InitialWorkDirRequirement:\n    listing:\n      - entryname: stageout.py\n        entry: |-\n          import sys\n          import shutil\n          import os\n          import pystac\n\n          cat_url = sys.argv[1]\n\n          shutil.copytree(cat_url, \"/tmp/catalog\")\n          cat = pystac.read_file(os.path.join(\"/tmp/catalog\", \"catalog.json\"))\n\n          ...\n</code></pre> <p>The helm chart values provide the opportunity to pass through additional inputs - to satisfy the input specifications that are specified in the <code>cwlwrapperAssets</code> files\u2026</p> <pre><code>workflow:\n  inputs:\n    STAGEIN_AWS_SERVICEURL: http://data.cloudferro.com\n    STAGEIN_AWS_ACCESS_KEY_ID: test\n    STAGEIN_AWS_SECRET_ACCESS_KEY: test\n    STAGEIN_AWS_REGION: RegionOne\n    STAGEOUT_AWS_SERVICEURL: https://minio.192-168-49-2.nip.io\n    STAGEOUT_AWS_ACCESS_KEY_ID: eoepca\n    STAGEOUT_AWS_SECRET_ACCESS_KEY: changeme\n    STAGEOUT_AWS_REGION: RegionOne\n    STAGEOUT_OUTPUT: eoepca\n</code></pre>"},{"location":"eoepca/ades-zoo/#node-selection","title":"Node Selection","text":"<p>The <code>zoo-project-dru</code> services uses a Node Selector to determine the node(s) upon which the processing execution is run. This is configured as a matching rule in the helm values, and must be tailored to your cluster.</p> <p>For example, for minikube\u2026</p> <pre><code>workflow:\n  nodeSelector:\n    minikube.k8s.io/primary: \"true\"\n</code></pre>"},{"location":"eoepca/ades-zoo/#ingress","title":"Ingress","text":"<p>Ingress can be enabled and configured to establish (reverse-proxy) external access to the <code>zoo-project-dru</code> services.</p> <p>Hosturl</p> <p>In the case that protection is enabled - e.g. via Resource Guard - then it is likely that ingress should be disabled here, since the ingress will instead be handled by the protection.</p> <p>In this case, the <code>hosturl</code> parameter should be set to reflect the public url through the service will be accessed.</p> <p>In the case that ingress is enabled then it is not necessary to specify the <code>hosturl</code>, since it will be taken from the <code>ingress.hosts[0].host</code> value.</p> <p>Ingress disabled\u2026</p> <pre><code>ingress:\n  enabled: false\n  hosturl: zoo.192-168-49-2.nip.io\n</code></pre> <p>Ingress enabled\u2026</p> <pre><code>ingress:\n  enabled: true\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    ingress.kubernetes.io/ssl-redirect: true\n    nginx.ingress.kubernetes.io/ssl-redirect: true\n    cert-manager.io/cluster-issuer: letsencrypt-production\n  hosts:\n  - host: zoo-open.192-168-49-2.nip.io\n    paths:\n    - path: /\n      pathType: ImplementationSpecific\n  tls:\n  - hosts:\n    - zoo-open.192-168-49-2.nip.io\n    secretName: zoo-open-tls\n</code></pre> <p>The above example assumes that TLS should be enabled via Letsencrypt as certificate provider - see section Letsencrypt Certificates.</p>"},{"location":"eoepca/ades-zoo/#persistence","title":"Persistence","text":"<p>Various of the services deployed as part of <code>zoo-project-dru</code> rely upon dynamic provisioning of persistent storage volumes.</p> <p>A number of helm values are impacted by this setting, which must be configured with the Storage Class appropriate to your cluster. For example, using the minikube <code>standard</code> storage class\u2026</p> <pre><code>workflow:\n  storageClass: standard\npersistence:\n  procServicesStorageClass: standard\n  storageClass: standard\n  tmpStorageClass: standard\npostgresql:\n  primary:\n    persistence:\n      storageClass: standard\n  readReplicas:\n    persistence:\n      storageClass: standard\nrabbitmq:\n  persistence:\n    storageClass: standard\n</code></pre>"},{"location":"eoepca/ades-zoo/#built-in-iam","title":"Built-in IAM","text":"<p>ZOO-Project DRU has a built-in capability for Identity &amp; Access Management (IAM), in which the zoo-project-dru service is configured as an OIDC client of an OIDC Identity Provider service.</p> <p>This capability is disabled by the default deployment offered by this guide (<code>ingress.enabled: false</code>) - which instead (optionally) applies resource protection using the EOEPCA IAM solution. Nevertheless, the built-in IAM can be enabled and configured through helm values.</p> <p>For example\u2026</p> <pre><code>iam: \n  enabled: true\n  openIdConnectUrl: https://keycloak.192-168-49-2.nip.io/realms/master/.well-known/openid-configuration\n  type: openIdConnect\n  name: OpenIDAuth\n  realm: Secured section\n</code></pre>"},{"location":"eoepca/ades-zoo/#protection","title":"Protection","text":"<p>As described in section Resource Protection (Keycloak), the <code>identity-gatekeeper</code> component can be inserted into the request path of the <code>zoo-project-dru</code> service to provide access authorization decisions</p>"},{"location":"eoepca/ades-zoo/#gatekeeper","title":"Gatekeeper","text":"<p>Gatekeeper is deployed using its helm chart\u2026</p> <pre><code>helm install zoo-project-dru-protection identity-gatekeeper -f zoo-protection-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  --namespace \"zoo\" --create-namespace \\\n  --version 1.0.12\n</code></pre> <p>The <code>identity-gatekeeper</code> must be configured with the values applicable to the <code>zoo-project-dru</code> - in particular the specific ingress requirements for the <code>zoo-project-dru-service</code>\u2026</p> <p>Example <code>zoo-protection-values.yaml</code>\u2026</p> <pre><code>fullnameOverride: zoo-project-dru-protection\nconfig:\n  client-id: ades\n  discovery-url: https://keycloak.192-168-49-2.nip.io/realms/master\n  cookie-domain: 192-168-49-2.nip.io\ntargetService:\n  host: zoo.192-168-49-2.nip.io\n  name: zoo-project-dru-service\n  port:\n    number: 80\nsecrets:\n  # Values for secret 'zoo-project-dru-protection'\n  # Note - if ommitted, these can instead be set by creating the secret independently.\n  clientSecret: \"changeme\"\n  encryptionKey: \"changemechangeme\"\ningress:\n  enabled: true\n  className: nginx\n  annotations:\n    ingress.kubernetes.io/ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n    cert-manager.io/cluster-issuer: letsencrypt-production\n  # open access to swagger docs\n  openUri:\n    - ^/(ogc-api/api.*|swagger-ui.*)\n</code></pre>"},{"location":"eoepca/ades-zoo/#keycloak-client","title":"Keycloak Client","text":"<p>The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. <code>client-id: ades</code> above.</p> <p>This can be created with the <code>create-client</code> helper script, as descirbed in section Client Registration.</p> <p>For example, with path protection for test users\u2026</p> <pre><code>../bin/create-client \\\n  -a https://keycloak.192-168-49-2.nip.io \\\n  -i https://identity-api.192-168-49-2.nip.io \\\n  -r \"master\" \\\n  -u \"admin\" \\\n  -p \"changeme\" \\\n  -c \"admin-cli\" \\\n  --id=ades \\\n  --name=\"ADES Gatekeeper\" \\\n  --secret=\"changeme\" \\\n  --description=\"Client to be used by ADES Gatekeeper\" \\\n  --resource=\"eric\" --uris='/eric/*' --scopes=view --users=\"eric\" \\\n  --resource=\"bob\" --uris='/bob/*' --scopes=view --users=\"bob\" \\\n  --resource=\"alice\" --uris='/alice/*' --scopes=view --users=\"alice\"\n</code></pre>"},{"location":"eoepca/ades-zoo/#service-urls","title":"Service URLs","text":"<p>The <code>zoo-project-dru</code> service provides a mutil-user aware set of service interfaces at\u2026</p> <ul> <li>OGC API Processes: <code>https://zoo.192-168-49-2.nip.io/&lt;username&gt;/ogc-api/</code></li> <li>Swagger UI: <code>https://zoo.192-168-49-2.nip.io/swagger-ui/oapip/</code></li> </ul>"},{"location":"eoepca/ades-zoo/#usage-samples","title":"Usage Samples","text":"<p>See the Example Requests in the Processing Deployment for sample requests that cans be used to test your deployment, and to learn usage of the OGC API Processes.</p>"},{"location":"eoepca/ades-zoo/#debugging-tips","title":"Debugging Tips","text":"<p>This section includes some tips that may be useful in debugging errors with deployed application packages.</p> <p>For debugging, establish a shell session with the <code>zoofpm</code> pod\u2026</p> <pre><code>$ kubectl -n zoo exec -it deploy/zoo-project-dru-zoofpm -c zoofpm -- bash\n</code></pre>"},{"location":"eoepca/ades-zoo/#execution-logs","title":"Execution Logs","text":"<p>The logs are in the directory <code>/tmp/zTmp</code>\u2026</p> <pre><code>$ cd /tmp/zTmp/\n</code></pre> <p>In the log directory, each execution is characterised by a set of files/directories\u2026</p> <ul> <li><code>&lt;appname&gt;_&lt;jobid&gt;_error.log</code> &lt;&lt;START HERE The main log output of the job</li> <li><code>&lt;appname&gt;_&lt;jobid&gt;.json</code> The output (results) of the job</li> <li><code>&lt;jobid&gt;_status.json</code> The overall status of the job</li> <li><code>&lt;jobid&gt;_logs.cfg</code> Index of logs for job workflow steps</li> <li><code>convert-url-c6637d4a-d561-11ee-bf3b-0242ac11000e</code> (directory) Subdirectory with a dedicated log file for each step of the CWL workflow, including the stage-in and stage-out steps</li> </ul>"},{"location":"eoepca/ades-zoo/#deployed-process-executables","title":"Deployed Process \u2018Executables\u2019","text":"<p>When the process is deployed from its Application Package, then a representation is created using the configured <code>cookiecutter.templateUrl</code>.</p> <p>It may be useful to debug the consequent process files, which are located under the path <code>/opt/zooservices_user/&lt;username&gt;</code>, with a dedicated subdirectory for each deployed process - i.e. <code>/opt/zooservices_user/&lt;username&gt;/&lt;appname&gt;/</code>.</p> <p>For example\u2026</p> <pre><code>$ cd /opt/zooservices_user/eric/convert-url\n$ ls -l\ntotal 28\n-rw-rw-r-- 1 www-data www-data     0 Feb 27 11:17 __init__.py\ndrwxrwxr-x 2 www-data www-data  4096 Feb 27 11:17 __pycache__\n-rw-rw-r-- 1 www-data www-data  1408 Feb 27 11:17 app-package.cwl\n-rw-rw-r-- 1 www-data www-data 17840 Feb 27 11:17 service.py\n</code></pre> <p>Note</p> <p>In the case that the cookie-cutter template is updated, then the process can be re-deployed to force a refresh against the updated template.</p>"},{"location":"eoepca/ades-zoo/#swagger-ui-openapi","title":"Swagger UI (OpenAPI)","text":"<p>The <code>zoo-project-dru</code> service includes a Swagger UI interactive representation of its OpenAPI REST interface - available at the URL <code>https://zoo.192-168-49-2.nip.io/swagger-ui/oapip/</code>.</p>"},{"location":"eoepca/ades-zoo/#application-package-example","title":"Application Package Example","text":"<p>For a (trivial) example application package see Example Application Package, which provides a description and illustration of the basics of creating an application that integrates with the expectations of the ADES stage-in and stage-out.</p> <p>For further reference see\u2026</p> <ul> <li>Application Packages<ul> <li>OGC Best Practise for Application Package</li> <li>Example Application Package</li> </ul> </li> <li>Common Workflow Language (CWL)<ul> <li>Guide for CWL in Earth Observation</li> <li>CWL Specification</li> <li>CWL User Guide</li> </ul> </li> </ul>"},{"location":"eoepca/ades-zoo/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the ADES can be found at:</p> <ul> <li>ZOO-Project DRU\u2026<ul> <li>Helm Chart</li> <li>Documentation</li> </ul> </li> <li>Git Repositories\u2026<ul> <li>ZOO-Project Core OGC API Processes capability</li> <li>eoepca-proc-service-template Cookie-cutter template for Application Package execution in Kubernetes</li> <li>zoo-calrissian-runner Python library used by the <code>eoepca-proc-service-template</code> to aid orchestration of CWL application packages running in Kubernetes via Calrissian</li> <li>pycalrissian Python library used by <code>zoo-calrissian-runner</code> to aid interfacing with Calrissian and Kubernetes</li> </ul> </li> </ul>"},{"location":"eoepca/application-hub/","title":"Application Hub","text":"<p>The Application Hub provides a set of web-based tooling, including JupyterLab for interactive analysis, Code Server for application development, and the capability to add user-defined interactive dashboards.</p>"},{"location":"eoepca/application-hub/#helm-chart","title":"Helm Chart","text":"<p>The Application Hub is deployed via the <code>application-hub</code> helm chart from the EOEPCA Helm Chart Repository.</p> <p>The chart is configured via values, which are detailed in the default values file for the chart.</p> <pre><code>helm install --version 2.0.58 --values application-hub-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  application-hub application-hub\n</code></pre>"},{"location":"eoepca/application-hub/#values","title":"Values","text":"<p>The Application Hub supports many values to configure the service - ref. the default values file for the chart.</p> <p>Typically, values for the following attributes may be specified:</p> <ul> <li>The fully-qualified public URL for the service</li> <li>Specification of Ingress for reverse-proxy access to the service</li> <li>Storage class for persistence</li> <li>Node selector rule - required by JupyterHub to spawn container workloads</li> <li>Values for integration with the user workspace</li> <li>Integration of JupyterHub with the Login Service (identity provider) via OpenID Connect configuration</li> <li>OIDC client credentials from a secret</li> </ul> <p>Example <code>application-hub-values.yaml</code>\u2026</p> <pre><code>ingress:\n  enabled: true\n  annotations: {}\n  hosts:\n    - host: applicationhub.192-168-49-2.nip.io\n      paths:\n        - path: /\n          pathType: ImplementationSpecific\n  tls:\n    - secretName: applicationhub-tls\n      hosts:\n      - applicationhub.192-168-49-2.nip.io\n  clusterIssuer: letsencrypt-production\n\njupyterhub:\n  fullnameOverride: \"application-hub\"\n  hub:\n    existingSecret: application-hub-secrets\n    extraEnv: \n        JUPYTERHUB_ENV: \"dev\"\n        JUPYTERHUB_SINGLE_USER_IMAGE: \"eoepca/pde-container:1.0.3\"\n        OAUTH_CALLBACK_URL: https://applicationhub.192-168-49-2.nip.io/hub/oauth_callback\n        OAUTH2_USERDATA_URL: https://keycloak.192-168-49-2.nip.io/oxauth/restv1/userinfo\n        OAUTH2_TOKEN_URL: https://keycloak.192-168-49-2.nip.io/oxauth/restv1/token\n        OAUTH2_AUTHORIZE_URL: https://keycloak.192-168-49-2.nip.io/oxauth/restv1/authorize\n        OAUTH_LOGOUT_REDIRECT_URL: \"https://applicationhub.192-168-49-2.nip.io\"\n        OAUTH2_USERNAME_KEY: \"preferred_username\"\n        APP_HUB_NAMESPACE: \"app-hub\"\n        STORAGE_CLASS: \"standard\"\n        RESOURCE_MANAGER_WORKSPACE_PREFIX: \"ws\"\n\n        JUPYTERHUB_CRYPT_KEY:\n          valueFrom:\n            secretKeyRef:\n              name: application-hub-secrets\n              key: JUPYTERHUB_CRYPT_KEY\n\n        OAUTH_CLIENT_ID:\n          valueFrom:\n            secretKeyRef:\n              name: application-hub-secrets\n              key: OAUTH_CLIENT_ID\n\n        OAUTH_CLIENT_SECRET:\n          valueFrom:\n            secretKeyRef:\n              name: application-hub-secrets\n              key: OAUTH_CLIENT_SECRET\n\n    image:\n      # name: eoepca/application-hub\n      # tag: \"1.2.0\"\n      pullPolicy: Always\n      # pullSecrets: []\n\n    db:\n      pvc:\n        storageClassName: standard\n\n  singleuser:\n    image:\n      name: jupyter/minimal-notebook\n      tag: \"2343e33dec46\"\n    profileList: \n    - display_name:  \"Minimal environment\"\n      description: \"To avoid too much bells and whistles: Python.\"\n      default: \"True\"\n    - display_name:  \"EOEPCA profile\"\n      description: \"Sample profile\"\n      kubespawner_override:\n        cpu_limit\": 4\n        mem_limit\": \"8G\"\n\nnodeSelector:\n  key: minikube.k8s.io/primary\n  value: \\\"true\\\"\n</code></pre>"},{"location":"eoepca/application-hub/#client-and-credentials","title":"Client and Credentials","text":"<p>The Application Hub requires an OIDC client to be registered with the Identity Service (Keycloak) in order to enable user identity integration - ref. <code>OAUTH_CLIENT_ID</code> and <code>OAUTH_CLIENT_SECRET</code>.</p> <p>This can be created with the <code>create-client</code> helper script, as descirbed in section Client Registration.</p> <p>For example\u2026</p> <pre><code>../bin/create-client \\\n  -a https://keycloak.192-168-49-2.nip.io \\\n  -i https://identity-api.192-168-49-2.nip.io \\\n  -r \"master\" \\\n  -u \"admin\" \\\n  -p \"changeme\" \\\n  -c \"admin-cli\" \\\n  --id=application-hub \\\n  --name=\"Application Hub OIDC Client\" \\\n  --secret=\"changeme\" \\\n  --description=\"Client to be used by Application Hub for OIDC integration\"\n</code></pre> <p>Corresponding to this client, a secret <code>application-hub-secrets</code> must be created (ref. value <code>jupyterhub.hub.existingSecret: application-hub-secrets</code>)\u2026</p> <pre><code>kubectl -n proc create secret generic application-hub-secrets \\\n  --from-literal=JUPYTERHUB_CRYPT_KEY=\"$(openssl rand -hex 32)\" \\\n  --from-literal=OAUTH_CLIENT_ID=\"application-hub\" \\\n  --from-literal=OAUTH_CLIENT_SECRET=\"changeme\"\n</code></pre>"},{"location":"eoepca/application-hub/#post-deployment-manual-steps","title":"Post-deployment Manual Steps","text":"<p>The deployment of the Application Hub has been designed, as far as possible, to automate the configuration. However, there remain some steps that must be performed manually after the scripted deployment has completed\u2026</p> <ul> <li>Configure Groups and Users</li> </ul>"},{"location":"eoepca/application-hub/#groups-and-users","title":"Groups and Users","text":"<p>The default helm chart has some built-in application launchers whose assignments to example users (eric and bob) assume the existence of some JupyterHub groups - which must be replicated to exploit this configuration.</p> <ul> <li>In a browser, navigate to the Application Hub - https://applicationhub.192-168-49-2.nip.io/</li> <li>Login as the user eric (or bob) for admin access</li> <li>Select the <code>Admin</code> menu (top of page)</li> <li>Add groups <code>group-1</code>, <code>group-2</code>, <code>group-3</code> to ApplicationHub, and add users <code>eric</code>, <code>bob</code> to these groups</li> </ul> <p>This setup corresponds to the \u2018sample\u2019 configuration that is built=in to the help chart - see file <code>config.yaml</code>.</p>"},{"location":"eoepca/application-hub/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the Application Hub can be found at:</p> <ul> <li>Helm Chart</li> </ul>"},{"location":"eoepca/container-registry/","title":"Container Registry","text":"<p>To support the development (ref. Application Hub) and deployment/execution (ref. ADES) of user-defined applications, we deploy a container registry to host container images. This is provied by a deployment of the Harbor artefact repository.</p>"},{"location":"eoepca/container-registry/#helm-chart","title":"Helm Chart","text":"<p>Harbor is deployed via the <code>harbor</code> helm chart from the Harbor Helm Chart Repository.</p> <pre><code>helm install --version 1.7.3 --values harbor-values.yaml \\\n   --repo https://helm.goharbor.io \\\n  harbor harbor\n</code></pre>"},{"location":"eoepca/container-registry/#values","title":"Values","text":"<p>The chart is configured via values that are fully documented on the Harbor website.</p> <p>Example\u2026</p> <pre><code>expose:\n  ingress:\n    annotations:\n      kubernetes.io/ingress.class: nginx\n      cert-manager.io/cluster-issuer: letsencrypt-production\n      nginx.ingress.kubernetes.io/proxy-read-timeout: '600'\n\n      # from chart:\n      ingress.kubernetes.io/ssl-redirect: letsencrypt-production\n      ingress.kubernetes.io/proxy-body-size: \"0\"\n      nginx.ingress.kubernetes.io/ssl-redirect: letsencrypt-production\n      nginx.ingress.kubernetes.io/proxy-body-size: \"0\"\n\n    hosts:\n      core: harbor.192-168-49-2.nip.io\n    tls:\n      enabled: \"true\"\n      certSource: secret\n      secret:\n        secretName: \"harbor-tls\"\n\npersistence:\n  persistentVolumeClaim:\n    registry:\n      storageClass: standard\n    chartmuseum:\n      storageClass: standard\n    jobservice:\n      storageClass: standard\n    database:\n      storageClass: standard\n    redis:\n      storageClass: standard\n    trivy:\n      storageClass: standard\n\nexternalURL: https://harbor.192-168-49-2.nip.io\n# initial password for logging in with user \"admin\"\nharborAdminPassword: \"changeme\"\n\nchartmuseum:\n  enabled: false\ntrivy:\n  enabled: false\nnotary:\n  enabled: false\n</code></pre> <p>Note</p> <ul> <li>We specify use of \u2018valid\u2019 certificates from Letsencrypt \u2018production\u2019. The Workspace API, which calls the Harbor API, expects valid certificates and will thus fail if presented with TLS certificates that fail validation.</li> <li>The <code>letsencrypt-production</code> Cluster Issuer relies upon the deployment being accessible from the public internet via the <code>expose.ingress.hosts.core</code> DNS name. If this is not the case, e.g. for a local minikube deployment in which this is unlikely to be so. In this case the TLS will fall-back to the self-signed certificate built-in to the nginx ingress controller. The Workspace API will not like this.</li> </ul>"},{"location":"eoepca/container-registry/#container-registry-usage","title":"Container Registry Usage","text":"<p>After deployemnt Harbor is accessible via its web interface at <code>https://harbor.192-168-49-2.nip.io/</code>e.g. https://harbor.192-168-49-2.nip.io/.</p> <p>Login as the admin user with the password specified in the helm values.</p>"},{"location":"eoepca/container-registry/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the Container Registry can be found at:</p> <ul> <li>Web Site</li> <li>Helm Chart Repository</li> <li>Helm Chart Description</li> <li>Harbor Documentation</li> </ul>"},{"location":"eoepca/data-access/","title":"Data Access","text":"<p>The Data Access provides standards-based services for access to platform hosted data - including OGC WMS/WMTS for visualisation, and OGC WCS for data retrieval. This component also includes Harvester and Registrar services to discover/watch the existing data holding of the infrastructure data layer and populate/maintain the data access and resource catalogue services accordingly.</p>"},{"location":"eoepca/data-access/#helm-chart","title":"Helm Chart","text":"<p>The Data Access is deployed via the <code>data-access</code> helm chart from the EOEPCA Helm Chart Repository.</p> <p>The chart is configured via values that are supplied with the instantiation of the helm release. The EOEPCA <code>data-access</code> chart provides a thin wrapper around the EOX View Server (<code>vs</code>) helm chart. The documentation for the View Server can be found here:</p> <ul> <li>User Guide: https://vs.pages.eox.at/documentation/user/main/</li> <li>Operator Guide: https://vs.pages.eox.at/documentation/operator/main/</li> </ul> <pre><code>helm install --version 1.4.0 --values data-access-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  data-access data-access\n</code></pre>"},{"location":"eoepca/data-access/#values","title":"Values","text":"<p>The Data Access supports many values to configure the service. These are documented in full in the View Server - Operator Guide Configuration page.</p>"},{"location":"eoepca/data-access/#core-configuration","title":"Core Configuration","text":"<p>Typically, values for the following attributes may be specified to override the chart defaults:</p> <ul> <li>The fully-qualified public URL for the service, ref. (<code>global.ingress.hosts.host[0]</code>)</li> <li>Metadata describing the service instance</li> <li>Dynamic provisioning StorageClass for persistence</li> <li>Persistent Volume Claims for <code>database</code> and <code>redis</code> components</li> <li>Object storage details for <code>data</code> and <code>cache</code></li> <li>Container images for <code>renderer</code> and <code>registrar</code></li> <li>(optional) Specification of Ingress for reverse-proxy access to the service Note that this is only required in the case that the Data Access will not be protected by the <code>identity-gatekeeper</code> component - ref. Resource Protection. Otherwise the ingress will be handled by the <code>identity-gatekeeper</code> - use <code>ingress.enabled: false</code>.</li> </ul> <pre><code>global:\n  env:\n    REGISTRAR_REPLACE: \"true\"\n    CPL_VSIL_CURL_ALLOWED_EXTENSIONS: .TIF,.tif,.xml,.jp2,.jpg,.jpeg\n    AWS_ENDPOINT_URL_S3: https://minio.192-168-49-2.nip.io\n    AWS_HTTPS: \"FALSE\"\n    startup_scripts:\n      - /registrar_pycsw/registrar_pycsw/initialize-collections.sh\n  ingress:\n    enabled: true\n    annotations:\n      kubernetes.io/ingress.class: nginx\n      kubernetes.io/tls-acme: \"true\"\n      nginx.ingress.kubernetes.io/proxy-read-timeout: \"600\"\n      nginx.ingress.kubernetes.io/enable-cors: \"true\"\n      cert-manager.io/cluster-issuer: letsencrypt-production\n    hosts:\n      - host: data-access.192-168-49-2.nip.io\n    tls:\n      - hosts:\n          - data-access.192-168-49-2.nip.io\n        secretName: data-access-tls\n  storage:\n    data:\n      data:\n        type: S3\n        endpoint_url: http://data.cloudferro.com\n        access_key_id: access\n        secret_access_key: access\n        region_name: RegionOne\n        validate_bucket_name: false\n    cache:\n      type: S3\n      endpoint_url: \"https://minio.192-168-49-2.nip.io\"\n      host: \"minio.192-168-49-2.nip.io\"\n      access_key_id: xxx\n      secret_access_key: xxx\n      region: us-east-1\n      bucket: cache-bucket\n  metadata:\n    title: EOEPCA Data Access Service developed by EOX\n    abstract: EOEPCA Data Access Service developed by EOX\n    header: \"EOEPCA Data Access View Server (VS) Client powered by &lt;a href=\\\"//eox.at\\\"&gt;&lt;img src=\\\"//eox.at/wp-content/uploads/2017/09/EOX_Logo.svg\\\" alt=\\\"EOX\\\" style=\\\"height:25px;margin-left:10px\\\"/&gt;&lt;/a&gt;\"\n    url: https://data-access.192-168-49-2.nip.io/ows\n  layers:\n    # see section 'Data-layer Configuration'\n  collections:\n    # see section 'Data-layer Configuration'\n  productTypes:\n    # see section 'Data-layer Configuration'\nvs:\n  renderer:\n    replicaCount: 4\n    ingress:\n      enabled: false\n    resources:\n      requests:\n        cpu: 100m\n        memory: 300Mi\n      limits:\n        cpu: 1.5\n        memory: 3Gi\n  registrar:\n    replicaCount: 1\n    config:\n      # see section 'Registrar Routes Configuration'\n    resources:\n      requests:\n        cpu: 100m\n        memory: 100Mi\n  harvester:\n    # see section 'Harvester Configuration'\n    replicaCount: 1\n    resources:\n      requests:\n        cpu: 100m\n        memory: 100Mi\n  client:\n    replicaCount: 1\n    ingress:\n      enabled: false\n  redis:\n    master:\n      persistence:\n        enabled: true\n        storageClass: standard\n  ingestor:\n    replicaCount: 0\n    ingress:\n      enabled: false\n  preprocessor:\n    replicaCount: 0\n  cache:\n    ingress:\n      enabled: false\n  scheduler:\n    resources:\n      requests:\n        cpu: 100m\n        memory: 100Mi\n</code></pre> <p>Note</p> <p>The <code>resources:</code> above have been limited for the benefit of a minikube deployment. For a production deployment the values should be tuned (upwards) according to operational needs.</p>"},{"location":"eoepca/data-access/#registrar-routes-configuration","title":"Registrar Routes Configuration","text":"<p>The Data Access <code>registrar</code> component supports a number of different resource types. For each a dedicated \u2018backend\u2019 is configured to handle the specific registration of the resource type\u2026</p> <pre><code>vs:\n  registrar:\n    config:\n      #--------------\n      # Default route\n      #--------------\n      disableDefaultRoute: false\n      # Additional backends for the default route\n      defaultBackends:\n        - path: registrar_pycsw.backend.ItemBackend\n          kwargs:\n            repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw\n            ows_url: https://data-access.192-168-49-2.nip.io/ows\n      defaultSuccessQueue: seed_queue\n      #----------------\n      # Specific routes\n      #----------------\n      routes:\n        collections:\n          path: registrar.route.stac.CollectionRoute\n          queue: register_collection_queue\n          replace: true\n          backends:\n            - path: registrar_pycsw.backend.CollectionBackend\n              kwargs:\n                repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw\n        ades:\n          path: registrar.route.json.JSONRoute\n          queue: register_ades_queue\n          replace: true\n          backends:\n            - path: registrar_pycsw.backend.ADESBackend\n              kwargs:\n                repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw\n        application:\n          path: registrar.route.json.JSONRoute\n          queue: register_application_queue\n          replace: true\n          backends:\n            - path: registrar_pycsw.backend.CWLBackend\n              kwargs:\n                repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw\n        catalogue:\n          path: registrar.route.json.JSONRoute\n          queue: register_catalogue_queue\n          replace: true\n          backends:\n            - path: registrar_pycsw.backend.CatalogueBackend\n              kwargs:\n                repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw\n        json:\n          path: registrar.route.json.JSONRoute\n          queue: register_json_queue\n          replace: true\n          backends:\n            - path: registrar_pycsw.backend.JSONBackend\n              kwargs:\n                repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw\n        xml:\n          path: registrar.route.json.JSONRoute\n          queue: register_xml_queue\n          replace: true\n          backends:\n            - path: registrar_pycsw.backend.XMLBackend\n              kwargs:\n                repository_database_uri: postgresql://postgres:mypass@resource-catalogue-db/pycsw\n</code></pre>"},{"location":"eoepca/data-access/#data-layer-configuration","title":"Data-layer Configuration","text":"<p>Configuration of the service data-layer - as described in the View Server Operator Guide. </p> <p>The data-access service data handling is configured by definition of <code>productTypes</code>, <code>collections</code> and <code>layers</code>\u2026</p> <ul> <li><code>productTypes</code> - Product Types   Identify the underlying file assets as WCS coverages and their visual representation</li> <li><code>collections</code> - Data Collections   Provides groupings into which products are organised</li> <li><code>layers</code> - Layers   Specifies the hoe the product visual representations are exposed through the WMS service</li> </ul> <p>For more information, see the worked example in section Data Specification for the example CREODIAS deployment.</p>"},{"location":"eoepca/data-access/#harvester","title":"Harvester","text":"<p>The Data Access service includes a Harvester component. The following subsections describe its configuration and usage.</p>"},{"location":"eoepca/data-access/#harvester-helm-configuration","title":"Harvester Helm Configuration","text":"<p>The Harvester can be configured through the helm chart values\u2026</p> <pre><code>vs:\n  harvester:\n    replicaCount: 1\n    resources:\n      requests:\n        cpu: 100m\n        memory: 100Mi\n    config:\n      redis:\n        host: data-access-redis-master\n        port: 6379\n      harvesters:\n        Sentinel2:\n          resource:\n            type: OpenSearch\n            opensearch:\n              url: https://datahub.creodias.eu/resto/api/collections/Sentinel2/describe.xml\n              format:\n                type: 'application/json'\n                json:\n                  property_mapping:\n                    start_datetime: 'startDate'\n                    end_datetime: 'completionDate'\n                    productIdentifier: 'productIdentifier'\n              query:\n                time:\n                  begin: 2019-09-10T00:00:00Z\n                  end: 2019-09-11T00:00:00Z\n                collection: null\n                bbox: 14.9,47.7,16.4,48.7\n          filter: {}\n          postprocessors:\n            - type: external\n              process: harvester_eoepca.postprocess.postprocess_sentinel2\n              kwargs: {}\n          queue: register\n        Landsat8:\n          filter: {}\n          postprocessors:\n          - kwargs: {}\n            process: harvester_eoepca.postprocess.postprocess_landsat8\n            type: external\n          queue: register\n          resource:\n            opensearch:\n              format:\n                json:\n                  property_mapping:\n                    end_datetime: completionDate\n                    productIdentifier: productIdentifier\n                    start_datetime: startDate\n                type: application/json\n              query:\n                bbox: 19.7,34.7,28.5,42.0\n                collection: null\n                time:\n                  begin: 2020-09-01T00:00:00Z\n                  end: 2020-09-05T00:00:00Z\n              url: https://datahub.creodias.eu/resto/api/collections/Landsat8/describe.xml\n            type: OpenSearch\n        Sentinel1-GRD:\n          resource:\n            type: OpenSearch\n            opensearch:\n              url: https://datahub.creodias.eu/resto/api/collections/Sentinel1/describe.xml\n              format:\n                type: 'application/json'\n                json:\n                  property_mapping:\n                    start_datetime: 'startDate'\n                    end_datetime: 'completionDate'\n                    productIdentifier: 'productIdentifier'\n              query:\n                time:\n                  begin: 2019-09-10T00:00:00Z\n                  end: 2019-09-11T00:00:00Z\n                collection: null\n                bbox: 14.9,47.7,16.4,48.7\n                extra_params:\n                  productType: GRD-COG\n          filter: {}\n          postprocessors:\n            - type: external\n              process: harvester_eoepca.postprocess.postprocess_sentinel1\n              kwargs: {}\n          queue: register\n        Sentinel3:\n          resource:\n            type: OpenSearch\n            opensearch:\n              url: https://datahub.creodias.eu/resto/api/collections/Sentinel3/describe.xml\n              format:\n                type: 'application/json'\n                json:\n                  property_mapping:\n                    start_datetime: 'startDate'\n                    end_datetime: 'completionDate'\n                    productIdentifier: 'productIdentifier'\n              query:\n                time:\n                  begin: 2019-09-10T00:00:00Z\n                  end: 2019-09-11T00:00:00Z\n                collection: null\n                bbox: 14.9,47.7,16.4,48.7\n                extra_params:\n                  productType: OL_2_LFR___\n          filter: {}\n          postprocessors:\n            - type: external\n              process: harvester_eoepca.postprocess.postprocess_sentinel3\n              kwargs: {}\n          queue: register\n        Sentinel1-SLC:\n          resource:\n            type: OpenSearch\n            opensearch:\n              url: https://datahub.creodias.eu/resto/api/collections/Sentinel1/describe.xml\n              format:\n                type: 'application/json'\n                json:\n                  property_mapping:\n                    start_datetime: 'startDate'\n                    end_datetime: 'completionDate'\n                    productIdentifier: 'productIdentifier'\n              query:\n                time:\n                  begin: 2019-09-10T00:00:00Z\n                  end: 2019-09-11T00:00:00Z\n                collection: null\n                bbox: 14.9,47.7,16.4,48.7\n                extra_params:\n                  productType: SLC\n          filter: {}\n          postprocessors:\n            - type: external\n              process: harvester_eoepca.postprocess.postprocess_sentinel1\n              kwargs: {}\n          queue: register\n</code></pre> <p>The <code>harvester.config.harvesters</code> list defines a set of pre-defined harvesters which can be invoked in a later stage. The name property must be unique for each harvester and must be unique among all harvesters in the list. Each harvester is associated with a <code>resource</code>, an optional <code>filter</code> or <code>postprocess</code> function, and a <code>queue</code>.</p> <p>The <code>resource</code> defines where each item is harvested from. This can be a file system, a search service, catalog file or something similar. The example above defines a connection to an OpenSearch service on CREODIAS, with associated default query parameters and a format configuration.</p> <p>The <code>filter</code> allows to filter elements within the harvester, when the resource does not provide a specific filter. This filter can be supplied using CQL2-JSON.</p> <p>The <code>postprocess</code> can adjust the harvested results. In this example the harvested items are not complete, and additional metadata must be retrieved from an object storage.</p> <p>The <code>queue</code> defines where harvested items will be pushed into. Usually this is a registration queue, where the registrar will pick up and start registration according to its configuration.</p>"},{"location":"eoepca/data-access/#starting-the-harvester","title":"Starting the Harvester","text":"<p>The harvester can either do one-off harvests via the CLI or listen on a redis queue to run consecutive harvests whenever a harvesting request is received on that queue.</p>"},{"location":"eoepca/data-access/#one-off-harvests-via-the-cli","title":"One-off harvests via the CLI","text":"<p>In order to start a harvest from the CLI, the operator first needs to connect to the kubernetes pod of the harvester. Within that pod, the harvest can be executed like this\u2026</p> <pre><code>python3 -m harvester harvest --config-file /config-run.yaml Sentinel2\n</code></pre> <p>This will invoke the <code>Sentinel2</code> harvester with default arguments. When some values are to be overridden, the <code>-co</code> or <code>--config-override</code> switch can be used to pass override values - using the same yaml paths as per the config file. The following example adjusts the begin and end times of the query parameters\u2026</p> <pre><code>python3 -m harvester harvest --config-file /config-run.yaml Sentinel2 \\\n  -co harvesters.Sentinel2.resource.opensearch.query.time.begin=2020-09-10T00:00:00Z \\\n  -co harvesters.Sentinel2.resource.opensearch.query.time.end=2020-09-11T00:00:00Z\n</code></pre>"},{"location":"eoepca/data-access/#harvests-via-the-harvest-daemon","title":"Harvests via the harvest daemon","text":"<p>The harvester pod runs a service listening on a redis queue. When a message is read from the queue, it will be read as a JSON string, expecting an object with at least a <code>name</code> property. Optionally, it can also have a <code>values</code> property, working in the same way as with CLI <code>--values</code>.</p> <p>To send a harvesting request via the redis queue, it is necessary to connect to the redis pod and execute the redis-cli there. Then the following command can be used to achieve the same result as above with CLI harvesting\u2026 <pre><code>redis-cli LPUSH '{\"name\": \"Sentinel2\", \"values\": {\"resource\": {\"query\": {\"time\": {\"begin\": \"2020-09-10T00:00:00Z\", \"end\": \"2020-09-11T00:00:00Z\"}}}}}'\n</code></pre></p>"},{"location":"eoepca/data-access/#results-of-the-harvesting","title":"Results of the harvesting","text":"<p>The harvester produces a continous stream of STAC Items which are sent down via the configured queue. It is possible that the harvested metadata is not sufficient to create a fully functional STAC Item. In this case the postprocess must transform this intermediate item to a valid STAC Item. In our example, the postprocessor looks up the Sentinel-2 product file referenced by the product identifier which is then accessed on the object storage. From the stored metadata files, the STAC Items to be sent is created.</p>"},{"location":"eoepca/data-access/#storage","title":"Storage","text":"<p>Specification of PVCs and access to object storage.</p>"},{"location":"eoepca/data-access/#persistent-volume-claims","title":"Persistent Volume Claims","text":"<p>The PVCs specified in the helm chart values must be created.</p>"},{"location":"eoepca/data-access/#pvc-for-database","title":"PVC for Database","text":"<pre><code>kind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\n  name: data-access-db\n  namespace: rm\n  labels:\n    k8s-app: data-access\n    name: data-access\nspec:\n  storageClassName: standard\n  accessModes:\n    - ReadWriteMany\n  resources:\n    requests:\n      storage: 100Gi\n</code></pre>"},{"location":"eoepca/data-access/#pvc-for-redis","title":"PVC for Redis","text":"<pre><code>kind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\n  name: data-access-redis\n  namespace: rm\n  labels:\n    k8s-app: data-access\n    name: data-access\nspec:\n  storageClassName: standard\n  accessModes:\n    - ReadWriteMany\n  resources:\n    requests:\n      storage: 1Gi\n</code></pre>"},{"location":"eoepca/data-access/#object-storage","title":"Object Storage","text":"<p>The helm chart values expect specification of object storage details for:</p> <ul> <li><code>data</code>: to access the EO data of the underlying infrastructure</li> <li><code>cache</code>: a dedicated object storage bucket is used to support the cache function of the data access services</li> </ul>"},{"location":"eoepca/data-access/#platform-eo-data","title":"Platform EO Data","text":"<p>Specifies the details for the infrastructure object storage that provides direct access to the EO product files.</p> <p>For example, the CREODIAS metadata catalogue provides references to product files in their <code>eodata</code> object storage - the access details for which are configured in the data access services:</p> <pre><code>global:\n  storage:\n    data:\n      data:\n        type: S3\n        endpoint_url: http://data.cloudferro.com\n        access_key_id: access\n        secret_access_key: access\n        region_name: RegionOne\n        validate_bucket_name: false\n</code></pre>"},{"location":"eoepca/data-access/#data-access-cache","title":"Data Access Cache","text":"<p>The Data Access services maintain a cache, which relies on the usage of a dedicate object storage bucket for data persistence. This bucket must be created (manual step) and its access details configured in the data access services. Example based upon CREODIAS:</p> <pre><code>global:\n  storage:\n    cache:\n      type: S3\n      endpoint_url: \"https://cf2.cloudferro.com:8080/cache-bucket\"\n      host: \"cf2.cloudferro.com:8080\"\n      access_key_id: xxx\n      secret_access_key: xxx\n      region: RegionOne\n      bucket: cache-bucket\n</code></pre> <p>\u2026where <code>xxx</code> must be replaced with the bucket credentials.</p>"},{"location":"eoepca/data-access/#protection","title":"Protection","text":"<p>As described in section Resource Protection (Keycloak), the <code>identity-gatekeeper</code> component can be inserted into the request path of the <code>data-access</code> service to provide access authorization decisions</p>"},{"location":"eoepca/data-access/#gatekeeper","title":"Gatekeeper","text":"<p>Gatekeeper is deployed using its helm chart\u2026</p> <pre><code>helm install data-access-protection identity-gatekeeper -f data-access-protection-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  --namespace \"rm\" --create-namespace \\\n  --version 1.0.12\n</code></pre> <p>The <code>identity-gatekeeper</code> must be configured with the values applicable to the <code>data-access</code> - in particular the specific ingress requirements for the <code>data-access</code> backend services\u2026</p> <p>Example <code>data-access-protection-values.yaml</code>\u2026</p> <pre><code>fullnameOverride: data-access-protection\nconfig:\n  client-id: data-access\n  discovery-url: https://keycloak.192-168-49-2.nip.io/realms/master\n  cookie-domain: 192-168-49-2.nip.io\ntargetService:\n  host: data-access.192-168-49-2.nip.io\n  name: data-access-renderer\n  port:\n    number: 80\nsecrets:\n  # Values for secret 'data-access-protection'\n  # Note - if ommitted, these can instead be set by creating the secret independently.\n  clientSecret: \"changeme\"\n  encryptionKey: \"changemechangeme\"\ningress:\n  enabled: true\n  className: nginx\n  annotations:\n    ingress.kubernetes.io/ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n    cert-manager.io/cluster-issuer: letsencrypt-production\n    nginx.ingress.kubernetes.io/proxy-read-timeout: \"600\"\n    nginx.ingress.kubernetes.io/enable-cors: \"true\"\n    nginx.ingress.kubernetes.io/rewrite-target: /$1\n  # Full open access - all request uri are open\n  openUri:\n    - ^.*\n  # Routes proxied to services\n  hosts:\n    - host: \"{{ .Values.targetService.host }}\"\n      paths:\n        - path: /(ows.*|opensearch.*|coverages/metadata.*|admin.*)\n          pathType: Prefix\n          backend:\n            service:\n              name: data-access-renderer\n              port:\n                number: 80\n        - path: /cache/(.*)\n          pathType: Prefix\n          backend:\n            service:\n              name: data-access-cache\n              port:\n                number: 80\n        - path: /(.*)\n          pathType: Prefix\n          backend:\n            service:\n              name: data-access-client\n              port:\n                number: 80\n</code></pre>"},{"location":"eoepca/data-access/#keycloak-client","title":"Keycloak Client","text":"<p>The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. <code>client-id: data-access</code> above.</p> <p>This can be created with the <code>create-client</code> helper script, as descirbed in section Client Registration.</p> <p>For example\u2026</p> <pre><code>../bin/create-client \\\n  -a https://keycloak.192-168-49-2.nip.io \\\n  -i https://identity-api.192-168-49-2.nip.io \\\n  -r \"master\" \\\n  -u \"admin\" \\\n  -p \"changeme\" \\\n  -c \"admin-cli\" \\\n  --id=data-access \\\n  --name=\"Data Access Gatekeeper\" \\\n  --secret=\"changeme\" \\\n  --description=\"Client to be used by Data Access Gatekeeper\"\n</code></pre>"},{"location":"eoepca/data-access/#data-access-usage","title":"Data Access Usage","text":""},{"location":"eoepca/data-access/#default-harvesting","title":"Default Harvesting","text":"<p>At deployment time the <code>harvester</code> helm values include configuration that populates a default harvester configuration, that is prepared in the file <code>/config.yaml</code> in the <code>harvester</code> pod.</p> <p>The Data Access and Resource Catalogue services are configured to properly interpret harvested data via these values specified in the instantiation of the helm release. See section Data-layer Configuration.</p> <p>The harvesting of data can be triggered (post deployment), in accordance with this default configuration, by connecting to the <code>rm/harvester</code> service and executing the command\u2026 <pre><code>python3 -m harvester harvest --config-file /config-run.yaml Sentinel2\n</code></pre></p>"},{"location":"eoepca/data-access/#ad-hoc-harvesting","title":"Ad-hoc Harvesting","text":"<p>Ad-hoc harvesting can be invoked by provision of a suitable <code>config.yaml</code> into the harvester pod, which can then be invoked as shown above for the default harvester configuration established at deploy time.</p> <p>The helper script <code>./deploy/bin/harvest</code> faciltates this\u2026</p> <pre><code>./deploy/bin/harvest &lt;path-to-config-file&gt;\n</code></pre> <p>See directory <code>./deploy/samples/harvester/</code> that contains some sample harvesting configuration files. For example\u2026</p> <pre><code>./deploy/bin/harvest ./deploy/samples/harvester/config-Sentinel2-2019.09.10.yaml\n</code></pre>"},{"location":"eoepca/data-access/#registration-of-collections","title":"Registration of Collections","text":"<p>The helper script <code>./deploy/bin/register-collection</code> is provided to faciltate the registration of collections that are specfied in STAC Collection format.</p> <pre><code>./deploy/bin/register-collection &lt;path-to-stac-collection-file&gt;\n</code></pre> <p>See directory <code>./deploy/samples/collections/</code> that contains some same STAC Collection files. For example\u2026</p> <pre><code>./deploy/bin/register-collection ./deploy/samples/collections/S2MSI2A.json\n</code></pre>"},{"location":"eoepca/data-access/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the Data Access can be found at:</p> <ul> <li>Helm Chart</li> <li>Documentation:<ul> <li>User Guide</li> <li>Operator Guide</li> </ul> </li> <li>Git Repository</li> </ul>"},{"location":"eoepca/iam-overview/","title":"IAM Overview","text":"<p>This guide includes two approaches for Identity &amp; Access Management:</p> <ul> <li>Keycloak Solution (NEW)</li> <li>Gluu Solution (deprecated)</li> </ul> <p>Until now, our IAM solution has been based solely upon Gluu.</p> <p>In the course of the project Keycloak has emerged as a preferred solution across EO platforms.</p> <p>Thus, we have introduced an IAM approach based upon Keycloak, whilst retaining the Gluu-based approach for reference, which will be deprecated.</p>"},{"location":"eoepca/identity-service/","title":"Identity Service","text":"<p>The Identity Service provides the platform Authorization Server for authenticated user identity and request authorization.</p> <p>Identity Service is composed of:</p> <ul> <li>Keycloak IAM Authorization Service - supporting OpenID Connect (OIDC), etc.</li> <li>Postgres DB Relational database used by Keycloak for persistence</li> <li>Identity API   Service that provided a convenience API to simplify IAM management interactions with Keycloak.   Provides endpoints to create clients and protect resources.   Uses a keycloak python client which sends requests to Keycloak API</li> <li>Identity API Gatekeeper   Instance of Gatekeeper to \u2018protect\u2019 access requests to the Identity API service.   Gatekeeper is a reusable component that provides the Policy Enforcement for requests to individual resource servers.   A Gatekeeper instance should be configured and deployed for each application that requires protection by access policies. </li> </ul>"},{"location":"eoepca/identity-service/#helm-chart","title":"Helm Chart","text":"<p>The Identity Service is deployed via the <code>identity-service</code> helm chart from the EOEPCA Helm Chart Repository.</p> <p>The chart is configured via values - the full set of available values can be tailored according the helm chart defaults, that can be found here\u2026</p> <ul> <li><code>identity-service</code> https://github.com/EOEPCA/helm-charts/blob/main/charts/identity-service/values.yaml</li> <li><code>identity-keycloak</code> https://github.com/EOEPCA/helm-charts/blob/main/charts/identity-service/charts/identity-keycloak/values.yaml</li> <li><code>identity-postgres</code> https://github.com/EOEPCA/helm-charts/blob/main/charts/identity-service/charts/identity-postgres/values.yaml</li> <li><code>identity-api</code> https://github.com/EOEPCA/helm-charts/blob/main/charts/identity-service/charts/identity-api/values.yaml</li> </ul> <pre><code>helm install --version 1.0.98 --values identity-service-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  identity-service identity-service\n</code></pre>"},{"location":"eoepca/identity-service/#values","title":"Values","text":"<p>The deployment must be configured for you environment. Some significant configuration values are elaborated here\u2026</p>"},{"location":"eoepca/identity-service/#identity-keycloak","title":"identity-keycloak","text":""},{"location":"eoepca/identity-service/#secrets","title":"Secrets","text":"<p>Keycloak relies upon a secret <code>identity-keycloak</code> that provides\u2026</p> <ul> <li><code>KEYCLOAK_ADMIN_PASSWORD</code> - admin password for Keycloak</li> <li><code>KC_DB_PASSWORD</code> - password for connecting with Postgres DB   This should match the <code>POSTGRES_PASSWORD</code> setting for <code>identity-postgres</code> (see below)</li> </ul> <p>The secret can either be created directly within the cluster, or can be created by the helm chart via values\u2026</p> <pre><code>identity-keycloak:\n  secrets:\n    # Values for secret 'identity-keycloak'\n    # Note - if ommitted, these can instead be set by creating the secret independently.\n    kcDbPassword: \"changeme\"\n    keycloakAdminPassword: \"changeme\"\n</code></pre>"},{"location":"eoepca/identity-service/#ingress","title":"Ingress","text":"<p>The details for ingress (reverse-proxy) to the Keycloak service - in particular the hostname and possible TLS - must be specified\u2026</p> <pre><code>identity-keycloak:\n  ingress:\n    enabled: true\n    className: nginx\n    annotations:\n      ingress.kubernetes.io/ssl-redirect: \"true\"\n      nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n      cert-manager.io/cluster-issuer: letsencrypt-production\n    hosts:\n      - host: keycloak.192-168-49-2.nip.io\n        paths:\n          - path: /\n            pathType: Prefix\n    tls:\n      - secretName: identity-keycloak-tls\n        hosts:\n          - keycloak.192-168-49-2.nip.io\n</code></pre>"},{"location":"eoepca/identity-service/#identity-postgres","title":"identity-postgres","text":""},{"location":"eoepca/identity-service/#secrets_1","title":"Secrets","text":"<p>Postgres relies upon a secret <code>identity-postgres</code> that provides\u2026</p> <ul> <li><code>POSTGRES_PASSWORD</code> - superuser password for PostgreSQL</li> <li><code>PGPASSWORD</code> - password used for client connections to the DB</li> </ul> <p>The secret can either be created directly within the cluster, or can be created by the helm chart via values\u2026</p> <pre><code>identity-postgres:\n  secrets:\n    # Values for secret 'identity-postgres'\n    # Note - if ommitted, these can instead be set by creating the secret independently.\n    postgresPassword: \"changeme\"\n    pgPassword: \"changeme\"\n</code></pre>"},{"location":"eoepca/identity-service/#persistence","title":"Persistence","text":"<p>In order to persist data, Postgres requires a Persistent Volume Claim.</p> <p>This can be specified as an existing volume claim - for example as described in the Persistence section.</p> <pre><code>identity-postgres:\n  volumeClaim:\n    name: eoepca-userman-pvc\n</code></pre>"},{"location":"eoepca/identity-service/#identity-api","title":"identity-api","text":""},{"location":"eoepca/identity-service/#secrets_2","title":"Secrets","text":"<p>The Identity API relies upon a secret <code>identity-api</code> that provides\u2026</p> <ul> <li><code>ADMIN_PASSWORD</code>   Admin password for Keycloak   This should match the <code>KEYCLOAK_ADMIN_PASSWORD</code> setting for <code>identity-keycloak</code> (see above)</li> </ul> <p>The secret can either be created directly within the cluster, or can be created by the helm chart via values\u2026</p> <pre><code>identity-api:\n  secrets:\n    # Values for secret 'identity-api'\n    # Note - if ommitted, these can instead be set by creating the secret independently\n    # e.g. as a SealedSecret via GitOps.\n    adminPassword: \"changeme\"\n</code></pre> <p>Note</p> <p>It is also possible to set the value of <code>ADMIN_PASSWORD</code> directly as an environment variable. In this case it is necessary to set the <code>secret</code> as optional\u2026</p> <pre><code>identity-api:\n  secrets:\n    optional: true\n</code></pre>"},{"location":"eoepca/identity-service/#environment-variables","title":"Environment Variables","text":"<p>The Identity API service can be configured via environment variables as follows\u2026</p> <ul> <li><code>AUTH_SERVER_URL</code>   URL of the Keycloak Authorization Server.   Can also be set via value <code>configMap.authServerUrl</code></li> <li><code>ADMIN_USERNAME</code>   Admin user for Keycloak</li> <li><code>REALM</code>   The Keycloak realm</li> </ul> <pre><code>identity-api:\n  deployment:\n    # Config values that can be passed via env vars\n    extraEnv:\n      - name: AUTH_SERVER_URL  # see configMap.authServerUrl instead\n        value: https://keycloak.192-168-49-2.nip.io\n      - name: ADMIN_USERNAME\n        value: admin\n      - name: ADMIN_PASSWORD  # see secrets.adminPassword instead\n        value: changeme\n      - name: REALM\n        value: master\n</code></pre>"},{"location":"eoepca/identity-service/#identity-api-gatekeeper","title":"identity-api-gatekeeper","text":""},{"location":"eoepca/identity-service/#secrets_3","title":"Secrets","text":"<p>gatekeeper relies upon a secret <code>identity-api-protection</code> that provides\u2026</p> <ul> <li><code>PROXY_CLIENT_SECRET</code>   Password for the Keycloak client configured for use by this Gatekeeper instance - corresponding to <code>config.client-id</code>.</li> <li><code>PROXY_ENCRYPTION_KEY</code>   Encryption Key used by Gatekeeper.</li> </ul> <p>The secret can either be created directly within the cluster, or can be created by the helm chart via values\u2026</p> <pre><code>identity-api-gatekeeper:\n  secrets:\n    # Values for secret 'identity-api-protection'\n    # Note - if ommitted, these can instead be set by creating the secret independently.\n    clientSecret: \"changeme\"\n    encryptionKey: \"changemechangeme\"\n</code></pre>"},{"location":"eoepca/identity-service/#configuration","title":"Configuration","text":"<p>Configuration of Gatekeeper via the file <code>config.yaml</code> that is mounted into the deployment\u2026</p> <ul> <li><code>client-id</code>   ID of the Keycloak client to be used by this Gatekeeper instance.</li> <li><code>discovery-url</code>   Discovery URL of the Keycloak Authorization Server</li> <li><code>cookie-domain</code>   Domain in which this Gatekeeper instance creates cookies </li> </ul> <pre><code>identity-api-gatekeeper:\n  config:\n    client-id: identity-api\n    discovery-url: https://keycloak.192-168-49-2.nip.io/realms/master\n    cookie-domain: 192-168-49-2.nip.io\n</code></pre>"},{"location":"eoepca/identity-service/#ingress_1","title":"Ingress","text":"<p>The details for ingress (reverse-proxy) to the Gatekeeper service that protects the Identity API\u2026</p> <pre><code>identity-api-gatekeeper:\n  targetService:\n    host: identity-api.192-168-49-2.nip.io\n  ingress:\n    annotations:\n      ingress.kubernetes.io/ssl-redirect: \"true\"\n      nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n      cert-manager.io/cluster-issuer: letsencrypt\n</code></pre>"},{"location":"eoepca/identity-service/#identity-api-client","title":"Identity API Client","text":"<p>The Identity API is protected via an instance of Gatekeeper - which relies upon a Keycloak client having been created for authorization decision/enforcement flows between Gatekeeper and Keycloak.</p> <p>As described in the \u2018create-client\u2019 section below, this can be achieved using the <code>create-client</code> helper script.</p> <p>Note</p> <p>At time of client creation, the Identity API is not yet protected with an ingress. Therefore, we use a <code>port-forward</code> to interface directly with the Identity API service.</p> <pre><code>$ kubectl -n um port-forward svc/identity-api \"9876\":http &gt;/dev/null &amp;\n$ portForwardPid=$!\n\n$ ./deploy/bin/create-client \\\n  -a https://keycloak.192-168-49-2.nip.io \\\n  -i http://localhost:9876 \\\n  -r master \\\n  -u admin \\\n  -p changeme \\\n  -c admin-cli \\\n  --id=identity-api \\\n  --name=\"Identity API Gatekeeper\" \\\n  --secret=changeme \\\n  --description=\"Client to be used by Identity API Gatekeeper\" \\\n  --resource=\"admin\" --uris='/*' --scopes=view --users=\"admin\"\n\n$ kill -TERM $portForwardPid\n</code></pre>"},{"location":"eoepca/identity-service/#create-user-helper-script","title":"<code>create-user</code> Helper Script","text":"<p>The Keycloak Admin UI can be used to create users interactively.</p> <p>Alternatvely there is a helper script <code>create-user</code> that can be used.</p> <p>The script is available in the <code>deployment-guide</code> repository, and can be obtained as follows\u2026</p> <pre><code>git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide\ncd deployment-guide\n</code></pre> <p>The <code>create-user</code> helper script requires some command-line arguments\u2026</p> <pre><code>$ ./deploy/bin/create-user -h\n\nCreate a new user.\ncreate-user -h | -a {auth_server} -r {realm} -c {client} -u {admin-username} -p {admin-password} -U {new-username} -P {new-password}\n\nwhere:\n    -h  show help message\n    -a  authorization server url (default: http://keycloak.192-168-49-2.nip.io)\n    -r  realm within Keycloak (default: master)\n    -u  username used for authentication (default: admin)\n    -p  password used for authentication (default: changeme)\n    -c  client id of the bootstrap client used in the create request (default: admin-cli)\n    -U  name of the (new) user to create\n    -P  password for the (new) user to create\n</code></pre>"},{"location":"eoepca/identity-service/#protection-of-resources","title":"Protection of Resources","text":"<p>The Identity Service is capable of protecting resources using OpenID-connect/SAML clients, resources (URIs/scopes), policies (user based, role based, etc) and permissions (associations between policies and resources).</p> <p>Creating and protecting resources can be done in multiple ways, as described in the following sections.</p>"},{"location":"eoepca/identity-service/#keycloak-admin-ui","title":"Keycloak Admin UI","text":"<p>To create and protect resources using the keycloak User Interface (UI), do the following steps:</p> <ul> <li>(Optional) Create clients. Clients can be created using the keycloak user interface at http://keycloak.192-168-49-2.nip.io. You need to login as admin.   To create a client: Login as admin in the keycloak UI &gt; Clients &gt; Create Client &gt; Set a name &gt; Next &gt; Turn Client Authentication and Authorization On &gt; Add the valid redirect URI\u2019s &gt; Save.</li> <li>(Optional) Create Users. Users &gt; Add User. Then set a password for the user. Credentials &gt; Set Password.</li> <li>Select a client.</li> <li>Create a Resource: Select Authorization tab &gt; Resources &gt; Create Resource.</li> <li>Create a Policy: In client details, select Authorization &gt; Policies &gt; Create Policy &gt; Select Policy Type (e.g.: User) &gt; Select users &gt; Save.</li> <li>Create Authorization Scope: In client details, select Authorization &gt; Scopes &gt; Create authorization scope &gt; Save.</li> <li>Create a Permission: In client details, select Authorization &gt; Permissions &gt; Create Permission &gt; Create Resource Based Permission &gt; Select Resources to protect &gt; Select Policies &gt; Save.</li> </ul>"},{"location":"eoepca/identity-service/#create-client-helper-script","title":"<code>create-client</code> Helper Script","text":"<p>Alternatively, a script was developed to allow simultaneaously create a client, create resources and protect them.</p> <p>The script is available in the <code>deployment-guide</code> repository, and can be obtained as follows\u2026</p> <pre><code>git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide\ncd deployment-guide\n</code></pre> <p>The <code>create-client</code> helper script requires some command-line arguments\u2026</p> <pre><code>$ ./deploy/bin/create-client -h\n\nAdd a client with protected resources.\ncreate-client [-h] [-a] [-i] [-u] [-p] [-c] [-s] [-t | --token t] [-r] --id id [--name name] (--secret secret | --public) [--default] [--authenticated] [--resource name] [--uris u1,u2] [--scopes s1,s2] [--users u1,u2] [--roles r1,r2]\n\nwhere:\n    -h                    show help message\n    -a                    authorization server url - e.g. https://keycloak.192-168-49-2.nip.io\n    -i                    identity-api server url - e.g. https://identity-api.192-168-49-2.nip.io\n    -u                    username used for authentication\n    -p                    password used for authentication\n    -c                    client id (of the bootstrap client used in the create request)\n    -s                    client secret (of the bootstrap client used in the create request)\n    -t or --token         access token used for authentication\n    -r                    realm\n    --id                  client id (of the created client)\n    --name                client name (of the created client)\n    --secret              client secret (of the created client)\n    --public              public client (no client secret)\n    --default             add default resource - /* authenticated\n    --authenticated       allow access to the resource only when authenticated\n    --resource            resource name\n    --uris                resource uris - separated by comma (,)\n    --scopes              resource scopes - separated by comma (,)\n    --users               user names with access to the resource - separated by comma (,)\n    --roles               role names with access to the resource - separated by comma (,)\n</code></pre> <p>The script interacts with Identity API and therefore requires admin authorization. It accepts basic authentication with username and password with <code>-u</code> and <code>-p</code> parameters, respectively - or a bearer access token with <code>-t</code> parameter.</p> <p>To generate the access token needed to use the script, you can get it through the login in the eoepca portal, by accessing the cookies in the browser. See section EOEPCA Portal for details regarding deployment/configuration of the <code>eoepca-portal</code>.</p> <p>Or you can generate an access token using postman oauth2.0, as described in the Postman document Requesting an OAuth 2.0 token.</p> <p>Script execution examples:</p> <ol> <li> <p>With username/password <pre><code>./deploy/bin/create-client \\\n  -a https://keycloak.192-168-49-2.nip.io \\\n  -i https://identity-api.192-168-49-2.nip.io \\\n  -r master \\\n  -u admin \\\n  -p changeme \\\n  -c admin-cli \\\n  --id=myservice-gatekeeper \\\n  --name=\"MyService Gatekeeper\" \\\n  --secret=changeme \\\n  --description=\"Client to be used by MyService Gatekeeper\" \\\n  --resource=\"Eric space\" --uris=/eric/* --users=eric \\\n  --resource=\"Alice space\" --uris=/alice/* --users=alice \\\n  --resource=\"Admin space\" --uris=/admin/* --roles=admin\n</code></pre></p> </li> <li> <p>With access token <pre><code>./deploy/bin/create-client \\\n  -a https://keycloak.192-168-49-2.nip.io \\\n  -i https://identity-api.192-168-49-2.nip.io \\\n  -r master \\\n  -t eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJXZWFIY2pscThPc1RUYjdlV0s5SjJTTDFBUDIyazZpajdlMGFlVHRNU2xRIn0.eyJleHAiOjE3MDAyNDM4MzgsImlhdCI6MTcwMDI0Mzc3OCwiYXV0aF90aW1lIjoxNzAwMjQxODYyLCJqdGkiOiI2MWI0ZGRhYy1mOWZjLTRmZjktOWQ4Zi01NWU1N2NlNmE5ODgiLCJpc3MiOiJodHRwczovL2lkZW50aXR5LmtleWNsb2FrLmRldmVsb3AuZW9lcGNhLm9yZy9yZWFsbXMvbWFzdGVyIiwiYXVkIjpbImFkZXMtcmVhbG0iLCJkZW1vLXJlYWxtIiwiZHVtbXktc2VydmljZS1yZWFsbSIsIm1hc3Rlci1yZWFsbSIsImFjY291bnQiLCJlb2VwY2EtcmVhbG0iXSwic3ViIjoiZTNkZTMyNGUtMGY0NS00MWUwLTk2YTctNTM1YzkxMTA1NTUyIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiZW9lcGNhLXBvcnRhbCIsIm5vbmNlIjoiMTIwMGJlNzAtZWI1Ni00Nzc2LThjODgtOWRiOWQxMDdiMGY2Iiwic2Vzc2lvbl9zdGF0ZSI6ImVmNGUwOTlmLTFmMDgtNDY3MC04ZmE2LTJiOGI3OGUwNWMzMSIsImFjciI6IjAiLCJhbGxvd2VkLW9yaWdpbnMiOlsiKiJdLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiY3JlYXRlLXJlYWxtIiwiZGVmYXVsdC1yb2xlcy1tYXN0ZXIiLCJvZmZsaW5lX2FjY2VzcyIsImFkbWluIiwidW1hX2F1dGhvcml6YXRpb24iLCJ1c2VyIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWRlcy1yZWFsbSI6eyJyb2xlcyI6WyJ2aWV3LWlkZW50aXR5LXByb3ZpZGVycyIsInZpZXctcmVhbG0iLCJtYW5hZ2UtaWRlbnRpdHktcHJvdmlkZXJzIiwiaW1wZXJzb25hdGlvbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfSwiZGVtby1yZWFsbSI6eyJyb2xlcyI6WyJ2aWV3LXJlYWxtIiwidmlldy1pZGVudGl0eS1wcm92aWRlcnMiLCJtYW5hZ2UtaWRlbnRpdHktcHJvdmlkZXJzIiwiaW1wZXJzb25hdGlvbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfSwiZHVtbXktc2VydmljZS1yZWFsbSI6eyJyb2xlcyI6WyJ2aWV3LXJlYWxtIiwidmlldy1pZGVudGl0eS1wcm92aWRlcnMiLCJtYW5hZ2UtaWRlbnRpdHktcHJvdmlkZXJzIiwiaW1wZXJzb25hdGlvbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfSwibWFzdGVyLXJlYWxtIjp7InJvbGVzIjpbInZpZXctaWRlbnRpdHktcHJvdmlkZXJzIiwidmlldy1yZWFsbSIsIm1hbmFnZS1pZGVudGl0eS1wcm92aWRlcnMiLCJpbXBlcnNvbmF0aW9uIiwiY3JlYXRlLWNsaWVudCIsIm1hbmFnZS11c2VycyIsInF1ZXJ5LXJlYWxtcyIsInZpZXctYXV0aG9yaXphdGlvbiIsInF1ZXJ5LWNsaWVudHMiLCJxdWVyeS11c2VycyIsIm1hbmFnZS1ldmVudHMiLCJtYW5hZ2UtcmVhbG0iLCJ2aWV3LWV2ZW50cyIsInZpZXctdXNlcnMiLCJ2aWV3LWNsaWVudHMiLCJtYW5hZ2UtYXV0aG9yaXphdGlvbiIsIm1hbmFnZS1jbGllbnRzIiwicXVlcnktZ3JvdXBzIl19LCJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX0sImVvZXBjYS1yZWFsbSI6eyJyb2xlcyI6WyJ2aWV3LWlkZW50aXR5LXByb3ZpZGVycyIsInZpZXctcmVhbG0iLCJtYW5hZ2UtaWRlbnRpdHktcHJvdmlkZXJzIiwiaW1wZXJzb25hdGlvbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfX0sInNjb3BlIjoib3BlbmlkIGVtYWlsIHByb2ZpbGUiLCJzaWQiOiJlZjRlMDk5Zi0xZjA4LTQ2NzAtOGZhNi0yYjhiNzhlMDVjMzEiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6ImFkbWluIn0.FK6DhVzpCRFmef2acD2Hmc149e1GTOCGz13dZA828crFbG8j4uhpkoNpiZqdyOPmDtMQ-OebNfjTAUaOt2sS1FmEIBgb9IddcpHKNJOquRjdzQNsX09bX8pFUq1haGwKh6_QmABNOBcT-kQNDSZO-aq7-8FoO9PYa0GWvBRcbcx0W_ngyb7xHglaZTElzcDPBcUTW6llVTTTFygn55smwdxTZ7-tEsMVGM5gNuHwJyLB51HI5KDWrwgUm1hqhhRzvcoutDEAB_HSEXGNNeF7fjP9Qx6q04b7fKOTtnIlXsu3oYW4va9y754llMSJ7w8U-y7yI6Tm2UdNMdYqju7hAA \\\n  -c admin-cli \\\n  --id=myservice-gatekeeper \\\n  --name=\"MyService Gatekeeper\" \\\n  --secret=changeme \\\n  --description=\"Client to be used by MyService Gatekeeper\" \\\n  --resource=\"Eric space\" --uris=/eric/* --users=eric \\\n  --resource=\"Alice space\" --uris=/alice/* --users=alice \\\n  --resource=\"Admin space\" --uris=/admin/* --roles=admin\n</code></pre></p> </li> </ol>"},{"location":"eoepca/identity-service/#using-identity-api","title":"Using Identity API","text":"<p>Also, an API was developed to interact more easily with the Keycloak API, that allows client, resource, policies and permissions management.</p> <p>The API documentation can be found in its Swagger UI at the service endpoint - https://identity-api.192-168-49-2.nip.io/docs.</p> <p>The Identity API is best used in combination with the <code>eoepca-portal</code> test aide, which can be used to establish a login sesssion in the browser to the benefit of the Identity API swagger UI. See section EOEPCA Portal for details regarding deployment/configuration of the <code>eoepca-portal</code>.</p>"},{"location":"eoepca/identity-service/#token-lifespans","title":"Token Lifespans","text":"<p>By default the Access Token Lifespan is 1 minute. With the current ADES (zoo-dru) implementation this presents a problem - since the <code>access_token</code> that is provided to the process execute request will (most likely) have expired by the time the ADES attempts to use the <code>access_token</code> in its call to the Workspace API to register the processing outputs. The lifespan of the token must outlive the duration of the processing execution - which we must assume can take a long time.</p> <p>To avoid this potential problem, the Keycloak Admin web console can be used to increase this token lifespan.</p> <p>Thus, the following settings are recommended to be updated following deployment\u2026</p> <ul> <li>SSO Session Settings /admin/master/console/#/master/realm-settings/sessions</li> <li>SSO Session Idle: <code>1 day</code></li> <li>SSO Session Max: <code>1 day</code></li> <li>Tokens /admin/master/console/#/master/realm-settings/tokens</li> <li>Access Token Lifespan: <code>1 day</code></li> </ul>"},{"location":"eoepca/identity-service/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the Identity Service can be found at:</p> <ul> <li>Helm Chart</li> <li>GitHub Repository</li> </ul>"},{"location":"eoepca/login-service/","title":"Login Service","text":"<p>The Login Service provides the platform Authorization Server for authenticated user identity and request authorization.</p>"},{"location":"eoepca/login-service/#helm-chart","title":"Helm Chart","text":"<p>The Login Service is deployed via the <code>login-service</code> helm chart from the EOEPCA Helm Chart Repository.</p> <p>The chart is configured via values that are fully documented in the README for the <code>login-service</code> chart.</p> <pre><code>helm install --version 1.2.8 --values login-service-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  login-service login-service\n</code></pre>"},{"location":"eoepca/login-service/#values","title":"Values","text":"<p>At minimum, values for the following attributes should be specified:</p> <ul> <li>Public hostname of the Authorization Server, e.g. <code>auth.192-168-49-2.nip.io</code></li> <li>IP Address of the public facing reverse proxy (Nginx Ingress Controller), e.g. <code>192.168.49.2</code></li> <li>Kubernetes <code>namespace</code> for the login-service components</li> <li>Initial password for the admin user Note that the password must meet the complexity: at least 6 characters and include one uppercase letter, one lowercase letter, one digit, and one special character</li> <li>Name of Persistent Volume Claim for <code>login-service</code> persistence, e.g. <code>eoepca-userman-pvc</code> The boolen value <code>volumeClaim.create</code> can be used for the PVC to be created by the helm release. This creates a volume of type <code>host-path</code> and, hence, is only useful for single-node development usage.</li> <li>TLS Certificate Provider, e.g. <code>letsencrypt-production</code></li> </ul> <p>Example <code>login-service-values.yaml</code>\u2026 <pre><code>global:\n  domain: auth.192-168-49-2.nip.io\n  nginxIp: 192.168.49.2\n  namespace: um\nvolumeClaim:\n  name: eoepca-userman-pvc\n  create: false\nconfig:\n  domain: auth.192-168-49-2.nip.io\n  adminPass: Chang3me!\n  ldapPass: Chang3me!\n  volumeClaim:\n    name: eoepca-userman-pvc\nopendj:\n  volumeClaim:\n    name: eoepca-userman-pvc\n  resources:\n    requests:\n      cpu: 100m\n      memory: 300Mi\noxauth:\n  volumeClaim:\n    name: eoepca-userman-pvc\n  resources:\n    requests:\n      cpu: 100m\n      memory: 1000Mi\noxtrust:\n  volumeClaim:\n    name: eoepca-userman-pvc\n  resources: \n    requests:\n      cpu: 100m\n      memory: 1500Mi\noxpassport:\n  resources:\n    requests:\n      cpu: 100m\n      memory: 100Mi\nnginx:\n  ingress:\n    annotations:\n      cert-manager.io/cluster-issuer: letsencrypt-production\n    hosts:\n      - auth.192-168-49-2.nip.io\n    tls:\n      - hosts:\n          - auth.192-168-49-2.nip.io\n        secretName: login-service-tls\n</code></pre></p> <p>Note</p> <p>The <code>resources:</code> above have been limited for the benefit of a minikube deployment. For a production deployment the values should be tuned (upwards) according to operational needs.</p>"},{"location":"eoepca/login-service/#post-deployment-manual-steps","title":"Post-deployment Manual Steps","text":"<p>The deployment of the Login Service has been designed, as far as possible, to automate the configuration. However, there remain some steps that must be performed manually after the scripted deployment has completed\u2026</p> <ul> <li>Configure <code>UMA Resource Lifetime</code></li> <li>Configure <code>Operator</code> user</li> </ul>"},{"location":"eoepca/login-service/#uma-resource-lifetime","title":"UMA Resource Lifetime","text":"<p>The Login Service maintains a background service that \u2018cleans\u2019 UMA resources that are older than aa certain age - by default 30 days (<code>2592000</code> secs). This lifetime does not fit the approach we are adopting, and so we must update this lifetime value to avoid the unexpected removal of UMA resources that would cause unexpected failures in policy enforcement.</p> <ul> <li>In a browser, navigate to the Login Service (Gluu) - <code>https://auth.192-168-49-2.nip.io/</code> - and login as the <code>admin</code> user</li> <li>Open <code>Configuration -&gt; JSON Configuration -&gt; OxAuth Configuration</code></li> <li>Search for the setting <code>umaResourceLifetime</code></li> <li>Update the values of <code>umaResourceLifetime</code> to <code>2147483647</code></li> <li>Select to <code>Save Configuration</code></li> <li>Restart the <code>oxauth</code> deployment\u2026 <pre><code>kubectl -n um rollout restart deploy/login-service-oxauth\n</code></pre></li> </ul>"},{"location":"eoepca/login-service/#configure-operator-user","title":"Configure <code>Operator</code> user","text":"<p>The default resource protection establishes policy in which \u2018operator\u2019 privilege is required for some services, such as the Workspace API. Thus, we need to configure a user with this privilege. For convenience we add this attribute to the built-in <code>admin</code> user - but alternatively you may choose to create a new user for this role.</p> <ul> <li>In a browser, navigate to the Login Service (Gluu) - <code>https://auth.192-168-49-2.nip.io/</code> - and login as the <code>admin</code> user</li> <li>Select <code>Users -&gt; Manage People</code> and search for user <code>admin</code></li> <li>For user <code>admin</code> select <code>Available User Claims -&gt; gluuCustomPerson</code></li> <li>Select <code>Is Operator</code> and ensure the value is set <code>True</code></li> <li>Select <code>Update</code> to confirm</li> </ul>"},{"location":"eoepca/login-service/#login-service-usage","title":"Login Service Usage","text":"<p>Once the deployment has been completed successfully, the Login Service is accessed at the endpoint <code>https://auth.192-168-49-2.nip.io/</code>, configured by your domain - e.g. https://auth.192-168-49-2.nip.io/.</p> <p>Login as the <code>admin</code> user with the credentials configured in the helm values - ref. <code>adminPass</code> / <code>ldapPass</code>.</p> <p>Typical first actions to undertake through the Gluu web interface include creation of users and clients.</p>"},{"location":"eoepca/login-service/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the Login Service can be found at:</p> <ul> <li>Helm Chart</li> <li>Wiki</li> <li>GitHub Repository</li> </ul>"},{"location":"eoepca/pdp/","title":"Policy Decision Point","text":"<p>The Policy Decision Point (PDP) provides the platform policy database and associated service for access policy decision requests.</p>"},{"location":"eoepca/pdp/#helm-chart","title":"Helm Chart","text":"<p>The PDP is deployed via the <code>pdp-engine</code> helm chart from the EOEPCA Helm Chart Repository.</p> <p>The chart is configured via values that are fully documented in the README for the <code>pdp-engine</code> chart.</p> <pre><code>helm install --version 1.1.12 --values pdp-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  pdp pdp-engine\n</code></pre>"},{"location":"eoepca/pdp/#values","title":"Values","text":"<p>At minimum, values for the following attributes should be specified:</p> <ul> <li>Public hostname of the Authorization Server, e.g. <code>auth.192-168-49-2.nip.io</code></li> <li>IP Address of the public facing reverse proxy (Nginx Ingress Controller), e.g. <code>192.168.49.2</code></li> <li>Name of Persistent Volume Claim for <code>pdp-engine</code> persistence, e.g. <code>eoepca-userman-pvc</code> The boolen value <code>volumeClaim.create</code> can be used for the PVC to be created by the helm release. This creates a volume of type <code>host-path</code> and, hence, is only useful for single-node development usage.</li> </ul> <p>Example <code>pdp-values.yaml</code>\u2026 <pre><code>global:\n  nginxIp: 192.168.49.2\n  domain: auth.192-168-49-2.nip.io\nvolumeClaim:\n  name: eoepca-userman-pvc\n  create: false\n</code></pre></p>"},{"location":"eoepca/pdp/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the PDP can be found at:</p> <ul> <li>Helm Chart</li> <li>Wiki</li> <li>GitHub Repository</li> </ul>"},{"location":"eoepca/persistence/","title":"Persistence","text":""},{"location":"eoepca/persistence/#overview","title":"Overview","text":"<p>The EOEPCA building-blocks rely upon Kubernetes <code>Persistent Volumes</code> for their component persistence. Components integrate with the storage provided in the cluster by means of configurable <code>Persistent Volume Claims</code> and/or dynamic <code>Storage Class</code> that are specfied as values at time of deployment. Some components require storage of type  <code>ReadWriteMany</code> - which, for a multi-node cluster, implies a network-based storage solution.</p> <p>Note</p> <p>Local CLuster Storage For the purposes of the Scripted Deployment, the default Storage Class included with the local Kubernetes distribution can be used for all storage concerns - e.g. <code>standard</code> for <code>minikube</code> which provides the <code>ReadWriteMany</code> persistence that is required by the ADES.</p>"},{"location":"eoepca/persistence/#readwritemany-storage","title":"ReadWriteMany Storage","text":"<p>For the EOEPCA development deployment, an NFS server has been established to provide the persistence layer for <code>ReadWriteMany</code> storage.</p>"},{"location":"eoepca/persistence/#pre-defined-persistent-volume-claims","title":"Pre-defined Persistent Volume Claims","text":"<p>The EOEPCA development deployment establishes the following pre-defined Persistent Volume Claims, to provide a simple storage architecture that is organised around the \u2018domain areas\u2019 into which the Reference Implementation is split.</p> <ul> <li>Resource Managment (<code>resman</code>) - <code>persistentvolumeclaim/eoepca-resman-pvc</code></li> <li>Processing &amp; Chaining (<code>proc</code>) - <code>persistentvolumeclaim/eoepca-proc-pvc</code></li> <li>User Management (<code>userman</code>) - <code>persistentvolumeclaim/eoepca-userman-pvc</code></li> </ul> <p>NOTE that this is offered only as an example thay suits the approach of the development team. Each building-block has configuration through which its persistence (PV/PVC) can be configured according the needs of the deployment.</p> <p>The following Kubernetes yaml provides an example of provisioning such domain-specific PersistentVolumeClaims within the cluster - in this case using the minikube built-in storage-class <code>standard</code> for dynamic provisioning\u2026</p> <pre><code>---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: eoepca-proc-pvc\n  namespace: proc\nspec:\n  accessModes:\n    - ReadWriteMany\n  storageClassName: standard\n  resources:\n    requests:\n      storage: 5Gi\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: eoepca-resman-pvc\n  namespace: rm\nspec:\n  accessModes:\n    - ReadWriteMany\n  storageClassName: standard\n  resources:\n    requests:\n      storage: 5Gi\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: eoepca-userman-pvc\n  namespace: um\nspec:\n  accessModes:\n    - ReadWriteMany\n  storageClassName: standard\n  resources:\n    requests:\n      storage: 5Gi\n</code></pre> <p>Once established, these PersistentVolumeClaims are then referenced within the deployment configurations of the building-blocks.</p>"},{"location":"eoepca/persistence/#dynamic-readwritemany-storage-provisioning","title":"Dynamic <code>ReadWriteMany</code> Storage Provisioning","text":"<p>In addition to the pre-defined PV/PVCs, the EOEPCA Reference Implementation also defines NFS-based storage classes for dynamic storage provisioning:</p> <ul> <li><code>managed-nfs-storage</code> With a <code>Reclaim Policy</code> of <code>Delete</code>.</li> <li><code>managed-nfs-storage-retain</code> With a <code>Reclaim Policy</code> of <code>Retain</code>.</li> </ul> <p>The building-blocks simply reference the required <code>Storage Class</code> in their volume specifications, to receive a <code>Persistent Volume Claim</code> that is dynamically provisioned at deployment time.</p> <p>This is acheived through the <code>nfs-provisioner</code> helm chart, with the following typical configurations\u2026</p> <p>Reclaim Policy <code>Delete</code>\u2026 <pre><code>provisionerName: nfs-storage\nstorageClass:\n  name: managed-nfs-storage\n  create: true\n  reclaimPolicy: Delete\n  archiveOnDelete: false\n  allowVolumeExpansion: true\nnfs:\n  server: \"&lt;your-nfs-ip-address-here&gt;\"\n  path: /data/dynamic  # your NFS server path here\n</code></pre></p> <p>Reclaim Policy <code>Retain</code>\u2026 <pre><code>provisionerName: nfs-storage-retain\nstorageClass:\n  name: managed-nfs-storage-retain\n  create: true\n  reclaimPolicy: Retain\n  allowVolumeExpansion: true\nnfs:\n  server: \"&lt;your-nfs-ip-address-here&gt;\"\n  path: /data/dynamic  # your NFS server path here\n</code></pre></p>"},{"location":"eoepca/persistence/#clustered-storage-solutions","title":"Clustered Storage Solutions","text":"<p>Clustered storage approaches offer an alternative to NFS. Clustered Storage provides a network-attached storage through a set of commodity hosts whose storage is aggregated to form a distributed file-system. Capacity is scaled by adding additional nodes or adding additional storage to the existing nodes. In the context of a multi-node Kubernetes cluster, then it is typical that the same commodity nodes provide both the cluster members and storage resources, i.e. the clustered storage is spread across the Kubernetes worker nodes.</p> <p>Candidate clustered storage solutions include:</p> <ul> <li>GlusterFS   GlusterFS is deployed as an operating system service across each node participating in the storage solution. Thus, with GlusterFS, the distributed storage nodes do not need to be one-and-the-same with the compute (cluster) nodes \u2013 although this may preferably be the case.</li> <li>Longhorn   Longhorn offers a solution that is similar to that of GlusterFS, except that Longhorn is \u2018cloud-native\u2019 in that its service layer deploys within the Kubernetes cluster itself. Thus, the storage nodes are also the cluster compute nodes by design.</li> </ul> <p>All things being equal, Longhorn is recommended as the best approach for Kubernetes clusters.</p>"},{"location":"eoepca/registration-api/","title":"Registration API","text":"<p>The Registration API provides a REST API through which resources can be registered with both the Resource Catalogue and (as applicable) with the Data Access services.</p>"},{"location":"eoepca/registration-api/#helm-chart","title":"Helm Chart","text":"<p>The Registration API is deployed via the <code>rm-registration-api</code> helm chart from the EOEPCA Helm Chart Repository.</p> <p>The chart is configured via values that are fully documented in the README for the <code>rm-registration-api</code> chart.</p> <pre><code>helm install --version 1.4.0 --values registration-api-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  registration-api rm-registration-api\n</code></pre>"},{"location":"eoepca/registration-api/#values","title":"Values","text":"<p>The Registration API supports many values to configure the service - as described in the Values section of the chart README.</p> <p>Typically, values for the following attributes may be specified:</p> <ul> <li>The fully-qualified public URL for the service</li> <li>(optional) Specification of Ingress for reverse-proxy access to the service Note that this is only required in the case that the Registration API will not be protected by the <code>identity-gatekeeper</code> component - ref. Resource Protection. Otherwise the ingress will be handled by the <code>identity-gatekeeper</code> - use <code>ingress.enabled: false</code>.</li> <li>Values for integration with the workspace-api and data-access services</li> </ul> <p>Example <code>registration-api-values.yaml</code>\u2026</p> <pre><code>fullnameOverride: registration-api\n\ningress:\n  enabled: false\n  hosts:\n    - host: registration-api-open.192-168-49-2.nip.io\n      paths: [\"/\"]\n  tls:\n    - hosts:\n        - registration-api-open.192-168-49-2.nip.io\n      secretName: registration-api-tls\n\n# some values for the workspace API\nworkspaceK8sNamespace: rm\nredisServiceName: \"data-access-redis-master\"\n</code></pre>"},{"location":"eoepca/registration-api/#protection","title":"Protection","text":"<p>As described in section Resource Protection (Keycloak), the <code>identity-gatekeeper</code> component can be inserted into the request path of the <code>registration-api</code> service to provide access authorization decisions</p>"},{"location":"eoepca/registration-api/#gatekeeper","title":"Gatekeeper","text":"<p>Gatekeeper is deployed using its helm chart\u2026</p> <pre><code>helm install registration-api-protection identity-gatekeeper -f registration-api-protection-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  --namespace \"rm\" --create-namespace \\\n  --version 1.0.12\n</code></pre> <p>The <code>identity-gatekeeper</code> must be configured with the values applicable to the <code>registration-api</code> - in particular the specific ingress requirements for the <code>registration-api</code> backend service\u2026</p> <p>Example <code>registration-api-protection-values.yaml</code>\u2026</p> <pre><code>fullnameOverride: registration-api-protection\nconfig:\n  client-id: registration-api\n  discovery-url: https://keycloak.192-168-49-2.nip.io/realms/master\n  cookie-domain: 192-168-49-2.nip.io\ntargetService:\n  host: registration-api.192-168-49-2.nip.io\n  name: registration-api\n  port:\n    number: 8080\nsecrets:\n  # Values for secret 'registration-api-protection'\n  # Note - if ommitted, these can instead be set by creating the secret independently.\n  clientSecret: \"changeme\"\n  encryptionKey: \"changemechangeme\"\ningress:\n  enabled: true\n  className: nginx\n  annotations:\n    ingress.kubernetes.io/ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n    cert-manager.io/cluster-issuer: letsencrypt-production\n    nginx.ingress.kubernetes.io/proxy-read-timeout: \"600\"\n    nginx.ingress.kubernetes.io/enable-cors: \"true\"\n  # open access\n  openUri:\n    - ^.*\n</code></pre>"},{"location":"eoepca/registration-api/#keycloak-client","title":"Keycloak Client","text":"<p>The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. <code>client-id: registration-api</code> above.</p> <p>This can be created with the <code>create-client</code> helper script, as descirbed in section Client Registration.</p> <p>For example\u2026</p> <pre><code>../bin/create-client \\\n  -a https://keycloak.192-168-49-2.nip.io \\\n  -i https://identity-api.192-168-49-2.nip.io \\\n  -r \"master\" \\\n  -u \"admin\" \\\n  -p \"changeme\" \\\n  -c \"admin-cli\" \\\n  --id=registration-api \\\n  --name=\"Registration API Gatekeeper\" \\\n  --secret=\"changeme\" \\\n  --description=\"Client to be used by Registration API Gatekeeper\"\n</code></pre>"},{"location":"eoepca/registration-api/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the Registration API can be found at:</p> <ul> <li>Helm Chart</li> <li>GitHub Repository</li> </ul>"},{"location":"eoepca/resource-catalogue/","title":"Resource Catalogue","text":"<p>The Resource Catalogue provides a standards-based EO metadata catalogue that includes support for OGC CSW / API Records, STAC and OpenSearch.</p>"},{"location":"eoepca/resource-catalogue/#helm-chart","title":"Helm Chart","text":"<p>The Resource Catalogue is deployed via the <code>rm-resource-catalogue</code> helm chart from the EOEPCA Helm Chart Repository.</p> <p>The chart is configured via values that are fully documented in the README for the <code>rm-resource-catalogue</code> chart.</p> <pre><code>helm install --version 1.4.0 --values resource-catalogue-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  resource-catalogue rm-resource-catalogue\n</code></pre>"},{"location":"eoepca/resource-catalogue/#values","title":"Values","text":"<p>The Resource Catalogue supports many values to configure the service - as described in the Values section of the chart README.</p> <p>Typically, values for the following attributes may be specified:</p> <ul> <li>The fully-qualified public URL for the service</li> <li>Dynamic provisioning StorageClass for database persistence</li> <li>(optional) Specification of Ingress for reverse-proxy access to the service Note that this is only required in the case that the Resource Catalogue will not be protected by the <code>identity-gatekeeper</code> component - ref. Resource Protection. Otherwise the ingress will be handled by the <code>identity-gatekeeper</code> - use <code>ingress.enabled: false</code>.</li> <li>Metadata describing the Catalogue instance</li> <li>Tuning configuration for PostgreSQL - see values <code>db.config.XXX</code>.</li> </ul> <p>Example <code>resource-catalogue-values.yaml</code>\u2026</p> <pre><code>global:\n  namespace: rm\n# For protected access disable this ingress, and rely upon the identity-gatekeeper\n# for ingress with protection.\ningress:\n  # Enabled for unprotected 'open' access to the resource-catalogue.\n  enabled: true\n  name: resource-catalogue\n  host: resource-catalogue.192-168-49-2.nip.io\n  tls_host: resource-catalogue.192-168-49-2.nip.io\n  tls_secret_name: resource-catalogue-tls\n  annotations:\n    cert-manager.io/cluster-issuer: letsencrypt-production\ndb:\n  volume_storage_type: standard\n  # config:\n  #   enabled: true\n  #   shared_buffers: 2GB\n  #   effective_cache_size: 6GB\n  #   maintenance_work_mem: 512MB\n  #   checkpoint_completion_target: 0.9\n  #   wal_buffers: 16MB\n  #   default_statistics_target: 100\n  #   random_page_cost: 4\n  #   work_mem: 4MB\n  #   cpu_tuple_cost: 0.4\npycsw:\n  config:\n    server:\n      url: https://resource-catalogue.192-168-49-2.nip.io/\n    manager:\n      transactions: \"true\"\n      allowed_ips: \"*\"\n</code></pre> <p>Note</p> <p>The above example values enable transactions (write-access) to the catalogue from any IP address. This is convenient for testing/demonstration of the capability, but should be disbaled or restricted for operational deployments.</p>"},{"location":"eoepca/resource-catalogue/#protection","title":"Protection","text":"<p>As described in section Resource Protection (Keycloak), the <code>identity-gatekeeper</code> component can be inserted into the request path of the <code>resource-catalogue</code> service to provide access authorization decisions</p>"},{"location":"eoepca/resource-catalogue/#gatekeeper","title":"Gatekeeper","text":"<p>Gatekeeper is deployed using its helm chart\u2026</p> <pre><code>helm install resource-catalogue-protection identity-gatekeeper -f resource-catalogue-protection-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  --namespace \"rm\" --create-namespace \\\n  --version 1.0.12\n</code></pre> <p>The <code>identity-gatekeeper</code> must be configured with the values applicable to the <code>resource-catalogue</code> - in particular the specific ingress requirements for the <code>resource-catalogue-service</code>\u2026</p> <p>Example <code>resource-catalogue-protection-values.yaml</code>\u2026</p> <pre><code>fullnameOverride: resource-catalogue-protection\nconfig:\n  client-id: resource-catalogue\n  discovery-url: https://keycloak.192-168-49-2.nip.io/realms/master\n  cookie-domain: 192-168-49-2.nip.io\ntargetService:\n  host: resource-catalogue.192-168-49-2.nip.io\n  name: resource-catalogue-service\n  port:\n    number: 80\nsecrets:\n  # Values for secret 'resource-catalogue-protection'\n  # Note - if ommitted, these can instead be set by creating the secret independently.\n  clientSecret: \"changeme\"\n  encryptionKey: \"changemechangeme\"\ningress:\n  enabled: true\n  className: nginx\n  annotations:\n    ingress.kubernetes.io/ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n    cert-manager.io/cluster-issuer: letsencrypt-production\n    nginx.ingress.kubernetes.io/proxy-read-timeout: \"600\"\n    nginx.ingress.kubernetes.io/enable-cors: \"true\"\n  # open access\n  openUri:\n    - ^.*\n</code></pre>"},{"location":"eoepca/resource-catalogue/#keycloak-client","title":"Keycloak Client","text":"<p>The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. <code>client-id: resource-catalogue</code> above.</p> <p>This can be created with the <code>create-client</code> helper script, as descirbed in section Client Registration.</p> <p>For example\u2026</p> <pre><code>../bin/create-client \\\n  -a https://keycloak.192-168-49-2.nip.io \\\n  -i https://identity-api.192-168-49-2.nip.io \\\n  -r \"master\" \\\n  -u \"admin\" \\\n  -p \"changeme\" \\\n  -c \"admin-cli\" \\\n  --id=resource-catalogue \\\n  --name=\"Resource Catalogue Gatekeeper\" \\\n  --secret=\"changeme\" \\\n  --description=\"Client to be used by Resource Catalogue Gatekeeper\"\n</code></pre>"},{"location":"eoepca/resource-catalogue/#resource-catalogue-usage","title":"Resource Catalogue Usage","text":"<p>The Resource Catalogue is initially populated during the initialisation of the Data Access service. See section Data-layer Configuration.</p> <p>The Resource Catalogue is accessed at the endpoint <code>https://resource-catalogue.192-168-49-2.nip.io/</code>, configured by your domain - e.g. https://resource-catalogue.192-168-49-2.nip.io/.</p>"},{"location":"eoepca/resource-catalogue/#loading-records","title":"Loading Records","text":"<p>As described in the pycsw documentation, ISO XML records can be loaded into the resource-catalogue using the <code>pycsw-admin.py</code> admin utility\u2026</p> <pre><code>pycsw-admin.py load_records -c /path/to/cfg -p /path/to/records\n</code></pre> <p>The <code>/path/to/records</code> can either be a single metadata file, or a directory containing multiple metadata files.</p> <p>This is most easily achieved via connection to the pycsw pod, which includes the <code>pycsw-admin.py</code> utility and the pycsw configuration file at <code>/etc/pycsw/pycsw.cfg</code>\u2026</p> <pre><code>kubectl -n rm cp \"&lt;metadata-file-or-directory&gt;\" \"&lt;pycsw-pod-name&gt;\":/tmp/metadata\nkubectl -n rm exec -i \"&lt;pycsw-pod-name&gt;\" -- pycsw-admin.py load-records -c /etc/pycsw/pycsw.cfg -p /tmp/metadata\n</code></pre> <p>The name of the pycsw pod can be obtained using <code>kubectl</code>\u2026</p> <pre><code>kubectl -n rm get pod --selector='io.kompose.service=pycsw' --output=jsonpath={.items[0].metadata.name}\n</code></pre> <p>To facilitate the loading of records via the pycsw pod, a helper script <code>load-records</code> has been provided in the git repository that hosts this document\u2026</p> <pre><code>git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide\ncd deployment-guide\n./deploy/bin/load-records \"&lt;metadata-file-or-directory&gt;\"\n</code></pre> <p>The helper script identifies the pycsw pod, copies the metadata files to the pod, and runs <code>pycsw-admin.py load-records</code> within the pod to load the records.</p>"},{"location":"eoepca/resource-catalogue/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the Resource Catalogue can be found at:</p> <ul> <li>Helm Chart</li> <li>pycsw Documentation</li> <li>GitHub Repository</li> </ul>"},{"location":"eoepca/resource-protection-gluu/","title":"Resource Protection (Gluu)","text":"<p>EOEPCA defines Building Blocks within a micro-service architecture. The services are subject to protection within an Identity and Access Management (IAM) approach that includes:</p> <ul> <li>Login Service (Authorization Server)</li> <li>Policy Decision Point (PDP)</li> <li>Policy Enforcement Point (PEP)</li> </ul> <p>Building Blocks that act as a Resource Server are individually protected by a Policy Enforcement Point (PEP). The PEP enforces the authorization decision in collaboration with the Login Service and Policy Decision Point (PDP).</p> <p>The PEP expects to interface to a client (user agent, e.g. browser) using User Managed Access (UMA) flows. It is not typical for a client to support UMA flows, and so the PEP can be deployed with a companion UMA User Agent component that interfaces between the client and the PEP, and performs the UMA Flow on behalf of the client.</p> <p>The Resource Guard is a \u2018convenience\u2019 component that deploys the PEP &amp; UMA User Agent as a cooperating pair.</p> <p>The Resource Guard \u2018inserts itself\u2019 into the request path of the target Resource Server using the <code>auth_request</code> facility offered by Nginx. Thus, the Resource Guard deploys with an Ingress specification that:</p> <ul> <li>Configures the <code>auth_request</code> module to defer access authorization to the <code>uma-user-agent</code> service</li> <li>Configures the ingress rules (host/path) for the target Resource Server</li> </ul>"},{"location":"eoepca/resource-protection-gluu/#helm-chart","title":"Helm Chart","text":"<p>The Resource Guard is deployed via the <code>resource-guard</code> helm chart from the EOEPCA Helm Chart Repository.</p> <p>The chart is configured via values that are fully documented in the README for the <code>resource-guard</code> chart.</p> <p>It is expected to deploy multiple instances of the Resource Guard chart, one for each Resource Server to be protected.</p> <pre><code>helm install --version 1.3.1 --values myservice-guard-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  myservice-guard resource-guard\n</code></pre>"},{"location":"eoepca/resource-protection-gluu/#values","title":"Values","text":"<p>The helm chart is deployed with values that are passed through to the subcharts for the <code>pep-engine</code> and <code>uma-user-agent</code>. Typical values to be specified include:</p> <ul> <li>Host/domain details for the Login Service and PDP, e.g. <code>auth.192-168-49-2.nip.io</code></li> <li>IP Address of the public facing reverse proxy (Nginx Ingress Controller), e.g. <code>192.168.49.2</code></li> <li>Name of Persistent Volume Claim for <code>pep-engine</code> persistence, e.g. <code>myservice-pep-pvc</code></li> <li>TLS Certificate Provider, e.g. <code>letsencrypt-production</code></li> <li>Optional specification of default resources with which to initialise the policy database for the component</li> <li>Ingress rules definition for reverse-proxy to the target Resource Server</li> <li>Name of <code>Secret</code> that contains the client credentials used by the <code>uma-user-agent</code> to interface with the Login Service. See section Client Secret below</li> </ul> <p>Example <code>myservice-guard-values.yaml</code>\u2026 <pre><code>#---------------------------------------------------------------------------\n# Global values\n#---------------------------------------------------------------------------\nglobal:\n  context: myservice\n  domain: 192-168-49-2.nip.io\n  nginxIp: 192.168.49.2\n  certManager:\n    clusterIssuer: letsencrypt-production\n#---------------------------------------------------------------------------\n# PEP values\n#---------------------------------------------------------------------------\npep-engine:\n  configMap:\n    asHostname: auth\n    pdpHostname: auth\n  customDefaultResources:\n  - name: \"Eric's space\"\n    description: \"Protected Access for eric to his space in myservice\"\n    resource_uri: \"/ericspace\"\n    scopes: []\n    default_owner: \"d3688daa-385d-45b0-8e04-2062e3e2cd86\"\n  volumeClaim:\n    name: myservice-pep-pvc\n    create: false\n#---------------------------------------------------------------------------\n# UMA User Agent values\n#---------------------------------------------------------------------------\numa-user-agent:\n  nginxIntegration:\n    enabled: true\n    hosts:\n      - host: myservice\n        paths:\n          - path: /(.*)\n            service:\n              name: myservice\n              port: 80\n          - path: /(doc.*)\n            service:\n              name: myservice-docs\n              port: 80\n    annotations:\n      nginx.ingress.kubernetes.io/proxy-read-timeout: \"600\"\n      nginx.ingress.kubernetes.io/enable-cors: \"true\"\n      nginx.ingress.kubernetes.io/rewrite-target: /$1\n  client:\n    credentialsSecretName: \"myservice-agent\"\n  logging:\n    level: \"debug\"\n  unauthorizedResponse: 'Bearer realm=\"https://portal.192-168-49-2.nip.io/oidc/authenticate/\"'\n#---------------------------------------------------------------------------\n# END values\n#---------------------------------------------------------------------------\n</code></pre></p>"},{"location":"eoepca/resource-protection-gluu/#client-credentials","title":"Client Credentials","text":"<p>The <code>uma-user-agent</code> requires Client Credentials for its interactions with the <code>login-service</code>. The <code>uma-user-agent</code> expects to read these credentials from the file <code>client.yaml</code>, in the form\u2026</p> <pre><code>client-id: &lt;my-client-id&gt;\nclient-secret: &lt;my-secret&gt;\n</code></pre>"},{"location":"eoepca/resource-protection-gluu/#client-registration","title":"Client Registration","text":"<p>To obtain the Client Credentials required by the <code>uma-user-agent</code> it is necessary to register a client with the <code>login-service</code>, or use the credentials for an existing client.</p> <p>A helper script is provided to register a basic client and obtain the required credentials. The script is available in the <code>deployment-guide</code> repository, and can be obtained as follows\u2026</p> <pre><code>git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide\ncd deployment-guide\n</code></pre> <p>The <code>register-client</code> helper script requires some command-line arguments\u2026</p> <pre><code>Usage:\n  register_client &lt;authorization-server-hostname&gt; &lt;client-name&gt; [&lt;redirect-uri&gt; [&lt;logout-uri&gt;]]\n</code></pre> <p>For example\u2026</p> <pre><code>./deploy/bin/register-client auth.192-168-49-2.nip.io myclient\n\nINFO: Preparing docker image... [done]\nClient successfully registered.\nMake a note of the credentials:\nclient-id: a98ba66e-e876-46e1-8619-5e130a38d1a4\nclient-secret: 73914cfc-c7dd-4b54-8807-ce17c3645558\n</code></pre> <p>Or to register OIDC redirect URLs\u2026 <pre><code>./deploy/bin/register-client auth.192-168-49-2.nip.io myclient https://portal.192-168-49-2.nip.io/oidc/callback/ https://portal.192-168-49-2.nip.io/logout\n</code></pre></p> <p>The script writes the \u2018client credentials\u2019 to stdout - in the expected YAML configuration file format - which can be redirected to file\u2026 <pre><code>./deploy/bin/register-client auth.192-168-49-2.nip.io myclient | tee client.yaml\n</code></pre> \u2026writes the client credentials to the file <code>client.yaml</code>.</p> <p>NOTE that the <code>register-client</code> helper relies upon <code>docker</code> to build and run the script.</p>"},{"location":"eoepca/resource-protection-gluu/#client-secret","title":"Client Secret","text":"<p>The <code>client.yaml</code> configuration file is made available via a Kubernetes Secret\u2026</p> <pre><code>kubectl -n myservice-ns create secret generic myservice-agent \\\n  --from-file=client.yaml \\\n  --dry-run=client -o yaml \\\n  &gt; myservice-agent-secret.yaml\n</code></pre> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: myservice-agent\n  namespace: myservice-ns\ndata:\n  client.yaml: Y2xpZW50LWlkOiBhOThiYTY2ZS1lODc2LTQ2ZTEtODYxOS01ZTEzMGEzOGQxYTQKY2xpZW50LXNlY3JldDogNzM5MTRjZmMtYzdkZC00YjU0LTg4MDctY2UxN2MzNjQ1NTU4\n</code></pre> <p>The <code>resource-guard</code> deployment is configured with the name of the <code>Secret</code> through the helm chart value <code>client.credentialsSecretName</code>.</p>"},{"location":"eoepca/resource-protection-gluu/#user-id-token","title":"User ID Token","text":"<p>As described in the README for the Resource Guard, it is necessary for a request to a protected resource to provide the User ID Token in the request header.</p>"},{"location":"eoepca/resource-protection-gluu/#obtaining-the-user-id-token","title":"Obtaining the User ID Token","text":"<p>In the simple case of a user with username/password held within the Login Service, the User ID Token can be obtained as follows:</p> <pre><code>curl --location --request POST 'https://auth.192-168-49-2.nip.io/oxauth/restv1/token' \\\n--header 'Cache-Control: no-cache' \\\n--header 'Content-Type: application/x-www-form-urlencoded' \\\n--data-urlencode 'scope=openid user_name is_operator' \\\n--data-urlencode 'grant_type=password' \\\n--data-urlencode 'username=&lt;username&gt;' \\\n--data-urlencode 'password=&lt;password&gt;' \\\n--data-urlencode 'client_id=&lt;client-id&gt;' \\\n--data-urlencode 'client_secret=&lt;client-password&gt;'\n</code></pre> <p>The User ID Token is included in the <code>id_token</code> field of the json response.</p> <p>Alternatively, OAuth/OIDC flows can be followed to authenticate via external identity providers.</p>"},{"location":"eoepca/resource-protection-gluu/#user-id-token-in-http-requests","title":"User ID Token in HTTP requests","text":"<p>The Resource Guard protection supports presentation of the User ID Token via the following HTTP request headers (in order of priority)\u2026</p> <ul> <li><code>Authorization</code> header as a bearer token - in the form: <code>Authorization: Bearer &lt;token&gt;</code></li> <li><code>X-User-Id</code> header</li> <li><code>Cookie: auth_user_id=&lt;token&gt;</code> <p>Note that the name of the cookie is configurable</p> </li> </ul>"},{"location":"eoepca/resource-protection-gluu/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the Resource Guard can be found at:</p> <ul> <li>Helm Chart</li> <li>README</li> <li>GitHub Repository:<ul> <li>pep-engine</li> <li>uma-user-agent</li> </ul> </li> </ul>"},{"location":"eoepca/resource-protection-keycloak/","title":"Resource Protection (Keycloak)","text":"<p>EOEPCA defines Building Blocks within a micro-service architecture. The services are subject to protection within an Identity and Access Management (IAM) approach that includes:</p> <ul> <li>Keycloak - Identity Service (Authorization Server)</li> <li>Gatekeeper - Policy Enforcement</li> </ul> <p>Building Blocks that act as a Resource Server are individually protected by a dedicated Gatekeeper instance that enforces the authorization decision in collaboration with the Identity Service (Keycloak).</p> <p>Gatekeeper \u2018inserts itself\u2019 into the request path of the target Resource Server using the <code>auth_request</code> facility offered by Nginx. Thus, Gatekeeper deploys with an Ingress specification that:</p> <ul> <li>Configures the <code>auth_request</code> module to defer access authorization to the <code>gatekeeper</code> service</li> <li>Configures the ingress rules (host/path) for the target Resource Server</li> </ul>"},{"location":"eoepca/resource-protection-keycloak/#helm-chart","title":"Helm Chart","text":"<p>Each Gatekeeper is deployed via the <code>identity-gatekeeper</code> helm chart from the EOEPCA Helm Chart Repository.</p> <p>The chart is configured via values - the full set of available values can be seen at https://github.com/EOEPCA/helm-charts/blob/main/charts/application-hub/values.yaml.</p> <p>It is expected to deploy multiple instances of the <code>Gatekeeper</code> chart, one for each Resource Server to be protected.</p> <pre><code>helm install --version 1.0.12 --values myservice-gatekeeper-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  myservice-protection identity-gatekeeper\n</code></pre>"},{"location":"eoepca/resource-protection-keycloak/#values","title":"Values","text":"<p>The helm chart is deployed with values that customise the service for the specific needs of the resource-server under protection and the deployment target platform. Typical values to be specified include:</p> <ul> <li>Host/domain details for the Keycloak Identity Service, e.g. <code>keycloak.192-168-49-2.nip.io</code></li> <li>Credentials for the Keycloak client to be used by Gatekeeper (ideally via secret)</li> <li>TLS Certificate Provider, e.g. <code>letsencrypt-production</code></li> <li>Ingress rules definition for reverse-proxy to the target Resource Server</li> </ul> <p>Example <code>myservice-protection-values.yaml</code>\u2026 <pre><code>nameOverride: myservice-protection\nconfig:\n  client-id: myservice\n  discovery-url: https://keycloak.192-168-49-2.nip.io/realms/master\n  cookie-domain: 192-168-49-2.nip.io\ntargetService:\n  host: myservice.192-168-49-2.nip.io\n  name: myservice\n  port:\n    number: 80\nsecrets:\n  # Values for secret 'myservice-protection'\n  # Note - if ommitted, these can instead be set by creating the secret independently.\n  clientSecret: \"changeme\"\n  encryptionKey: \"changemechangeme\"\ningress:\n  enabled: true\n  className: nginx\n  annotations:\n    ingress.kubernetes.io/ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n    cert-manager.io/cluster-issuer: letsencrypt-production\n  # Open access to some endpoints, including Swagger UI\n  openUri:\n    - ^/(docs|openapi.json|probe)\n</code></pre></p>"},{"location":"eoepca/resource-protection-keycloak/#client-credentials","title":"Client Credentials","text":"<p>Gatekeeper requires Client Credentials for its interactions with the Keycloak <code>identity-service</code>. These credentials must be supplied by the secret named <code>&lt;myservice&gt;-protection</code>. The secret can be created directly by the helm chart - via the values <code>secrets.clientSecret</code> and <code>secrets.encryptionKey</code> - or perhaps more securely the secret can be created independently (e.g. via a <code>SealedSecret</code>).</p>"},{"location":"eoepca/resource-protection-keycloak/#client-registration","title":"Client Registration","text":"<p>The Keycloak client can be created directly in the Keycloak admin console - e.g. via https://keycloak.192-168-49-2.nip.io/admin.</p> <p>As an aide there is a helper script <code>create-client</code>. The script is available in the <code>deployment-guide</code> repository, and can be obtained as follows\u2026</p> <pre><code>git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide\ncd deployment-guide\n</code></pre> <p>The <code>create-client</code> helper script requires some command-line arguments\u2026</p> <pre><code>$ ./deploy/bin/create-client -h\n\nAdd a client with protected resources.\ncreate-client [-h] [-a] [-i] [-u] [-p] [-c] [-s] [-t | --token t] [-r] --id id [--name name] (--secret secret | --public) [--default] [--authenticated] [--resource name] [--uris u1,u2] [--scopes s1,s2] [--users u1,u2] [--roles r1,r2]\n\nwhere:\n    -h                    show help message\n    -a                    authorization server url - e.g. https://keycloak.192-168-49-2.nip.io\n    -i                    identity-api server url - e.g. https://identity-api.192-168-49-2.nip.io\n    -u                    username used for authentication\n    -p                    password used for authentication\n    -c                    client id (of the bootstrap client used in the create request)\n    -s                    client secret (of the bootstrap client used in the create request)\n    -t or --token         access token used for authentication\n    -r                    realm\n    --id                  client id (of the created client)\n    --name                client name (of the created client)\n    --secret              client secret (of the created client)\n    --public              public client (no client secret)\n    --default             add default resource - /* authenticated\n    --authenticated       allow access to the resource only when authenticated\n    --resource            resource name\n    --uris                resource uris - separated by comma (,)\n    --scopes              resource scopes - separated by comma (,)\n    --users               user names with access to the resource - separated by comma (,)\n    --roles               role names with access to the resource - separated by comma (,)\n</code></pre> <p>For example\u2026</p> <pre><code>./deploy/bin/create-client \\\n  -a https://keycloak.192-168-49-2.nip.io \\\n  -i https://identity-api.192-168-49-2.nip.io \\\n  -r \"master\" \\\n  -u \"admin\" \\\n  -p \"changeme\" \\\n  -c \"admin-cli\" \\\n  --id=myservice \\\n  --name=\"Gatekeeper for myservice\" \\\n  --secret=\"changeme\" \\\n  --description=\"Client to be used by Gatekeeper for myservice\" \\\n  --resource=\"eric\" --uris='/eric/*' --scopes=view --users=\"eric\" \\\n  --resource=\"bob\" --uris='/bob/*' --scopes=view --users=\"bob\" \\\n  --resource=\"alice\" --uris='/alice/*' --scopes=view --users=\"alice\"\n</code></pre>"},{"location":"eoepca/resource-protection-keycloak/#user-tokens","title":"User Tokens","text":"<p>Requests to resource server endpoints that are protected by Gatekeeper must carry an Access Token that has been obtained on behalf of the requesting user. The <code>access_token</code> is carried in the request header\u2026</p> <pre><code>Authorization: Bearer &lt;access_token&gt;\n</code></pre> <p>The Access Token for a given user  can be obtained with a call to the token endpoint of the Keycloak Identity Service - supplying the credentials for the user and the pre-registered client\u2026</p> <pre><code>curl -L -X POST 'https://keycloak.192-168-49-2.nip.io/realms/master/protocol/openid-connect/token' \\\n  -H 'Cache-Control: no-cache' \\\n  -H 'Content-Type: application/x-www-form-urlencoded' \\\n  --data-urlencode 'scope=openid profile email' \\\n  --data-urlencode 'grant_type=password' \\\n  --data-urlencode 'username=&lt;username&gt;' \\\n  --data-urlencode 'password=&lt;password&gt;' \\\n  --data-urlencode 'client_id=admin-cli'\n</code></pre> <p>A json response is returned, in which the field <code>access_token</code> provides the Access Token for the specified <code>&lt;username&gt;</code>.</p>"},{"location":"eoepca/resource-protection-keycloak/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the Gatekeeper can be found at:</p> <ul> <li>Container Image</li> <li>Helm Chart</li> <li>GitHub Repository</li> </ul>"},{"location":"eoepca/user-profile/","title":"User Profile","text":"<p>The User Profile represents the user\u2019s \u2018account\u2019 within the platform.</p>"},{"location":"eoepca/user-profile/#helm-chart","title":"Helm Chart","text":"<p>The User Profile is deployed via the <code>user-profile</code> helm chart from the EOEPCA Helm Chart Repository.</p> <p>The chart is configured via values that are fully documented in the README for the <code>user-profile</code> chart.</p> <pre><code>helm install --version 1.1.12 --values user-profile-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  user-profile user-profile\n</code></pre>"},{"location":"eoepca/user-profile/#values","title":"Values","text":"<p>At minimum, values for the following attributes should be specified:</p> <ul> <li>Public hostname of the Authorization Server, e.g. <code>auth.192-168-49-2.nip.io</code></li> <li>IP Address of the public facing reverse proxy (Nginx Ingress Controller), e.g. <code>192.168.49.2</code></li> <li>Name of Persistent Volume Claim for <code>user-profile</code> persistence, e.g. <code>eoepca-userman-pvc</code> The boolen value <code>volumeClaim.create</code> can be used for the PVC to be created by the helm release. This creates a volume of type <code>host-path</code> and, hence, is only useful for single-node development usage.</li> </ul> <p>Example <code>user-profile-values.yaml</code>\u2026 <pre><code>global:\n  domain: auth.192-168-49-2.nip.io\n  nginxIp: 192.168.49.2\nvolumeClaim:\n  name: eoepca-userman-pvc\n  create: false\n</code></pre></p>"},{"location":"eoepca/user-profile/#user-profile-usage","title":"User Profile Usage","text":"<p>The User Profile is accessed through the <code>/web_ui</code> path of the Login Service, e.g. http://auth.kube.guide.eoepca.org/web_ui.</p>"},{"location":"eoepca/user-profile/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the User Profile can be found at:</p> <ul> <li>Helm Chart</li> <li>Wiki</li> <li>GitHub Repository</li> </ul>"},{"location":"eoepca/workspace/","title":"Workspace","text":"<p>The Workspace provides protected user resource management that includes dedicated storage and services for resource discovery and access.</p>"},{"location":"eoepca/workspace/#workspace-api","title":"Workspace API","text":"<p>The Workspace API provides a REST service through which user workspaces can be created, interrogated, managed and deleted.</p>"},{"location":"eoepca/workspace/#helm-chart","title":"Helm Chart","text":"<p>The Workspace API is deployed via the <code>rm-workspace-api</code> helm chart from the EOEPCA Helm Chart Repository.</p> <p>The chart is configured via values that are fully documented in the README for the <code>um-workspace-api</code> chart.</p> <pre><code>helm install --version 1.4.2 --values workspace-api-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  workspace-api rm-workspace-api\n</code></pre>"},{"location":"eoepca/workspace/#values","title":"Values","text":"<p>At minimum, values for the following attributes should be specified:</p> <ul> <li>The fully-qualified public URL for the service</li> <li>(optional) Specification of Ingress for reverse-proxy access to the service Note that this is only required in the case that the Workspace API will not be protected by the <code>identity-gatekeeper</code> component - ref. Resource Protection. Otherwise the ingress will be handled by the <code>identity-gatekeeper</code> - use <code>ingress.enabled: false</code>.</li> <li>Prefix for user projects in OpenStack</li> <li>Details for underlying S3 object storage service</li> <li>Identification of secret that provides the client credentials for resource protection</li> <li>Whether flux components should be installed - otherwise they must already be present - Flux Dependency</li> <li>Name of the ConfigMap for user workspace templates - See User Workspace Templates</li> </ul> <p>Example <code>workspace-api-values.yaml</code>\u2026 <pre><code>fullnameOverride: workspace-api\ningress:\n  enabled: true\n  annotations:\n    cert-manager.io/cluster-issuer: letsencrypt-production\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/enable-cors: \"true\"\n    nginx.ingress.kubernetes.io/proxy-read-timeout: \"600\"\n  hosts:\n    - host: workspace-api-open.192-168-49-2.nip.io\n      paths: [\"/\"]\n  tls:\n    - hosts:\n        - workspace-api-open.192-168-49-2.nip.io\n      secretName: workspace-api-open-tls\nfluxHelmOperator:\n  enabled: true\nprefixForName: \"ws\"\nworkspaceSecretName: \"bucket\"\nnamespaceForBucketResource: \"rm\"\ns3Endpoint: \"https://minio.192-168-49-2.nip.io\"\ns3Region: \"RegionOne\"\nharborUrl: \"https://harbor.192-168-49-2.nip.io\"\nharborUsername: \"admin\"\nharborPasswordSecretName: \"harbor\"\nworkspaceChartsConfigMap: \"workspace-charts\"\nbucketEndpointUrl: \"http://minio-bucket-api:8080/bucket\"\nkeycloakIntegration:\n  enabled: true\n  keycloakUrl: \"https://keycloak.192-168-49-2.nip.io\"\n  realm: \"master\"\n  identityApiUrl: \"https://identity-api.192-168-49-2.nip.io\"\n  workspaceApiIamClientId: \"workspace-api\"\n  defaultIamClientSecret: \"changeme\"\n</code></pre></p> <p>Note</p> <ul> <li>The Workspace API assumes a deployment of the Harbor Container Regsitry, as configured by the <code>harborXXX</code> values above.See section Container Registry.</li> <li>The password for the harbor <code>admin</code> user must be created as described in the section Harbor <code>admin</code> Password.</li> <li>The <code>keycloakIntegration</code> allows the Workspace API to apply protecion (for the specified workspace owner) to the services within newly created workspaces.</li> <li>The workspace-api initiates the creation of a storage \u2018bucket\u2019 for each workspace - the actual bucket creation being abstracted via a webhook - the URL of which is specified in the value <code>bucketEndpointUrl</code>. See section Bucket Creation Webhook for details.</li> </ul>"},{"location":"eoepca/workspace/#harbor-admin-password","title":"Harbor <code>admin</code> Password","text":"<p>The password for the harbor <code>admin</code> user is provided to the workspace-api via the specified secret - defined as <code>harbor</code> above.</p> <p>This secret must be created - for example as follows\u2026</p> <pre><code>kubectl -n rm create secret generic harbor \\\n  --from-literal=HARBOR_ADMIN_PASSWORD=\"changeme\"\n</code></pre>"},{"location":"eoepca/workspace/#flux-dependency","title":"Flux Dependency","text":"<p>Workspaces are created by instantiating the <code>rm-user-workspace</code> helm chart for each user/group. The Workspace API uses Flux CD as a helper to manage these subordinate helm charts - via flux resources of type <code>HelmRelease</code>. Thus, it is necessary to deploy within the cluster the aspects of flux that support this helm chart management - namely the flux <code>helm-controller</code>, <code>source-controller</code> and the Kubernetes Custom Resource Definitions (CRD) for <code>HelmRelease</code> and <code>HelmRepository</code>.</p> <p>In case you are not already using flux within your clsuter, then the Workspace API helm chart can be configured to deploy the required flux components\u2026 <pre><code>fluxHelmOperator:\n  enabled: true  # true = install flux for me, false = I already have flux\n</code></pre></p>"},{"location":"eoepca/workspace/#user-workspace-templates","title":"User Workspace Templates","text":"<p>The Workspace API instantiates for each user a set of services, including a Resource Catalogue and Data Access services. These user services are instantiated via helm using templates. The templates are provided to the Workspace API in a <code>ConfigMap</code> that is, by default, named <code>workspace-charts</code>. Each file in the config-map is expected to be of <code>kind</code> <code>HelmRelease</code>. During creation of a new workspace, the Worksapce API applies each file to the cluster in the namespace of the newly created namespace.</p> <p>The default ConfigMap that is included with this guide contains the following templates for instantiation of user-specific components:</p> <ul> <li>Data Access: <code>template-hr-data-access.yaml</code></li> <li>Resource Catalogue: <code>template-hr-resource-catalogue.yaml</code></li> <li>Protection: <code>template-hr-resource-protection.yaml</code></li> </ul> <p>Each of these templates is expressed as a flux <code>HelmRelease</code> object that describes the helm chart and values required to deploy the service.</p> <p>In addition, ConfigMap templates are included that provide specific details required to access the user-scoped workspace resources, including access to S3 object storage and container registry:</p> <ul> <li>S3 client configuration: <code>template-cm-aws-config.yaml</code></li> <li>S3 client credentials: <code>template-cm-aws-credentials.yaml</code></li> <li>Container registry configuration: <code>template-cm-docker-config.yaml</code></li> </ul> <p>These ConfigMaps are designed to be mounted as files into the runtime environments of other components for user workspace integration. In particular the Application Hub makes use of this approach to provide a user experience that integrates with the user\u2019s workspace resources.</p>"},{"location":"eoepca/workspace/#templates-configmap","title":"Templates ConfigMap","text":"<p>The templates are provided to the Workspace API as a <code>ConfigMap</code> in the namespace of the Workspace API deployment\u2026</p> <p>(for full examples see https://github.com/EOEPCA/deployment-guide/tree/eoepca-v1.4/deploy/eoepca/workspace-templates)</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: workspace-charts\ndata:\n  template-hr-resource-catalogue.yaml: |\n    apiVersion: helm.toolkit.fluxcd.io/v2beta1\n    kind: HelmRelease\n    metadata:\n      name: rm-resource-catalogue\n    spec:\n      interval: 5m\n      chart:\n        spec:\n          chart: rm-resource-catalogue\n          version: 1.3.1\n          sourceRef:\n            kind: HelmRepository\n            name: eoepca\n            namespace: rm\n      values:\n        ...\n  template-hr-data-access.yaml: |\n    apiVersion: helm.toolkit.fluxcd.io/v2beta1\n    kind: HelmRelease\n    metadata:\n      name: vs\n    spec:\n      interval: 5m\n      chart:\n        spec:\n          chart: data-access\n          version: 1.3.1\n          sourceRef:\n            kind: HelmRepository\n            name: eoepca\n            namespace: rm\n      values:\n        ...\n  template-hr-resource-protection.yaml: |\n    apiVersion: helm.toolkit.fluxcd.io/v2beta1\n    kind: HelmRelease\n    metadata:\n      name: resource-protection\n    spec:\n      interval: 5m\n      chart:\n        spec:\n          chart: identity-gatekeeper\n          version: 1.0.12\n          sourceRef:\n            kind: HelmRepository\n            name: eoepca\n            namespace: ${NAMESPACE}\n      values:\n        ...\n  template-cm-aws-config.yaml: |\n    apiVersion: v1\n    kind: ConfigMap\n    metadata:\n      name: aws-config\n    data:\n      aws-config: |\n        [default]\n        region = {{ s3_region }}\n        s3 =\n          endpoint_url = {{ s3_endpoint_url }}\n        s3api =\n          endpoint_url = {{ s3_endpoint_url }}\n        [plugins]\n        endpoint = awscli_plugin_endpoint\n  template-cm-aws-credentials.yaml: |\n    apiVersion: v1\n    kind: ConfigMap\n    metadata:\n      name: aws-credentials\n    data:\n      aws-credentials: |\n        [default]\n        aws_access_key_id = {{ access_key_id }}\n        aws_secret_access_key = {{ secret_access_key }}\n  template-cm-docker-config.yaml: |\n    apiVersion: v1\n    kind: ConfigMap\n    metadata:\n      name: docker-config\n    data:\n      docker-config: |\n        {\n          \"auths\": {\n            \"{{ container_registry_host }}\": {\n              \"auth\": \"{{ container_registry_credentials }}\"\n            }\n        }\n</code></pre> <p>Notice the use of workspace template parameters <code>{{ param_name }}</code> that are used at workspace creation time to contextualise the workspace for the owning user. See section Workspace Template Parameters for more information.</p>"},{"location":"eoepca/workspace/#helmrepositories-for-templates","title":"HelmRepositories for Templates","text":"<p>As can be seen above, the HelmRelease templates rely upon objects of type HelmRepository that define the hosting helm chart repository. Thus, in support of the workspace templates, appropriate HelmRepository objects must be provisioned within the cluster. For example, in support of the above examples that rely upon the EOEPCA Helm Chart Repository\u2026</p> <pre><code>apiVersion: source.toolkit.fluxcd.io/v1beta1\nkind: HelmRepository\nmetadata:\n  name: eoepca\n  namespace: rm\nspec:\n  interval: 2m\n  url: https://eoepca.github.io/helm-charts/\n</code></pre>"},{"location":"eoepca/workspace/#workspace-template-parameters","title":"Workspace Template Parameters","text":"<p>The Workspace API uses the <code>jinja2</code> templating engine when applying the resources for a user workspace. The current parameters are currently supported:</p> <ul> <li><code>workspace_name</code>   The name of the workspace - <code>{{ workspace_name }}</code> used to ensure unique naming of cluster resources, such as service ingress</li> <li><code>default_owner</code>   The <code>uuid</code> of the owner of the workspace - <code>{{ default_owner }}</code> used to initialise the workspace protection</li> <li>S3 Object Storage details\u2026<ul> <li><code>{{ s3_endpoint_url }}</code></li> <li><code>{{ s3_region }}</code></li> <li><code>{{ access_key_id }}</code></li> <li><code>{{ secret_access_key }}</code></li> </ul> </li> <li>Container Registry details\u2026<ul> <li><code>{{ container_registry_host }}</code></li> <li><code>{{ container_registry_credentials }}</code></li> </ul> </li> </ul>"},{"location":"eoepca/workspace/#protection","title":"Protection","text":"<p>As described in section Resource Protection (Keycloak), the <code>identity-gatekeeper</code> component can be inserted into the request path of the <code>workspace-api</code> service to provide access authorization decisions</p>"},{"location":"eoepca/workspace/#gatekeeper","title":"Gatekeeper","text":"<p>Gatekeeper is deployed using its helm chart\u2026</p> <pre><code>helm install workspace-api-protection identity-gatekeeper -f workspace-api-protection-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  --namespace \"rm\" --create-namespace \\\n  --version 1.0.12\n</code></pre> <p>The <code>identity-gatekeeper</code> must be configured with the values applicable to the <code>workspace-api</code> - in particular the specific ingress requirements for the <code>workspace-api</code> backend service\u2026</p> <p>Example <code>workspace-api-protection-values.yaml</code>\u2026</p> <pre><code>fullnameOverride: workspace-api-protection\nconfig:\n  client-id: workspace-api\n  discovery-url: https://keycloak.192-168-49-2.nip.io/realms/master\n  cookie-domain: 192-168-49-2.nip.io\ntargetService:\n  host: workspace-api.192-168-49-2.nip.io\n  name: workspace-api\n  port:\n    number: 8080\nsecrets:\n  # Values for secret 'workspace-api-protection'\n  # Note - if ommitted, these can instead be set by creating the secret independently.\n  clientSecret: \"changeme\"\n  encryptionKey: \"changemechangeme\"\ningress:\n  enabled: true\n  className: nginx\n  annotations:\n    ingress.kubernetes.io/ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n    cert-manager.io/cluster-issuer: letsencrypt-production\n  # Open access to swagger docs etc.\n  openUri:\n    - ^/(docs.*|openapi.json|probe.*)\n</code></pre>"},{"location":"eoepca/workspace/#keycloak-client","title":"Keycloak Client","text":"<p>The Gatekeeper instance relies upon an associated client configured within Keycloak - ref. <code>client-id: workspace-api</code> above.</p> <p>This can be created with the <code>create-client</code> helper script, as descirbed in section Client Registration.</p> <p>For example, with path protection for the <code>admin</code> user\u2026</p> <pre><code>../bin/create-client \\\n  -a https://keycloak.192-168-49-2.nip.io \\\n  -i https://identity-api.192-168-49-2.nip.io \\\n  -r \"master\" \\\n  -u \"admin\" \\\n  -p \"changeme\" \\\n  -c \"admin-cli\" \\\n  --id=\"workspace-api\" \\\n  --name=\"Workspace API Gatekeeper\" \\\n  --secret=\"changeme\" \\\n  --description=\"Client to be used by Workspace API Gatekeeper\" \\\n  --resource=\"admin\" --uris='/*' --scopes=view --users=\"admin\"\n</code></pre>"},{"location":"eoepca/workspace/#workspace-api-usage","title":"Workspace API Usage","text":"<p>The Workspace API provides a REST interface that is accessed at the endpoint https://workspace-api.192-168-49-2.nip.io/. See the Swagger Docs - /docs.</p> <p>Note</p> <p>If the Workspace API has been protected (via Gatekeeper with Keycloak), then requests must be supported by an <code>access_token</code> carried in the HTTP header <code>Authorozation: Bearer &lt;token&gt;</code>. This diminishes the utility of the swagger UI.</p>"},{"location":"eoepca/workspace/#additional-information","title":"Additional Information","text":"<p>Additional information regarding the Workspace API can be found at:</p> <ul> <li>Helm Chart</li> <li>Wiki</li> <li>GitHub Repository</li> </ul>"},{"location":"eoepca/workspace/#bucket-creation-webhook","title":"Bucket Creation Webhook","text":"<p>With helm chart version <code>1.3.1</code> of the <code>workspace-api</code> the approach to bucket creation has been re-architected to use a webhook approach.</p>"},{"location":"eoepca/workspace/#approach","title":"Approach","text":"<p>During workspace creation the <code>workspace-api</code> needs to create an object storage bucket for the user. The method by which the bucket is created is a function of the hosting infrastructure object storage layer - i.e. there is no \u2018common\u2019 approach for the <code>workspace-api</code> to perform the bucket creation.</p> <p>In order to allow this bucket creation step to be customised by the platform integrator, the workspace-api is configured with a webhook endpoint that is invoked to effect the bucket creation on behalf of the workspace-api.</p> <p>The workspace-api is configured by the following value in its helm chart deployment, e.g\u2026 <pre><code>bucketEndpointUrl: \"http://my-bucket-webhook:8080/bucket\"\n</code></pre></p> <p>The webhook service must implement the following REST interface\u2026</p> <p>method: <code>POST</code> content-type: <code>application/json</code> data: <pre><code>{\n  bucketName: str\n  secretName: str\n  secretNamespace: str\n}\n</code></pre></p> <p>There are two possible approaches to implement this request, distinguished by the response code\u2026</p> <ul> <li><code>200</code>   The bucket is created and the credentials are included in the response body.   In this case only the supplied <code>bucketName</code> is relevant to fulfil the request.</li> <li><code>201</code>   The bucket will be created (asychronously) and the outcome is provided by the webhook via a Kubernetes secret, as per the <code>secretName</code> and <code>secretNamespace</code> request parameters</li> </ul> <p><code>200</code> Response</p> <p>In case <code>200</code> response, the response body should communicate the credentials with an <code>application/json</code> content-type in the form\u2026 <pre><code>{\n    \"bucketname\": \"...\",\n    \"access_key\": \"...\",\n    \"access_secret\": \"....\",\n    \"projectid\": \"...\",\n}\n</code></pre></p> <p>In this case the workspace-api will create the appropriate bucket secret using the returned credentials.</p> <p><code>201</code> Response</p> <p>In case <code>201</code> response, the secret should be created in the form\u2026 <pre><code>data:\n  bucketname: \"...\"\n  access: \"...\"\n  secret: \"...\"\n  projectid: \"...\"\n</code></pre></p> <p>In this case the workspace-api will wait for the (asynchronous) creation of the specified secret before continuing with the workspace creation.</p> <p>Overall Outcome</p> <p>In both cases the ultimate outcome is the creation of the bucket in the back-end object storage, and the creation of a Kubernetes secret that maintains the credentials for access to the bucket. The existence of the bucket secret is prerequisite to the continuation of the user workspace creation.</p>"},{"location":"eoepca/workspace/#minio-bucket-api-webhook","title":"Minio Bucket API (Webhook)","text":"<p>The Minio Bucket API provides an implementation of a Bucket Creation Webhook for a Minio S3 Object Storage backend. This is used as the default in this guide - but should be replaced for a production deployment with an appropriate webhook to integrate with the object storage solution of the deployment environment.</p>"},{"location":"eoepca/workspace/#helm-chart_1","title":"Helm Chart","text":"<p>The Minio Bucket API is deployed via the <code>rm-minio-bucket-api</code> helm chart from the EOEPCA Helm Chart Repository - ref. Helm Chart for the Minio Bucket API.</p> <pre><code>helm install --version 0.0.4 --values minio-bucket-api-values.yaml \\\n  --repo https://eoepca.github.io/helm-charts \\\n  rm-minio-bucket-api rm-minio-bucket-api\n</code></pre>"},{"location":"eoepca/workspace/#values_1","title":"Values","text":"<p>At minimum, values for the following attributes should be specified:</p> <ul> <li>The URL for the Minio endpoint - <code>minIOServerEndpoint</code></li> <li>The credentials for admin access to Minio - via the specified secret <code>accessCredentials.secretName</code> (ref. Minio Credentials Secret)</li> </ul> <p>Example <code>minio-bucket-api-values.yaml</code>\u2026 <pre><code>fullnameOverride: minio-bucket-api\nminIOServerEndpoint: https://minio.192-168-49-2.nip.io\naccessCredentials:\n  secretName: minio-auth\n</code></pre></p>"},{"location":"eoepca/workspace/#additional-information_1","title":"Additional Information","text":"<p>Additional information regarding the Minio Bucket API can be found at:</p> <ul> <li>Helm Chart</li> <li>GitHub Repository</li> </ul>"},{"location":"quickstart/application-hub-deployment/","title":"Application Hub Deployment","text":""},{"location":"quickstart/application-hub-deployment/#overview","title":"Overview","text":"<p>A deployment wrapper script has been prepared for an \u2018Application Hub\u2019 deployment - that provides the Application Hub integrated with the Identity Service (Keycloak) via OIDC for user authentication.</p> <p>The script <code>deploy/apphub/apphub</code> achieves this by appropriate configuration of the environment variables, before launching the eoepca.sh deployment script. The deployment configuration is captured in the file <code>deploy/apphub/apphub-options</code>.</p> <p>The Application Hub deployment applies the following configuration:</p> <ul> <li>Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment</li> <li>No TLS for service ingress endpoints</li> <li>Services deployed:<ul> <li>Identity Service (Keycloak) With test users eric, bob and alice created in Keycloak</li> <li>Application Hub User eric and bob predefined as admin users</li> </ul> </li> <li>Other eoepca services not deployed</li> </ul>"},{"location":"quickstart/application-hub-deployment/#initiate-deployment","title":"Initiate Deployment","text":"<p>Deployment is initiated by invoking the script\u2026</p> <pre><code>./deploy/apphub/apphub\n</code></pre> <p>The Identity Service (Keycloak) is accessed at the following endpoints\u2026</p> <ul> <li>http://keycloak.192-168-49-2.nip.io/</li> <li>http://identity-api.192-168-49-2.nip.io/docs (Swagger docs for the API)</li> </ul> <p>The Application Hub is accessed at the endpoint - http://applicationhub.192-168-49-2.nip.io/.</p>"},{"location":"quickstart/application-hub-deployment/#post-deploy-manual-steps","title":"Post-deploy Manual Steps","text":"<p>To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.</p>"},{"location":"quickstart/application-hub-deployment/#application-hub-notes","title":"Application Hub Notes","text":""},{"location":"quickstart/application-hub-deployment/#login","title":"Login","text":"<p>Authentication is made via the <code>Sign in with EOEPCA</code> button on the service home page - which redirects to Keycloak for authentication.</p> <p>With the out-of-the-box configuration user <code>eric</code> or <code>bob</code> should be used with default password <code>changeme</code>. Users eric and bob are currently predefined within the helm chart as admin users - see https://github.com/EOEPCA/helm-charts/blob/main/charts/application-hub/files/hub/jupyter_config.py#L171.</p>"},{"location":"quickstart/application-hub-deployment/#spawning-applications","title":"Spawning Applications","text":"<p>Once logged in, the service list is presented for spawning of applications. Note that this list of applications is currently defined within the helm chart - see https://github.com/EOEPCA/helm-charts/blob/main/charts/application-hub/files/hub/config.yml.</p> <p>From the list, a service is selected and the <code>Start</code> button initiates spawning.</p> <p>For a clean deployment, the first spawn of each application may take some time whilst the container image representing the application is downloaded to the node. Subsequent invocations (at least on the same node) should be much faster. Once running, the application continues (in the background) until stopped by the user using the <code>Stop Server</code> button on the user\u2019s home screen.</p> <p>The current JupyterHub configuration assumes a single application service (per user) running at a time - i.e. the current application must be stopped before the next can be started. There is an alternative configuration in which applications can be run in parallel and their lifecycles individually managed.</p>"},{"location":"quickstart/application-hub-deployment/#returning-to-the-home-screen","title":"Returning to the Home Screen","text":"<p>The launched applications do not (yet) have a navigation link \u2018out\u2019 of the application back to the home screen.</p> <p>Therefore, it is necessary to manually modify the url in the browser address bar to <code>/hub/home</code> to navigate to the home screen - from where the current running server can be stopped or re-entered.</p>"},{"location":"quickstart/application-hub-deployment/#iat-jupyterlab","title":"IAT - JupyterLab","text":"<p>Following instantiation, the IAT application (Interactive Analysis Tool) defaults to the \u2018Jupyter Notebook\u2019 view (<code>/user/&lt;user&gt;/tree</code>) - rather than the Jupyter Lab view (<code>/user/&lt;user&gt;/lab</code>).</p> <p>To switch to the Jupyter Lab view it is necessary to manually edit the url path from <code>/user/&lt;user&gt;/tree</code> to <code>/user/&lt;user&gt;/lab</code>. It is intended to update the default to this Jupyter Lab path.</p>"},{"location":"quickstart/creodias-deployment/","title":"CREODIAS Deployment","text":""},{"location":"quickstart/creodias-deployment/#deployment","title":"Deployment","text":"<p>Based upon our development experiences on CREODIAS, there is a wrapper script <code>creodias</code> with particular customisations suited to the CREODIAS infrastructure and data offering. The customisations are expressed through environment variables that are captured in the file <code>creodias-options</code>.</p> <p>These scripts are examples that can be seen as a starting point, from which they can be adapted to your needs.</p> <p>The CREODIAS deployment applies the following configuration:</p> <ul> <li>Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment</li> <li>No TLS for service ingress endpoints</li> <li>Protected service endpoints requiring IAM authorization</li> </ul> <p>With reference to the file <code>creodias-options</code>, particular attention is drawn to the following environment variables that require tailoring to your CREODIAS (Cloudferro) environment\u2026</p> <ul> <li>Values for access to CREODIAS eodata\u2026<ul> <li>CREODIAS_EODATA_S3_ENDPOINT - if different from the default <code>http://data.cloudferro.com</code></li> <li>Credentials required for the new clouds, including <code>WAW3-2</code> and <code>FRA1-2</code>   Credentials must be created at - https://eodata-keymanager.creodias.eu/panel/s3-credentials - and set into the variables <code>CREODIAS_EODATA_S3_ACCESS_KEY</code> and <code>CREODIAS_EODATA_S3_ACCESS_SECRET</code></li> </ul> </li> <li>Passwords: <code>MINIO_ROOT_PASSWORD</code>, <code>HARBOR_ADMIN_PASSWORD</code></li> <li>Identity Service credentials - e.g. <code>IDENTITY_SERVICE_DEFAULT_SECRET</code>, <code>IDENTITY_SERVICE_ADMIN_PASSWORD</code>, etc.</li> <li>OpenStack details: see section Openstack Configuration</li> <li>If configuring an external deployment - ref. Public Deployment\u2026<ul> <li><code>public_ip</code> - The public IP address through which the deployment is exposed via the ingress-controller</li> <li><code>domain</code> - The DNS domain name through which the deployment is accessed - forming the stem for all service hostnames in the ingress rules</li> </ul> </li> </ul> <p>Once the file <code>creodias-options</code> has been well populated for your environment, then the deployment is initiated with\u2026 <pre><code>./deploy/creodias/creodias\n</code></pre> \u2026noting that this step is a customised version of that described in section Deployment.</p>"},{"location":"quickstart/creodias-deployment/#harvest-creodias-data","title":"Harvest CREODIAS Data","text":"<p>The harvester can be deployed with a default configuration file at <code>/config.yaml</code>. As described in the Data Access section, harvesting according to this configuration can be triggered with\u2026</p> <pre><code>kubectl -n rm exec -it deployment.apps/data-access-harvester -- python3 -m harvester harvest --config-file /config.yaml Sentinel2\n</code></pre> <p>See the Harvester section below for an explanation of this harvester configuration.</p> <p>See EOData Catalogue API Manual on CREODIAS for details regarding access to the CREODIAS data offering.</p>"},{"location":"quickstart/creodias-deployment/#data-specification-walkthrough","title":"Data Specification Walkthrough","text":"<p>The example scripts include optional specifcation of data-access/harvesting configuration that is tailored for the CREODIAS data offering. This is controlled via the option <code>CREODIAS_DATA_SPECIFICATION=true</code> - see Environment Variables. In addition, it may be necessary to set the variable <code>CREODIAS_EODATA_S3_ENDPOINT</code> if different from the default - for example the value <code>http://eodata.cloudferro.com</code> for the <code>WAW3-2</code> Cloudferro cloud.</p> <p>This section provides a walkthrough of this configuration for CREODIAS - to act as an aid to understanding by way of a worked example.</p>"},{"location":"quickstart/creodias-deployment/#harvester","title":"Harvester","text":"<p>The harvester configuration specifies datasets with spatial/temporal extents, which is configured into the file <code>/config.yaml</code> of the <code>data-access-harvester</code> deployment.</p> <p>The harvester is configured as follows\u2026</p> <pre><code>harvester:\n  replicaCount: 1\n  resources:\n    requests:\n      cpu: 100m\n      memory: 100Mi\n  config:\n    redis:\n      host: data-access-redis-master\n      port: 6379\n    harvesters:\n      - name: Creodias-Opensearch\n        resource:\n          url: https://datahub.creodias.eu/resto/api/collections/Sentinel2/describe.xml\n          type: OpenSearch\n          format_config:\n            type: 'application/json'\n            property_mapping:\n              start_datetime: 'startDate'\n              end_datetime: 'completionDate'\n              productIdentifier: 'productIdentifier'\n          query:\n            time:\n              property: sensed\n              begin: 2019-09-10T00:00:00Z\n              end: 2019-09-11T00:00:00Z\n            collection: null\n            bbox: 14.9,47.7,16.4,48.7\n        filter: {}\n        postprocess:\n          - type: harvester_eoepca.postprocess.CREODIASOpenSearchSentinel2Postprocessor\n        queue: register\n      - name: Creodias-Opensearch-Sentinel1\n        resource:\n          url: https://datahub.creodias.eu/resto/api/collections/Sentinel1/describe.xml\n          type: OpenSearch\n          format_config:\n            type: 'application/json'\n            property_mapping:\n              start_datetime: 'startDate'\n              end_datetime: 'completionDate'\n              productIdentifier: 'productIdentifier'\n          query:\n            time:\n              property: sensed\n              begin: 2019-09-10T00:00:00Z\n              end: 2019-09-11T00:00:00Z\n            collection: null\n            bbox: 14.9,47.7,16.4,48.7\n            extra_params:\n              productType: GRD-COG\n        filter: {}\n        postprocess:\n          - type: harvester_eoepca.postprocess.CREODIASOpenSearchSentinel1Postprocessor\n        queue: register\n</code></pre> <p>Based upon this harvester configuration we expect that the following query is made to discover data - i.e. an OpenSearch query, with json response representation, for a defined spatial and temporal extent\u2026</p> <pre><code>https://datahub.creodias.eu/resto/api/collections/Sentinel2/search.json?startDate=2019-09-10T00:00:00Z&amp;completionDate=2019-09-11T00:00:00Z&amp;box=14.9,47.7,16.4,48.7\n</code></pre> <p>From the result returned, the path to each product (<code>feature</code>) is obtained from the <code>productIdentifier</code> property, e.g.</p> <pre><code>{\n  \"type\": \"FeatureCollection\",\n  \"features\": [\n    {\n      \"type\": \"Feature\",\n      \"properties\": {\n        \"productIdentifier\": \"/eodata/Sentinel-2/MSI/L1C/2019/09/10/S2B_MSIL1C_20190910T095029_N0208_R079_T33TXN_20190910T120910.SAFE\"\n        ...\n      }\n      ...\n    }\n    ...\n  ]\n}\n</code></pre> <p>The harvester is configured with a Sentinel-2/CREODIAS specific post-processor <code>harvester_eoepca.postprocess.CREODIASOpenSearchSentinel2Postprocessor</code> which transforms the product path from <code>/eodata/...</code> to <code>s3://EODATA/...</code>.</p> <p>The harvester post-processor follows this path to the Sentinel-2 scene and uses stactools (with built-in support for Sentinel-2) to establish a STAC item representing the product. This includes enumeration of <code>assets</code> for <code>inspire-metadata</code> and <code>product-metadata</code> - which are used by the registrar pycsw backend to embelesh the product record metadata.</p> <p>Note</p> <p>The above description considers Sentinel-2 data. Similar considerations apply for Sentinel-1 that is also detailed in the above harvester configuration.</p> <p>The harvester outputs the STAC item for each product, which is pushed to the registrar via the <code>register</code> redis queue.</p>"},{"location":"quickstart/creodias-deployment/#registration","title":"Registration","text":"<p>The registrar is configured at deployment to have the access details for the CREODIAS data in S3\u2026</p> <pre><code>global:\n  storage:\n    data:\n      data:\n        type: S3\n        endpoint_url: http://data.cloudferro.com\n        access_key_id: access\n        secret_access_key: access\n        region_name: RegionOne\n        validate_bucket_name: false\n</code></pre> <p>Using this S3 configuration, the registrar pycsw backend uses the product metadata linked in the STAC item (ref. assets <code>inspire-metadata</code> and <code>product-metadata</code>) to embelesh the metadata. For example, <code>product-metadata</code> in the file\u2026</p> <pre><code>s3://EODATA/Sentinel-2/MSI/L1C/2019/09/10/S2B_MSIL1C_20190910T095029_N0208_R079_T33TXN_20190910T120910.SAFE/MTD_MSIL1C.xml\n</code></pre> <p>The registrar uses this information to create the ISO XML metadata that is loaded into the resource-catalogue.</p>"},{"location":"quickstart/creodias-deployment/#product-type","title":"Product Type","text":"<p>The registrar recognises the product as Sentinel-2 and so reads its metadata XML files to obtain additional information. From the metadata XML file (e.g. <code>MTD_MSIL1C.xml</code>) the registrar obtains the Product Type for each product from the field <code>&lt;PRODUCT_TYPE&gt;</code>\u2026</p> <pre><code>&lt;n1:Level-1C_User_Product&gt;\n  &lt;n1:General_Info&gt;\n    &lt;Product_Info&gt;\n      &lt;PRODUCT_TYPE&gt;S2MSI1C&lt;/PRODUCT_TYPE&gt;\n      ...\n    &lt;/Product_Info&gt;\n    ...\n  &lt;/n1:General_Info&gt;\n  ...\n&lt;n1:Level-1C_User_Product&gt;\n</code></pre>"},{"location":"quickstart/creodias-deployment/#resource-catalogue-collections","title":"Resource Catalogue Collections","text":"<p>The registrar (<code>eoepca/rm-data-access-core</code>) container image is pre-loaded with two collections at the path <code>/registrar_pycsw/registrar_pycsw/resources</code>, (in the built container the files are at the path <code>/usr/local/lib/python3.8/dist-packages/registrar_pycsw/resources/</code>):</p> <ul> <li>S2MSI1C.yml - identifier: <code>S2MSI1C</code></li> <li>S2MSI2A.yml - identifier: <code>S2MSI2A</code></li> </ul> <p>The registrar applies these collections into the resource-catalogue during start-up - to create pre-defined out-of-the-box collections in pycsw.</p> <p>During registration, the <code>PycswBackend</code> of the registrar uses the Product Type to map the product into the collection of the same name - using metadata field <code>parentidentifier</code>.</p>"},{"location":"quickstart/creodias-deployment/#data-specification","title":"Data Specification","text":"<p>The data-access service data handling is configured by definition of <code>productTypes</code>, <code>collections</code> and <code>layers</code>\u2026</p> <ul> <li><code>productTypes</code> identify the underlying file assets as WCS coverages and their visual representation</li> <li><code>collections</code> provide groupings into which products are organised</li> <li><code>layers</code> specifies the hoe the product visual representations are exposed through the WMS service</li> </ul>"},{"location":"quickstart/creodias-deployment/#producttype","title":"<code>productType</code>","text":"<p>During registration, products are mapped into a <code>productType</code> via a <code>filter</code> that is applied against the STAC item metadata.</p> <p>The registrar uses the <code>product_type</code> of each product to determine the <code>collection</code> into which the product should be registered - noting that the <code>name</code> of the product type does not take part in the matching logic (and hence can be any text name)\u2026</p> <pre><code>  productTypes:\n    - name: S2MSI1C\n      filter:\n        s2:product_type: S2MSI1C\n</code></pre> <p>In the above example, the field <code>s2:product_type</code> is populated by the <code>stactools</code> that prepares the STAC item from the product metadata.</p>"},{"location":"quickstart/creodias-deployment/#producttype-coverages","title":"<code>productType</code> - <code>coverages</code>","text":"<p><code>coverages</code> defines the coverages for the WCS service. Each coverage links to the <code>assets</code> that are defined within the product STAC item.</p>"},{"location":"quickstart/creodias-deployment/#producttype-browses","title":"<code>productType</code> - <code>browses</code>","text":"<p><code>browses</code> defines the images that are visualised in the View Server Client. Expressions are used to map the product assets into their visual representation.</p>"},{"location":"quickstart/creodias-deployment/#collections","title":"<code>collections</code>","text":"<p>Collections are defined by reference to the defined <code>productTypes</code> and <code>coverages</code>.</p>"},{"location":"quickstart/creodias-deployment/#layers","title":"<code>layers</code>","text":"<p><code>layers</code> defines the layers that are presented through the WMS service - each layer being linked to the underlying <code>browse</code> that provides the image source. Layers are defined via their <code>id</code> that relies upon the naming convection <code>&lt;collection&gt;__&lt;browse&gt;</code> to identify the browse and so define the layer.</p>"},{"location":"quickstart/creodias-deployment/#example-configuration","title":"Example Configuration","text":"<p>Example configuration for Sentinel-2 L1C and L2A data.</p> <pre><code>global:\n  layers:\n    - id: S2L1C\n      title: Sentinel-2 Level 1C True Color\n      abstract: Sentinel-2 Level 2A True Color\n      displayColor: '#eb3700'\n      grids:\n        - name: WGS84\n          zoom: 13\n      parentLayer: S2L1C\n    - id: S2L1C__TRUE_COLOR\n      title: Sentinel-2 Level 1C True Color\n      abstract: Sentinel-2 Level 2A True Color\n      grids:\n        - name: WGS84\n          zoom: 13\n      parentLayer: S2L1C\n    - id: S2L1C__masked_clouds\n      title: Sentinel-2 Level 1C True Color with cloud masks\n      abstract: Sentinel-2 Level 1C True Color with cloud masks\n      grids:\n        - name: WGS84\n          zoom: 13\n      parentLayer: S2L1C\n    - id: S2L1C__FALSE_COLOR\n      title: Sentinel-2 Level 1C False Color\n      abstract: Sentinel-2 Level 1C False Color\n      grids:\n        - name: WGS84\n          zoom: 13\n      parentLayer: S2L1C\n    - id: S2L1C__NDVI\n      title: Sentinel-2 Level 21CNDVI\n      abstract: Sentinel-2 Level 1C NDVI\n      grids:\n        - name: WGS84\n          zoom: 13\n      parentLayer: S2L1C\n    - id: S2L2A\n      title: Sentinel-2 Level 2A True Color\n      abstract: Sentinel-2 Level 2A True Color\n      displayColor: '#eb3700'\n      grids:\n        - name: WGS84\n          zoom: 13\n      parentLayer: S2L2A\n    - id: S2L2A__TRUE_COLOR\n      title: Sentinel-2 Level 2A True Color\n      abstract: Sentinel-2 Level 2A True Color\n      grids:\n        - name: WGS84\n          zoom: 13\n      parentLayer: S2L2A\n    - id: S2L2A__masked_clouds\n      title: Sentinel-2 Level 2A True Color with cloud masks\n      abstract: Sentinel-2 Level 2A True Color with cloud masks\n      grids:\n        - name: WGS84\n          zoom: 13\n      parentLayer: S2L2A\n    - id: S2L2A__FALSE_COLOR\n      title: Sentinel-2 Level 2A False Color\n      abstract: Sentinel-2 Level 2A False Color\n      grids:\n        - name: WGS84\n          zoom: 13\n      parentLayer: S2L2A\n    - id: S2L2A__NDVI\n      title: Sentinel-2 Level 2A NDVI\n      abstract: Sentinel-2 Level 2A NDVI\n      grids:\n        - name: WGS84\n          zoom: 13\n      parentLayer: S2L2A\n  collections:\n    S2L1C:\n      product_types:\n        - S2MSI1C\n      coverage_types:\n        - S2L1C_B01\n        - S2L1C_B02\n        - S2L1C_B03\n        - S2L1C_B04\n        - S2L1C_B05\n        - S2L1C_B06\n        - S2L1C_B07\n        - S2L1C_B08\n        - S2L1C_B8A\n        - S2L1C_B09\n        - S2L1C_B10\n        - S2L1C_B11\n        - S2L1C_B12\n    S2L2A:\n      product_types:\n        - S2MSI2A\n      product_levels:\n        - Level-2A\n      coverage_types:\n        - S2L2A_B01\n        - S2L2A_B02\n        - S2L2A_B03\n        - S2L2A_B04\n        - S2L2A_B05\n        - S2L2A_B06\n        - S2L2A_B07\n        - S2L2A_B08\n        - S2L2A_B8A\n        - S2L2A_B09\n        - S2L2A_B11\n        - S2L2A_B12\n  productTypes:\n    - name: S2MSI1C\n      filter:\n        s2:product_type: S2MSI1C\n      metadata_assets: []\n      coverages:\n        S2L1C_B01:\n          assets:\n            - B01\n        S2L1C_B02:\n          assets:\n            - B02\n        S2L1C_B03:\n          assets:\n            - B03\n        S2L1C_B04:\n          assets:\n            - B04\n        S2L1C_B05:\n          assets:\n            - B05\n        S2L1C_B06:\n          assets:\n            - B06\n        S2L1C_B07:\n          assets:\n            - B07\n        S2L1C_B08:\n          assets:\n            - B08\n        S2L1C_B8A:\n          assets:\n            - B8A\n        S2L1C_B09:\n          assets:\n            - B09\n        S2L1C_B10:\n          assets:\n            - B10\n        S2L1C_B11:\n          assets:\n            - B11\n        S2L1C_B12:\n          assets:\n            - B12\n      defaultBrowse: TRUE_COLOR\n      browses:\n        TRUE_COLOR:\n          asset: visual\n          red:\n            expression: B04\n            range: [0, 4000]\n            nodata: 0\n          green:\n            expression: B03\n            range: [0, 4000]\n            nodata: 0\n          blue:\n            expression: B02\n            range: [0, 4000]\n            nodata: 0\n        FALSE_COLOR:\n          red:\n            expression: B08\n            range: [0, 4000]\n            nodata: 0\n          green:\n            expression: B04\n            range: [0, 4000]\n            nodata: 0\n          blue:\n            expression: B03\n            range: [0, 4000]\n            nodata: 0\n        NDVI:\n          grey:\n            expression: (B08-B04)/(B08+B04)\n            range: [-1, 1]\n      masks:\n        clouds:\n          validity: false\n    - name: S2MSI2A\n      filter:\n        s2:product_type: S2MSI2A\n      metadata_assets: []\n      coverages:\n        S2L2A_B01:\n          assets:\n            - B01\n        S2L2A_B02:\n          assets:\n            - B02\n        S2L2A_B03:\n          assets:\n            - B03\n        S2L2A_B04:\n          assets:\n            - B04\n        S2L2A_B05:\n          assets:\n            - B05\n        S2L2A_B06:\n          assets:\n            - B06\n        S2L2A_B07:\n          assets:\n            - B07\n        S2L2A_B08:\n          assets:\n            - B08\n        S2L2A_B8A:\n          assets:\n            - B8A\n        S2L2A_B09:\n          assets:\n            - B09\n        S2L2A_B11:\n          assets:\n            - B11\n        S2L2A_B12:\n          assets:\n            - B12\n      default_browse_locator: TCI_10m\n      browses:\n        TRUE_COLOR:\n          asset: visual-10m\n          red:\n            expression: B04\n            range: [0, 4000]\n            nodata: 0\n          green:\n            expression: B03\n            range: [0, 4000]\n            nodata: 0\n          blue:\n            expression: B02\n            range: [0, 4000]\n            nodata: 0\n        FALSE_COLOR:\n          red:\n            expression: B08\n            range: [0, 4000]\n            nodata: 0\n          green:\n            expression: B04\n            range: [0, 4000]\n            nodata: 0\n          blue:\n            expression: B03\n            range: [0, 4000]\n            nodata: 0\n        NDVI:\n          grey:\n            expression: (B08-B04)/(B08+B04)\n            range: [-1, 1]\n      masks:\n        clouds:\n          validity: false\n</code></pre>"},{"location":"quickstart/data-access-deployment/","title":"Data Access Deployment","text":""},{"location":"quickstart/data-access-deployment/#overview","title":"Overview","text":"<p>A deployment wrapper script has been prepared for a \u2018data access\u2019 deployment - that is focused on the Resource Catalogue and Data Access services.</p> <p>The script <code>deploy/data-access/data-access</code> achieves this by appropriate configuration of the environment variables, before launching the eoepca.sh deployment script. The deployment configuration is captured in the file <code>deploy/data-access/data-access-options</code>.</p> <p>The data-access deployment applies the following configuration:</p> <ul> <li>Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment</li> <li>No TLS for service ingress endpoints</li> <li>Services deployed:<ul> <li>Resource Catalogue for data discovery</li> <li>Data Access for data visualisation and download</li> </ul> </li> <li>Includes data specification for CREODIAS Sentinel-2, which can be exploited if running in a CREODIAS VM connected to the <code>eodata</code> network - see description of variable <code>CREODIAS_DATA_SPECIFICATION</code> Note that it may be necessary to set the variable <code>CREODIAS_EODATA_S3_ENDPOINT</code> if different from the default - for example the value <code>http://eodata.cloudferro.com</code> for the <code>WAW3-2</code> Cloudferro cloud.</li> <li>Open ingress are enabled for unauthenticated access to resource-catalogue and data-access services</li> <li>Other eoepca services not deployed</li> </ul>"},{"location":"quickstart/data-access-deployment/#initiate-deployment","title":"Initiate Deployment","text":"<p>Deployment is initiated by invoking the script\u2026</p> <pre><code>./deploy/data-access/data-access\n</code></pre> <p>The Resource Catalogue is accessed at the endpoint <code>resource-catalogue-open.192-168-49-2.nip.io</code> - e.g. <code>resource-catalogue-open.192-168-49-2.nip.io</code>.</p> <p>The Data Access View Server is accessed at the endpoint <code>data-access-open.192-168-49-2.nip.io</code> - e.g. <code>data-access-open.192-168-49-2.nip.io</code>.</p>"},{"location":"quickstart/data-access-deployment/#post-deploy-manual-steps","title":"Post-deploy Manual Steps","text":"<p>To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.</p>"},{"location":"quickstart/data-access-deployment/#data-harvesting","title":"Data Harvesting","text":"<p>See section Harvest CREODIAS Data to harvest the default data specification from the CREODIAS data offering.</p>"},{"location":"quickstart/exploitation-deployment/","title":"Exploitation Deployment","text":""},{"location":"quickstart/exploitation-deployment/#overview","title":"Overview","text":"<p>A deployment wrapper script has been prepared for an \u2018exploitation\u2019 deployment - that provides deployment/execution of processing via the ADES, supported by Resource Catalogue and Data Access services.</p> <p>The script <code>deploy/exploitation/exploitation</code> achieves this by appropriate configuration of the environment variables, before launching the eoepca.sh deployment script. The deployment configuration is captured in the file <code>deploy/exploitation/exploitation-options</code>.</p> <p>The exploitation deployment applies the following configuration:</p> <ul> <li>Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment</li> <li>No TLS for service ingress endpoints</li> <li>Services deployed:<ul> <li>ADES for processing</li> <li>Resource Catalogue for data discovery</li> <li>Data Access for data visualisation and download</li> <li>Minio for S3 object storage</li> </ul> </li> <li>ADES stage-out to Minio</li> <li>Includes data specification for CREODIAS Sentinel-2, which can be exploited if running in a CREODIAS VM connected to the <code>eodata</code> network - see description of variable <code>CREODIAS_DATA_SPECIFICATION</code> Note that it may be necessary to set the variable <code>CREODIAS_EODATA_S3_ENDPOINT</code> if different from the default - for example the value <code>http://eodata.cloudferro.com</code> for the <code>WAW3-2</code> Cloudferro cloud.</li> <li>Open ingress are enabled for unauthenticated access to ADES, resource-catalogue and data-access services</li> <li>Other eoepca services not deployed</li> </ul>"},{"location":"quickstart/exploitation-deployment/#initiate-deployment","title":"Initiate Deployment","text":"<p>Deployment is initiated by invoking the script\u2026</p> <pre><code>./deploy/exploitation/exploitation\n</code></pre> <p>The ADES service is accessed at the endpoint <code>ades-open.192-168-49-2.nip.io</code>.</p> <p>The Resource Catalogue is accessed at the endpoint <code>resource-catalogue-open.192-168-49-2.nip.io</code>.</p> <p>The Data Access View Server is accessed at the endpoint <code>data-access-open.192-168-49-2.nip.io</code>.</p>"},{"location":"quickstart/exploitation-deployment/#post-deploy-manual-steps","title":"Post-deploy Manual Steps","text":"<p>To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.</p>"},{"location":"quickstart/exploitation-deployment/#example-requests-s-expression-on-creodias","title":"Example Requests - <code>s-expression</code> on CREODIAS","text":"<p>NOTE that this example processing request requires harvesting data from CREODIAS, which can only be performed if the deployment is made to a CREODIAS VM with access to the <code>eodata</code> network - see description of variable <code>CREODIAS_DATA_SPECIFICATION</code>.</p> <p>Section Processing provides an example of a simple self-contained processing deployment and execution, and access to the processing results.</p> <p>In addition to the <code>snuggs</code> example, the file <code>deploy/samples/requests/processing/s-expression.http</code> has been prepared to exploit data that has been registered within the Resource Catalogue and Data Access services.</p> <p>First the input data for processing must be harvested into the resource management services. Sentinel-2 data on 2nd Sept 2020\u2026</p> <pre><code>./deploy/bin/harvest ./deploy/samples/harvester/config-Sentinel2-2020.09.02.yaml\n</code></pre> <p>Then the <code>s-expression.http</code> file provides sample requests for OGC API Processes operations:</p> <ul> <li>List Processes</li> <li>Deploy Process</li> <li>Get Process Details</li> <li>Execute Process</li> <li>Get Job Status</li> <li>Get Job Results</li> </ul> <p>NOTE that the first requests in the file provide optional calls to obtain a user access token (<code>openidConfiguration</code> / <code>authenticate</code>) - to be used in the case that protected (not \u2018open\u2019) endpoints are deployed.</p> <p>The files <code>snuggs.http</code> and <code>s-expression.http</code> describe the HTTP requests for the ADES OGC API Processes endpoint, and is designed for use with the Visual Studio Code (vscode) extension REST Client. Install in vscode with <code>ext install humao.rest-client</code>.</p> <p>Various variables, such as to specify the <code>@domain</code> for your deployment, can be configured at the top of the file.</p> <p>At the completion of successful processing execution, the procesing results are obtained as described in section Processing Results.</p>"},{"location":"quickstart/exploitation-deployment/#data-harvesting","title":"Data Harvesting","text":"<p>See section Harvest CREODIAS Data to harvest the default data specification from the CREODIAS data offering.</p>"},{"location":"quickstart/processing-deployment/","title":"Processing Deployment","text":""},{"location":"quickstart/processing-deployment/#overview","title":"Overview","text":"<p>A deployment wrapper script has been prepared for a \u2018processing\u2019 deployment - that is focused on the ADES and the deployment/execution of processing jobs.</p> <p>The script <code>deploy/processing/processing</code> achieves this by appropriate configuration of the environment variables, before launching the eoepca.sh deployment script. The deployment configuration is captured in the file <code>deploy/processing/processing-options</code>.</p> <p>The processing deployment applies the following configuration:</p> <ul> <li>Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment</li> <li>No TLS for service ingress endpoints</li> <li>Services deployed:<ul> <li>ADES for processing</li> <li>Minio for S3 object storage</li> </ul> </li> <li>ADES stage-out to Minio</li> <li>Open ingress are enabled for unauthenticated access to ADES service</li> <li>Other eoepca services not deployed</li> </ul>"},{"location":"quickstart/processing-deployment/#initiate-deployment","title":"Initiate Deployment","text":"<p>Deployment is initiated by invoking the script\u2026</p> <pre><code>./deploy/processing/processing\n</code></pre> <p>The ADES service is accessed at the endpoint <code>zoo-open.192-168-49-2.nip.io</code>.</p>"},{"location":"quickstart/processing-deployment/#post-deploy-manual-steps","title":"Post-deploy Manual Steps","text":"<p>To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.</p>"},{"location":"quickstart/processing-deployment/#example-requests","title":"Example Requests","text":"<p>Some sample requests have been prepared in the subdirectory <code>deploy/samples/requests/processing</code> - for example\u2026</p> <ul> <li><code>convert</code> Provides a \u2018hello world\u2019 processing example that can be used simply to check that the processing capability has been well deployed</li> <li><code>snuggs</code> Provides a packaged EO exploitation algorithm that perform \u2018real\u2019 work and, as such, is more resource demanding (10GB RAM, 3 CPU) - and so may not be suitable for execution within a local minikube deployment (depending on resource allocations)</li> </ul> <p>These sample <code>http</code> files have been prepared with sample requests for OGC API Processes operations:</p> <ul> <li>List Processes</li> <li>Deploy Process</li> <li>Get Process Details</li> <li>Execute Process</li> <li>Get Job Status</li> <li>Get Job Results</li> </ul> <p>Note</p> <ul> <li>The first requests in the file provide optional calls to obtain a user ID token (<code>openidConfiguration</code> / <code>authenticate</code>). These are to be used in the case that protected (not \u2018open\u2019) endpoints are deployed.</li> <li>The file describes the HTTP requests for the ADES OGC API Processes endpoint, and is designed for use with the Visual Studio Code (vscode) extension REST Client. Install in vscode with <code>ext install humao.rest-client</code>.</li> <li>The variables <code>@hostname</code> and <code>@domain</code> can be configured at the top of the file.</li> </ul>"},{"location":"quickstart/processing-deployment/#alternative-curl-commands","title":"Alternative <code>curl</code> Commands","text":"<p>Alternatively the following <code>curl</code> commands can be used\u2026</p> List Processes <pre><code>curl -k \\\n  --request GET \\\n  --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes \\\n  --header 'accept: application/json'\n</code></pre> Deploy &amp; Execute (<code>convert</code>) Deploy Process (<code>convert</code>) - By Reference (JSON) <pre><code>curl -k \\\n  --request POST \\\n  --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes \\\n  --header 'accept: application/json' \\\n  --header 'content-type: application/json' \\\n  --data '{\"executionUnit\": {\"href\": \"https://raw.githubusercontent.com/EOEPCA/convert/main/convert-url-app.cwl\",\"type\": \"application/cwl\"}}'\n</code></pre> Deploy Process (<code>convert</code>) - Inline (CWL) <pre><code>curl -k \\\n  --request POST \\\n  --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes \\\n  --header 'accept: application/json' \\\n  --header 'content-type: application/cwl+yaml' \\\n  --data '&lt; convert-url-app.cwl'\n</code></pre> Get Process Details (<code>convert</code>) <pre><code>curl -k \\\n  --request GET \\\n  --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/convert-url \\\n  --header 'accept: application/json'\n</code></pre> Execute Process (<code>convert</code>) <pre><code>curl -k -v \\\n  --request POST \\\n  --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/convert-url/execution \\\n  --header 'accept: application/json' \\\n  --header 'content-type: application/json' \\\n  --header 'prefer: respond-async' \\\n  --data '{\"inputs\": {\"fn\":  \"resize\",\"url\": \"https://eoepca.org/media_portal/images/logo6_med.original.png\", \"size\": \"50%\"},\"response\":\"raw\"}'\n</code></pre> Undeploy Process (<code>convert</code>) <pre><code>curl -k -v \\\n  --request DELETE \\\n  --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/convert-url \\\n  --header 'accept: application/json'\n</code></pre> Deploy &amp; Execute (<code>snuggs</code>) Deploy Process (<code>snuggs</code>) <pre><code>curl -k \\\n  --request POST \\\n  --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes \\\n  --header 'accept: application/json' \\\n  --header 'content-type: application/json' \\\n  --data '{\"executionUnit\": {\"href\": \"https://raw.githubusercontent.com/EOEPCA/deployment-guide/eoepca-v1.4/deploy/samples/requests/processing/snuggs.cwl\",\"type\": \"application/cwl\"}}'\n</code></pre> Get Process Details (<code>snuggs</code>) <pre><code>curl -k \\\n  --request GET \\\n  --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/snuggs \\\n  --header 'accept: application/json'\n</code></pre> Execute Process (<code>snuggs</code>) <pre><code>curl -k -v \\\n  --request POST \\\n  --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/snuggs/execution \\\n  --header 'accept: application/json' \\\n  --header 'content-type: application/json' \\\n  --header 'prefer: respond-async' \\\n  --data '{\"inputs\": {\"input_reference\":  \"https://earth-search.aws.element84.com/v0/collections/sentinel-s2-l2a-cogs/items/S2B_36RTT_20191205_0_L2A\",\"s_expression\": \"ndvi:(/ (- B05 B03) (+ B05 B03))\"},\"response\":\"raw\"}'\n</code></pre> Undeploy Process (<code>snuggs</code>) <pre><code>curl -k -v \\\n  --request DELETE \\\n  --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/processes/snuggs \\\n  --header 'accept: application/json'\n</code></pre> Get Job Status <p>This request requires the <code>Location</code> header from the response to the execute request. This will be of the form <code>http://zoo-open.192-168-49-2.nip.io/{user}/ogc-api/jobs/{job-id}</code> - e.g. <code>http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/jobs/7b58bc38-64d4-11ed-b962-0242ac11000e</code>.</p> <pre><code>curl -k \\\n  --request GET \\\n  --url {location-header} \\\n  --header 'accept: application/json'\n</code></pre> Get Job Results <p>This request uses the same URL as <code>Get Job Status</code>, with the additional URL path <code>/results</code> - i.e. <code>/{user}/ogc-api/jobs/{job-id}/results</code> - e.g. <code>/eric/ogc-api/jobs/7b58bc38-64d4-11ed-b962-0242ac11000e/results</code></p> <pre><code>curl -k \\\n  --request GET \\\n  --url {location-header}/results \\\n  --header 'accept: application/json'\n</code></pre> <p>The response indicates the location of the results, which should be in the <code>minio</code> object storage. See Processing Results.</p> <p>The response also provides links to log files regarding each step of the Application Package workflow execution - which may be useful for debugging.</p> List Jobs <pre><code>curl -k \\\n  --request GET \\\n  --url http://zoo-open.192-168-49-2.nip.io/eric/ogc-api/jobs \\\n  --header 'accept: application/json'\n</code></pre>"},{"location":"quickstart/processing-deployment/#processing-results","title":"Processing Results","text":"<p>The outputs are published as a static STAC catalogue to a path that includes the unique job ID.</p> <p>In the default configuration, the processing results are pushed to the Minio S3 object storage. This can be checked via browser access at the endpoint <code>http://console.minio.192-168-49-2.nip.io/</code>, or using an S3 client such as\u2026</p> <pre><code>s3cmd -c ./deploy/cluster/s3cfg ls s3://eoepca\n</code></pre> <p>For the default credentials to connect to Minio see Minio Object Storage Default Credentials.</p> <p>Note</p> <p>If the ADES deployment has been configured to stage-out to the user\u2019s Workspace, then the above <code>s3cmd</code> and credentials would have to be adjusted accordingly - for example the bucket <code>s3://ws-eric</code>.</p>"},{"location":"quickstart/quickstart/","title":"Quick Start","text":"<p>Note</p> <p>The deployment of the EOEPCA components and the supporting Kubernetes cluster is described in the sections Prepare Cluster and Deploy EOEPCA Components. These sections should be consulted for more detailed information.</p>"},{"location":"quickstart/quickstart/#scripted-deployment","title":"Scripted Deployment","text":"<p>As a companion to these descriptions, we have developed a set of scripts to provide a demonstration of example deployments - see section Scripted Deployment for a detailed description of the scripts and how they are configured and used.</p> <p>Note</p> <p>The scripted deployment assumes that installation of the Prerequisite Tooling has been performed</p>"},{"location":"quickstart/quickstart/#customised-deployments","title":"Customised Deployments","text":"<p>The Scripted Deployment can be quickly exploited through the following customisations (profiles) for particular use cases:</p> <ul> <li>Simple Basic local deployment</li> <li>Processing Deployment focused on processing</li> <li>Data Access Deployment focused on the Resource Catalogue and Data Access services</li> <li>Exploitation Deployment providing deployment/execution of processing via the ADES, supported by Resource Catalogue and Data Access services</li> <li>User Management Deployment focused on the Identity &amp; Access Management services</li> <li>Application Hub Deployment providing the Application Hub that is pre-integrated via OIDC with the Identity Service</li> <li>CREODIAS Deployment with access to CREODIAS EO data</li> </ul> <p>Each customisation is introduced in their respective sections.</p>"},{"location":"quickstart/quickstart/#quick-example","title":"Quick Example","text":"<p>Follow these steps to create a simple local deployment in minikube\u2026</p> <ol> <li>Prerequisite Tooling    Follow the steps in section Prerequisite Tooling to install the required tooling.</li> <li>Clone the repository <code>git clone -b eoepca-v1.4 https://github.com/EOEPCA/deployment-guide</code></li> <li>Initiate the deployment <pre><code>cd deployment-guide\n./deploy/simple/simple\n</code></pre></li> <li>Wait for deployment ready<ol> <li>List pod status <code>watch kubectl get pod -A</code></li> <li>Wait until all pods report either <code>Running</code> or <code>Completed</code> This may take 10-20 mins depending on the capabilities of your platform.</li> </ol> </li> <li>Test the deployment    Make the sample requests to the ADES processing service.</li> </ol>"},{"location":"quickstart/scripted-deployment/","title":"Scripted Deployment","text":""},{"location":"quickstart/scripted-deployment/#overview","title":"Overview","text":"<p>The Scripted Deployment provides a demonstration of an example deployment, and can found in the subdirectory <code>deployment-guide/deploy</code> of the source repository for this guide\u2026</p> <pre><code>git clone -b eoepca-v1.4 https://github.com/EOEPCA/deployment-guide \\\n&amp;&amp; cd deployment-guide \\\n&amp;&amp; ls deploy\n</code></pre> <p>The script <code>deploy/eoepca/eoepca.sh</code> acts as an entry-point to the full system deployment. In order to tailor the deployment for your target environment, the script is configured through environment variables and command-line arguments. By default the script assumes deployment to a local minikube.</p> <p>Note</p> <p>The scripted deployment assumes that installation of the Prerequisite Tooling has been performed.</p> <p>The following subsections lead through the steps for a full local deployment. Whilst minikube is assumed, minimal adaptions are required to make the deployment to your existing Kubernetes cluster.</p> <p>The deployment follows these broad steps:</p> <ul> <li>Configuration   Tailoring of deployment options.</li> <li>Deployment   Creation of cluster and deployment of eoepca services.</li> <li>Manual Steps   Manual steps to be performed post-deployment.</li> </ul>"},{"location":"quickstart/scripted-deployment/#configuration","title":"Configuration","text":"<p>The script <code>deploy/eoepca/eoepca.sh</code> is configured by some environment variables and command-line arguments.</p>"},{"location":"quickstart/scripted-deployment/#environment-variables","title":"Environment Variables","text":"Environment Variables Variable Description Default REQUIRE_&lt;cluster-component&gt; A set of variables that can be used to control which CLUSTER components are deployed by the script, as follows (with defaults):<code>REQUIRE_MINIKUBE=true</code><code>REQUIRE_INGRESS_NGINX=true</code><code>REQUIRE_CERT_MANAGER=true</code><code>REQUIRE_LETSENCRYPT=true</code><code>REQUIRE_SEALED_SECRETS=false</code><code>REQUIRE_MINIO=false</code> see description REQUIRE_&lt;eoepca-component&gt; A set of variables that can be used to control which EOEPCA components are deployed by the script, as follows (with defaults):<code>REQUIRE_STORAGE=true</code><code>REQUIRE_DUMMY_SERVICE=false</code><code>REQUIRE_IDENTITY_SERVICE=true</code><code>REQUIRE_ADES=true</code><code>REQUIRE_RESOURCE_CATALOGUE=true</code><code>REQUIRE_DATA_ACCESS=true</code><code>REQUIRE_REGISTRATION_API=true</code><code>REQUIRE_WORKSPACE_API=true</code><code>REQUIRE_HARBOR=true</code><code>REQUIRE_PORTAL=true</code><code>REQUIRE_APPLICATION_HUB=true</code> see description REQUIRE_&lt;protection-component&gt; A set of variables that can be used to control which PROTECTION components are deployed by the script, as follows (with defaults):<code>REQUIRE_DUMMY_SERVICE_PROTECTION=false</code><code>REQUIRE_ADES_PROTECTION=true</code><code>REQUIRE_RESOURCE_CATALOGUE_PROTECTION=true</code><code>REQUIRE_DATA_ACCESS_PROTECTION=true</code><code>REGISTRATION_API_PROTECTION=true</code><code>REQUIRE_WORKSPACE_API_PROTECTION=true</code> see description MINIKUBE_VERSION The Minikube version to be (optionally) installedNote that the EOEPCA development has been conducted using the default stated here. <code>v1.32.0</code> MINIKUBE_KUBERNETES_VERSION The Kubernetes version to be used by minikubeNote that the EOEPCA development has been conducted primarily using version 1.22.5. <code>v1.22.5</code> MINIKUBE_MEMORY_AMOUNT Amount of memory to allocate to the docker containers used by minikube to implement the cluster. <code>12g</code> MINIKUBE_DISK_AMOUNT Amount of disk space to allocate to the docker containers used by minikube to implement the cluster. <code>20g</code> MINIKUBE_EXTRA_OPTIONS Additional options to pass to <code>minikube start</code> command-line <code>--ports=80:80,443:443</code> USE_METALLB Enable use of minikube\u2019s built-in load-balancer.The load-balancer can be used to facilitate exposing services publicly. However, the same can be achieved using minikube\u2019s built-in ingress-controller. Therefore, this option is suppressed by default. <code>false</code> USE_INGRESS_NGINX_HELM Install the ingress-nginx controller using the published helm chart, rather than relying upon the version that is built-in to minikube. By default we prefer the version that is built in to minikube. <code>false</code> USE_INGRESS_NGINX_LOADBALANCER Patch the built-in minikube nginx-ingress-controller to offer a service of type <code>LoadBalancer</code>, rather than the default <code>NodePort</code>. It was initially thought that this would be necessary to achieve public access to the ingress services - but was subsequently found that the default <code>NodePort</code> configuration of the ingress-controller was sufficient. This option is left in case it proves useful.Only applicable for <code>USE_INGRESS_NGINX_HELM=false</code> (i.e. when using the minikube built-in ) <code>false</code> OPEN_INGRESS Create \u2018open\u2019 ingress endpoints that are not subject to authorization protection. For a secure system the open endpoints should be disabled (<code>false</code>) and access to resource should be protected via ingress that apply protection <code>false</code> USE_TLS Indicates whether TLS will be configured for service <code>Ingress</code> rules.If not (i.e. <code>USE_TLS=false</code>), then the ingress-controller is configured to disable <code>ssl-redirect</code>, and <code>TLS_CLUSTER_ISSUER=notls</code> is set. <code>true</code> TLS_CLUSTER_ISSUER The name of the ClusterIssuer to satisfy ingress tls certificates.Out-of-the-box ClusterIssuer instances are configured in the file <code>deploy/cluster/letsencrypt.sh</code>. <code>letsencrypt-staging</code> IDENTITY_SERVICE_DEFAULT_SECRET Default secret that is used by exception for other Identity Service credentials <code>changeme</code> IDENTITY_SERVICE_ADMIN_USER The admin user for Keycloak <code>admin</code> IDENTITY_SERVICE_ADMIN_PASSWORD The admin user password for Keycloak <code>${IDENTITY_SERVICE_DEFAULT_SECRET}</code> IDENTITY_SERVICE_ADMIN_CLIENT The Keycloak client to use for admin API tasks during scripted deployment <code>admin-cli</code> IDENTITY_POSTGRES_PASSWORD The password for the Keycloak Postgres service <code>${IDENTITY_SERVICE_DEFAULT_SECRET}</code> IDENTITY_GATEKEEPER_CLIENT_SECRET The secret used for each Keycloak client (one per resource service) created during scripted deployment <code>${IDENTITY_SERVICE_DEFAULT_SECRET}</code> IDENTITY_GATEKEEPER_ENCRYPTION_KEY The encryption key for each Keycloak client (one per resource service) created during scripted deploymentNOTE that this must be either 16 or 32 characters long <code>changemechangeme</code> IDENTITY_REALM Keycloak realm for Identity Service.This is not explicitly created by the scripted deployment, and so is assumed to exist within the Keycloak instance. Thus, will probably break the deployment if modified. <code>master</code> MINIO_ROOT_USER Name of the \u2018root\u2019 user for the Minio object storage service. <code>eoepca</code> MINIO_ROOT_PASSWORD Password for the \u2018root\u2019 user for the Minio object storage service. <code>changeme</code> HARBOR_ADMIN_PASSWORD Password for the \u2018admin\u2019 user for the Harbor artefact registry service. <code>changeme</code> DEFAULT_STORAGE Storage Class to be used by default for all components requiring dynamic storage provisioning.See variables <code>&lt;component&gt;_STORAGE</code> for per-component overrides. <code>standard</code> &lt;component&gt;_STORAGE A set of variables to control the dynamic provisioning Storage Class for individual components, as follows:MINIO_STORAGEADES_STORAGEAPPLICATION_HUB_STORAGEDATA_ACCESS_STORAGEHARBOR_STORAGERESOURCE_CATALOGUE_STORAGE <code>&lt;DEFAULT_STORAGE&gt;</code> PROCESSING_MAX_RAM Max RAM allocated to an individual processing job <code>8Gi</code> PROCESSING_MAX_CORES Max number of CPU cores allocated to an individual processing job <code>4</code> PROCESSING_ZOO_IMAGE Container image for <code>zoo-dru</code> deployment <code>eoepca-092ea7a2c6823dba9c6d52c383a73f5ff92d0762</code> STAGEOUT_TARGET Configures the ADES with the destination to which it should push processing results:<code>workspace</code> - via the Workspace API<code>minio</code> - to minio S3 object storage <code>workspace</code> INSTALL_FLUX The Workspace API relies upon Flux CI/CD, and has the capability to install the required flux components to the cluster. If your deployment already has flux installed then set this value <code>false</code> to suppress the Workspace API flux install <code>true</code> CREODIAS_DATA_SPECIFICATION Apply the data specification to harvest from the CREODIAS data offering into the resource-catalogue and data-access services.Can only be used when running in the CREODIAS (Cloudferro) cloud, with access to the <code>eodata</code> network. <code>false</code> CREODIAS_EODATA_S3_ENDPOINT URL for the S3 endpoint in CREODIAS <code>http://data.cloudferro.com</code> CREODIAS_EODATA_S3_ACCESS_KEY Access key for CREODIAS S3 endpoint <code>access</code> CREODIAS_EODATA_S3_ACCESS_SECRET Access secret for CREODIAS S3 endpoint <code>access</code> CREODIAS_EODATA_S3_REGION Region for the S3 endpoint in CREODIAS <code>RegionOne</code> TEMP_FORWARDING_PORT Local port used during the scripted deployment for <code>kubectl port-forward</code> operations <code>9876</code>"},{"location":"quickstart/scripted-deployment/#command-line-arguments","title":"Command-line Arguments","text":"<p>The eoepca.sh script is further configured via command-line arguments\u2026</p> <pre><code>eoepca.sh &lt;action&gt; &lt;cluster-name&gt; &lt;domain&gt; &lt;public-ip&gt;\n</code></pre> <code>eoepca.sh</code> Command-line Arguments Argument Description Default action Action to perform: <code>apply</code> | <code>delete</code> | <code>template</code>.<code>apply</code> makes the deployment<code>delete</code> removes the deployment<code>template</code> outputs generated kubernetes yaml to stdout <code>apply</code> cluster-name The name of the minikube \u2018profile\u2019 for the created minikube cluster <code>eoepca</code> domain The DNS domain name through which the deployment is accessed. Forms the stem for all service hostnames in the ingress rules - i.e. <code>&lt;service-name&gt;.&lt;domain&gt;</code>.By default, the value is deduced from the assigned cluster minikube IP address, using <code>nip.io</code> to establish a DNS lookup - i.e. <code>&lt;minikube ip&gt;.nip.io</code>. <code>&lt;minikube ip&gt;.nip.io</code> public-ip The public IP address through which the deployment is exposed via the ingress-controller.By default, the value is deduced from the assigned cluster minikube IP address - ref. command <code>minikube ip</code>. <code>&lt;minikube-ip&gt;</code>"},{"location":"quickstart/scripted-deployment/#public-deployment","title":"Public Deployment","text":"<p>For simplicity, the out-of-the-box scripts assume a \u2018private\u2019 deployment - with no public IP / DNS and hence no use of TLS for service ingress endpoints.</p> <p>In the case that an external-facing public deployment is desired, then the following configuration selections should be made:</p> <ul> <li><code>domain</code> - set to the domain (as per DNS records) for your deployment Note that the EOEPCA components typically configure their ingress with hostname prefixes applied to this <code>domain</code>. Thus, it is necessary that the DNS record for the domain is established as a wildcard record - i.e. <code>*.&lt;domain&gt;</code></li> <li><code>public_ip</code> - set to the public IP address through which the deployment is exposed via the ingress-controller i.e. the IP address that is assigned to the ingress controller service of type LoadBalancer</li> <li><code>USE_TLS=true</code> - to enable configuration of TLS endpoints in each component service ingress</li> <li><code>TLS_CLUSTER_ISSUER=&lt;issuer&gt;</code> - should be configured ~ e.g. using the <code>letsencrypt-production</code> or <code>letsencrypt-staging</code> (testing only) Cluster Issuer that are configured by the scripted deployment</li> </ul>"},{"location":"quickstart/scripted-deployment/#deployment","title":"Deployment","text":"<p>The deployment is initiated by setting the appropriate environment variables and invoking the <code>eoepca.sh</code> script with suitable command-line arguments. You may find it convenient to do so using a wrapper script that customises the environment varaibles according to your cluster, and then invokes the <code>eoepca.sh</code> script.</p> <p>Customised examples are provided for Simple, CREODIAS and Processing deployments.</p> <p>NOTE that if a prior deployment has been attempted then, before redeploying, a clean-up should be performed as described in the Clean-up section below. This is particularly important in the case that the minikube <code>none</code> driver is used, as the persistence is maintained on the host and so is not naturally removed when the minikube cluster is destroyed.</p> <p>Initiate the deployment\u2026 <pre><code>./deploy/eoepca/eoepca.sh apply \"&lt;cluster-name&gt;\" \"&lt;public-ip&gt;\" \"&lt;domain&gt;\"\n</code></pre></p> <p>The deployment takes 10+ minutes - depending on the resources of your host/cluster. The progress can be monitored\u2026 <pre><code>kubectl get pods -A\n</code></pre></p> <p>The deployment is ready once all pods are either <code>Running</code> or <code>Completed</code>.</p>"},{"location":"quickstart/scripted-deployment/#post-deployment-manual-steps","title":"Post-deployment Manual Steps","text":"<p>The scripted deployment has been designed, as far as possible, to automate the configuration of the deployed components. However, there remain some steps that must be performed manually after the scripted deployment has completed. See the building block specific pages\u2026</p> <ul> <li>Identity Service: Token Lifespans</li> <li>Application Hub: Post-deployment Manual Steps</li> </ul>"},{"location":"quickstart/scripted-deployment/#default-credentials","title":"Default Credentials","text":""},{"location":"quickstart/scripted-deployment/#identity-service","title":"Identity Service","text":"<p>By default, the Identity Service is accessed at the URL <code>https://keycloak.192-168-49-2.nip.io/</code> with the credentials\u2026</p> <pre><code>username: `admin`\npassword: `changeme`\n</code></pre> <p>\u2026unless the password is overridden via the variable <code>IDENTITY_SERVICE_ADMIN_PASSWORD</code>.</p>"},{"location":"quickstart/scripted-deployment/#minio-object-storage","title":"Minio Object Storage","text":"<p>By default, Minio is accessed at the URL <code>https://console.minio.192-168-49-2.nip.io/</code> with the credentials\u2026</p> <pre><code>username: `eoepca`\npassword: `changeme`\n</code></pre> <p>\u2026unless the username/password are overridden via the variables <code>MINIO_ROOT_USER</code> and <code>MINIO_ROOT_PASSWORD</code>.</p>"},{"location":"quickstart/scripted-deployment/#harbor-container-registry","title":"Harbor Container Registry","text":"<p>By default, Harbor is accessed at the URL <code>https://harbor.192-168-49-2.nip.io/</code> with the credentials\u2026</p> <pre><code>username: `admin`\npassword: `changeme`\n</code></pre> <p>\u2026unless the password is overridden via the variable <code>HARBOR_ADMIN_PASSWORD</code>.</p>"},{"location":"quickstart/scripted-deployment/#protection","title":"Protection","text":"<p>The protection of resource server endpoints is applied during the deployment of each service requiring protection. This comprises creating a dedicated Keycloak client for each resource server, and the creation of associated resources and policies that protect the service-specific URLs.</p> <p>This protection can be disabled via the environment variables <code>REQUIRE_XXX_PROTECTION</code> - e.g. <code>REQUIRE_ADES_PROTECTION=false</code>.</p> <p>Note</p> <p>By default, if <code>OPEN_INGRESS</code> is set <code>true</code> then <code>PROTECTION</code> will be disabled (<code>false</code>) unless overridden via the <code>REQUIRE_XXX_PROTECTION</code> variables.</p>"},{"location":"quickstart/scripted-deployment/#test-users","title":"Test Users","text":"<p>The deployment creates (in the Keycloak Identity Service) the test users: <code>eric</code>, <code>bob</code>, <code>alice</code>.</p> <p>Note</p> <p>This does NOT create the workspace for each of these users - which must be performed via the Workspace API.</p>"},{"location":"quickstart/scripted-deployment/#user-workspace-creation","title":"User Workspace Creation","text":"<p>The deployment created the test users <code>eric</code>, <code>bob</code> and <code>alice</code>. For completeness we use the Workspace API to create their user workspaces, which hold their personal resources (data, processing results, etc.) within the platform - see Workspace.</p>"},{"location":"quickstart/scripted-deployment/#using-workspace-swagger-ui","title":"Using Workspace Swagger UI","text":"<p>The Workspace API provides a Swagger UI that facilitates interaction with the API - at the URL <code>https://workspace-api.192-168-49-2.nip.io/docs#</code>.</p> <p>Note</p> <p>If the Workspace API has been protected (via Gatekeeper with Keycloak), then requests must be supported by an <code>access_token</code> carried in the HTTP header <code>Authorozation: Bearer &lt;token&gt;</code>. This diminishes the utility of the swagger UI.</p> <p>Access the Workspace Swagger UI at <code>https://workspace-api.192-168-49-2.nip.io/docs</code>. Workspaces are created using <code>POST  /workspaces</code> (Create Workspace). Expand the node and select <code>Try it out</code>. Complete the request body, such as\u2026 <pre><code>{\n  \"preferred_name\": \"eric\",\n  \"default_owner\": \"eric\"\n}\n</code></pre> \u2026where the <code>default_owner</code> is the ID for the user in Keycloak - thus protecting the created workspace for the identified user.</p>"},{"location":"quickstart/scripted-deployment/#using-curl","title":"Using <code>curl</code>","text":"<p>The same can be achieved with a straight http request, for example using <code>curl</code>\u2026</p> <pre><code>curl -X 'POST' \\\n  'http://workspace-api.192-168-49-2.nip.io/workspaces' \\\n  -H 'Content-Type: application/json' \\\n  -H 'Accept: application/json' \\\n  -H 'Authorization: Bearer &lt;admin-access-token&gt;' \\\n  -d '{\n  \"preferred_name\": \"&lt;workspace-name&gt;\",\n  \"default_owner\": \"&lt;user-id&gt;\"\n}'\n</code></pre> <p>Values must be provided for:</p> <ul> <li><code>admin-access-token</code> - Access Token for the admin user</li> <li><code>workspace-name</code> - name of the workspace, typically the username</li> <li><code>user-id</code> - the ID of the user for which the created workspace will be protected, typically the username</li> </ul> <p>The Access Token for the <code>admin</code> user can be obtained with a call to the token endpoint of the Identity Service - supplying the credentials for the <code>admin</code> user and the pre-registered client\u2026</p> <pre><code>curl -L -X POST 'https://keycloak.192-168-49-2.nip.io/realms/master/protocol/openid-connect/token' \\\n  -H 'Cache-Control: no-cache' \\\n  -H 'Content-Type: application/x-www-form-urlencoded' \\\n  --data-urlencode 'scope=openid profile email' \\\n  --data-urlencode 'grant_type=password' \\\n  --data-urlencode 'username=admin' \\\n  --data-urlencode 'password=&lt;admin-password&gt;' \\\n  --data-urlencode 'client_id=admin-cli'\n</code></pre> <p>A json response is returned, in which the field <code>access_token</code> provides the Access Token for the <code>admin</code> user.</p>"},{"location":"quickstart/scripted-deployment/#using-create-workspace-helper-script","title":"Using <code>create-workspace</code> helper script","text":"<p>As an aide there is a helper script <code>create-workspace</code>. The script is available in the <code>deployment-guide</code> repository, and can be obtained as follows\u2026</p> <pre><code>git clone -b eoepca-v1.4 git@github.com:EOEPCA/deployment-guide\ncd deployment-guide\n</code></pre> <p>The <code>create-workspace</code> helper script requires some command-line arguments\u2026</p> <pre><code>$ ./deploy/bin/create-workspace -h\n\nCreate a new User Workspace.\ncreate-workspace -h | -w {workspace_api} -a {auth_server} -r {realm} -c {client} -u {admin-username} -p {admin-password} -O {owner} -W {workspace-name}\n\nwhere:\n    -h  show help message\n    -w  workspace-api service url (default: http://workspace-api.192-168-49-2.nip.io)\n    -a  authorization server url (default: http://keycloak.192-168-49-2.nip.io)\n    -r  realm within Keycloak (default: master)\n    -u  username used for authentication (default: admin)\n    -p  password used for authentication (default: changeme)\n    -c  client id of the bootstrap client used in the create request (default: admin-cli)\n    -O  user ID of the 'owner' of the new workspace (default: workspace(-W))\n    -W  name of the workspace to create (default: owner(-O))\n</code></pre> <p>Most of the arguments have default values that are aligned to the defaults of the scripted deployment. At minimum either <code>-O owner</code> or <code>-W workspace</code> must be specified.</p> <p>For example (assuming defaults)\u2026</p> <pre><code>./deploy/bin/create-workspace -O eric\n</code></pre> <p>For example (all arguments)\u2026</p> <pre><code>./deploy/bin/create-workspace \n  -w http://workspace-api.192-168-49-2.nip.io \\\n  -a http://keycloak.192-168-49-2.nip.io \\\n  -r master \\\n  -u admin \\\n  -p changeme \\\n  -c admin-cli \\\n  -O bob \\\n  -W bob\n</code></pre>"},{"location":"quickstart/scripted-deployment/#eoepca-portal","title":"EOEPCA Portal","text":"<p>The <code>eoepca-portal</code> is a simple web application that is used as a test aid. It\u2019s main purpose is to provide the ability to login, and so establish a session with appropriate browser cookies - which then allow authenticated access to other EOEPCA services such as the Workspace API, Identity API, etc.</p> <p>The portal is deployed via a helm chart\u2026</p> <pre><code>helm install eoepca-portal eoepca-portal -f portal-values.yaml - \\\n  --repo https://eoepca.github.io/helm-charts \\\n  --namespace \"demo\" --create-namespace \\\n  --version 1.0.11\n</code></pre> <p>The helm values must be tailored for your deployment. For example\u2026</p> <pre><code>configMap:\n  identity_url: \"http://keycloak.192-168-49-2.nip.io\"\n  realm: \"master\"\n  client_id: \"eoepca-portal\"\n  identity_api_url: \"http://identity-api.192-168-49-2.nip.io\"\n  ades_url: \"http://zoo.192-168-49-2.nip.io/ogc-api/processes\"\n  resource_catalogue_url: \"http://resource-catalogue.192-168-49-2.nip.io\"\n  data_access_url: \"http://data-access.192-168-49-2.nip.io\"\n  workspace_url: \"http://workspace-api.192-168-49-2.nip.io\"\n  workspace_docs_url: \"http://workspace-api.192-168-49-2.nip.io/docs#\"\n  images_registry_url: \"http://harbor.192-168-49-2.nip.io\"\n  dummy_service_url: \"http://dummy-service.192-168-49-2.nip.io\"\n  access_token_name: \"auth_user_id\"\n  access_token_domain: \".192-168-49-2.nip.io\"\n  refresh_token_name: \"auth_refresh_token\"\n  refresh_token_domain: \".192-168-49-2.nip.io\"\ningress:\n  enabled: true\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    ingress.kubernetes.io/ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n    cert-manager.io/cluster-issuer: letsencrypt-production\n  hosts:\n    - host: eoepca-portal.192-168-49-2.nip.io\n      paths:\n        - path: /\n          pathType: Prefix\n  tls:\n    - secretName: eoepca-portal-tls\n      hosts:\n        - eoepca-portal.192-168-49-2.nip.io\n</code></pre> <p>The setting <code>client_id: eoepca-portal</code> identifies a client that must be created in Keycloak - as described in section <code>create-client</code> Helper Script - noting that the <code>eoepca-portal</code> requires a client that is configured as a <code>Public Client</code>\u2026</p> <pre><code>../bin/create-client \\\n  -a https://keycloak.192-168-49-2.nip.io \\\n  -i https://identity-api.192-168-49-2.nip.io \\\n  -r \"master\" \\\n  -u \"admin\" \\\n  -p \"changeme\" \\\n  -c \"admin-cli\" \\\n  --id=eoepca-portal \\\n  --name=\"EOEPCA Portal\" \\\n  --public \\\n  --description=\"Client to be used by the EOEPCA Portal\"\n</code></pre>"},{"location":"quickstart/scripted-deployment/#clean-up","title":"Clean-up","text":"<p>Before initiating a fresh deployment, if a prior deployment has been attempted, then it is necessary to remove any persistent artefacts of the prior deployment. This includes\u2026</p> <ol> <li> <p>Minikube cluster   Delete the minikube cluster\u2026 <code>minikube delete</code>   If necessary specify the cluster (profile)\u2026 <code>minikube -p &lt;profile&gt; delete</code></p> </li> <li> <p>Persistent Data   In the case that the minikube <code>none</code> driver is used, the persistence is maintained on the host and so is not naturally removed when the minikube cluster is destroyed. In this case, the minikube <code>standard</code> StorageClass is fulfilled by the <code>hostpath</code> provisioner, whose persistence is removed as follows\u2026 <code>sudo rm -rf /tmp/hostpath-provisioner</code></p> </li> </ol> <p>There is a helper script <code>clean</code> that can be used for step 2 above, (the script does not delete the cluster). <pre><code>./deploy/cluster/clean\n</code></pre></p>"},{"location":"quickstart/simple-deployment/","title":"Simple Deployment","text":""},{"location":"quickstart/simple-deployment/#overview","title":"Overview","text":"<p>A deployment wrapper script has been prepared for a \u2018simple\u2019 deployment - designed to get a core local deployment of the primary servies.</p> <p>The script <code>deploy/simple/simple</code> achieves this by appropriate configuration of the environment variables, before launching the eoepca.sh deployment script. The deployment configuration is captured in the file <code>deploy/simple/simple-options</code>.</p> <p>The simple deployment applies the following configuration:</p> <ul> <li>Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment</li> <li>No TLS for service ingress endpoints</li> <li>Configuration of \u2018open\u2019 interfaces - i.e. service/API endpoints that are not protected and can accessed without authentication. This facilitates experimentation with the services</li> <li>Configuration of ADES stage-out to a local instance of <code>minio</code>, to avoid the need to create a Workspace for each user</li> </ul>"},{"location":"quickstart/simple-deployment/#initiate-deployment","title":"Initiate Deployment","text":"<p>Deployment is initiated by invoking the script\u2026</p> <pre><code>./deploy/simple/simple\n</code></pre> <p>See section Deployment for more details regarding the outcome of the scripted deployment.</p>"},{"location":"quickstart/simple-deployment/#post-deploy-manual-steps","title":"Post-deploy Manual Steps","text":"<p>To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.</p>"},{"location":"quickstart/userman-deployment/","title":"User Management Deployment","text":""},{"location":"quickstart/userman-deployment/#overview","title":"Overview","text":"<p>A deployment wrapper script has been prepared for a \u2018user management\u2019 deployment - that is focused on the Identity Service (Authorization Server), Identity API and Gatekeeper (Protection Policy Enforcement).</p> <p>The script <code>deploy/userman/userman</code> achieves this by appropriate configuration of the environment variables, before launching the eoepca.sh deployment script. The deployment configuration is captured in the file <code>deploy/userman/userman-options</code>.</p> <p>The user-management deployment applies the following configuration:</p> <ul> <li>Assumes a private deployment - i.e. no external-facing IP/ingress, and hence no TLS To configure an external-facing deployment with TLS protection, then see section Public Deployment</li> <li>No TLS for service ingress endpoints</li> <li>Services deployed:<ul> <li>Identity Service</li> <li>Identity API</li> <li>Gatekeeper instance, protecting the Identity API</li> </ul> </li> <li>Other eoepca services not deployed</li> </ul>"},{"location":"quickstart/userman-deployment/#initiate-deployment","title":"Initiate Deployment","text":"<p>Deployment is initiated by invoking the script\u2026</p> <pre><code>./deploy/userman/userman\n</code></pre> <p>The Identity Service is accessed at the endpoint <code>keycloak.192-168-49-2.nip.io</code>.</p> <p>The Identity API is accessed at the endpoint <code>identity-api.192-168-49-2.nip.io</code>.</p>"},{"location":"quickstart/userman-deployment/#post-deploy-manual-steps","title":"Post-deploy Manual Steps","text":"<p>To complete the deployment, see section Post-deployment Manual Steps of the Scripted Deployment page.</p>"}]}