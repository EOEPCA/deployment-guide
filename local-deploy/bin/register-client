#!/usr/bin/env bash

ORIG_DIR="$(pwd)"
cd "$(dirname "$0")"
BIN_DIR="$(pwd)"

onExit() {
  cd "${ORIG_DIR}"
}

trap onExit EXIT

# Check docker is installed
if ! hash docker >/dev/null 2>&1; then
  echo "ERROR: docker is required" 1>&2
  exit 1
fi

# Create the container image
echo -n "INFO: Preparing docker image... "
docker build -t register-client register-client-src >/dev/null
docker system prune -f >/dev/null
echo "[done]"

# Use minikube network if active
docker_network=
# minikube installed?
if hash minikube >/dev/null 2>&1; then
  # minikube running?
  if minikube status >/dev/null 2>&1; then
    # get current profile which doubles as the network name
    current_profile="$(minikube profile 2>/dev/null | cut -d\  -f2-)"
    if test $?; then
      docker_network="--network ${current_profile}"
      echo "Using minikube network: ${current_profile}"
    fi
  fi
fi

# Run using docker container
output_file="${3:-/dev/null}"
docker run --rm ${docker_network} register-client "$1" "$2" | tee "${output_file}"
